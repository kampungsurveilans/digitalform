<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Sistem Surveilans Modern</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.015em;
            -webkit-tap-highlight-color: transparent; 
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            letter-spacing: -0.025em;
            line-height: 1.2;
        }
        
        .text-display {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -0.03em;
            line-height: 1.1;
        }
        
        .text-title {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .text-subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            line-height: 1.4;
        }
        
        .text-body {
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .text-caption {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .text-micro {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        input, select, textarea, button {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        
        .font-mono {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Fira Mono', 'Droid Sans Mono', 'Courier New', monospace;
            letter-spacing: -0.01em;
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        :focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .typography-spacing > * + * {
            margin-top: 1.5em;
        }
        
        .readable-text {
            max-width: 65ch;
            line-height: 1.75;
        }
        
        .uppercase-input {
            text-transform: uppercase;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .pulse-notification {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Responsive improvements for mobile */
        @media (max-width: 640px) {
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-scroll table {
                min-width: 768px;
            }
            
            .mobile-stack {
                flex-direction: column;
            }
            
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            
            .mobile-button-group {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .mobile-button-group button {
                flex: 1;
                min-width: 120px;
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // BAGIAN 1: KONFIGURASI DAN DATA
        const { useState, useEffect, useRef } = React;

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCNkEVslyMr-ReNO77drTO7n-AkWoYJPCY",
            authDomain: "pd3i-roli.firebaseapp.com",
            projectId: "pd3i-roli",
            storageBucket: "pd3i-roli.firebasestorage.app",
            messagingSenderId: "93373481706",
            appId: "1:93373481706:web:509299c6fdd8433eb30d93",
            measurementId: "G-H0HDJ0F901"
        };

        let dbAuth, dbStore;
        try {
            if (!firebase.apps.length) { firebase.initializeApp(FIREBASE_CONFIG); }
            dbAuth = firebase.auth();
            dbStore = firebase.firestore();
        } catch (e) { console.error("Firebase Error:", e); }

        const DATA_PUSKESMAS = [
            "Puskesmas Alianyang", "Puskesmas Banjar Serasan", "Puskesmas Gang Sehat",
            "Puskesmas Kampung Bali", "Puskesmas Kampung Bangka", "Puskesmas Kampung Dalam",
            "Puskesmas Karya Mulia", "Puskesmas Khatulistiwa", "Puskesmas Kom. Yos Sudarso",
            "Puskesmas Pal Lima", "Puskesmas Pal Tiga", "Puskesmas Parit Haji Husin II",
            "Puskesmas Parit Mayor", "Puskesmas Perumnas I", "Puskesmas Perumnas II",
            "Puskesmas Purnama", "Puskesmas Saigon", "Puskesmas Siantan Hilir",
            "Puskesmas Siantan Hulu", "Puskesmas Siantan Tengah", "Puskesmas Tambelan Sampit",
            "Puskesmas Tanjung Hulu", "Puskesmas Telaga Biru"
        ];

        const DATA_RUMAH_SAKIT = [
            "RS Anugerah Bunda Khatulistiwa", "RS Bersalin Jeumpa Pontianak",
            "RS Bhayangkara Tk. III Anton Soedjarwo Pontianak", "RS Islam Yarsi Pontianak",
            "RS Jiwa Daerah Sungai Bangkong", "RS Kharitas Bhakti", "RS Medika Djaya",
            "RS Mitra Medika Pontianak", "RS Pro Medika Pontianak", "RS St. Antonius",
            "RS Universitas Tanjungpura", "RSIA Nabasa", "RSUD dr. Soedarso",
            "RSUD Pontianak Utara", "RSUD Sultan Syarif Mohammad Alkadrie"
        ];

        const DATA_WILAYAH_MAPPING = {
            "Kecamatan Pontianak Kota": ["Darat sekip", "Mariana", "Sungai bangkong", "Sungai jawi", "Tengah"],
            "Kecamatan Pontianak Timur": ["Dalam Bugis", "Parit Mayor", "Saigon", "Tanjung Hulu", "Tanjung Hilir", "Tambelan Sampit", "Banjar Serasan"],
            "Kecamatan Pontianak Barat": ["Pal Lima", "Sungai Beliung", "Sungai Jawi Luar", "Sungai Jawi Dalam", "Kota Baru"],
            "Kecamatan Pontianak Selatan": ["Akcaya", "Benua melayu Darat", "Benua melayu Laut", "Kotabaru", "Parit tokaya"],
            "Kecamatan Pontianak Utara": ["Batulayang", "Siantan Hilir", "Siantan Hulu", "Siantan Tengah"],
            "Kecamatan Pontianak Tenggara": ["Bangka Belitung Laut", "Bangka Belitung Darat", "Bansir Laut", "Bansir Darat"]
        };

        const DATA_KOMPLIKASI = ["Diare", "Bronchopneumonia", "Kebutaan", "Otitis media", "Pneumonia", "Encephalitis", "Malnutrisi", "Ulkus mukasa mulut", "Lainnya"];
        const ALL_SERVICES = [...DATA_PUSKESMAS, ...DATA_RUMAH_SAKIT].filter((value, index, self) => self.indexOf(value) === index);

        const IconBase = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            AlertTriangle: (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Thermometer: (p) => <IconBase {...p}><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Syringe: (p) => <IconBase {...p}><path d="M18 6L6 18"/><path d="M21 12l-6 6"/><path d="M15 3l-3 3"/><path d="M3 21l6-6"/><path d="M9 3l3-3 5 5-3 3"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Shield: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>,
            Plane: (p) => <IconBase {...p}><path d="M2 22h20"/><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            XCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>,
            Gps: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            List: (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Archive: (p) => <IconBase {...p}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></IconBase>,
            Share: (p) => <IconBase {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></IconBase>,
            Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconBase>,
            Send: (p) => <IconBase {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>,
            Inbox: (p) => <IconBase {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></IconBase>,
            XOctagon: (p) => <IconBase {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            Eye: (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></IconBase>,
            Grid: (p) => <IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>,
            Database: (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            Home: (p) => <IconBase {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
            School: (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>,
            Hourglass: (p) => <IconBase {...p}><path d="M5 22h14"/><path d="M5 2h14"/><path d="M12 2v20"/><path d="M12 8l4 4-4 4"/><path d="M8 12l-4 4 4 4"/></IconBase>
        };

        const mockUserDB = {
            checkAndCreateDefaultAdmin: async () => {
                if(!dbStore) return;
                try {
                    const snap = await dbStore.collection('users').limit(1).get();
                    if(snap.empty) await dbStore.collection('users').add({ 
                        username: 'admin', 
                        password: 'admin123', 
                        role: 'admin', 
                        name: 'Administrator Utama', 
                        unitName: 'Puskesmas Alianyang'
                    });
                } catch(e) {}
            },
            getUsers: async () => { 
                if (!dbStore) return []; 
                try { 
                    const snapshot = await dbStore.collection('users').get(); 
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                } catch (e) { 
                    return []; 
                } 
            },
            addUser: async (user) => { 
                if (!dbStore) return false; 
                try { 
                    const snap = await dbStore.collection('users').where('username', '==', user.username).get(); 
                    if(!snap.empty) return false; 
                    await dbStore.collection('users').add(user); 
                    return true; 
                } catch (e) { 
                    return false; 
                } 
            },
            updateUser: async (id, userData) => {
                if (!dbStore) return false;
                try {
                    await dbStore.collection('users').doc(id).update(userData);
                    return true;
                } catch (e) {
                    console.error("Error updating user:", e);
                    return false;
                }
            },
            deleteUser: async (id) => { 
                if (dbStore) await dbStore.collection('users').doc(id).delete(); 
            },
            authenticate: async (u, p) => { 
                if (!dbStore) return null; 
                try { 
                    const snap = await dbStore.collection('users').where('username', '==', u).where('password', '==', p).get(); 
                    return snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() }; 
                } catch(e) { 
                    return null; 
                } 
            }
        };

        const mockDB = {
            save: async (data) => { 
                console.log("Saving data to Firebase:", data.id);
                if (dbStore) {
                    try {
                        await dbStore.collection('forms').doc(data.id).set(data);
                        console.log("Data saved successfully");
                    } catch (e) {
                        console.error("Error saving to Firebase:", e);
                        throw e;
                    }
                }
            },
            delete: async (id) => { 
                console.log("Deleting data from Firebase:", id);
                if (dbStore) {
                    try {
                        await dbStore.collection('forms').doc(id).delete();
                        console.log("Data deleted successfully");
                    } catch (e) {
                        console.error("Error deleting from Firebase:", e);
                        throw e;
                    }
                }
            },
            getById: async (id) => { 
                if (!dbStore) return null; 
                const doc = await dbStore.collection('forms').doc(id).get();
                return doc.exists ? doc.data() : null; 
            },
            countFinal: async () => { 
                if (!dbStore) return 0; 
                const snap = await dbStore.collection('forms').where('statusData', 'in', ['Final', 'Rejected']).get(); 
                return snap.size; 
            },
            getAllForms: async () => { 
                if (!dbStore) return []; 
                try {
                    const snap = await dbStore.collection('forms').orderBy('updatedAt', 'desc').get(); 
                    return snap.docs.map(d => d.data());
                } catch (e) {
                    console.error("Error getting all forms:", e);
                    return [];
                }
            },
            getFormsByStatus: async (statuses) => { 
                if (!dbStore) return []; 
                const snap = await dbStore.collection('forms').where('statusData', 'in', statuses).get(); 
                return snap.docs.map(d => d.data()).sort((a, b) => b.updatedAt - a.updatedAt); 
            }
        };

        const exportToCSV = (data, filename, isRaw = false) => {
            if (!data || data.length === 0) { alert("Tidak ada data."); return; }
            let headers, csvRows;
            if (isRaw) {
                headers = Object.keys(data[0]);
                csvRows = data.map(item => headers.map(header => `"${String(item[header]||'').replace(/"/g, '""')}"`).join(","));
            } else {
                // PERBAIKAN POINT 2: Format CSV sesuai urutan pertanyaan formulir
                headers = [
                    "Nomor EPID", "Status", "Nama Kasus", "Jenis Kelamin", "Tanggal Lahir", 
                    "Alamat", "Kabupaten", "Kecamatan", "Kelurahan", "RT", "RW", 
                    "Nama Orangtua", "No Kontak Orangtua", "Sumber Laporan", "Unit Pelapor", 
                    "Tanggal Terima Laporan", "Tanggal Pelacakan Kasus", "Demam", "Tanggal Mulai Demam",
                    "Ruam", "Tanggal Mulai Ruam", "Gejala Lain", "Gejala Lain Sebutkan", 
                    "Komplikasi", "Komplikasi Lainnya", "Dirawat", "Nama Rumah Sakit", 
                    "Nomor Rekam Medik", "Tanggal Masuk Rawat", "Tanggal Keluar Rawat",
                    "Imunisasi Campak 1", "Sumber Campak 1", "Imunisasi Campak 2", "Sumber Campak 2",
                    "Imunisasi BIAS", "Sumber BIAS", "Imunisasi MMR", "Sumber MMR",
                    "Imunisasi Tambahan", "Sumber Tambahan", "Tanggal Imunisasi Terakhir",
                    "Vitamin A", "Ada Kontak Sakit Sama", "Jumlah Kontak Sakit", "Bepergian",
                    "Lokasi Bepergian", "Tanggal Pergi", "Tanggal Kembali", "Spesimen Darah",
                    "Jenis Sample Darah", "Tanggal Ambil Darah", "Tanggal Kirim Darah",
                    "Spesimen Lain", "Jenis Sampel Lain", "Jenis Sampel Lain Sebutkan",
                    "Tanggal Ambil Lain", "Tanggal Kirim Lain", "Keadaan Saat Ini",
                    "Pelaksana Investigasi", "Nama Sekolah", "Titik Lokasi", "Petugas Input",
                    "Unit Pembuat", "Current Owner", "Tanggal Terakhir Update"
                ];
                
                csvRows = data.map(item => [
                    `"${item.nomorEPID||''}"`, `"${item.statusData||''}"`, `"${item.namaKasus||''}"`, `"${item.jenisKelamin||''}"`, `"${item.tanggalLahir||''}"`, 
                    `"${(item.alamat||'').replace(/"/g, '""')}"`, `"${item.kabupaten||'Kota Pontianak'}"`, `"${item.kecamatan||''}"`, `"${item.kelurahan||''}"`, 
                    `"${item.rt||''}"`, `"${item.rw||''}"`, `"${item.namaOrangtua||''}"`, `"${item.noKontakOrangtua||''}"`, `"${item.sumberLaporan||''}"`, 
                    `"${item.namaUnitPelapor||''}"`, `"${item.tanggalTerimaLaporan||''}"`, `"${item.tanggalPelacakan||''}"`, `"${item.demam||''}"`, 
                    `"${item.tanggalMulaiDemam||''}"`, `"${item.ruam||''}"`, `"${item.tanggalMulaiRuam||''}"`, `"${Array.isArray(item.gejalaLain) ? item.gejalaLain.join(', ') : item.gejalaLain||''}"`, 
                    `"${item.gejalaLainSebutkan||''}"`, `"${Array.isArray(item.komplikasi) ? item.komplikasi.join(', ') : item.komplikasi||''}"`, `"${item.komplikasiLainnyaSebutkan||''}"`, 
                    `"${item.dirawat||''}"`, `"${item.namaRumahSakit||''}"`, `"${item.nomorRekamMedik||''}"`, `"${item.tanggalMasukRawat||''}"`, `"${item.tanggalKeluarRawat||''}"`, 
                    `"${item.imunisasiCampak1||''}"`, `"${item.sumberCampak1||''}"`, `"${item.imunisasiCampak2||''}"`, `"${item.sumberCampak2||''}"`, `"${item.imunisasiBIAS||''}"`, 
                    `"${item.sumberBIAS||''}"`, `"${item.imunisasiMMR||''}"`, `"${item.sumberMMR||''}"`, `"${item.imunisasiTambahan||''}"`, `"${item.sumberTambahan||''}"`, 
                    `"${item.tanggalImunisasiTerakhir||''}"`, `"${item.vitaminA||''}"`, `"${item.adaKontakSakitSama||''}"`, `"${item.jumlahKontakSakit||''}"`, `"${item.bepergian||''}"`, 
                    `"${item.lokasiBepergian||''}"`, `"${item.tanggalPergi||''}"`, `"${item.tanggalKembali||''}"`, `"${item.spesimenDarah||''}"`, `"${Array.isArray(item.jenisSampleDarah) ? item.jenisSampleDarah.join(', ') : item.jenisSampleDarah||''}"`, 
                    `"${item.tanggalAmbilDarah||''}"`, `"${item.tanggalKirimDarah||''}"`, `"${item.spesimenLain||''}"`, `"${Array.isArray(item.jenisSampelLain) ? item.jenisSampelLain.join(', ') : item.jenisSampelLain||''}"`, 
                    `"${item.jenisSampelLainSebutkan||''}"`, `"${item.tanggalAmbilLain||''}"`, `"${item.tanggalKirimLain||''}"`, `"${item.keadaanSaatIni||''}"`, `"${item.pelaksanaInvestigasi||''}"`, 
                    `"${item.namaSekolah||''}"`, `"${item.titikLokasi||''}"`, `"${item.createdBy||''}"`, `"${item.createdUnit||''}"`, `"${item.currentOwner || item.createdUnit}"`, 
                    `"${new Date(item.updatedAt).toLocaleDateString()}"`
                ].join(","));
            }
            const blob = new Blob([[headers.join(","), ...csvRows].join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // BAGIAN 2: LOGIC & STATE
        const INITIAL_DATA = {
            id: '', updatedAt: 0, statusData: 'Baru', sharedTo: '', createdBy: '', createdUnit: '',
            originalUnit: '', currentOwner: '', transferHistory: [], nomorEPID: '', kasusKLB: '', 
            klbKe: '', nomorKLB: '', sumberLaporan: '', sumberLainnya: '', namaUnitPelapor: '',
            tanggalTerimaLaporan: '', tanggalPelacakan: '', namaKasus: '', jenisKelamin: '', 
            tanggalLahir: '', alamat: '', provinsi: 'Kalimantan Barat', kabupaten: 'Kota Pontianak', 
            kecamatan: '', kelurahan: '', rw: '', rt: '', namaOrangtua: '', noKontakOrangtua: '',
            demam: '', tanggalMulaiDemam: '', ruam: '', tanggalMulaiRuam: '', gejalaLain: [], 
            gejalaLainSebutkan: '', komplikasi: [], komplikasiLainnyaSebutkan: '', dirawat: '', 
            namaRumahSakit: '', nomorRekamMedik: '', tanggalMasukRawat: '', tanggalKeluarRawat: '',
            imunisasiCampak1: '', sumberCampak1: '', imunisasiCampak2: '', sumberCampak2: '',
            imunisasiBIAS: '', sumberBIAS: '', imunisasiMMR: '', sumberMMR: '', imunisasiTambahan: '', 
            sumberTambahan: '', tanggalImunisasiTerakhir: '', vitaminA: '', adaKontakSakitSama: '', 
            jumlahKontakSakit: '', bepergian: '', lokasiBepergian: '', tanggalPergi: '', tanggalKembali: '',
            spesimenDarah: '', jenisSampleDarah: [], tanggalAmbilDarah: '', tanggalKirimDarah: '',
            spesimenLain: '', jenisSampelLain: [], jenisSampelLainSebutkan: '', tanggalAmbilLain: '', 
            tanggalKirimLain: '', keadaanSaatIni: '', pelaksanaInvestigasi: '', namaSekolah: '', 
            titikLokasi: '', epidManual: false,
            // PERBAIKAN POINT 1: Tambah field untuk kontak erat
            kontakErat: []
        };

        const calculateAge = (tanggalLahir) => {
            if (!tanggalLahir) return '';
            try {
                const birthDate = new Date(tanggalLahir);
                const today = new Date();
                let years = today.getFullYear() - birthDate.getFullYear();
                let months = today.getMonth() - birthDate.getMonth();
                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} tahun, ${months} bulan`;
            } catch (e) {
                return '';
            }
        };

        let lastEPIDNumber = 0;
        // PERBAIKAN POINT 3: Hapus fungsi generateAutoEPID karena diganti input manual
        // const generateAutoEPID = async () => { ... }

        const validateManualEPID = (epid) => {
            // PERBAIKAN POINT 3: Validasi bebas untuk input manual
            if (!epid) return { valid: false, message: 'Nomor EPID tidak boleh kosong' };
            return { valid: true, message: '' };
        };

        // PERBAIKAN UTAMA: Fungsi untuk menentukan current owner dengan logika yang benar
        const determineCurrentOwner = (formData) => {
            if (formData.currentOwner && formData.currentOwner !== '') {
                return formData.currentOwner;
            }
            
            // Untuk chain referral, kita perlu mencari pengirim terakhir
            if (formData.transferHistory && formData.transferHistory.length > 0) {
                // Cari riwayat transfer terakhir yang BERHASIL (diterima)
                const successfulTransfers = formData.transferHistory.filter(
                    record => record.action === 'diterima' || record.action === 'dikirim'
                );
                
                if (successfulTransfers.length > 0) {
                    const lastTransfer = successfulTransfers[successfulTransfers.length - 1];
                    
                    // Jika ada newOwner di record terakhir, gunakan itu
                    if (lastTransfer.newOwner) {
                        return lastTransfer.newOwner;
                    }
                    
                    // Jika action 'dikirim', owner masih pengirim
                    if (lastTransfer.action === 'dikirim') {
                        return lastTransfer.from;
                    }
                    
                    // Jika action 'diterima', owner adalah penerima
                    if (lastTransfer.action === 'diterima') {
                        return lastTransfer.to;
                    }
                }
            }
            
            // Fallback untuk data lama
            if (formData.statusData === 'Final' || formData.statusData === 'Baru' || formData.statusData === 'Draft') {
                return formData.createdUnit;
            }
            
            if (formData.statusData === 'Pending') {
                return formData.currentOwner || formData.createdUnit;
            }
            
            if (formData.statusData === 'Proses') {
                return formData.createdUnit;
            }
            
            if (formData.statusData === 'Ditolak') {
                // Saat ditolak, kembalikan ke pengirim terakhir dari transferHistory
                if (formData.transferHistory && formData.transferHistory.length > 0) {
                    // Cari pengirim terakhir yang mengirim form ini
                    const sendRecords = formData.transferHistory.filter(r => r.action === 'dikirim');
                    if (sendRecords.length > 0) {
                        return sendRecords[sendRecords.length - 1].from;
                    }
                }
                return formData.createdUnit;
            }
            
            return formData.createdUnit;
        };

        const createTransferRecord = (action, fromUnit, toUnit, newOwner = null) => {
            const record = {
                action: action,
                from: fromUnit,
                to: toUnit,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            if (newOwner) {
                record.newOwner = newOwner;
                record.ownershipTransferred = true;
            }
            
            return record;
        };

        const sessionManager = {
            save: (user) => {
                const data = JSON.stringify(user);
                try { localStorage.setItem('epid_session', data); } catch (e) {}
                const d = new Date();
                d.setTime(d.getTime() + (7*24*60*60*1000));
                document.cookie = "epid_session=" + encodeURIComponent(data) + ";expires=" + d.toUTCString() + ";path=/;SameSite=None;Secure";
            },
            load: () => {
                try {
                    const local = localStorage.getItem('epid_session');
                    if (local) return JSON.parse(local);
                } catch (e) {}
                const name = "epid_session=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') c = c.substring(1);
                    if (c.indexOf(name) == 0) {
                        try { return JSON.parse(decodeURIComponent(c.substring(name.length, c.length))); } catch(e){}
                    }
                }
                return null;
            },
            clear: () => {
                try { localStorage.removeItem('epid_session'); } catch (e) {}
                document.cookie = "epid_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }
        };

        // BAGIAN 3: KOMPONEN UI DASAR
        const Card = ({ children, className = "" }) => (<div className={`bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-6 ${className}`}>{children}</div>);

        const Input = ({ label, as = 'input', className, uppercase = false, ...props }) => (
            <div className={`w-full ${className} mb-4`}>
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{label}</label>
                {as === 'textarea' ? (
                    <textarea {...props} rows={3} className={`w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300 ${uppercase ? 'uppercase-input' : ''}`} />
                ) : (
                    <input {...props} className={`w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300 ${uppercase ? 'uppercase-input' : ''}`} />
                )}
            </div>
        );

        const Select = ({ label, children, ...props }) => (
            <div className="w-full mb-4">
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{label}</label>
                <div className="relative">
                    <select {...props} className="w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium appearance-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all outline-none border border-slate-200 text-body hover:border-slate-300">
                        {children}
                    </select>
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"><Icons.ChevronLeft className="-rotate-90 w-4 h-4"/></div>
                </div>
            </div>
        );

        const RadioGroup = ({ name, options, value, onChange }) => (
            <div className="flex flex-wrap gap-2 mb-4">
                {options.map(opt => (
                    <label key={opt} className={`flex-1 min-w-[100px] text-center py-3 px-4 rounded-lg cursor-pointer transition-all duration-300 font-medium text-sm capitalize relative overflow-hidden group ${value === opt ? 'bg-blue-600 text-white shadow-sm shadow-blue-500/30' : 'bg-slate-50 text-slate-600 hover:bg-slate-100 border border-slate-200'}`}>
                        <input type="radio" name={name} value={opt} checked={value === opt} onChange={onChange} className="hidden" />
                        <span className="relative z-10">{opt}</span>
                        {value === opt && <div className="absolute inset-0 bg-gradient-to-tr from-blue-600 to-indigo-500 z-0"></div>}
                    </label>
                ))}
            </div>
        );

        const Checkbox = ({ label, ...props }) => (
            <label className="flex items-center p-4 bg-slate-50 rounded-lg cursor-pointer transition active:scale-95 border border-transparent hover:border-slate-200 text-caption">
                <input type="checkbox" {...props} className="w-5 h-5 accent-blue-600 rounded mr-3" />
                <span className="text-slate-700 font-medium capitalize">{label}</span>
            </label>
        );

        const Label = ({ children }) => <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{children}</label>;

        const ImunisasiSection = ({ label, name, sourceName, data, onChange }) => (
            <div className="bg-slate-50 p-5 rounded-xl border border-slate-100 mb-4">
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 text-micro">{label}</label>
                <RadioGroup 
                    name={name} 
                    options={['Ya', 'Tidak', 'Belum Cukup Umur', 'Tidak Tahu']} 
                    value={data[name]} 
                    onChange={onChange} 
                />
                <div className="mt-3 pt-3 border-t border-slate-200">
                    <label className="text-[10px] font-semibold text-slate-500 uppercase mb-2 block text-micro">Sumber Data:</label>
                    <div className="flex flex-wrap gap-2">
                        {['Catatan Buku KIA/KMS', 'Ingatan Responden', 'Lain-lain'].map(o => (
                            <label key={o} className={`flex items-center p-2 bg-white rounded-lg cursor-pointer border ${data[sourceName] === o ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-slate-300'}`}>
                                <input 
                                    type="radio" 
                                    name={sourceName} 
                                    value={o} 
                                    checked={data[sourceName] === o} 
                                    onChange={onChange} 
                                    className="w-4 h-4 accent-blue-600 rounded mr-2" 
                                />
                                <span className="text-xs text-slate-700">{o}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </div>
        );

        // PERBAIKAN POINT 3: Step1 dengan input manual untuk nomor EPID
        const Step1 = ({ data, onChange, onSumberChange, Icons }) => {
            return (
                <div className="animate-fadeIn">
                    <div className="mb-8">
                        <Label>Nomor EPID</Label>
                        <input
                            type="text"
                            name="nomorEPID"
                            value={data.nomorEPID}
                            onChange={onChange}
                            placeholder="Masukkan nomor EPID"
                            className="w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300"
                        />
                        <p className="text-sm text-slate-500 mt-2">Nomor EPID disesuaikan dengan ketentuan</p>
                    </div>
                    
                    <div className="mb-8">
                        <Label>Apakah kasus KLB?</Label>
                        <RadioGroup name="kasusKLB" options={['ya', 'tidak']} value={data.kasusKLB} onChange={onChange} />
                    </div>
                    
                    {data.kasusKLB === 'ya' && (
                        <div className="bg-orange-50 p-5 rounded-xl border border-orange-100 mb-6 animate-fadeIn">
                            <p className="text-sm font-semibold text-orange-700 mb-3">Detail KLB</p>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="KLB Ke-" name="klbKe" value={data.klbKe} onChange={onChange} className="mb-0" />
                                <Input label="Nomor KLB" name="nomorKLB" value={data.nomorKLB} onChange={onChange} className="mb-0" />
                            </div>
                        </div>
                    )}

                    <div className="mb-6">
                        <Label>Sumber Laporan</Label>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">
                            {['Puskesmas', 'Rumah Sakit', 'Bidan', 'Klinik Swasta', 'Lainnya'].map(src => (
                                <label key={src} className={`p-4 rounded-lg cursor-pointer text-center border transition-all text-sm font-medium ${data.sumberLaporan === src ? 'bg-slate-800 text-white border-slate-800 shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                    <input type="radio" name="sumberLaporan" value={src} checked={data.sumberLaporan === src} onChange={onSumberChange} className="hidden" />
                                    <span>{src}</span>
                                </label>
                            ))}
                        </div>
                    </div>

                    {data.sumberLaporan === 'Puskesmas' && (
                        <Select label="Pilih Puskesmas" name="namaUnitPelapor" value={data.namaUnitPelapor} onChange={onChange}>
                            <option value="">Pilih Puskesmas...</option>
                            {DATA_PUSKESMAS.map(p=><option key={p} value={p}>{p}</option>)}
                        </Select>
                    )}
                    {data.sumberLaporan === 'Rumah Sakit' && (
                        <Select label="Pilih Rumah Sakit" name="namaUnitPelapor" value={data.namaUnitPelapor} onChange={onChange}>
                            <option value="">Pilih Rumah Sakit...</option>
                            {DATA_RUMAH_SAKIT.map(p=><option key={p} value={p}>{p}</option>)}
                        </Select>
                    )}
                    {['Lainnya', 'Bidan', 'Klinik Swasta'].includes(data.sumberLaporan) && (
                        <Input label="Nama Unit Pelapor" name="namaUnitPelapor" value={data.namaUnitPelapor} onChange={onChange} />
                    )}

                    <div className="grid grid-cols-2 gap-4 mt-6">
                        <Input label="Tanggal Terima Laporan" type="date" name="tanggalTerimaLaporan" value={data.tanggalTerimaLaporan} onChange={onChange} />
                        <Input label="Tanggal Pelacakan Kasus" type="date" name="tanggalPelacakan" value={data.tanggalPelacakan} onChange={onChange} />
                    </div>
                </div>
            );
        };

        const Step2 = ({ data, onChange, onChangeKecamatan, Icons }) => (
            <div className="animate-fadeIn">
                <Input label="Nama Lengkap Pasien" name="namaKasus" value={data.namaKasus} onChange={onChange} placeholder="Masukkan nama lengkap" uppercase={true} />
                
                <div className="grid grid-cols-2 gap-4">
                    <Select label="Jenis Kelamin" name="jenisKelamin" value={data.jenisKelamin} onChange={onChange}>
                        <option value="">Pilih jenis kelamin...</option>
                        <option value="laki-laki">Laki-laki</option>
                        <option value="perempuan">Perempuan</option>
                    </Select>
                    <div>
                        <Input label="Tanggal Lahir" type="date" name="tanggalLahir" value={data.tanggalLahir} onChange={onChange} />
                        {data.tanggalLahir && (
                            <p className="text-sm text-slate-500 mt-1 ml-1">
                                Usia: {calculateAge(data.tanggalLahir)}
                            </p>
                        )}
                    </div>
                </div>
                
                <Input label="Alamat Lengkap" as="textarea" name="alamat" value={data.alamat} onChange={onChange} placeholder="Jl. Nama Jalan, Nomor, RT/RW" />
                
                <div className="bg-slate-50 p-5 rounded-xl border border-slate-100 mb-6">
                    <Label>Wilayah Administrasi</Label>
                    <div className="space-y-4 mt-3">
                        <Select label="Kecamatan" name="kecamatan" value={data.kecamatan} onChange={onChangeKecamatan}>
                            <option value="">Pilih Kecamatan...</option>
                            {Object.keys(DATA_WILAYAH_MAPPING).map(k=>
                                <option key={k} value={k}>{k}</option>
                            )}
                        </Select>
                        <Select label="Kelurahan" name="kelurahan" value={data.kelurahan} onChange={onChange} disabled={!data.kecamatan}>
                            <option value="">Pilih Kelurahan...</option>
                            {data.kecamatan && DATA_WILAYAH_MAPPING[data.kecamatan]?.map(k=>
                                <option key={k} value={k}>{k}</option>
                            )}
                        </Select>
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="RT" name="rt" value={data.rt} onChange={onChange} />
                            <Input label="RW" name="rw" value={data.rw} onChange={onChange} />
                        </div>
                    </div>
                </div>

                <Input label="Nama Orangtua / Wali" name="namaOrangtua" value={data.namaOrangtua} onChange={onChange} placeholder="Nama lengkap orangtua" uppercase={true} />
                <Input label="Nomor Kontak (HP/WA)" name="noKontakOrangtua" value={data.noKontakOrangtua} onChange={onChange} placeholder="0812XXXXXX" />
            </div>
        );

        const Step3 = ({ data, onChange, Icons }) => {
            const gejalaOptions = ['Batuk', 'Pilek', 'Mata Merah', 'Adenopathy', 'Arthralgia', 'Kehamilan', 'Lainnya'];
            
            return (
                <div className="animate-fadeIn">
                    <div className="mb-8">
                        <Label>Apakah demam?</Label>
                        <RadioGroup name="demam" options={['ya','tidak']} value={data.demam} onChange={onChange}/>
                        {data.demam==='ya' && (
                            <div className="mt-4">
                                <Input type="date" label="Tanggal Mulai Demam" name="tanggalMulaiDemam" value={data.tanggalMulaiDemam} onChange={onChange}/>
                            </div>
                        )}
                    </div>
                    
                    <div className="mb-8">
                        <Label>Apakah ruam?</Label>
                        <RadioGroup name="ruam" options={['ya','tidak']} value={data.ruam} onChange={onChange}/>
                        {data.ruam==='ya' && (
                            <div className="mt-4">
                                <Input type="date" label="Tanggal Mulai Ruam" name="tanggalMulaiRuam" value={data.tanggalMulaiRuam} onChange={onChange}/>
                            </div>
                        )}
                    </div>
                    
                    <div className="mb-8">
                        <Label>Gejala Lain</Label>
                        <div className="grid grid-cols-2 gap-3 mt-3">
                            {gejalaOptions.map(o=>
                                <Checkbox key={o} label={o} name="gejalaLain" value={o} checked={data.gejalaLain.includes(o)} onChange={onChange}/>
                            )}
                        </div>
                        {data.gejalaLain.includes('Lainnya') && (
                            <Input className="mt-4" placeholder="Sebutkan gejala lainnya..." name="gejalaLainSebutkan" value={data.gejalaLainSebutkan} onChange={onChange}/>
                        )}
                    </div>
                    
                    <div className="mb-8">
                        <Label>Komplikasi</Label>
                        <div className="grid grid-cols-2 gap-3 mt-3">
                            {DATA_KOMPLIKASI.map(o=>
                                <Checkbox key={o} label={o} name="komplikasi" value={o} checked={data.komplikasi?.includes(o)} onChange={onChange}/>
                            )}
                        </div>
                    </div>
                    
                    <div className="bg-slate-50 p-5 rounded-xl border border-slate-100">
                        <Label>Riwayat Rawat Inap</Label>
                        <RadioGroup name="dirawat" options={['ya','tidak']} value={data.dirawat} onChange={onChange}/>
                        {data.dirawat==='ya' && (
                            <div className="mt-5 space-y-4">
                                <Input label="Nama Rumah Sakit" name="namaRumahSakit" value={data.namaRumahSakit} onChange={onChange} placeholder="Nama rumah sakit"/>
                                <div className="grid grid-cols-2 gap-4">
                                    <Input label="Tanggal Masuk Rawat" type="date" name="tanggalMasukRawat" value={data.tanggalMasukRawat} onChange={onChange}/>
                                    <Input label="Tanggal Keluar Rawat" type="date" name="tanggalKeluarRawat" value={data.tanggalKeluarRawat} onChange={onChange}/>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Step4 = ({ data, onChange, Icons }) => (
            <div className="animate-fadeIn">
                <ImunisasiSection
                    label="Imunisasi Campak/Rubela Dosis 1"
                    name="imunisasiCampak1"
                    sourceName="sumberCampak1"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Imunisasi Campak/Rubela Dosis 2"
                    name="imunisasiCampak2"
                    sourceName="sumberCampak2"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Imunisasi Campak/Rubela saat BIAS"
                    name="imunisasiBIAS"
                    sourceName="sumberBIAS"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Pernah menerima imunisasi Measles Mumps Rubella (MMR) sebelumnya?"
                    name="imunisasiMMR"
                    sourceName="sumberMMR"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Pernah menerima imunisasi campak-rubela saat imunisasi tambahan Campak/Rubela?"
                    name="imunisasiTambahan"
                    sourceName="sumberTambahan"
                    data={data}
                    onChange={onChange}
                />
                
                <Input
                    label="Tanggal imunisasi campak-rubela terakhir"
                    type="date"
                    name="tanggalImunisasiTerakhir"
                    value={data.tanggalImunisasiTerakhir}
                    onChange={onChange}
                />
                
                <div className="mt-6">
                    <Label>Pemberian Vitamin A</Label>
                    <RadioGroup name="vitaminA" options={['Ya','Tidak']} value={data.vitaminA} onChange={onChange} />
                </div>
            </div>
        );

        // PERBAIKAN POINT 1: Step5 dengan fitur Pengumpulan Data Kontak Erat
        const Step5 = ({ data, onChange, Icons }) => {
            // Fungsi untuk menambah kontak erat
            const addKontakErat = () => {
                const newKontakErat = [...data.kontakErat, {
                    nama: '',
                    umur: '',
                    alamat: '',
                    hubungan: '',
                    imunisasiCampakRubella: '',
                    kondisi: ''
                }];
                onChange({ target: { name: 'kontakErat', value: newKontakErat } });
            };

            // Fungsi untuk menghapus kontak erat
            const removeKontakErat = (index) => {
                const newKontakErat = [...data.kontakErat];
                newKontakErat.splice(index, 1);
                onChange({ target: { name: 'kontakErat', value: newKontakErat } });
            };

            // Fungsi untuk mengubah kontak erat
            const handleKontakEratChange = (index, field, value) => {
                const newKontakErat = [...data.kontakErat];
                newKontakErat[index] = { ...newKontakErat[index], [field]: value };
                onChange({ target: { name: 'kontakErat', value: newKontakErat } });
            };

            return (
                <div className="animate-fadeIn">
                    <div className="mb-8">
                        <Label>Apakah ada kontak dengan kasus serupa?</Label>
                        <RadioGroup name="adaKontakSakitSama" options={['ya','tidak']} value={data.adaKontakSakitSama} onChange={onChange}/>
                        {data.adaKontakSakitSama === 'ya' && (
                            <div className="mt-4">
                                <Input label="Jumlah Kontak Sakit" name="jumlahKontakSakit" value={data.jumlahKontakSakit} onChange={onChange} placeholder="Misal: 3" />
                            </div>
                        )}
                    </div>
                    
                    <div className="mb-8">
                        <Label>Riwayat Bepergian</Label>
                        <RadioGroup name="bepergian" options={['ya','tidak']} value={data.bepergian} onChange={onChange}/>
                        {data.bepergian==='ya' && (
                            <div className="bg-slate-50 p-5 rounded-xl border border-slate-100 mt-5">
                                <Input label="Lokasi Bepergian" name="lokasiBepergian" value={data.lokasiBepergian} onChange={onChange} placeholder="Kota, provinsi, atau negara tujuan"/>
                                <div className="grid grid-cols-2 gap-4 mt-4">
                                    <Input label="Tanggal Pergi" type="date" name="tanggalPergi" value={data.tanggalPergi} onChange={onChange}/>
                                    <Input label="Tanggal Pulang" type="date" name="tanggalKembali" value={data.tanggalKembali} onChange={onChange}/>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* PERBAIKAN POINT 1: Bagian Pengumpulan Data Kontak Erat */}
                    <div className="mt-10 pt-6 border-t border-slate-200">
                        <div className="flex items-center justify-between mb-6">
                            <div>
                                <h3 className="text-lg font-bold text-slate-800">Data Kontak Erat</h3>
                                <p className="text-sm text-slate-500 mt-1">Silahkan tambah data kontak erat!</p>
                            </div>
                            <button
                                type="button"
                                onClick={addKontakErat}
                                className="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                            >
                                <Icons.UserPlus className="w-4 h-4" /> Tambah
                            </button>
                        </div>

                        {/* Daftar Kontak Erat */}
                        <div className="space-y-6 mb-8">
                            {data.kontakErat.map((kontak, index) => (
                                <div key={index} className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-5 rounded-xl relative">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                                                <Icons.User className="w-4 h-4" />
                                            </div>
                                            <h4 className="font-bold text-slate-800">Kontak Erat #{index + 1}</h4>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => removeKontakErat(index)}
                                            className="w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition"
                                        >
                                            <Icons.Trash className="w-4 h-4" />
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <Label>Nama</Label>
                                            <input
                                                type="text"
                                                value={kontak.nama}
                                                onChange={(e) => handleKontakEratChange(index, 'nama', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Nama lengkap"
                                            />
                                        </div>
                                        <div>
                                            <Label>Umur</Label>
                                            <input
                                                type="text"
                                                value={kontak.umur}
                                                onChange={(e) => handleKontakEratChange(index, 'umur', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Contoh: 2 tahun"
                                            />
                                        </div>
                                        <div className="md:col-span-2">
                                            <Label>Alamat</Label>
                                            <textarea
                                                value={kontak.alamat}
                                                onChange={(e) => handleKontakEratChange(index, 'alamat', e.target.value)}
                                                rows={2}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Alamat lengkap"
                                            />
                                        </div>
                                        <div>
                                            <Label>Hubungan</Label>
                                            <input
                                                type="text"
                                                value={kontak.hubungan}
                                                onChange={(e) => handleKontakEratChange(index, 'hubungan', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Contoh: Saudara, Teman Sekolah"
                                            />
                                        </div>
                                        <div>
                                            <Label>Imunisasi Campak/Rubella</Label>
                                            <select
                                                value={kontak.imunisasiCampakRubella}
                                                onChange={(e) => handleKontakEratChange(index, 'imunisasiCampakRubella', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                <option value="">Belum Pernah</option>
                                                <option value="1 Kali">1 Kali</option>
                                                <option value="2 Kali">2 Kali</option>
                                                <option value="3 Kali">3 Kali</option>
                                            </select>
                                        </div>
                                        <div>
                                            <Label>Kondisi</Label>
                                            <select
                                                value={kontak.kondisi}
                                                onChange={(e) => handleKontakEratChange(index, 'kondisi', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                <option value="">Pilih Kondisi</option>
                                                <option value="sehat">Sehat</option>
                                                <option value="sakit">Sakit</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Tombol Tambah di bawah kartu terakhir */}
                        {data.kontakErat.length > 0 && (
                            <div className="flex justify-center mt-2">
                                <button
                                    type="button"
                                    onClick={addKontakErat}
                                    className="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                                >
                                    <Icons.UserPlus className="w-4 h-4" /> Tambah Kontak Erat Lagi
                                </button>
                            </div>
                        )}

                        {/* Ringkasan Kontak Erat */}
                        {data.kontakErat.length > 0 && (
                            <div className="mt-8 bg-slate-50 p-5 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-slate-800 mb-3">Ringkasan Kontak Erat</h4>
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-600">Total Kontak Erat:</span>
                                        <span className="font-bold text-blue-600">{data.kontakErat.length} orang</span>
                                    </div>
                                    <div className="text-xs text-slate-500 space-y-1">
                                        {data.kontakErat.map((kontak, index) => (
                                            <div key={index} className="flex justify-between border-b border-slate-100 pb-1">
                                                <span>Kontak #{index + 1}: {kontak.nama || 'Tanpa Nama'}</span>
                                                <span className={`px-2 py-0.5 rounded text-xs ${kontak.kondisi === 'sakit' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                    {kontak.kondisi || 'Tidak diketahui'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Step6 = ({ data, onChange, getGeo, loadingGeo, onSaveToPending, onSaveAndFinal, Icons }) => (
            <div className="animate-fadeIn">
                <div className="mb-8">
                    <Label>Apakah spesimen darah diambil?</Label>
                    <RadioGroup name="spesimenDarah" options={['Ya', 'Tidak']} value={data.spesimenDarah} onChange={onChange} />
                    {data.spesimenDarah === 'Ya' && (
                        <div className="mt-4">
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Tanggal Pengambilan" type="date" name="tanggalAmbilDarah" value={data.tanggalAmbilDarah} onChange={onChange} />
                                <Input label="Tanggal Pengiriman" type="date" name="tanggalKirimDarah" value={data.tanggalKirimDarah} onChange={onChange} />
                            </div>
                            <div className="mt-4">
                                <Label>Jenis Sample Darah</Label>
                                <div className="grid grid-cols-2 gap-3 mt-2">
                                    {['Serum', 'Darah Lengkap'].map(o => (
                                        <Checkbox key={o} label={o} name="jenisSampleDarah" value={o} checked={data.jenisSampleDarah?.includes(o)} onChange={onChange} />
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                <div className="mb-8">
                    <Label>Apakah spesimen lain diambil?</Label>
                    <RadioGroup name="spesimenLain" options={['Ya', 'Tidak']} value={data.spesimenLain} onChange={onChange} />
                    {data.spesimenLain === 'Ya' && (
                        <div className="mt-4">
                            <Label>Jenis Sampel Lain</Label>
                            <div className="grid grid-cols-2 gap-3 mt-2 mb-4">
                                {['Urin', 'Swap Tenggorok', 'Lainnya'].map(o => (
                                    <Checkbox key={o} label={o} name="jenisSampelLain" value={o} checked={data.jenisSampelLain?.includes(o)} onChange={onChange} />
                                ))}
                            </div>
                            {data.jenisSampelLain?.includes('Lainnya') && (
                                <Input label="Sebutkan" name="jenisSampelLainSebutkan" value={data.jenisSampelLainSebutkan} onChange={onChange} />
                            )}
                            <div className="grid grid-cols-2 gap-4 mt-4">
                                <Input label="Tanggal Pengambilan" type="date" name="tanggalAmbilLain" value={data.tanggalAmbilLain} onChange={onChange} />
                                <Input label="Tanggal Pengiriman" type="date" name="tanggalKirimLain" value={data.tanggalKirimLain} onChange={onChange} />
                            </div>
                        </div>
                    )}
                </div>

                <div className="mb-8">
                    <Label>Keadaan saat ini</Label>
                    <RadioGroup name="keadaanSaatIni" options={['Hidup', 'Meninggal', 'Lost to Follow-Up']} value={data.keadaanSaatIni} onChange={onChange} />
                </div>

                <Input label="Pelaksana Investigasi" name="pelaksanaInvestigasi" value={data.pelaksanaInvestigasi} onChange={onChange} uppercase={true} />
                <Input label="Nama Sekolah (Jika penderita berusia sekolah)" name="namaSekolah" value={data.namaSekolah} onChange={onChange} uppercase={true} />

                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-6 rounded-xl">
                    <Label>Titik Lokasi Kasus</Label>
                    <div className="flex gap-3 mt-3">
                        <input 
                            name="titikLokasi"
                            className="w-full p-4 bg-white rounded-lg text-slate-800 font-mono shadow-sm border border-blue-100 outline-none focus:ring-2 focus:ring-blue-500 text-body"
                            value={data.titikLokasi} 
                            onChange={onChange} 
                            placeholder="Contoh: -0.026330, 109.342506" 
                        />
                        <button 
                            type="button"
                            onClick={getGeo} 
                            className="bg-gradient-to-r from-slate-800 to-slate-900 text-white px-6 rounded-lg shadow-lg hover:shadow-xl active:scale-95 transition flex items-center justify-center whitespace-nowrap min-w-[60px]"
                            disabled={loadingGeo}
                        >
                            {loadingGeo ? (
                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            ) : (
                                <Icons.MapPin className="w-5 h-5"/>
                            )}
                        </button>
                    </div>
                </div>

                <div className="mt-10 pt-6 border-t border-slate-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-4">Opsi Penyimpanan</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-200">
                            <div className="flex items-start mb-3">
                                <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <Icons.Hourglass className="w-5 h-5" />
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-800 mb-1">Simpan ke Pending Form</h4>
                                    <p className="text-sm text-slate-600">
                                        Formulir akan masuk ke <strong>Pending Form</strong>.
                                    </p>
                                </div>
                            </div>
                            <button 
                                type="button"
                                onClick={onSaveToPending}
                                className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 mt-2"
                            >
                                <Icons.Save className="w-4 h-4" /> Simpan ke Pending Form
                            </button>
                        </div>

                        <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-5 rounded-xl border border-green-200">
                            <div className="flex items-start mb-3">
                                <div className="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <Icons.CheckCircle className="w-5 h-5" />
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-800 mb-1">Simpan & Langsung Finalisasi</h4> <p className="text-sm text-slate-600">
                                        Formulir akan masuk ke <strong>Form Final</strong>.
                                    </p>
                                    
                                    
                                </div>
                            </div>
                            <button 
                                type="button"
                                onClick={onSaveAndFinal}
                                className="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center gap-2 mt-2"
                            >
                                <Icons.Check className="w-4 h-4" /> Simpan & Finalisasi
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const LoadingOverlay = () => (
            <div className="fixed inset-0 bg-slate-900/30 flex items-center justify-center z-50">
                <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-slate-700 font-bold">Memproses...</p>
                </div>
            </div>
        );

        const Toast = ({ notification }) => {
            if (!notification) return null;
            
            const bgColor = notification.type === 'success' ? 'bg-green-500' : 
                           notification.type === 'error' ? 'bg-red-500' : 
                           'bg-blue-500';
            
            return (
                <div className={`fixed top-6 right-6 ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-fadeIn`}>
                    <div className="flex items-center gap-3">
                        {notification.type === 'success' && <Icons.CheckCircle className="w-5 h-5" />}
                        {notification.type === 'error' && <Icons.XCircle className="w-5 h-5" />}
                        <span className="font-bold">{notification.msg}</span>
                    </div>
                </div>
            );
        };

        // BAGIAN 4: APP COMPONENT
        const App = () => {
            const [currentUser, setCurrentUser] = useState(sessionManager.load);
            const [view, setView] = useState(() => {
                const user = sessionManager.load();
                if (user) return user.role === 'admin' ? 'admin-dashboard' : 'start';
                return 'login';
            });

            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState(INITIAL_DATA);
            const [notification, setNotification] = useState(null);
            const [hasNewReceived, setHasNewReceived] = useState(false);

            // Modals & States
            const [showExitModal, setShowExitModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false); 
            const [showReviewModal, setShowReviewModal] = useState(false); 
            const [showTransferModal, setShowTransferModal] = useState(false);
            const [showViewModal, setShowViewModal] = useState(false);
            const [showAdminDeleteUserModal, setShowAdminDeleteUserModal] = useState(false);
            const [adminUserToDelete, setAdminUserToDelete] = useState(null);
            const [reviewItem, setReviewItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [itemToShare, setItemToShare] = useState(null); 
            const [itemToView, setItemToView] = useState(null);
            const [itemToTransfer, setItemToTransfer] = useState(null);
            
            const [showFinalizeModal, setShowFinalizeModal] = useState(false);
            const [itemToFinalize, setItemToFinalize] = useState(null);
            
            const [showRejectModal, setShowRejectModal] = useState(false);
            const [itemToReject, setItemToReject] = useState(null);
            
            const [showUnfinalizeModal, setShowUnfinalizeModal] = useState(false);
            const [itemToUnfinalize, setItemToUnfinalize] = useState(null);
            
            const [showEditEpidModal, setShowEditEpidModal] = useState(false);
            const [itemToEditEpid, setItemToEditEpid] = useState(null);
            const [newEpidNumber, setNewEpidNumber] = useState('');
            
            const [draftsList, setDraftsList] = useState([]);
            const [pendingList, setPendingList] = useState([]);
            const [formFinalList, setFormFinalList] = useState([]);
            const [outgoingList, setOutgoingList] = useState([]);
            const [receivedList, setReceivedList] = useState([]); 
            const [rejectedList, setRejectedList] = useState([]);
            
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const topRef = useRef(null);
            const [showLoadingOverlay, setShowLoadingOverlay] = useState(false);

            const showLoading = (show = true, minDelay = 300) => {
                if (show) {
                    setLoading(true);
                    setShowLoadingOverlay(true);
                } else {
                    setTimeout(() => {
                        setLoading(false);
                        setShowLoadingOverlay(false);
                    }, minDelay);
                }
            };

            const checkNewReceived = async () => {
                if (!currentUser) return;
                try {
                    const all = await mockDB.getAllForms();
                    const received = all.filter(i => 
                        i.sharedTo === currentUser.unitName && 
                        i.statusData === 'Proses' &&
                        i.createdUnit !== currentUser.unitName
                    );
                    setHasNewReceived(received.length > 0);
                } catch (e) {
                    console.error("Error checking new received:", e);
                }
            };

            useEffect(() => { 
                const init = async () => { 
                    await mockUserDB.checkAndCreateDefaultAdmin(); 
                    
                    if (view !== 'login' && !currentUser) {
                        setView('login'); 
                    }
                    
                    if (currentUser) {
                        console.log(`Current user: ${currentUser.name}, role: ${currentUser.role}, unit: ${currentUser.unitName}`);
                        
                        if (view === 'start') {
                            await checkNewReceived();
                        }
                        
                        if (['form-final', 'outgoing', 'inbox', 'drafts', 'pending', 'rejected'].includes(view)) {
                            console.log(`Loading data for view: ${view}`);
                            await loadDataForView();
                        }
                    }
                }; 
                init(); 
            }, [view, currentUser]);

            const loadDataForView = async () => {
                if (!currentUser) return;
                
                console.log(`Loading data for user: ${currentUser.username}, unit: ${currentUser.unitName}`);
                showLoading(true);
                try {
                    const allForms = await mockDB.getAllForms();
                    console.log(`Total forms loaded: ${allForms.length}`);
                    
                    // 1. Drafts
                    const drafts = allForms.filter(d => 
                        d.createdBy === currentUser.username && 
                        d.statusData === 'Draft'
                    );
                    console.log(`Drafts found: ${drafts.length}`);
                    setDraftsList(drafts);
                    
                    // 2. Pending Form
                    const pending = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isPendingStatus = i.statusData === 'Pending';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        return isPendingStatus && isOwnedByMe;
                    });
                    console.log(`Pending forms: ${pending.length}`);
                    setPendingList(pending);
                    
                    // 3. Form Final
                    const formFinal = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isFinalStatus = i.statusData === 'Final';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        return isFinalStatus && isOwnedByMe;
                    });
                    console.log(`Form Final: ${formFinal.length}`);
                    setFormFinalList(formFinal);
                    
                    // 4. Formulir Keluar
                    const outgoing = allForms.filter(i => {
                        const isCreatedByMe = i.createdBy === currentUser.username;
                        const hasBeenShared = i.sharedTo && i.sharedTo !== '';
                        const notToMyself = i.sharedTo !== currentUser.unitName;
                        
                        if (isCreatedByMe && hasBeenShared && notToMyself) {
                            const currentOwner = determineCurrentOwner(i);
                            
                            if ((i.statusData === 'Proses' || i.statusData === 'Ditolak') && 
                                currentOwner === currentUser.unitName) {
                                return true;
                            }
                        }
                        
                        return false;
                    });
                    console.log(`Outgoing forms: ${outgoing.length}`);
                    setOutgoingList(outgoing);
                    
                    // 5. Inbox
                    const received = allForms.filter(i => {
                        const isSharedToMe = i.sharedTo === currentUser.unitName;
                        const isInProcess = i.statusData === 'Proses';
                        const currentOwner = determineCurrentOwner(i);
                        
                        if (isSharedToMe && isInProcess && currentOwner !== currentUser.unitName) {
                            return true;
                        }
                        
                        return false;
                    });
                    console.log(`Inbox forms: ${received.length}`);
                    setReceivedList(received);
                    
                    // 6. Form Ditolak
                    const rejected = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isRejected = i.statusData === 'Ditolak';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        
                        return isRejected && isOwnedByMe;
                    });
                    console.log(`Rejected forms: ${rejected.length}`);
                    setRejectedList(rejected);
                    
                    setHasNewReceived(received.length > 0);
                    
                } catch (e) {
                    console.error("Error loading data:", e);
                    showNotification('Error memuat data: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            useEffect(() => { 
                if(view === 'form') window.scrollTo({ top: 0, behavior: 'smooth' }); 
            }, [step, view]);

            const handleLogin = async (e) => {
                e.preventDefault(); 
                showLoading(true);
                try {
                    const user = await mockUserDB.authenticate(username, password);
                    if (user) {
                        sessionManager.save(user); 
                        setCurrentUser(user);
                        if (user.role === 'admin') { 
                            setView('admin-dashboard'); 
                            showNotification('Welcome Admin', 'success'); 
                        } else { 
                            setView('start'); 
                            showNotification(`Halo, ${user.name}`, 'success'); 
                        }
                    } else { 
                        showNotification('Akun tidak ditemukan', 'error'); 
                    }
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const handleLogout = () => { 
                sessionManager.clear(); 
                setUsername(''); 
                setPassword(''); 
                setCurrentUser(null); 
                setView('login'); 
            };

            const handleStartNew = async () => { 
                const newId = Date.now().toString(); 
                setFormData({ 
                    ...INITIAL_DATA, 
                    id: newId, 
                    nomorEPID: '', 
                    createdBy: currentUser.username, 
                    createdUnit: currentUser.unitName,
                    originalUnit: currentUser.unitName,
                    currentOwner: currentUser.unitName,
                    epidManual: false,
                    transferHistory: []
                }); 
                setStep(1); 
                setView('form'); 
            };
            
            const handleEditForm = (item) => {
                console.log("Editing form:", item);
                
                const currentOwner = determineCurrentOwner(item);
                let canEdit = false;
                
                if (currentOwner === currentUser.unitName) {
                    canEdit = true;
                }
                
                if (!canEdit) {
                    showNotification('Anda tidak memiliki hak akses untuk mengedit formulir ini', 'error');
                    return;
                }
                
                const formDataToEdit = {
                    ...item,
                    updatedAt: Date.now()
                };
                
                showNotification('Formulir dibuka untuk diedit', 'success');
                setFormData(formDataToEdit);
                setStep(1); 
                setView('form'); 
            };
            
            const handleOpenDrafts = async () => { 
                await loadDataForView();
                setView('drafts'); 
            };
            
            const handleOpenPending = async () => { 
                await loadDataForView();
                setView('pending'); 
            };
            
            const handleOpenFormFinal = async () => { 
                await loadDataForView();
                setView('form-final'); 
            };
            
            const handleOpenOutgoing = async () => { 
                await loadDataForView();
                setView('outgoing'); 
            };
            
            const handleOpenInbox = async () => { 
                console.log("Opening inbox...");
                setHasNewReceived(false);
                await loadDataForView();
                setView('inbox');
                showNotification('Inbox dimuat', 'success');
            };

            const handleOpenRejected = async () => { 
                await loadDataForView();
                setView('rejected'); 
            };

            const handleShareForm = (item) => {
                setItemToShare(item);
                setShowShareModal(true);
            };

            const handleViewForm = (item) => {
                console.log("Opening view modal for item:", item);
                if (!item) {
                    showNotification('Data tidak ditemukan', 'error');
                    return;
                }
                setItemToView(item);
                setShowViewModal(true);
            };

            const handleCloseViewModal = () => {
                console.log("Closing view modal");
                setShowViewModal(false);
                setItemToView(null);
            };

            const handleTransferForm = (item) => {
                setItemToTransfer(item);
                setShowTransferModal(true);
            };

            const confirmShare = async (target) => {
                if (!target || target === currentUser.unitName) {
                    showNotification('Tidak dapat mengirim ke diri sendiri', 'error');
                    return;
                }
                
                showLoading(true);
                setShowShareModal(false);
                
                try {
                    const transferRecord = createTransferRecord(
                        'dikirim', 
                        currentUser.unitName, 
                        target
                    );
                    
                    const up = { 
                        ...itemToShare, 
                        statusData: 'Proses', 
                        sharedTo: target, 
                        updatedAt: Date.now(),
                        currentOwner: itemToShare.currentOwner || determineCurrentOwner(itemToShare),
                        transferHistory: [...(itemToShare.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setItemToShare(null);
                    showNotification(`Formulir dikirim ke ${target}`, 'success');
                } catch (e) {
                    console.error("Error sharing form:", e);
                    showNotification('Error mengirim formulir', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const confirmTransfer = async (target) => {
                if (!target || target === currentUser.unitName) {
                    showNotification('Tidak dapat meneruskan ke diri sendiri', 'error');
                    return;
                }
                
                showLoading(true);
                setShowTransferModal(false);
                
                try {
                    const transferRecord = createTransferRecord(
                        'diteruskan', 
                        currentUser.unitName, 
                        target
                    );
                    
                    const up = { 
                        ...itemToTransfer, 
                        statusData: 'Proses',
                        sharedTo: target,
                        updatedAt: Date.now(),
                        currentOwner: itemToTransfer.currentOwner || determineCurrentOwner(itemToTransfer),
                        transferHistory: [...(itemToTransfer.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setItemToTransfer(null);
                    showNotification(`Formulir diteruskan ke ${target}`, 'success');
                } catch (e) {
                    console.error("Error transferring form:", e);
                    showNotification('Error meneruskan formulir', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const handleAcceptTransfer = async (item) => { 
                showLoading(true); 
                try {
                    const transferRecord = createTransferRecord(
                        'diterima',
                        item.currentOwner || item.createdUnit,
                        currentUser.unitName,
                        currentUser.unitName
                    );
                    
                    const up = { 
                        ...item, 
                        statusData: 'Pending',
                        currentOwner: currentUser.unitName,
                        updatedAt: Date.now(),
                        transferHistory: [...(item.transferHistory || []), transferRecord]
                    }; 
                    
                    await mockDB.save(up); 
                    await loadDataForView();
                    setShowReviewModal(false); 
                    showNotification('Formulir diterima - Masuk ke menu Pending Form', 'success');
                } catch (e) {
                    console.error("Error accepting transfer:", e);
                    showNotification('Error menerima formulir', 'error');
                } finally {
                    showLoading(false); 
                }
            };
            
            const handleRejectTransfer = (item) => { 
                setItemToReject(item);
                setShowRejectModal(true);
            };
            
            const confirmRejectTransfer = async () => {
                if (!itemToReject) return;
                
                showLoading(true); 
                try {
                    const transferRecord = createTransferRecord(
                        'ditolak',
                        currentUser.unitName,
                        itemToReject.currentOwner || itemToReject.createdUnit
                    );
                    
                    const up = { 
                        ...itemToReject, 
                        statusData: 'Ditolak', 
                        currentOwner: itemToReject.currentOwner || determineCurrentOwner(itemToReject),
                        updatedAt: Date.now(),
                        transferHistory: [...(itemToReject.transferHistory || []), transferRecord]
                    }; 
                    
                    await mockDB.save(up); 
                    await loadDataForView();
                    setShowRejectModal(false); 
                    setItemToReject(null);
                    showNotification('Formulir ditolak - Kembali ke pengirim', 'error');
                } catch (e) {
                    console.error("Error rejecting transfer:", e);
                    showNotification('Error menolak formulir', 'error');
                } finally {
                    showLoading(false); 
                }
            };

            const handleFinalizeFromPending = (item) => {
                setItemToFinalize(item);
                setShowFinalizeModal(true);
            };

            const confirmFinalize = async () => {
                if (!itemToFinalize) return;
                
                showLoading(true); 
                try {
                    let finalData = { ...itemToFinalize };
                    
                    // PERBAIKAN POINT 3: Tidak ada lagi generate otomatis
                    if (finalData.nomorEPID) {
                        finalData.epidManual = true;
                    }
                    
                    finalData.updatedAt = Date.now();
                    finalData.statusData = 'Final';
                    finalData.sharedTo = '';
                    finalData.currentOwner = finalData.currentOwner || finalData.createdUnit;
                    
                    await mockDB.save(finalData); 
                    await loadDataForView();
                    setShowFinalizeModal(false);
                    setItemToFinalize(null);
                    showNotification('Formulir berhasil difinalkan!', 'success');
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error menyimpan: ' + e.message, 'error'); 
                } finally {
                    showLoading(false);
                }
            };

            const handleUnfinalizeForm = (item) => {
                setItemToUnfinalize(item);
                setShowUnfinalizeModal(true);
            };

            const confirmUnfinalize = async () => {
                if (!itemToUnfinalize) return;
                
                showLoading(true);
                try {
                    const currentOwner = determineCurrentOwner(itemToUnfinalize);
                    
                    const transferRecord = createTransferRecord(
                        'dibatalkan_finalisasi',
                        'admin',
                        currentOwner
                    );
                    
                    const up = {
                        ...itemToUnfinalize,
                        statusData: 'Pending',
                        updatedAt: Date.now(),
                        currentOwner: currentOwner,
                        transferHistory: [...(itemToUnfinalize.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setShowUnfinalizeModal(false);
                    setItemToUnfinalize(null);
                    showNotification('Formulir berhasil dibatalkan finalisasi! Kembali ke Pending Form ' + currentOwner, 'success');
                } catch (e) {
                    console.error("Error unfinalizing form:", e);
                    showNotification('Error membatalkan finalisasi: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            const handleEditEpidForm = (item) => {
                setItemToEditEpid(item);
                setNewEpidNumber(item.nomorEPID || '');
                setShowEditEpidModal(true);
            };

            const confirmEditEpid = async () => {
                if (!itemToEditEpid) return;
                
                const validation = validateManualEPID(newEpidNumber);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
                
                showLoading(true);
                try {
                    const up = {
                        ...itemToEditEpid,
                        nomorEPID: newEpidNumber,
                        epidManual: true,
                        updatedAt: Date.now()
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setShowEditEpidModal(false);
                    setItemToEditEpid(null);
                    setNewEpidNumber('');
                    showNotification('Nomor EPID berhasil diubah!', 'success');
                } catch (e) {
                    console.error("Error editing EPID:", e);
                    showNotification('Error mengubah nomor EPID: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            const handleResumeDraft = (d) => { 
                setFormData(d); 
                setStep(1); 
                setView('form'); 
            };
            
            const handleExportMyData = () => { 
                if (formFinalList.length===0) {
                    showNotification('Tidak ada data untuk diexport', 'error'); 
                    return;
                }
                
                const enhancedData = formFinalList.map(item => {
                    const currentOwner = determineCurrentOwner(item);
                    return {
                        ...item,
                        currentOwner: currentOwner
                    };
                });
                
                exportToCSV(enhancedData, `Epid_${currentUser.unitName}_${new Date().toISOString().split('T')[0]}.csv`); 
            };
            
            const handleOpenReview = (i) => { 
                setReviewItem(i); 
                setShowReviewModal(true); 
            };
            
            const handleBackToStart = () => setShowExitModal(true);
            
            const handleConfirmExit = (act) => { 
                setShowExitModal(false); 
                if (act === 'save') { 
                    handleSaveDraft(); 
                    setTimeout(() => setView('start'), 1000); 
                } else if (act === 'discard') setView('start'); 
            };
            
            const confirmDelete = (i) => { 
                setItemToDelete(i); 
                setShowDeleteModal(true); 
            };
            
            const handleDeleteForm = async () => { 
                if (itemToDelete && currentUser?.role === 'admin') { 
                    showLoading(true);
                    try {
                        await mockDB.delete(itemToDelete.id); 
                        await loadDataForView();
                        setShowDeleteModal(false); 
                        showNotification('Formulir dihapus', 'success');
                    } catch (e) {
                        console.error("Error deleting form:", e);
                        showNotification('Error menghapus formulir', 'error');
                    } finally {
                        showLoading(false);
                    }
                } else {
                    showNotification('Hanya admin yang dapat menghapus formulir', 'error');
                }
            };

            const handleChange = (e) => { 
                const { name, value, type, checked } = e.target; 
                
                let processedValue = value;
                if (name === 'namaKasus' || name === 'namaOrangtua' || name === 'pelaksanaInvestigasi' || name === 'namaSekolah') {
                    processedValue = value.toUpperCase();
                }
                
                if (name === 'noKontakOrangtua') {
                    processedValue = value.replace(/\D/g, '');
                }
                
                if (name === 'nomorEPID') {
                    processedValue = value.toUpperCase();
                }
                
                if (type === 'checkbox') { 
                    if (['gejalaLain', 'komplikasi', 'jenisSampleDarah', 'jenisSampelLain'].some(k => name.includes(k))) { 
                        setFormData(prev => { 
                            const cur = prev[name] || []; 
                            const nv = checked ? [...cur, value] : cur.filter(v => v !== value); 
                            return { ...prev, [name]: nv }; 
                        }); 
                    } else { 
                        setFormData(prev => ({ ...prev, [name]: checked })); 
                    } 
                } else if (type === 'radio') {
                    if (name.includes('sumber')) {
                        setFormData(prev => ({ ...prev, [name]: value }));
                    } else {
                        setFormData(prev => ({ ...prev, [name]: processedValue }));
                    }
                } else { 
                    setFormData(prev => ({ ...prev, [name]: processedValue })); 
                } 
            };
            
            const handleKecamatanChange = (e) => { 
                const v = e.target.value; 
                setFormData(p => ({ ...p, kecamatan: v, kelurahan: '' })); 
            };
            
            const handleSumberLaporanChange = (e) => { 
                const v = e.target.value; 
                setFormData(p => ({ ...p, sumberLaporan: v, namaUnitPelapor: '', sumberLainnya: '' })); 
            };
            
            const getGeoLocation = () => { 
                showLoading(true); 
                navigator.geolocation.getCurrentPosition( 
                    (p) => { 
                        setFormData(pr => ({ ...pr, titikLokasi: `${p.coords.latitude}, ${p.coords.longitude}` })); 
                        showLoading(false); 
                        showNotification('Koordinat berhasil direkam', 'success');
                    }, 
                    (e) => { 
                        showLoading(false); 
                        showNotification('GPS Error: ' + e.message, 'error'); 
                    } 
                ); 
            };
            
            const handleSaveDraft = async () => { 
                showLoading(true); 
                try { 
                    const d = { 
                        ...formData, 
                        statusData: 'Draft', 
                        updatedAt: Date.now(), 
                        createdBy: currentUser?.username, 
                        createdUnit: currentUser?.unitName,
                        originalUnit: currentUser?.unitName,
                        currentOwner: formData.currentOwner || currentUser?.unitName
                    }; 
                    
                    await mockDB.save(d); 
                    setFormData(d); 
                    showLoading(false); 
                    showNotification('Draft tersimpan', 'success'); 
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error Save: ' + e.message, 'error'); 
                } 
            };
            
            const handleSaveToPending = async () => { 
                if (!formData.namaKasus) { 
                    showNotification('Nama Kasus wajib!', 'error'); 
                    return; 
                } 
                
                // PERBAIKAN POINT 3: Validasi nomor EPID
                if (!formData.nomorEPID) {
                    showNotification('Nomor EPID wajib diisi!', 'error');
                    return;
                }
                
                showLoading(true); 
                try { 
                    const d = { 
                        ...formData, 
                        statusData: 'Pending',
                        updatedAt: Date.now(), 
                        createdBy: currentUser?.username, 
                        createdUnit: currentUser?.unitName,
                        originalUnit: currentUser?.unitName,
                        currentOwner: currentUser?.unitName
                    }; 
                    
                    await mockDB.save(d); 
                    setFormData(d); 
                    showLoading(false); 
                    showNotification('Formulir disimpan ke Pending Form', 'success');
                    
                    setTimeout(() => {
                        setView('pending'); 
                    }, 1000);
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error Save: ' + e.message, 'error'); 
                } 
            };
            
            const handleSaveAndFinal = async () => {
                if (!formData.namaKasus) { 
                    showNotification('Nama Kasus wajib!', 'error'); 
                    return; 
                } 
                
                if (!formData.tanggalLahir) {
                    showNotification('Tanggal Lahir wajib!', 'error');
                    return;
                }
                
                if (!formData.kecamatan || !formData.kelurahan) {
                    showNotification('Kecamatan dan Kelurahan wajib!', 'error');
                    return;
                }
                
                // PERBAIKAN POINT 3: Validasi nomor EPID
                if (!formData.nomorEPID) {
                    showNotification('Nomor EPID wajib diisi!', 'error');
                    return;
                }
                
                showLoading(true); 
                try { 
                    let finalData = { ...formData };
                    
                    // PERBAIKAN POINT 3: Tidak ada lagi generate otomatis
                    if (finalData.nomorEPID) {
                        finalData.epidManual = true;
                    }
                    
                    finalData.updatedAt = Date.now();
                    finalData.statusData = 'Final';
                    finalData.sharedTo = '';
                    finalData.currentOwner = finalData.currentOwner || finalData.createdUnit;
                    
                    await mockDB.save(finalData); 
                    setFormData(finalData); 
                    showLoading(false); 
                    
                    showNotification('Formulir berhasil difinalkan!', 'success');
                    
                    setTimeout(() => {
                        setView('success'); 
                    }, 500);
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error menyimpan: ' + e.message, 'error'); 
                } 
            };
            
            const showNotification = (msg, type) => { 
                setNotification({ msg, type }); 
                setTimeout(() => setNotification(null), 3000); 
            };
            
            const nextStep = () => {
                setStep(p => Math.min(p + 1, 6));
                // PERBAIKAN POINT 2: Scroll ke pertanyaan teratas
                setTimeout(() => {
                    if (topRef.current) {
                        topRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 50);
            };
            
            const prevStep = () => {
                setStep(p => Math.max(p - 1, 1));
                setTimeout(() => {
                    if (topRef.current) {
                        topRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 50);
            };

            const STEP_LABELS = [
                { id: 1, label: 'Laporan', icon: Icons.FileText }, 
                { id: 2, label: 'Kasus', icon: Icons.User }, 
                { id: 3, label: 'Klinis', icon: Icons.Thermometer }, 
                { id: 4, label: 'Imunisasi', icon: Icons.Shield }, 
                { id: 5, label: 'Kontak', icon: Icons.Plane }, 
                { id: 6, label: 'Spesimen', icon: Icons.Syringe }
            ];
                                        
            const renderCurrentView = () => {
                if (view === 'login') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-gradient-to-br from-slate-900 to-slate-800 overflow-y-auto">
                        <div className="min-h-full flex items-center justify-center p-6 relative z-10">
                            <div className="w-full max-w-sm bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl">
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-500 to-indigo-500 shadow-lg shadow-blue-500/40 mb-4">
                                        <Icons.Shield className="w-8 h-8 text-white" />
                                    </div>
                                    <h1 className="text-3xl font-black text-white mb-2 tracking-tight">Surveilans Campak/Rubella</h1>
                                    <p className="text-slate-300 text-body font-medium">Masuk untuk melanjutkan</p>
                                </div>
                                
                                <form onSubmit={handleLogin} className="space-y-5">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-300 mb-2 text-caption">Username</label>
                                        <div className="bg-white/10 rounded-xl p-1 flex items-center border border-white/20 focus-within:border-blue-400 transition">
                                            <div className="p-3 text-slate-400"><Icons.User className="w-5 h-5"/></div>
                                            <input 
                                                type="text" 
                                                value={username} 
                                                onChange={e=>setUsername(e.target.value)} 
                                                placeholder="Masukkan username" 
                                                className="bg-transparent w-full p-2 text-white placeholder-slate-500 outline-none font-medium text-body" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-300 mb-2 text-caption">Password</label>
                                        <div className="bg-white/10 rounded-xl p-1 flex items-center border border-white/20 focus-within:border-blue-400 transition">
                                            <div className="p-3 text-slate-400"><Icons.Lock className="w-5 h-5"/></div>
                                            <input 
                                                type="password" 
                                                value={password} 
                                                onChange={e=>setPassword(e.target.value)} 
                                                placeholder="Masukkan password" 
                                                className="bg-transparent w-full p-2 text-white placeholder-slate-500 outline-none font-medium text-body" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <button className="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:shadow-blue-500/30 transition-all active:scale-[0.98] text-subtitle mt-6">
                                        Masuk Sekarang
                                    </button>
                                </form>
                                
                                <div className="mt-8 text-center">
                                    <p className="text-[11px] font-bold text-slate-500 uppercase tracking-widest text-micro">by UPT Puskesmas Kampung Dalam</p>
                                </div>
                            </div>
                        </div>
                        {showLoadingOverlay && <LoadingOverlay />} 
                        <Toast notification={notification} />
                    </div>
                );

                if (view === 'admin-dashboard') return <AdminDashboard 
                    currentUser={currentUser} 
                    onLogout={handleLogout} 
                    mockDB={mockDB} 
                    mockUserDB={mockUserDB} 
                    showNotification={showNotification} 
                    exportToCSV={exportToCSV} 
                    loadDataForView={loadDataForView} 
                    ALL_SERVICES={ALL_SERVICES}
                    onViewForm={handleViewForm}
                    onUnfinalizeForm={handleUnfinalizeForm}
                    onEditEpidForm={handleEditEpidForm}
                    showAdminDeleteUserModal={showAdminDeleteUserModal}
                    setShowAdminDeleteUserModal={setShowAdminDeleteUserModal}
                    adminUserToDelete={adminUserToDelete}
                    setAdminUserToDelete={setAdminUserToDelete}
                    rejectedList={rejectedList}
                />;

                if (view === 'start') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                        <div className="p-6 pt-8 bg-white pb-6 rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <p className="text-slate-500 text-sm font-semibold uppercase tracking-wider mb-1 text-micro">Selamat datang,</p>
                                    <h1 className="text-2xl font-bold text-slate-800 tracking-tight">{currentUser?.name || 'Pengguna'}</h1>
                                    <div className="flex items-center gap-1 mt-2 text-blue-600 font-medium text-caption">
                                        <Icons.MapPin className="w-3.5 h-3.5"/> 
                                        {currentUser?.unitName}
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition">
                                    <Icons.LogOut className="w-5 h-5"/>
                                </button>
                            </div>
                            
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                                <p className="text-slate-700 font-medium text-caption">Sistem ini dikembangkan oleh UPT Puskesmas Kampung Dalam</p>
                                <p className="text-slate-900 font-bold text-subtitle">Sistem Epidemiologi Campak</p>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={handleStartNew} className="col-span-2 bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl shadow-blue-500/30 flex items-center justify-between group active:scale-[0.98] transition-all">
                                    <div className="text-left">
                                        <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mb-3 text-white">
                                            <Icons.FileText className="w-6 h-6"/>
                                        </div>
                                        <h3 className="font-bold text-lg tracking-tight">Buat Laporan Baru</h3>
                                        <p className="text-blue-100 text-body font-medium">Input kasus surveilans baru</p>
                                    </div>
                                    <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                        <Icons.ChevronLeft className="rotate-180 w-5 h-5"/>
                                    </div>
                                </button>

                                <button onClick={handleOpenDrafts} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-orange-50 text-orange-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.List className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Draft Tersimpan</h3>
                                    <p className="text-slate-500 text-caption mt-1">Lanjutkan Editing Formulir</p>
                                    {draftsList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {draftsList.length}
                                        </div>
                                    )}
                                </button>
                                
                                <button onClick={handleOpenPending} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Hourglass className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Pending Form</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir dalam verifikasi</p>
                                    {pendingList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-amber-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {pendingList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenFormFinal} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Archive className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Final</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir yang difinalisasi</p>
                                    {formFinalList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-emerald-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {formFinalList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenOutgoing} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Send className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Keluar</h3>
                                    <p className="text-slate-500 text-caption mt-1">Proses Pengiriman Formulir</p>
                                    {outgoingList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-indigo-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {outgoingList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenInbox} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative overflow-hidden group">
                                    <div className="w-10 h-10 bg-rose-50 text-rose-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Inbox className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Inbox</h3>
                                    <p className="text-slate-500 text-caption mt-1">Penerimaan formulir</p>
                                    {hasNewReceived && (
                                        <div className="absolute top-4 right-4">
                                            <div className="w-3 h-3 bg-rose-500 rounded-full animate-ping"></div>
                                            <div className="absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full"></div>
                                        </div>
                                    )}
                                    {receivedList.length > 0 && !hasNewReceived && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-rose-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {receivedList.length}
                                        </div>
                                    )}
                                </button>
                                
                                <button onClick={handleOpenRejected} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-red-50 text-red-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.XOctagon className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Ditolak</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir yang ditolak</p>
                                    {rejectedList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {rejectedList.length}
                                        </div>
                                    )}
                                </button>
                            </div>
                            
                            <div className="mt-10 text-center">
                                <p className="text-slate-300 text-xs font-bold uppercase tracking-[0.2em] text-micro">Roli Surveilans v1.0</p>
                            </div>
                        </div>
                        
                        {showLoadingOverlay && <LoadingOverlay />} 
                        <Toast notification={notification} />
                    </div>
                );

                if (view === 'form') {
                    const progressPercent = ((step - 1) / (STEP_LABELS.length - 1)) * 100;
                    
                    return (
                        <div className="fixed inset-0 h-[100dvh] w-full flex flex-col bg-slate-50 overflow-hidden" ref={topRef}>
                            <div className="flex-none z-50 px-4 py-4 bg-white/90 backdrop-blur-sm border-b border-slate-100 shadow-sm">
                                <div className="max-w-3xl mx-auto">
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="flex items-center gap-2">
                                            <button onClick={step === 1 ? handleBackToStart : prevStep} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm hover:shadow-md active:scale-90 transition">
                                                {step === 1 ? (
                                                    <Icons.Home className="w-5 h-5" />
                                                ) : (
                                                    <Icons.ChevronLeft className="w-5 h-5" />
                                                )}
                                            </button>
                                            {step > 1 && (
                                                <button onClick={handleBackToStart} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm hover:shadow-md active:scale-90 transition" title="Kembali ke Menu Utama">
                                                    <Icons.Home className="w-5 h-5" />
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="flex flex-col items-center">
                                            <span className="text-[11px] font-bold text-blue-600 uppercase tracking-wider mb-0.5 text-micro">
                                                Langkah {step} dari 6
                                            </span>
                                            <h2 className="text-lg font-bold text-slate-800 tracking-tight">
                                                {STEP_LABELS[step-1].label}
                                            </h2>
                                        </div>

                                        {step < 6 ? (
                                            <button onClick={nextStep} className="h-10 px-5 rounded-full bg-slate-900 text-white text-sm font-bold shadow-md hover:shadow-lg active:scale-90 transition flex items-center gap-2">
                                                Lanjut <Icons.ChevronLeft className="rotate-180 w-3.5 h-3.5"/>
                                            </button>
                                        ) : (
                                            <div className="w-20"></div>
                                        )}
                                    </div>
                                    
                                    <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-500 ease-out" style={{ width: `${progressPercent}%` }}></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 pb-32 scroll-smooth">
                                <div className="max-w-3xl mx-auto animate-fadeIn">
                                    <Card className="min-h-[60vh]">
                                        <div className="flex justify-between items-start mb-8">
                                            <div>
                                                <h3 className="font-bold text-2xl text-slate-800 mb-2 tracking-tight">
                                                    {STEP_LABELS[step-1].label}
                                                </h3>
                                                <p className="text-slate-500 text-body font-medium">
                                                    Lengkapi data berikut dengan benar dan teliti.
                                                </p>
                                            </div>
                                            <button onClick={handleSaveDraft} className="text-blue-600 bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-100 transition flex items-center gap-2 border border-blue-100">
                                                <Icons.Save className="w-4 h-4"/> Draft
                                            </button>
                                        </div>

                                        {step === 1 && <Step1 data={formData} onChange={handleChange} onSumberChange={handleSumberLaporanChange} Icons={Icons} />}
                                        {step === 2 && <Step2 data={formData} onChange={handleChange} onChangeKecamatan={handleKecamatanChange} Icons={Icons} />}
                                        {step === 3 && <Step3 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 4 && <Step4 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 5 && <Step5 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 6 && <Step6 
                                            data={formData} 
                                            onChange={handleChange} 
                                            getGeo={getGeoLocation} 
                                            loadingGeo={loading} 
                                            onSaveToPending={handleSaveToPending}
                                            onSaveAndFinal={handleSaveAndFinal}
                                            Icons={Icons} 
                                        />}
                                    </Card>
                                </div>
                            </div>

                            {showExitModal && <ExitConfirmationModal onSave={() => handleConfirmExit('save')} onDiscard={() => handleConfirmExit('discard')} onCancel={() => setShowExitModal(false)} />} 
                            {showLoadingOverlay && <LoadingOverlay />} 
                            <Toast notification={notification} />
                        </div>
                    );
                }
                
                if (view === 'drafts') return (
                    <ListView 
                        title="Draft Tersimpan" 
                        data={draftsList} 
                        type="draft" 
                        onBack={() => setView('start')} 
                        onAction={handleResumeDraft} 
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        notification={notification} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        currentUser={currentUser}
                        count={draftsList.length}
                    />
                );
                
                if (view === 'pending') return (
                    <PendingListView 
                        title="Pending Form" 
                        data={pendingList} 
                        type="pending" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onEdit={handleEditForm}
                        onFinalize={handleFinalizeFromPending}
                        onShare={handleShareForm}
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        showShareModal={showShareModal} 
                        setShowShareModal={setShowShareModal} 
                        confirmShare={confirmShare} 
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={pendingList.length}
                    />
                );
                
                if (view === 'form-final') return (
                    <FormFinalListView 
                        title="Form Final" 
                        data={formFinalList} 
                        type="form-final" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onExport={handleExportMyData} 
                        Icons={Icons} 
                        notification={notification} 
                        currentUser={currentUser}
                        count={formFinalList.length}
                    />
                );
                
                if (view === 'outgoing') return (
                    <OutgoingListView 
                        title="Formulir Keluar" 
                        data={outgoingList} 
                        type="outgoing" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        Icons={Icons} 
                        notification={notification} 
                        currentUser={currentUser}
                        count={outgoingList.length}
                    />
                );
                
                if (view === 'inbox') return (
                    <InboxListView 
                        title="Inbox" 
                        data={receivedList} 
                        type="inbox" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm} 
                        onAccept={handleAcceptTransfer} 
                        onReject={handleRejectTransfer}
                        onTransfer={handleTransferForm}
                        Icons={Icons} 
                        showReviewModal={showReviewModal} 
                        reviewItem={reviewItem} 
                        setShowReviewModal={setShowReviewModal} 
                        setReviewItem={setReviewItem} 
                        showTransferModal={showTransferModal}
                        setShowTransferModal={setShowTransferModal}
                        confirmTransfer={confirmTransfer}
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={receivedList.length}
                        showRejectModal={showRejectModal}
                        setShowRejectModal={setShowRejectModal}
                        confirmRejectTransfer={confirmRejectTransfer}
                    />
                );

                if (view === 'rejected') return (
                    <RejectedListView 
                        title="Form Ditolak" 
                        data={rejectedList} 
                        type="rejected" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onEdit={handleEditForm}
                        onShare={handleShareForm}
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        showShareModal={showShareModal} 
                        setShowShareModal={setShowShareModal} 
                        confirmShare={confirmShare} 
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={rejectedList.length}
                    />
                );

                if (view === 'success') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-white flex items-center justify-center p-6">
                        <div className="text-center w-full max-w-sm animate-fadeIn">
                            <div className="w-24 h-24 bg-gradient-to-br from-green-50 to-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-green-100">
                                <Icons.CheckCircle className="w-12 h-12 text-green-500" />
                            </div>
                            <h2 className="text-3xl font-black text-slate-800 mb-3 tracking-tight">Berhasil Disimpan!</h2>
                            <p className="text-slate-500 mb-8 font-medium text-body">Data surveilans telah tersimpan dengan aman.</p>
                            
                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-100 mb-8">
                                <p className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 text-micro">Nomor EPID</p>
                                <p className="text-2xl font-mono font-bold text-slate-800 tracking-tight">{formData.nomorEPID}</p>
                                <p className="text-sm text-slate-500 mt-2">
                                    {formData.epidManual ? '(EPID Manual)' : '(EPID Otomatis)'}
                                </p>
                            </div>
                            
                            <button onClick={() => setView('start')} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:shadow-slate-900/20 active:scale-95 transition text-subtitle">
                                Kembali ke Menu Utama
                            </button>
                        </div>
                    </div>
                );

                return (
                    <div className="fixed inset-0 bg-slate-900 text-white flex items-center justify-center">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold mb-4">Terjadi Kesalahan</h1>
                            <p>View tidak ditemukan: {view}</p>
                            <button onClick={() => setView('start')} className="mt-4 px-4 py-2 bg-blue-600 rounded-lg">
                                Kembali ke Start
                            </button>
                        </div>
                    </div>
                );
            };

            const StableLoadingOverlay = () => (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center min-w-[200px] min-h-[200px] justify-center">
                        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-slate-700 font-bold">Memproses...</p>
                        <p className="text-slate-500 text-sm mt-2">Harap tunggu sebentar</p>
                    </div>
                </div>
            );

            return (
                <div id="root">
                    {renderCurrentView()}
                    
                    {showViewModal && (
                        <ViewModal 
                            item={itemToView} 
                            onClose={() => {
                                console.log("Closing view modal");
                                setShowViewModal(false);
                                setItemToView(null);
                            }} 
                            Icons={Icons} 
                        />
                    )}
                    
                    {showEditEpidModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.Edit className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-blue-600">Edit Nomor EPID</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Formulir: <strong>{itemToEditEpid?.namaKasus || 'Tanpa Nama'}</strong>
                                </p>
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold text-slate-600 mb-2">Nomor EPID Baru</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-center"
                                        value={newEpidNumber}
                                        onChange={(e) => setNewEpidNumber(e.target.value.toUpperCase())}
                                        placeholder="Masukkan nomor EPID (bebas)"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">Bebas mengisi nomor EPID</p>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowEditEpidModal(false);
                                            setItemToEditEpid(null);
                                            setNewEpidNumber('');
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmEditEpid} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Simpan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showFinalizeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.CheckCircle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-green-600">Finalisasi Formulir?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Apakah Anda yakin data ini sudah valid dan ingin difinalisasi?
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowFinalizeModal(false);
                                            setItemToFinalize(null);
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmFinalize} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Finalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showUnfinalizeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-amber-600">Batalkan Finalisasi?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Formulir akan dikembalikan ke Pending Form current owner.
                                </p>
                                <div className="mb-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                                    <p className="text-sm text-amber-700 font-medium">
                                        Status: <strong>Pending</strong><br/>
                                        Current Owner: <strong>{itemToUnfinalize ? determineCurrentOwner(itemToUnfinalize) : ''}</strong>
                                    </p>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowUnfinalizeModal(false);
                                            setItemToUnfinalize(null);
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmUnfinalize} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Batalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showTransferModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmTransfer} onCancel={() => setShowTransferModal(false)} />}
                    
                    {showRejectModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Tolak Formulir?</h3>
                                <p className="text-slate-500 mb-6 text-body">Formulir akan dikembalikan ke pengirim dengan status "Ditolak".</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowRejectModal(false)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={confirmRejectTransfer} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Tolak
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showLoadingOverlay && <StableLoadingOverlay />}
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        // BAGIAN 5: KOMPONEN LIST VIEW
        const ListView = ({ title, data, type, onBack, onAction, onDelete, Icons, notification, showDeleteModal, setShowDeleteModal, handleDelete, currentUser, count }) => (
            <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                    <div className="flex items-center justify-between mb-6">
                        <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                            <Icons.ChevronLeft className="w-5 h-5"/>
                        </button>
                        <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-blue-600 text-sm">({count})</span></h2>
                        <div className="w-10"></div>
                    </div>
                </div>
                
                <div className="flex-1 overflow-y-auto p-6 pb-24">
                    {data.length === 0 ? (
                        <div className="text-center text-slate-400 py-20 font-medium italic">
                            Tidak ada data untuk ditampilkan
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {data.map(item => (
                                <div key={item.id} className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                            {item.nomorEPID || 'DRAFT'}
                                        </div>
                                        <div className="text-xs text-slate-500 font-medium">
                                            {new Date(item.updatedAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    
                                    <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                    <p className="text-sm text-slate-600 font-medium mb-1">
                                        {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                    </p>
                                    <p className="text-sm text-slate-500 mb-5">
                                        {item.kelurahan || 'Lokasi tidak diketahui'}
                                    </p>
                                    
                                    <div className="flex gap-2 border-t border-slate-100 pt-4">
                                        <button onClick={() => onAction(item)} className="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition">
                                            Edit Draft
                                        </button>
                                        {currentUser?.role === 'admin' && (
                                            <button onClick={() => onDelete(item)} className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100">
                                                <Icons.Trash className="w-4.5 h-4.5"/>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                
                {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                <Toast notification={notification} />
            </div>
        );

        const PendingListView = ({ title, data, type, onBack, onView, onEdit, onFinalize, onShare, onDelete, Icons, showDeleteModal, setShowDeleteModal, handleDelete, showShareModal, setShowShareModal, confirmShare, notification, loading, ALL_SERVICES, currentUser, count }) => {
            const getStatusBadge = (status, isFromOtherUnit = false) => {
                const statusColors = {
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Draft': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200'
                };
                
                const color = statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                const fromOtherBadge = isFromOtherUnit ? 'bg-purple-100 text-purple-800 ml-1 border border-purple-200' : '';
                
                return (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`status-badge ${color}`}>
                            {status}
                        </span>
                        {isFromOtherUnit && (
                            <span className={`status-badge ${fromOtherBadge}`}>
                                Eksternal
                            </span>
                        )}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-amber-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                    const currentOwner = determineCurrentOwner(item);
                                    const isCurrentOwner = currentOwner === currentUser.unitName;
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData, isFromOtherUnit)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                {isFromOtherUnit && (
                                                    <span className="block text-xs text-purple-600 mt-1 font-semibold">
                                                        Dari: {item.createdUnit}
                                                    </span>
                                                )}
                                                <span className="block text-xs text-green-600 mt-1">
                                                    Current Owner: {currentOwner}
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onEdit(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 border border-blue-100 hover:border-blue-200 hover:bg-blue-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Edit className="w-4 h-4"/> Edit
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onFinalize(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-green-50 to-emerald-50 text-green-600 border border-green-100 hover:border-green-200 hover:bg-green-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Check className="w-4 h-4"/> Finalisasi
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onShare(item) : null} 
                                                    disabled={!isCurrentOwner || isFromOtherUnit}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        (isCurrentOwner && !isFromOtherUnit)
                                                            ? 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-600 border border-purple-100 hover:border-purple-200 hover:bg-purple-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Share className="w-4 h-4"/> Bagikan
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onDelete(item)} 
                                                    className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100"
                                                >
                                                    <Icons.Trash className="w-4.5 h-4.5"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                    {showShareModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmShare} onCancel={() => setShowShareModal(false)} />}
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const FormFinalListView = ({ title, data, type, onBack, onView, onExport, Icons, notification, currentUser, count }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            const filteredData = data.filter(item => 
                item.namaKasus?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.nomorEPID?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.kelurahan?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.createdUnit?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredData.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            const nextPage = () => {
                if (currentPage < totalPages) setCurrentPage(currentPage + 1);
            };

            const prevPage = () => {
                if (currentPage > 1) setCurrentPage(currentPage - 1);
            };

            const getStatusBadge = (status) => {
                return (
                    <span className={`status-badge bg-green-100 text-green-800 border border-green-200`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-green-600 text-sm">({count})</span></h2>
                            <button onClick={onExport} className="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100">
                                <Icons.Download className="w-5 h-5"/>
                            </button>
                        </div>
                        
                        <div className="mt-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Cari di Form Final..."
                                    className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => {
                                        setSearchTerm(e.target.value);
                                        setCurrentPage(1);
                                    }}
                                />
                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
                            </div>
                            <p className="text-xs text-slate-500 mt-2">
                                Menampilkan {Math.min(filteredData.length, itemsPerPage)} data per halaman
                            </p>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {filteredData.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                {searchTerm ? 'Tidak ada data yang sesuai dengan pencarian' : 'Tidak ada data untuk ditampilkan'}
                            </div>
                        ) : (
                            <>
                                <div className="grid gap-4">
                                    {currentItems.map(item => {
                                        const currentOwner = determineCurrentOwner(item);
                                        const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                        
                                        return (
                                            <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-2">
                                                        <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                                            {item.nomorEPID || 'NO-EPID'}
                                                        </div>
                                                        {getStatusBadge(item.statusData)}
                                                        {isFromOtherUnit && (
                                                            <span className="status-badge bg-purple-100 text-purple-800 border border-purple-200">
                                                                Rujukan
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="text-xs text-slate-500 font-medium">
                                                        {new Date(item.updatedAt).toLocaleDateString()}
                                                    </div>
                                                </div>
                                                
                                                <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                                <p className="text-sm text-slate-600 font-medium mb-1">
                                                    {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                                </p>
                                                <p className="text-sm text-slate-500 mb-5">
                                                    {item.kelurahan || 'Lokasi tidak diketahui'}
                                                    {isFromOtherUnit && (
                                                        <span className="block text-xs text-purple-600 mt-1">
                                                            Asal: {item.createdUnit}
                                                        </span>
                                                    )}
                                                    <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                        Current Owner: {currentOwner}
                                                    </span>
                                                </p>
                                                
                                                <div className="flex gap-2 border-t border-slate-100 pt-4">
                                                    <button 
                                                        onClick={() => onView(item)} 
                                                        className="w-full py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                    >
                                                        <Icons.Eye className="w-4 h-4"/> Lihat Detail (Read-Only)
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {filteredData.length > itemsPerPage && (
                                    <div className="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                        <p className="text-sm text-slate-600">
                                            Menampilkan {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, filteredData.length)} dari {filteredData.length} data
                                        </p>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={prevPage}
                                                disabled={currentPage === 1}
                                                className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                            >
                                                Sebelumnya
                                            </button>
                                            <span className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium">
                                                Halaman {currentPage} dari {totalPages}
                                            </span>
                                            <button
                                                onClick={nextPage}
                                                disabled={currentPage === totalPages}
                                                className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                            >
                                                Selanjutnya
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        const OutgoingListView = ({ title, data, type, onBack, onView, Icons, notification, currentUser, count }) => {
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Diterima': 'bg-emerald-100 text-emerald-800 border border-emerald-200',
                    'Transferred': 'bg-purple-100 text-purple-800 border border-purple-200'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-indigo-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const currentOwner = determineCurrentOwner(item);
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-indigo-600 mt-1">
                                                    Dikirim ke: {item.sharedTo}
                                                </span>
                                                {item.statusData === 'Ditolak' && (
                                                    <span className="block text-xs text-red-600 mt-1">
                                                        Status: Ditolak oleh penerima
                                                    </span>
                                                )}
                                                {item.statusData === 'Diterima' && (
                                                    <span className="block text-xs text-green-600 mt-1">
                                                        Status: Diterima oleh penerima (masuk Pending Form)
                                                    </span>
                                                )}
                                            </p>
                                            
                                            <div className="flex gap-2 border-t border-slate-100 pt-4">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat Detail
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        const InboxListView = ({ title, data, type, onBack, onView, onAccept, onReject, onTransfer, Icons, showReviewModal, reviewItem, setShowReviewModal, setReviewItem, showTransferModal, setShowTransferModal, confirmTransfer, notification, loading, ALL_SERVICES, currentUser, count, showRejectModal, setShowRejectModal, confirmRejectTransfer }) => {
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-rose-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const currentOwner = determineCurrentOwner(item);
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-indigo-600 mt-1">
                                                    Dari: {item.createdUnit}
                                                </span>
                                                <span className="block text-xs text-blue-600 mt-1">
                                                    Status: Menunggu tindakan Anda
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => { 
                                                        console.log("Accepting item:", item);
                                                        setReviewItem(item); 
                                                        setShowReviewModal(true); 
                                                    }} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-green-50 text-green-600 rounded-lg text-sm font-bold border border-green-100 hover:border-green-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Check className="w-4 h-4"/> Terima
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onReject(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-red-50 text-red-600 rounded-lg text-sm font-bold border border-red-100 hover:border-red-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.XCircle className="w-4 h-4"/> Tolak
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onTransfer(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold border border-indigo-100 hover:border-indigo-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Send className="w-4 h-4"/> Teruskan
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showReviewModal && reviewItem && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.CheckCircle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-slate-800">Yakin Terima Formulir?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    <strong>{reviewItem.namaKasus || 'Formulir'}</strong>
                                </p>
                                <p className="text-slate-500 mb-6 text-sm">
                                    Formulir akan masuk ke <strong>Pending Form</strong> untuk verifikasi.
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowReviewModal(false)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={() => onAccept(reviewItem)} className="flex-1 p-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Terima
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    
                    
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const RejectedListView = ({ title, data, type, onBack, onView, onEdit, onShare, onDelete, Icons, showDeleteModal, setShowDeleteModal, handleDelete, showShareModal, setShowShareModal, confirmShare, notification, loading, ALL_SERVICES, currentUser, count }) => {
            const getStatusBadge = (status, isFromOtherUnit = false) => {
                const statusColors = {
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200'
                };
                
                const color = statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                const fromOtherBadge = isFromOtherUnit ? 'bg-purple-100 text-purple-800 ml-1 border border-purple-200' : '';
                
                return (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`status-badge ${color}`}>
                            {status}
                        </span>
                        {isFromOtherUnit && (
                            <span className={`status-badge ${fromOtherBadge}`}>
                                Eksternal
                            </span>
                        )}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-red-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                    const currentOwner = determineCurrentOwner(item);
                                    const isCurrentOwner = currentOwner === currentUser.unitName;
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData, isFromOtherUnit)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                {isFromOtherUnit && (
                                                    <span className="block text-xs text-purple-600 mt-1 font-semibold">
                                                        Dari: {item.createdUnit}
                                                    </span>
                                                )}
                                                <span className="block text-xs text-green-600 mt-1">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-red-600 mt-1 font-semibold">
                                                    Ditolak oleh: {item.sharedTo || 'Unit Lain'}
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onEdit(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 border border-blue-100 hover:border-blue-200 hover:bg-blue-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Edit className="w-4 h-4"/> Edit
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onShare(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-600 border border-purple-100 hover:border-purple-200 hover:bg-purple-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Share className="w-4 h-4"/> Bagikan Ulang
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onDelete(item)} 
                                                    className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100"
                                                >
                                                    <Icons.Trash className="w-4.5 h-4.5"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                    {showShareModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmShare} onCancel={() => setShowShareModal(false)} />}
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const SharePuskesmasModalWithSearch = ({ servicesList, currentUnit, onConfirm, onCancel, title = "Kirim ke Unit Lain", description = "Pilih unit layanan yang akan menerima formulir ini." }) => {
            const [search, setSearch] = useState('');
            const [selected, setSelected] = useState('');
            
            const filteredServices = servicesList.filter(s => 
                s.toLowerCase().includes(search.toLowerCase()) && 
                s !== currentUnit
            );
            
            const handleSelect = (service) => {
                setSelected(service);
            };
            
            const handleConfirm = () => {
                if (selected) {
                    onConfirm(selected);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="font-bold text-xl text-slate-800">{title}</h3>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600">
                                <Icons.XCircle className="w-6 h-6" />
                            </button>
                        </div>
                        
                        <p className="text-slate-500 mb-6 text-body">{description}</p>
                        
                        <div className="relative mb-6">
                            <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400">
                                <Icons.Search className="w-5 h-5" />
                            </div>
                            <input
                                type="text"
                                className="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                placeholder="Cari unit layanan (Puskesmas/Rumah Sakit)..."
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                            />
                        </div>
                        
                        <div className="max-h-60 overflow-y-auto mb-6 border border-slate-200 rounded-lg">
                            {filteredServices.length === 0 ? (
                                <p className="text-center p-4 text-slate-400">Tidak ada unit layanan ditemukan</p>
                            ) : (
                                filteredServices.map(service => (
                                    <div
                                        key={service}
                                        className={`p-4 border-b border-slate-100 last:border-b-0 cursor-pointer hover:bg-slate-50 ${selected === service ? 'bg-blue-50 border-blue-200' : ''}`}
                                        onClick={() => handleSelect(service)}
                                    >
                                        <div className="flex items-center">
                                            <div className={`w-5 h-5 rounded-full border mr-3 flex items-center justify-center ${selected === service ? 'bg-blue-500 border-blue-500' : 'border-slate-300'}`}>
                                                {selected === service && <Icons.Check className="w-3 h-3 text-white" />}
                                            </div>
                                            <div>
                                                <span className="font-medium text-slate-800">{service}</span>
                                                <div className="text-xs text-slate-500 mt-1">
                                                    {service.startsWith('Puskesmas') ? 'Puskesmas' : 'Rumah Sakit'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                Batal
                            </button>
                            <button 
                                onClick={handleConfirm} 
                                className="flex-1 p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={!selected}
                            >
                                Konfirmasi
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExitConfirmationModal = ({ onSave, onDiscard, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icons.AlertTriangle className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-xl mb-2 text-slate-800">Simpan Perubahan?</h3>
                    <p className="text-slate-500 mb-6 text-body">Konfirmasi sebelum meninggalkan halaman</p>
                    <div className="flex flex-col gap-3">
                        <button onClick={onSave} className="w-full p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Simpan sebagai Draft
                        </button>
                        <button onClick={onDiscard} className="w-full p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Buang Perubahan
                        </button>
                        <button onClick={onCancel} className="w-full p-3.5 border border-slate-200 text-slate-500 rounded-lg font-bold hover:bg-slate-50 transition">
                            Kembali ke Form
                        </button>
                    </div>
                </div>
            </div>
        );

        const DeleteConfirmationModal = ({ onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icons.AlertTriangle className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-xl mb-2 text-red-600">Hapus Formulir?</h3>
                    <p className="text-slate-500 mb-6 text-body">Formulir akan dihapus secara permanen dan tidak dapat dikembalikan.</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                            Batal
                        </button>
                        <button onClick={onConfirm} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            </div>
        );

        // PERBAIKAN POINT 1 & 3: AdminDashboard yang diperbaiki
        const AdminDashboard = ({ currentUser, onLogout, mockDB, mockUserDB, showNotification, exportToCSV, loadDataForView, ALL_SERVICES, onViewForm, onUnfinalizeForm, onEditEpidForm, showAdminDeleteUserModal, setShowAdminDeleteUserModal, adminUserToDelete, setAdminUserToDelete, rejectedList }) => {
            const [activeTab, setActiveTab] = useState('forms');
            const [allForms, setAllForms] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [newUser, setNewUser] = useState({ 
                name: '', 
                username: '', 
                password: '', 
                role: 'user', 
                unitName: '' 
            });
            const [deleteFormId, setDeleteFormId] = useState(null);
            const [editingUser, setEditingUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [userSearchTerm, setUserSearchTerm] = useState('');
            
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage] = useState(10);

            const getStatusBadge = (status) => {
                const statusColors = {
                    'Draft': 'bg-yellow-100 text-yellow-800',
                    'Pending': 'bg-amber-100 text-amber-800',
                    'Final': 'bg-green-100 text-green-800',
                    'Proses': 'bg-blue-100 text-blue-800',
                    'Ditolak': 'bg-red-100 text-red-800',
                    'Diterima': 'bg-emerald-100 text-emerald-800',
                    'Transferred': 'bg-purple-100 text-purple-800',
                    'Baru': 'bg-gray-100 text-gray-800'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800'}`}>
                        {status}
                    </span>
                );
            };

            const calculateAge = (dob) => { 
                if (!dob) return '-'; 
                const birth = new Date(dob); 
                const now = new Date(); 
                let age = now.getFullYear() - birth.getFullYear(); 
                const m = now.getMonth() - birth.getMonth(); 
                if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--; 
                return age + ' Thn'; 
            };

            const loadAllData = async () => {
                try {
                    const forms = await mockDB.getAllForms();
                    const formsWithOwner = forms.map(form => ({
                        ...form,
                        currentOwner: determineCurrentOwner(form)
                    }));
                    setAllForms(formsWithOwner);
                    
                    const users = await mockUserDB.getUsers();
                    setAllUsers(users);
                } catch (e) {
                    console.error("Error loading admin data:", e);
                    showNotification('Error memuat data', 'error');
                }
            };

            useEffect(() => { 
                loadAllData();
            }, [activeTab]);

            const filteredForms = searchTerm ? allForms.filter(form => 
                form.namaKasus?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.nomorEPID?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.currentOwner?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.statusData?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.createdUnit?.toLowerCase().includes(searchTerm.toLowerCase())
            ) : allForms;

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentForms = filteredForms.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredForms.length / itemsPerPage);

            const nextPage = () => {
                if (currentPage < totalPages) setCurrentPage(currentPage + 1);
            };

            const prevPage = () => {
                if (currentPage > 1) setCurrentPage(currentPage - 1);
            };

            const filteredUsers = userSearchTerm ? allUsers.filter(user => 
                user.name?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.username?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.unitName?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.role?.toLowerCase().includes(userSearchTerm.toLowerCase())
            ) : allUsers;

            const handleAddUser = async (e) => { 
                e.preventDefault(); 
                
                if (!newUser.name || !newUser.username || !newUser.password || !newUser.unitName) {
                    showNotification('Semua field wajib diisi', 'error');
                    return;
                }
                
                const existingUser = allUsers.find(u => u.username === newUser.username);
                if (existingUser) {
                    showNotification('Username sudah digunakan', 'error');
                    return;
                }
                
                if(await mockUserDB.addUser(newUser)) { 
                    showNotification('User berhasil ditambahkan', 'success'); 
                    setNewUser({ name: '', username: '', password: '', role: 'user', unitName: '' }); 
                    setAllUsers(await mockUserDB.getUsers()); 
                } else {
                    showNotification('Gagal menambahkan user', 'error'); 
                }
            };
            
            const handleUpdateUser = async (e) => {
                e.preventDefault();
                if (!editingUser) return;
                
                if (!editingUser.name || !editingUser.username || !editingUser.password || !editingUser.unitName) {
                    showNotification('Semua field wajib diisi', 'error');
                    return;
                }
                
                try {
                    if (dbStore) {
                        await dbStore.collection('users').doc(editingUser.id).update({
                            name: editingUser.name,
                            username: editingUser.username,
                            password: editingUser.password,
                            role: editingUser.role,
                            unitName: editingUser.unitName
                        });
                        showNotification('User berhasil diperbarui', 'success');
                        setEditingUser(null);
                        setAllUsers(await mockUserDB.getUsers());
                    } else {
                        showNotification('Database tidak tersedia', 'error');
                    }
                } catch (e) {
                    console.error("Error updating user:", e);
                    showNotification('Error memperbarui user: ' + e.message, 'error');
                }
            };
            
            const handleDeleteUser = async (id) => { 
                if(window.confirm('Yakin ingin menghapus user ini secara permanen?')) { 
                    await mockUserDB.deleteUser(id); 
                    showNotification('User dihapus', 'success'); 
                    setAllUsers(await mockUserDB.getUsers()); 
                } 
            };
            
            const handleExportAll = () => { 
                if(allForms.length > 0) {
                    exportToCSV(allForms, 'SEMUA_DATA_SURVEILANS.csv', false);
                } else {
                    showNotification('Tidak ada data untuk didownload', 'error'); 
                }
            };

            const handleDeleteForm = async (formId) => {
                if (!formId) return;
                
                try {
                    await mockDB.delete(formId);
                    showNotification('Formulir dihapus', 'success');
                    setDeleteFormId(null);
                    await loadAllData();
                } catch (e) {
                    console.error("Error deleting form:", e);
                    showNotification('Error menghapus formulir: ' + e.message, 'error');
                }
            };

            const handleViewFormInAdmin = (form) => {
                onViewForm(form);
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full flex flex-col bg-slate-50 overflow-hidden">
                    <div className="flex-none bg-gradient-to-r from-slate-800 to-slate-900 text-white p-4 shadow-lg z-20">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="font-bold text-xl tracking-tight">Admin Panel Surveilans</h1>
                                <p className="text-slate-300 text-sm font-medium mt-1">Manajemen data dan pengguna</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={onLogout} className="bg-red-600 hover:bg-red-700 px-5 py-2.5 rounded-lg text-sm font-bold shadow-sm">
                                    Keluar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 w-full">
                        <div className="max-w-6xl mx-auto">
                            <div className="flex gap-8 border-b border-slate-300 mb-8 overflow-x-auto">
                                <button 
                                    onClick={() => setActiveTab('forms')} 
                                    className={`pb-4 px-1 font-bold transition text-lg whitespace-nowrap ${activeTab === 'forms' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    Data Formulir
                                </button>
                                <button 
                                    onClick={() => setActiveTab('users')} 
                                    className={`pb-4 px-1 font-bold transition text-lg whitespace-nowrap ${activeTab === 'users' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    Manajemen User
                                </button>
                            </div>
                            
                            {activeTab === 'forms' && (
                                <div className="bg-white rounded-xl shadow border border-slate-200 p-4 md:p-6 fade-in">
                                    <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
                                        <div>
                                            <h3 className="font-bold text-xl text-slate-800 mb-1">Semua Data Formulir</h3>
                                            <p className="text-slate-500 text-body">Total: {allForms.length} formulir</p>
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-2">
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Cari formulir..."
                                                    className="w-full md:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                    value={searchTerm}
                                                    onChange={(e) => {
                                                        setSearchTerm(e.target.value);
                                                        setCurrentPage(1);
                                                    }}
                                                />
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            </div>
                                            <button onClick={handleExportAll} className="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                                <Icons.Download className="w-4 h-4"/> Download CSV
                                            </button>
                                            <button onClick={loadAllData} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                                <Icons.Database className="w-4 h-4"/> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto border border-slate-200 rounded-lg mobile-scroll">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-600 uppercase text-xs font-bold">
                                                <tr>
                                                    <th className="px-4 py-3">No EPID</th>
                                                    <th className="px-4 py-3">Status</th>
                                                    <th className="px-4 py-3">Nama Kasus</th>
                                                    <th className="px-4 py-3">Usia</th>
                                                    <th className="px-4 py-3">Current Owner</th>
                                                    <th className="px-4 py-3">Tgl Update</th>
                                                    <th className="px-4 py-3">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {currentForms.map(form => (
                                                    <tr key={form.id} className="hover:bg-slate-50">
                                                        <td className="px-4 py-3 font-mono">
                                                            {form.nomorEPID || 'DRAFT'}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            {getStatusBadge(form.statusData)}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="font-semibold text-slate-800">{form.namaKasus || 'Tanpa Nama'}</div>
                                                            <div className="text-[10px] text-slate-400 mt-0.5">{form.jenisKelamin}</div>
                                                        </td>
                                                        <td className="px-4 py-3 font-medium text-slate-600">{calculateAge(form.tanggalLahir)}</td>
                                                        <td className="px-4 py-3">
                                                            <span className="text-slate-700 text-xs font-medium">
                                                                {form.currentOwner || determineCurrentOwner(form)}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-slate-500">
                                                            {new Date(form.updatedAt).toLocaleDateString()}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex gap-1">
                                                                <button 
                                                                    onClick={() => handleViewFormInAdmin(form)}
                                                                    className="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Lihat Detail"
                                                                >
                                                                    <Icons.Eye className="w-4 h-4"/>
                                                                </button>
                                                                {form.statusData === 'Final' && (
                                                                    <button 
                                                                        onClick={() => onUnfinalizeForm(form)}
                                                                        className="text-amber-500 bg-amber-50 hover:bg-amber-100 p-2 rounded-lg text-xs font-bold transition"
                                                                        title="Batalkan Finalisasi"
                                                                    >
                                                                        <Icons.AlertTriangle className="w-4 h-4"/>
                                                                    </button>
                                                                )}
                                                                <button 
                                                                    onClick={() => onEditEpidForm(form)}
                                                                    className="text-green-500 bg-green-50 hover:bg-green-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Edit Nomor EPID"
                                                                >
                                                                    <Icons.Edit className="w-4 h-4"/>
                                                                </button>
                                                                <button 
                                                                    onClick={() => setDeleteFormId(form.id)}
                                                                    className="text-red-500 bg-red-50 hover:bg-red-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Hapus Formulir"
                                                                >
                                                                    <Icons.Trash className="w-4 h-4"/>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {currentForms.length === 0 && (
                                            <div className="text-center p-8 text-slate-400 italic">
                                                {searchTerm ? 'Tidak ada formulir yang sesuai dengan pencarian' : 'Belum ada data formulir.'}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {filteredForms.length > itemsPerPage && (
                                        <div className="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                            <p className="text-sm text-slate-600">
                                                Menampilkan {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, filteredForms.length)} dari {filteredForms.length} formulir
                                            </p>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={prevPage}
                                                    disabled={currentPage === 1}
                                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                                >
                                                    Sebelumnya
                                                </button>
                                                <span className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium">
                                                    Halaman {currentPage} dari {totalPages}
                                                </span>
                                                <button
                                                    onClick={nextPage}
                                                    disabled={currentPage === totalPages}
                                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                                >
                                                    Selanjutnya
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="mt-6 grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <p className="text-xs text-blue-600 font-bold mb-1">Draft</p>
                                            <p className="text-2xl font-bold text-blue-800">
                                                {allForms.filter(f => f.statusData === 'Draft').length}
                                            </p>
                                        </div>
                                        <div className="bg-amber-50 p-4 rounded-lg border border-amber-200">
                                            <p className="text-xs text-amber-600 font-bold mb-1">Pending Form</p>
                                            <p className="text-2xl font-bold text-amber-800">
                                                {allForms.filter(f => f.statusData === 'Pending').length}
                                            </p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-xs text-green-600 font-bold mb-1">Form Final</p>
                                            <p className="text-2xl font-bold text-green-800">
                                                {allForms.filter(f => f.statusData === 'Final').length}
                                            </p>
                                        </div>
                                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                            <p className="text-xs text-indigo-600 font-bold mb-1">Proses</p>
                                            <p className="text-2xl font-bold text-indigo-800">
                                                {allForms.filter(f => f.statusData === 'Proses').length}
                                            </p>
                                        </div>
                                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                                            <p className="text-xs text-red-600 font-bold mb-1">Ditolak</p>
                                            <p className="text-2xl font-bold text-red-800">
                                                {allForms.filter(f => f.statusData === 'Ditolak').length}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'users' && (
                                <div className="grid md:grid-cols-2 gap-8 fade-in">
                                    <div className="bg-white rounded-xl shadow border border-slate-200 p-6 h-fit">
                                        <h3 className="font-bold text-xl text-slate-800 mb-6 pb-3 border-b border-slate-100">
                                            {editingUser ? 'Edit User' : 'Tambah User Baru'}
                                        </h3>
                                        <form onSubmit={editingUser ? handleUpdateUser : handleAddUser} className="space-y-5">
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Nama Lengkap</label>
                                                <input 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    placeholder="Contoh: John Doe" 
                                                    value={editingUser ? editingUser.name : newUser.name} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, name:e.target.value}) 
                                                        : setNewUser({...newUser, name:e.target.value})} 
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Role / Peran</label>
                                                <select 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    value={editingUser ? editingUser.role : newUser.role} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, role:e.target.value}) 
                                                        : setNewUser({...newUser, role:e.target.value})}
                                                >
                                                    <option value="user">User (Petugas)</option>
                                                    <option value="admin">Admin (Dinkes)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Unit Layanan</label>
                                                <select 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    value={editingUser ? editingUser.unitName : newUser.unitName} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, unitName:e.target.value}) 
                                                        : setNewUser({...newUser, unitName:e.target.value})} 
                                                    required
                                                >
                                                    <option value="">-- Pilih Unit --</option>
                                                    {ALL_SERVICES.map(p=>
                                                        <option key={p} value={p}>{p}</option>
                                                    )}
                                                </select>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Username</label>
                                                    <input 
                                                        className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                        placeholder="user123" 
                                                        value={editingUser ? editingUser.username : newUser.username} 
                                                        onChange={e => editingUser 
                                                            ? setEditingUser({...editingUser, username:e.target.value}) 
                                                            : setNewUser({...newUser, username:e.target.value})} 
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Password</label>
                                                    <input 
                                                        className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                        placeholder="***" 
                                                        type="password"
                                                        value={editingUser ? editingUser.password : newUser.password} 
                                                        onChange={e => editingUser 
                                                            ? setEditingUser({...editingUser, password:e.target.value}) 
                                                            : setNewUser({...newUser, password:e.target.value})} 
                                                        required
                                                    />
                                                </div>
                                            </div>
                                            <div className="flex gap-3">
                                                {editingUser && (
                                                    <button 
                                                        type="button"
                                                        onClick={() => {
                                                            setEditingUser(null);
                                                            setNewUser({ name: '', username: '', password: '', role: 'user', unitName: '' });
                                                        }}
                                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                                    >
                                                        Batal
                                                    </button>
                                                )}
                                                <button 
                                                    type="submit"
                                                    className={`${editingUser ? 'flex-1' : 'w-full'} p-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition transform active:scale-95 text-subtitle`}
                                                >
                                                    {editingUser ? 'Simpan Perubahan' : 'Simpan User Baru'}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div className="bg-white rounded-xl shadow border border-slate-200 p-6">
                                        <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6 pb-3 border-b border-slate-100">
                                            <h3 className="font-bold text-xl text-slate-800">Daftar User Terdaftar ({filteredUsers.length})</h3>
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Cari user..."
                                                    className="w-full md:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                                    value={userSearchTerm}
                                                    onChange={(e) => setUserSearchTerm(e.target.value)}
                                                />
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            </div>
                                        </div>
                                        <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                            {filteredUsers.map(u => (
                                                <div key={u.id} className="flex justify-between items-center p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition group">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-slate-800">{u.name}</p>
                                                        <p className="text-sm text-slate-500 mt-1">
                                                            {u.unitName}  
                                                            <span className={`ml-2 px-2 py-0.5 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                {u.role}
                                                            </span>
                                                        </p>
                                                        <p className="text-xs text-slate-400 font-mono mt-2">
                                                            Username: @{u.username} | Password: {u.password}
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => setEditingUser(u)} 
                                                            className="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2.5 rounded-lg text-sm font-bold transition border border-blue-100"
                                                            title="Edit User"
                                                        >
                                                            <Icons.Edit className="w-4 h-4" />
                                                        </button>
                                                        {u.role !== 'admin' && u.username !== 'admin' && (
                                                            <button 
                                                                onClick={() => handleDeleteUser(u.id)} 
                                                                className="text-red-500 bg-red-50 hover:bg-red-100 p-2.5 rounded-lg text-sm font-bold transition border border-red-100"
                                                                title="Hapus User"
                                                            >
                                                                <Icons.Trash className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredUsers.length === 0 && (
                                                <div className="text-center p-8 text-slate-400 italic">
                                                    {userSearchTerm ? 'Tidak ada user yang sesuai dengan pencarian' : 'Belum ada user terdaftar.'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {deleteFormId && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Hapus Formulir?</h3>
                                <p className="text-slate-500 mb-6 text-body">Formulir akan dihapus permanen dan nomor EPID dapat digunakan kembali.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteFormId(null)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={() => handleDeleteForm(deleteFormId)} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // MODAL VIEW FORMULIR
        const ViewModal = ({ item, onClose, Icons }) => {
            if (!item) {
                console.log("ViewModal: No item provided");
                return null;
            }
            
            console.log("ViewModal rendering with item:", item);
            
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                try {
                    if (typeof dateString === 'number') {
                        return new Date(dateString).toLocaleDateString('id-ID');
                    }
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;
                    return date.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    console.log("Date formatting error:", e);
                    return dateString;
                }
            };
            
            const formatDateTime = (timestamp) => {
                if (!timestamp) return '-';
                try {
                    const date = new Date(timestamp);
                    if (isNaN(date.getTime())) return timestamp;
                    return date.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return timestamp;
                }
            };
            
            const calculateAgeFromDOB = (dob) => {
                if (!dob) return '';
                try {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    
                    let years = today.getFullYear() - birthDate.getFullYear();
                    let months = today.getMonth() - birthDate.getMonth();
                    
                    if (months < 0) {
                        years--;
                        months += 12;
                    }
                    
                    return `${years} tahun, ${months} bulan`;
                } catch (e) {
                    return dob;
                }
            };
            
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Draft': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Final': 'bg-green-100 text-green-800 border border-green-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Diterima': 'bg-emerald-100 text-emerald-800 border border-emerald-200',
                    'Transferred': 'bg-purple-100 text-purple-800 border border-purple-200',
                    'Baru': 'bg-gray-100 text-gray-800 border border-gray-200'
                };
                
                return (
                    <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${statusColors[status] || 'bg-gray-100 text-gray-800'}`}>
                        {status || 'Unknown'}
                    </span>
                );
            };
            
            const currentOwner = determineCurrentOwner(item);
            const isFromOtherUnit = item.createdUnit !== currentOwner;
            
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl w-full sm:w-[95%] md:w-[80%] lg:w-[70%] max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl border border-slate-200">
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 border-b border-slate-200">
                            <div className="flex justify-between items-start">
                                <div className="flex-1">
                                    <div className="flex items-center gap-3 mb-2">
                                        
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800">Ringkasan Data</h2>
                                            <div className="flex items-center gap-3 mt-1">
                                                <span className="font-mono font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded">
                                                    {item.nomorEPID || 'NO-EPID'}
                                                </span>
                                                {getStatusBadge(item.statusData)}
                                                {isFromOtherUnit && (
                                                    <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-800 border border-purple-200">
                                                        Eksternal
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-4 mt-3 text-sm text-slate-600">
                                        
                                        <div className="flex items-center gap-1">
                                            <Icons.Shield className="w-4 h-4" />
                                            <span>Owner: <strong>{currentOwner}</strong></span>
                                        </div>
                                        
                                        <div className="flex items-center gap-1">
                                            <Icons.Clock className="w-4 h-4" />
                                            <span>Update: <strong>{formatDateTime(item.updatedAt)}</strong></span>
                                        </div>
                                    </div>
                                </div>
                                <button 
                                    onClick={onClose}
                                >
                                    <Icons.XCircle className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-6 overflow-y-auto max-h-[65vh]">
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                    <Icons.FileText className="w-5 h-5 text-amber-500" />
                                    Informasi Workflow
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className={`p-4 rounded-lg border ${
                                        item.statusData === 'Pending' 
                                            ? 'bg-amber-50 border-amber-100' 
                                            : item.statusData === 'Final'
                                            ? 'bg-green-50 border-green-100'
                                            : item.statusData === 'Ditolak'
                                            ? 'bg-red-50 border-red-100'
                                            : 'bg-blue-50 border-blue-100'
                                    }`}>
                                        <p className="text-sm font-semibold mb-1">Status Saat Ini</p>
                                        <p className={`text-lg font-bold ${
                                            item.statusData === 'Pending' 
                                                ? 'text-amber-800' 
                                                : item.statusData === 'Final'
                                                ? 'text-green-800'
                                                : item.statusData === 'Ditolak'
                                                ? 'text-red-800'
                                                : 'text-blue-800'
                                        }`}>
                                            {item.statusData}
                                        </p>
                                        <p className="text-xs mt-1">
                                            {item.statusData === 'Pending' 
                                                ? 'Formulir dalam proses verifikasi di Pending Form'
                                                : item.statusData === 'Final'
                                                ? 'Formulir sudah final (read-only)'
                                                : item.statusData === 'Ditolak'
                                                ? 'Formulir ditolak oleh unit lain'
                                                : 'Formulir dalam proses lainnya'}
                                        </p>
                                    </div>
                                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
                                        <p className="text-sm font-semibold mb-1">Alur Formulir</p>
                                        <p className="text-sm text-blue-800">
                                            {isFromOtherUnit 
                                                ? 'Formulir dari unit lain  Inbox  Pending Form  Form Final'
                                                : 'Formulir buatan sendiri  Draft/Pending  Form Final (Fast Track)'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                    <Icons.User className="w-5 h-5 text-blue-500" />
                                    Informasi Umum
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Nama Lengkap Kasus</p>
                                        <p className="font-bold text-slate-800 text-lg">{item.namaKasus || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Jenis Kelamin</p>
                                        <p className="font-medium text-slate-800">{item.jenisKelamin || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Tanggal Lahir / Usia</p>
                                        <p className="font-medium text-slate-800">
                                            {formatDate(item.tanggalLahir)} 
                                            {item.tanggalLahir && (
                                                <span className="ml-2 text-blue-600">({calculateAgeFromDOB(item.tanggalLahir)})</span>
                                            )}
                                        </p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Alamat Lengkap</p>
                                        <p className="font-medium text-slate-800">{item.alamat || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Kecamatan</p>
                                        <p className="font-medium text-slate-800">{item.kecamatan || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Kelurahan</p>
                                        <p className="font-medium text-slate-800">{item.kelurahan || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">RT/RW</p>
                                        <p className="font-medium text-slate-800">{item.rt || '-'}/{item.rw || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Sumber Laporan</p>
                                        <p className="font-medium text-slate-800">{item.sumberLaporan || '-'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            {(item.demam || item.ruam || item.dirawat) && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                        <Icons.Thermometer className="w-5 h-5 text-red-500" />
                                        Data Klinis
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {item.demam && (
                                            <div className="bg-red-50 p-4 rounded-lg">
                                                <p className="text-sm text-red-600 mb-1">Demam</p>
                                                <p className="font-medium text-red-800">{item.demam === 'ya' ? 'Ya' : 'Tidak'}</p>
                                                {item.demam === 'ya' && item.tanggalMulaiDemam && (
                                                    <p className="text-xs text-red-500 mt-1">
                                                        Mulai: {formatDate(item.tanggalMulaiDemam)}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                        
                                        {item.ruam && (
                                            <div className="bg-orange-50 p-4 rounded-lg">
                                                <p className="text-sm text-orange-600 mb-1">Ruam</p>
                                                <p className="font-medium text-orange-800">{item.ruam === 'ya' ? 'Ya' : 'Tidak'}</p>
                                                {item.ruam === 'ya' && item.tanggalMulaiRuam && (
                                                    <p className="text-xs text-orange-500 mt-1">
                                                        Mulai: {formatDate(item.tanggalMulaiRuam)}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                        
                                        {item.gejalaLain && item.gejalaLain.length > 0 && (
                                            <div className="bg-yellow-50 p-4 rounded-lg col-span-2">
                                                <p className="text-sm text-yellow-600 mb-1">Gejala Lain</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {Array.isArray(item.gejalaLain) 
                                                        ? item.gejalaLain.map((gejala, idx) => (
                                                            <span key={idx} className="bg-white px-3 py-1 rounded-full text-sm font-medium text-yellow-800 border border-yellow-200">
                                                                {gejala}
                                                            </span>
                                                        ))
                                                        : <p className="font-medium text-yellow-800">{item.gejalaLain}</p>
                                                    }
                                                </div>
                                            </div>
                                        )}
                                        
                                        {item.komplikasi && item.komplikasi.length > 0 && (
                                            <div className="bg-red-50 p-4 rounded-lg col-span-2">
                                                <p className="text-sm text-red-600 mb-1">Komplikasi</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {Array.isArray(item.komplikasi)
                                                        ? item.komplikasi.map((komp, idx) => (
                                                            <span key={idx} className="bg-white px-3 py-1 rounded-full text-sm font-medium text-red-800 border border-red-200">
                                                                {komp}
                                                            </span>
                                                        ))
                                                        : <p className="font-medium text-red-800">{item.komplikasi}</p>
                                                    }
                                                </div>
                                            </div>
                                        )}
                                        
                                        {item.dirawat && (
                                            <div className="bg-purple-50 p-4 rounded-lg col-span-2">
                                                <p className="text-sm text-purple-600 mb-1">Rawat Inap</p>
                                                <p className="font-medium text-purple-800">{item.dirawat === 'ya' ? 'Ya' : 'Tidak'}</p>
                                                {item.dirawat === 'ya' && item.namaRumahSakit && (
                                                    <div className="mt-2 space-y-2">
                                                        <p className="text-sm font-medium">RS: {item.namaRumahSakit}</p>
                                                        {item.tanggalMasukRawat && (
                                                            <p className="text-xs">Masuk: {formatDate(item.tanggalMasukRawat)}</p>
                                                        )}
                                                        {item.tanggalKeluarRawat && (
                                                            <p className="text-xs">Keluar: {formatDate(item.tanggalKeluarRawat)}</p>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {item.transferHistory && item.transferHistory.length > 0 && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                        <Icons.Share className="w-5 h-5 text-green-500" />
                                        Riwayat Transfer
                                    </h3>
                                    <div className="space-y-3">
                                        {item.transferHistory.map((record, idx) => (
                                            <div key={idx} className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${
                                                            record.action === 'dikirim' ? 'bg-blue-100 text-blue-800' :
                                                            record.action === 'diterima' ? 'bg-green-100 text-green-800' :
                                                            record.action === 'ditolak' ? 'bg-red-100 text-red-800' :
                                                            record.action === 'diteruskan' ? 'bg-purple-100 text-purple-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {record.action || 'transfer'}
                                                        </span>
                                                        <p className="text-sm text-slate-700 mt-2">
                                                            Dari: <span className="font-bold">{record.from}</span> 
                                                            <Icons.ChevronLeft className="inline w-4 h-4 mx-2 rotate-180" />
                                                            Ke: <span className="font-bold">{record.to}</span>
                                                        </p>
                                                        {record.newOwner && (
                                                            <p className="text-sm text-green-700 mt-1">
                                                                <span className="font-bold">Ownership berpindah ke:</span> {record.newOwner}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <span className="text-sm text-slate-500">
                                                        {new Date(record.date).toLocaleDateString('id-ID')}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-6 border-t border-slate-200 bg-slate-50">
                            <div className="flex flex-col md:flex-row justify-end gap-3">
                                <button 
                                    onClick={onClose}
                                    className="px-6 py-3 bg-white border border-slate-300 text-slate-700 rounded-lg font-bold hover:bg-slate-50 transition shadow-sm"
                                >
                                    Tutup
                                </button>
                                {item.titikLokasi && (
                                    <button 
                                        onClick={() => {
                                            if (item.titikLokasi) {
                                                const coords = item.titikLokasi.split(',').map(c => c.trim());
                                                if (coords.length === 2) {
                                                    const url = `https://www.google.com/maps?q=${coords[0]},${coords[1]}`;
                                                    window.open(url, '_blank');
                                                }
                                            }
                                        }}
                                        className="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-sm flex items-center justify-center gap-2"
                                    >
                                        <Icons.MapPin className="w-4 h-4" />
                                        Lihat Lokasi
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // BAGIAN 7: RENDER UTAMA
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
