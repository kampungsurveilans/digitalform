
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Sistem Surveilans Modern</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.015em;
            -webkit-tap-highlight-color: transparent; 
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            letter-spacing: -0.025em;
            line-height: 1.2;
        }
        
        .text-display {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -0.03em;
            line-height: 1.1;
        }
        
        .text-title {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .text-subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            line-height: 1.4;
        }
        
        .text-body {
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .text-caption {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .text-micro {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        input, select, textarea, button {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        
        .font-mono {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Fira Mono', 'Droid Sans Mono', 'Courier New', monospace;
            letter-spacing: -0.01em;
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        :focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .typography-spacing > * + * {
            margin-top: 1.5em;
        }
        
        .readable-text {
            max-width: 65ch;
            line-height: 1.75;
        }
        
        .uppercase-input {
            text-transform: uppercase;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .pulse-notification {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Responsive improvements for mobile */
        @media (max-width: 640px) {
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-scroll table {
                min-width: 768px;
            }
            
            .mobile-stack {
                flex-direction: column;
            }
            
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            
            .mobile-button-group {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .mobile-button-group button {
                flex: 1;
                min-width: 120px;
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // BAGIAN 1: KONFIGURASI DAN DATA
        const { useState, useEffect, useRef } = React;

        const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAX18Jk0pOqXyV3kY0sxgbt3xC6Th1VbWU",
    authDomain: "campak-e836a.firebaseapp.com",
    projectId: "campak-e836a",
    storageBucket: "campak-e836a.firebasestorage.app",
    messagingSenderId: "451728366574",
    appId: "1:451728366574:web:87ee770d010ef7dc93ccff",
    measurementId: "G-F3SYCYF5YS"
};

let dbAuth, dbStore;
try {
    const firebaseApp = firebase.apps.length 
        ? firebase.apps[0] 
        : firebase.initializeApp(FIREBASE_CONFIG);
    
    console.log("Firebase App Name:", firebaseApp.name);
    
    dbAuth = firebase.auth();
    dbStore = firebase.firestore();
    
    console.log("Firebase initialized successfully");
    console.log("Auth available:", !!dbAuth);
    console.log("Firestore available:", !!dbStore);
} catch (e) { 
    console.error("Firebase Initialization Error:", e); 
    console.error("Error details:", e.code, e.message);
}

        const LAYANAN_BY_KABUPATEN = {
    "Sambas": [
        { nama: "Puskesmas Galing", jenis: "Puskesmas" },
        { nama: "Puskesmas Matang Suri", jenis: "Puskesmas" },
        { nama: "Puskesmas Paloh", jenis: "Puskesmas" },
        { nama: "Puskesmas Pemangkat", jenis: "Puskesmas" },
        { nama: "Puskesmas Pimpinan", jenis: "Puskesmas" },
        { nama: "Puskesmas Sajad", jenis: "Puskesmas" },
        { nama: "Puskesmas Sajingan Besar", jenis: "Puskesmas" },
        { nama: "Puskesmas Salatiga", jenis: "Puskesmas" },
        { nama: "Puskesmas Sambas", jenis: "Puskesmas" },
        { nama: "Puskesmas Satai", jenis: "Puskesmas" },
        { nama: "Puskesmas Sebangkau", jenis: "Puskesmas" },
        { nama: "Puskesmas Sebawi", jenis: "Puskesmas" },
        { nama: "Puskesmas Segarau", jenis: "Puskesmas" },
        { nama: "Puskesmas Sejangkung", jenis: "Puskesmas" },
        { nama: "Puskesmas Sekura", jenis: "Puskesmas" },
        { nama: "Puskesmas Selakau", jenis: "Puskesmas" },
        { nama: "Puskesmas Selakau Timur", jenis: "Puskesmas" },
        { nama: "Puskesmas Semberang", jenis: "Puskesmas" },
        { nama: "Puskesmas Semparuk", jenis: "Puskesmas" },
        { nama: "Puskesmas Sentebang", jenis: "Puskesmas" },
        { nama: "Puskesmas Simpang Empat", jenis: "Puskesmas" },
        { nama: "Puskesmas Subah", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Baru", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Kelambu", jenis: "Puskesmas" },
        { nama: "Puskesmas Tebas", jenis: "Puskesmas" },
        { nama: "Puskesmas Tekarang", jenis: "Puskesmas" },
        { nama: "Puskesmas Temajuk", jenis: "Puskesmas" },
        { nama: "Puskesmas Terigas", jenis: "Puskesmas" },
        { nama: "RS Santa Elizabeth", jenis: "Rumah Sakit" },
        { nama: "RSUD Pemangkat", jenis: "Rumah Sakit" },
        { nama: "RSUD Sambas", jenis: "Rumah Sakit" },
        { nama: "RSUD Teluk Keramat", jenis: "Rumah Sakit" }
    ],
    "Bengkayang": [
        { nama: "Puskesmas Bengkayang", jenis: "Puskesmas" },
        { nama: "Puskesmas Capkala", jenis: "Puskesmas" },
        { nama: "Puskesmas Jagoi Babang", jenis: "Puskesmas" },
        { nama: "Puskesmas Ledo", jenis: "Puskesmas" },
        { nama: "Puskesmas Lembah Bawang", jenis: "Puskesmas" },
        { nama: "Puskesmas Lumar", jenis: "Puskesmas" },
        { nama: "Puskesmas Monterado", jenis: "Puskesmas" },
        { nama: "Puskesmas Samalantan", jenis: "Puskesmas" },
        { nama: "Puskesmas Sanggau Ledo", jenis: "Puskesmas" },
        { nama: "Puskesmas Seluas", jenis: "Puskesmas" },
        { nama: "Puskesmas Siding", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Betung", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Duri", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Raya", jenis: "Puskesmas" },
        { nama: "Puskesmas Suti Semarang", jenis: "Puskesmas" },
        { nama: "Puskesmas Teriak", jenis: "Puskesmas" },
        { nama: "Puskesmas Tujuh Belas", jenis: "Puskesmas" },
        { nama: "RS Bethesda Serukam", jenis: "Rumah Sakit" },
        { nama: "RSUD Drs. Jacobus Luna, M. Si Bengkayang", jenis: "Rumah Sakit" }
    ],
    "Landak": [
        { nama: "Puskesmas Darit", jenis: "Puskesmas" },
        { nama: "Puskesmas Jelimpo", jenis: "Puskesmas" },
        { nama: "Puskesmas Karangan", jenis: "Puskesmas" },
        { nama: "Puskesmas Kuala Behe", jenis: "Puskesmas" },
        { nama: "Puskesmas Mandor", jenis: "Puskesmas" },
        { nama: "Puskesmas Menjalin", jenis: "Puskesmas" },
        { nama: "Puskesmas Meranti", jenis: "Puskesmas" },
        { nama: "Puskesmas Ngabang", jenis: "Puskesmas" },
        { nama: "Puskesmas Pahauman", jenis: "Puskesmas" },
        { nama: "Puskesmas Sebangki", jenis: "Puskesmas" },
        { nama: "Puskesmas Semata", jenis: "Puskesmas" },
        { nama: "Puskesmas Senakin", jenis: "Puskesmas" },
        { nama: "Puskesmas Serimbu", jenis: "Puskesmas" },
        { nama: "Puskesmas Sidas", jenis: "Puskesmas" },
        { nama: "Puskesmas Simpang Tiga", jenis: "Puskesmas" },
        { nama: "Puskesmas Sompak", jenis: "Puskesmas" },
        { nama: "RSUD Landak", jenis: "Rumah Sakit" }
    ],
    "Mempawah": [
        { nama: "Puskesmas Anjungan", jenis: "Puskesmas" },
        { nama: "Puskesmas Antibar", jenis: "Puskesmas" },
        { nama: "Puskesmas Jungkat", jenis: "Puskesmas" },
        { nama: "Puskesmas Mempawah", jenis: "Puskesmas" },
        { nama: "Puskesmas Sadaniang", jenis: "Puskesmas" },
        { nama: "Puskesmas Segedong", jenis: "Puskesmas" },
        { nama: "Puskesmas Semudun", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Bakau Kecil", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Kunyit", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Pinyuh", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Purun Kecil", jenis: "Puskesmas" },
        { nama: "Puskesmas Takong", jenis: "Puskesmas" },
        { nama: "Puskesmas Toho", jenis: "Puskesmas" },
        { nama: "Puskesmas Wajok Hulu", jenis: "Puskesmas" },
        { nama: "RSUD dr. Rubini Mempawah", jenis: "Rumah Sakit" }
    ],
    "Sanggau": [
        { nama: "Puskesmas Balai Karangan", jenis: "Puskesmas" },
        { nama: "Puskesmas Balai Sebut", jenis: "Puskesmas" },
        { nama: "Puskesmas Batang Tarang", jenis: "Puskesmas" },
        { nama: "Puskesmas Beduwai", jenis: "Puskesmas" },
        { nama: "Puskesmas Belangin III", jenis: "Puskesmas" },
        { nama: "Puskesmas Bonti", jenis: "Puskesmas" },
        { nama: "Puskesmas Entikong", jenis: "Puskesmas" },
        { nama: "Puskesmas Harapan Makmur", jenis: "Puskesmas" },
        { nama: "Puskesmas Kampung Kawat", jenis: "Puskesmas" },
        { nama: "Puskesmas Kedukul", jenis: "Puskesmas" },
        { nama: "Puskesmas Kembayan", jenis: "Puskesmas" },
        { nama: "Puskesmas Meliau", jenis: "Puskesmas" },
        { nama: "Puskesmas Noyan", jenis: "Puskesmas" },
        { nama: "Puskesmas Pusat Damai", jenis: "Puskesmas" },
        { nama: "Puskesmas Sanggau", jenis: "Puskesmas" },
        { nama: "Puskesmas Sosok", jenis: "Puskesmas" },
        { nama: "Puskesmas Tanjung Sekayam", jenis: "Puskesmas" },
        { nama: "Puskesmas Tayan", jenis: "Puskesmas" },
        { nama: "Puskesmas Teraju", jenis: "Puskesmas" },
        { nama: "RS Parindu", jenis: "Rumah Sakit" },
        { nama: "RS Sentra Medika Sanggau", jenis: "Rumah Sakit" },
        { nama: "RSUD M. Th. Djaman Sanggau", jenis: "Rumah Sakit" },
        { nama: "RSUD Temenggung Gergaji", jenis: "Rumah Sakit" }
    ],
    "Ketapang": [
        { nama: "Puskesmas Air Upas", jenis: "Puskesmas" },
        { nama: "Puskesmas Balai Berkuak", jenis: "Puskesmas" },
        { nama: "Puskesmas Hulu Sungai", jenis: "Puskesmas" },
        { nama: "Puskesmas Kedondong", jenis: "Puskesmas" },
        { nama: "Puskesmas Kendawangan", jenis: "Puskesmas" },
        { nama: "Puskesmas Kuala Satong", jenis: "Puskesmas" },
        { nama: "Puskesmas Manis Mata", jenis: "Puskesmas" },
        { nama: "Puskesmas Marau", jenis: "Puskesmas" },
        { nama: "Puskesmas Mulia Baru", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Tayap", jenis: "Puskesmas" },
        { nama: "Puskesmas Pemahan", jenis: "Puskesmas" },
        { nama: "Puskesmas Pesaguan", jenis: "Puskesmas" },
        { nama: "Puskesmas Riam", jenis: "Puskesmas" },
        { nama: "Puskesmas Sandai", jenis: "Puskesmas" },
        { nama: "Puskesmas Simpang Dua", jenis: "Puskesmas" },
        { nama: "Puskesmas Suka Bangun", jenis: "Puskesmas" },
        { nama: "Puskesmas Sukamulya", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Awan", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Besar", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Laur", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Melayu", jenis: "Puskesmas" },
        { nama: "Puskesmas Tanjung Pura", jenis: "Puskesmas" },
        { nama: "Puskesmas Tuan Tuan", jenis: "Puskesmas" },
        { nama: "Puskesmas Tumbang Titi", jenis: "Puskesmas" },
        { nama: "RS Fatima Ketapang", jenis: "Rumah Sakit" },
        { nama: "RSIA Permata Bunda Ketapang", jenis: "Rumah Sakit" },
        { nama: "RSUD dr. Agoesdjam", jenis: "Rumah Sakit" }
    ],
    "Sintang": [
        { nama: "Puskesmas Dara Juanti", jenis: "Puskesmas" },
        { nama: "Puskesmas Dedai", jenis: "Puskesmas" },
        { nama: "Puskesmas Emparu", jenis: "Puskesmas" },
        { nama: "Puskesmas Jasa", jenis: "Puskesmas" },
        { nama: "Puskesmas Jelimpau", jenis: "Puskesmas" },
        { nama: "Puskesmas Kebong", jenis: "Puskesmas" },
        { nama: "Puskesmas Kemangai", jenis: "Puskesmas" },
        { nama: "Puskesmas Mensiku", jenis: "Puskesmas" },
        { nama: "Puskesmas Merakai", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Ketungau", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Lebang", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Mau", jenis: "Puskesmas" },
        { nama: "Puskesmas Pandan", jenis: "Puskesmas" },
        { nama: "Puskesmas Sekubang", jenis: "Puskesmas" },
        { nama: "Puskesmas Senaning", jenis: "Puskesmas" },
        { nama: "Puskesmas Sepauk", jenis: "Puskesmas" },
        { nama: "Puskesmas Serangas", jenis: "Puskesmas" },
        { nama: "Puskesmas Serawai", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Durian Sintang", jenis: "Puskesmas" },
        { nama: "Puskesmas Tanjung Puri", jenis: "Puskesmas" },
        { nama: "Puskesmas Tebidah", jenis: "Puskesmas" },
        { nama: "Puskesmas Tempunak", jenis: "Puskesmas" },
        { nama: "RS Anugrah Bunda Jaya", jenis: "Rumah Sakit" },
        { nama: "RS Sayang Ibu Sintang", jenis: "Rumah Sakit" },
        { nama: "RS Tk. IV 12.07.02 Sintang", jenis: "Rumah Sakit" },
        { nama: "RSIA Bujang Dara", jenis: "Rumah Sakit" },
        { nama: "RSUD Ade Muhammad Djoen Sintang", jenis: "Rumah Sakit" },
        { nama: "RSUD Serawai", jenis: "Rumah Sakit" }
    ],
    "Kapuas Hulu": [
        { nama: "Puskesmas Badau", jenis: "Puskesmas" },
        { nama: "Puskesmas Batang Lupar", jenis: "Puskesmas" },
        { nama: "Puskesmas Bika", jenis: "Puskesmas" },
        { nama: "Puskesmas Boyan Tanjung", jenis: "Puskesmas" },
        { nama: "Puskesmas Bunut Hilir", jenis: "Puskesmas" },
        { nama: "Puskesmas Bunut Hulu", jenis: "Puskesmas" },
        { nama: "Puskesmas Embaloh Hilir", jenis: "Puskesmas" },
        { nama: "Puskesmas Embaloh Hulu", jenis: "Puskesmas" },
        { nama: "Puskesmas Empanang", jenis: "Puskesmas" },
        { nama: "Puskesmas Hulu Gurung", jenis: "Puskesmas" },
        { nama: "Puskesmas Jongkong", jenis: "Puskesmas" },
        { nama: "Puskesmas Kalis", jenis: "Puskesmas" },
        { nama: "Puskesmas Mentebah", jenis: "Puskesmas" },
        { nama: "Puskesmas Pengkadan", jenis: "Puskesmas" },
        { nama: "Puskesmas Puring Kencana", jenis: "Puskesmas" },
        { nama: "Puskesmas Putussibau Selatan", jenis: "Puskesmas" },
        { nama: "Puskesmas Putussibau Utara", jenis: "Puskesmas" },
        { nama: "Puskesmas Seberuang", jenis: "Puskesmas" },
        { nama: "Puskesmas Selimbau", jenis: "Puskesmas" },
        { nama: "Puskesmas Semitau", jenis: "Puskesmas" },
        { nama: "Puskesmas Silat Hilir", jenis: "Puskesmas" },
        { nama: "Puskesmas Silat Hulu", jenis: "Puskesmas" },
        { nama: "Puskesmas Suhaid", jenis: "Puskesmas" },
        { nama: "RS Bergerak Badau Kapuas Hulu", jenis: "Rumah Sakit" },
        { nama: "RSUD dr. Achmad Diponegoro Putussibau", jenis: "Rumah Sakit" },
        { nama: "RSUD Semitau", jenis: "Rumah Sakit" }
    ],
    "Sekadau": [
        { nama: "Puskesmas Balai Sepuak", jenis: "Puskesmas" },
        { nama: "Puskesmas Bukit Rambat", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Belitang", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Mahap", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Taman", jenis: "Puskesmas" },
        { nama: "Puskesmas Rawak", jenis: "Puskesmas" },
        { nama: "Puskesmas Sebetung", jenis: "Puskesmas" },
        { nama: "Puskesmas Sekadau", jenis: "Puskesmas" },
        { nama: "Puskesmas Selalong", jenis: "Puskesmas" },
        { nama: "Puskesmas Simpang Empat Kayu Lapis", jenis: "Puskesmas" },
        { nama: "Puskesmas SP III Trans", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Ayak", jenis: "Puskesmas" },
        { nama: "Puskesmas Tapang Perodah", jenis: "Puskesmas" },
        { nama: "RSUD Sekadau", jenis: "Rumah Sakit" }
    ],
    "Melawi": [
        { nama: "Puskesmas Ella Hilir", jenis: "Puskesmas" },
        { nama: "Puskesmas Kota Baru", jenis: "Puskesmas" },
        { nama: "Puskesmas Manding", jenis: "Puskesmas" },
        { nama: "Puskesmas Manggala", jenis: "Puskesmas" },
        { nama: "Puskesmas Menukung", jenis: "Puskesmas" },
        { nama: "Puskesmas Nanga Pinoh", jenis: "Puskesmas" },
        { nama: "Puskesmas Pemuar", jenis: "Puskesmas" },
        { nama: "Puskesmas Sayan", jenis: "Puskesmas" },
        { nama: "Puskesmas Sokan", jenis: "Puskesmas" },
        { nama: "Puskesmas Tiong Keranjik", jenis: "Puskesmas" },
        { nama: "Puskesmas Ulak Muid", jenis: "Puskesmas" },
        { nama: "RS Citra Husada Nanga Pinoh", jenis: "Rumah Sakit" },
        { nama: "RS Kasih Bunda Jaya Nanga Pinoh", jenis: "Rumah Sakit" },
        { nama: "RSUD Belimbing", jenis: "Rumah Sakit" },
        { nama: "RSUD Melawi", jenis: "Rumah Sakit" }
    ],
    "Kayong Utara": [
        { nama: "Puskesmas Dusun Besar", jenis: "Puskesmas" },
        { nama: "Puskesmas Matan Jaya", jenis: "Puskesmas" },
        { nama: "Puskesmas Padang", jenis: "Puskesmas" },
        { nama: "Puskesmas Pelapis", jenis: "Puskesmas" },
        { nama: "Puskesmas Siduk", jenis: "Puskesmas" },
        { nama: "Puskesmas Sukadana", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Paduan", jenis: "Puskesmas" },
        { nama: "Puskesmas Tanjung Satai", jenis: "Puskesmas" },
        { nama: "Puskesmas Telaga Arum", jenis: "Puskesmas" },
        { nama: "Puskesmas Teluk Batang", jenis: "Puskesmas" },
        { nama: "Puskesmas Teluk Melano", jenis: "Puskesmas" },
        { nama: "RSUD Sultan Muhammad Jamaludin I", jenis: "Rumah Sakit" }
    ],
    "Kubu Raya": [
        { nama: "Puskesmas Air Putih", jenis: "Puskesmas" },
        { nama: "Puskesmas Batu Ampar", jenis: "Puskesmas" },
        { nama: "Puskesmas Kakap", jenis: "Puskesmas" },
        { nama: "Puskesmas Korpri", jenis: "Puskesmas" },
        { nama: "Puskesmas Kuala Mandor B", jenis: "Puskesmas" },
        { nama: "Puskesmas Kubu", jenis: "Puskesmas" },
        { nama: "Puskesmas Lingga", jenis: "Puskesmas" },
        { nama: "Puskesmas Padang Tikar", jenis: "Puskesmas" },
        { nama: "Puskesmas Pal Sembilan", jenis: "Puskesmas" },
        { nama: "Puskesmas Parit Timur", jenis: "Puskesmas" },
        { nama: "Puskesmas Punggur", jenis: "Puskesmas" },
        { nama: "Puskesmas Rasau Jaya", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Ambawang", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Asam", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Durian", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Kerawang", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Radak", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Raya Dalam", jenis: "Puskesmas" },
        { nama: "Puskesmas Sungai Rengas", jenis: "Puskesmas" },
        { nama: "Puskesmas Teluk Pakedai", jenis: "Puskesmas" },
        { nama: "Puskesmas Terentang", jenis: "Puskesmas" },
        { nama: "RS Tk. II Kartika Husada Kesdam XII Tanjungpura", jenis: "Rumah Sakit" },
        { nama: "RSAU dr. Mohammad Sutomo", jenis: "Rumah Sakit" },
        { nama: "RSIA Anugrah", jenis: "Rumah Sakit" },
        { nama: "RSUD Kubu Raya", jenis: "Rumah Sakit" }
    ],
    "Kota Pontianak": [
        { nama: "Puskesmas Alianyang", jenis: "Puskesmas" },
        { nama: "Puskesmas Banjar Serasan", jenis: "Puskesmas" },
        { nama: "Puskesmas Gang Sehat", jenis: "Puskesmas" },
        { nama: "Puskesmas Kampung Bali", jenis: "Puskesmas" },
        { nama: "Puskesmas Kampung Bangka", jenis: "Puskesmas" },
        { nama: "Puskesmas Kampung Dalam", jenis: "Puskesmas" },
        { nama: "Puskesmas Karya Mulia", jenis: "Puskesmas" },
        { nama: "Puskesmas Khatulistiwa", jenis: "Puskesmas" },
        { nama: "Puskesmas Kom. Yos Sudarso", jenis: "Puskesmas" },
        { nama: "Puskesmas Pal Lima", jenis: "Puskesmas" },
        { nama: "Puskesmas Pal Tiga", jenis: "Puskesmas" },
        { nama: "Puskesmas Parit Haji Husin II", jenis: "Puskesmas" },
        { nama: "Puskesmas Parit Mayor", jenis: "Puskesmas" },
        { nama: "Puskesmas Perumnas I", jenis: "Puskesmas" },
        { nama: "Puskesmas Perumnas II", jenis: "Puskesmas" },
        { nama: "Puskesmas Purnama", jenis: "Puskesmas" },
        { nama: "Puskesmas Saigon", jenis: "Puskesmas" },
        { nama: "Puskesmas Siantan Hilir", jenis: "Puskesmas" },
        { nama: "Puskesmas Siantan Hulu", jenis: "Puskesmas" },
        { nama: "Puskesmas Siantan Tengah", jenis: "Puskesmas" },
        { nama: "Puskesmas Tambelan Sampit", jenis: "Puskesmas" },
        { nama: "Puskesmas Tanjung Hulu", jenis: "Puskesmas" },
        { nama: "Puskesmas Telaga Biru", jenis: "Puskesmas" },
        { nama: "RS Anugerah Bunda Khatulistiwa", jenis: "Rumah Sakit" },
        { nama: "RS Bersalin Jeumpa Pontianak", jenis: "Rumah Sakit" },
        { nama: "RS Bhayangkara Tk. III Anton Soedjarwo Pontianak", jenis: "Rumah Sakit" },
        { nama: "RS Islam Yarsi Pontianak", jenis: "Rumah Sakit" },
        { nama: "RS Jiwa Daerah Sungai Bangkong", jenis: "Rumah Sakit" },
        { nama: "RS Kharitas Bhakti", jenis: "Rumah Sakit" },
        { nama: "RS Medika Djaya", jenis: "Rumah Sakit" },
        { nama: "RS Mitra Medika Pontianak", jenis: "Rumah Sakit" },
        { nama: "RS Pro Medika Pontianak", jenis: "Rumah Sakit" },
        { nama: "RS St. Antonius", jenis: "Rumah Sakit" },
        { nama: "RS Universitas Tanjungpura", jenis: "Rumah Sakit" },
        { nama: "RSIA Nabasa", jenis: "Rumah Sakit" },
        { nama: "RSUD dr. Soedarso", jenis: "Rumah Sakit" },
        { nama: "RSUD Pontianak Utara", jenis: "Rumah Sakit" },
        { nama: "RSUD Sultan Syarif Mohammad Alkadrie", jenis: "Rumah Sakit" }
    ],
    "Kota Singkawang": [
        { nama: "Puskesmas Singkawang Barat I", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Barat II", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Selatan I", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Selatan II", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Tengah I", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Tengah II", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Timur I", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Timur II", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Utara I", jenis: "Puskesmas" },
        { nama: "Puskesmas Singkawang Utara II", jenis: "Puskesmas" },
        { nama: "RS Harapan Bersama", jenis: "Rumah Sakit" },
        { nama: "RS Jiwa Provinsi Kalimantan Barat", jenis: "Rumah Sakit" },
        { nama: "RS Kusta Alverno Singkawang", jenis: "Rumah Sakit" },
        { nama: "RS Sa'adah", jenis: "Rumah Sakit" },
        { nama: "RS Santo Vincentius", jenis: "Rumah Sakit" },
        { nama: "RS Tk. IV 12.07.01 Singkawang", jenis: "Rumah Sakit" },
        { nama: "RSIA Wempe Singkawang", jenis: "Rumah Sakit" },
        { nama: "RSUD dr. Abdul Aziz", jenis: "Rumah Sakit" }
    ]
};

        const DAFTAR_KABUPATEN = [
    "Sambas", "Bengkayang", "Landak", "Mempawah", "Sanggau", 
    "Ketapang", "Sintang", "Kapuas Hulu", "Sekadau", "Melawi",
    "Kayong Utara", "Kubu Raya", "Kota Pontianak", "Kota Singkawang"
];

        const DATA_WILAYAH_MAPPING = {
    "Kota Pontianak": {
        "Pontianak Barat": ["Pal Lima", "Sungai Beliung", "Sungai Jawi Dalam", "Sungai Jawi Luar"],
        "Pontianak Kota": ["Darat Sekip", "Mariana", "Sungai Bangkong", "Sungai Jawi", "Tengah"],
        "Pontianak Selatan": ["Akcaya", "Benua Melayu Darat", "Benua Melayu Laut", "Kota Baru", "Parit Tokaya"],
        "Pontianak Tenggara": ["Bangka Belitung Darat", "Bangka Belitung Laut", "Bansir Darat", "Bansir Laut"],
        "Pontianak Timur": ["Banjar Serasan", "Dalam Bugis", "Parit Mayor", "Saigon", "Tambelan Sampit", "Tanjung Hilir", "Tanjung Hulu"],
        "Pontianak Utara": ["Batulayang", "Siantan Hilir", "Siantan Hulu", "Siantan Tengah"]
    },
    "Kota Singkawang": {
        "Singkawang Barat": ["Kuala", "Pasiran", "Melayu", "Tengah"],
        "Singkawang Selatan": ["Pangmilang", "Sagatani", "Sedau", "Sijangkung"],
        "Singkawang Tengah": ["Bukit Batu", "Condong", "Jawa", "Roban", "Sekip Lama", "Sungai Wie"],
        "Singkawang Timur": ["Bagak Sahwa", "Mayasopa", "Nyarumkop", "Pajintan", "Sanggau Kulor"],
        "Singkawang Utara": ["Naram", "Semelagi Kecil", "Setapuk Besar", "Setapuk Kecil", "Sungai Bulan", "Sungai Garam Hilir", "Sungai Rasau"]
    },
    "Kubu Raya": {
        "Batu Ampar": ["Ambarawa", "Batu Ampar", "Muara Tiga", "Nipah Panjang", "Padang Tikar I", "Padang Tikar II", "Sumber Agung", "Sungai Besar", "Sungai Jawi", "Sungai Kerawang", "Tasik Malaya", "Teluk Nibung", "Tanjung Harapan", "Medan Mas", "Sungai Krawang"],
        "Kuala Mandor B": ["Kuala Mandor A", "Kuala Mandor B", "Kubu Padi", "Retok", "Sungai Enau"],
        "Kubu": ["Air Putih", "Ambarawa", "Dabong", "Jangkang Dua", "Jangkang Satu", "Kampung Baru", "Kubu", "Mengkalang", "Mengkalang Jambu", "Olak-Olak Kubu", "Pelita Jaya", "Pinang Dalam", "Pinang Luar", "Sei Bemban", "Sepakat Baru", "Seruat Dua", "Seruat Tiga", "Sungai Selamat", "Sungai Terus", "Teluk Nangka"],
        "Rasau Jaya": ["Bintang Mas", "Pematang Tujuh", "Rasau Jaya Dua", "Rasau Jaya Satu", "Rasau Jaya Tiga", "Rasau Jaya Umum"],
        "Sungai Ambawang": ["Ampera Raya", "Bengkarek", "Durian", "Jawa Tengah", "Korek", "Lingga", "Mega Timur", "Pancaroba", "Pasak", "Pasak Piang", "Puguk", "Simpang Kanan", "Simpang Kiri", "Sungai Ambawang Kuala", "Sungai Malaya", "Teluk Bakung"],
        "Sungai Kakap": ["Jeruju Besar", "Kalimas", "Pal Sembilan", "Punggur Besar", "Punggur Kapuas", "Punggur Kecil", "Sungai Belidak", "Sungai Itik", "Sungai Kakap", "Sungai Kupah", "Sungai Rengas", "Sepuk Laut", "Tanjung Saleh"],
        "Sungai Raya": ["Arang Limbung", "Gunung Tamang", "Kapur", "Kuala Dua", "Limbung", "Madusari", "Mekar Baru", "Mekar Sari", "Parit Baru", "Pulau Limbung", "Sungai Ambangah", "Sungai Asam", "Sungai Bulan", "Sungai Raya", "Sungai Raya Dalam", "Tebang Kacang", "Teluk Kapuas"],
        "Teluk Pakedai": ["Arus Deras", "Kuala Karang", "Madura", "Pasir Putih", "Selat Remis", "Seruat I", "Sungai Deras", "Sungai Nibung", "Tanjung Bunga", "Teluk Pakedai I", "Teluk Pakedai II", "Teluk Pakedai Hulu", "Sungai Nipah"],
        "Terentang": ["Betuah", "Permata", "Radak Baru", "Radak Dua", "Radak Satu", "Sungai Dungun", "Sungai Radak", "Teluk Bayur", "Terentang Hilir", "Terentang Hulu"]
    },
    "Sambas": {
        "Galing": [],
        "Jawai": [],
        "Jawai Selatan": [],
        "Paloh": [],
        "Pemangkat": [],
        "Sajad": [],
        "Sajingan Besar": [],
        "Salatiga": [],
        "Sambas": [],
        "Sebawi": [],
        "Sejangkung": [],
        "Selakau": [],
        "Selakau Timur": [],
        "Semparuk": [],
        "Subah": [],
        "Tangaran": [],
        "Tebas": [],
        "Tekarang": [],
        "Teluk Keramat": []
    },
    "Mempawah": {
        "Anjongan": [],
        "Mempawah Hilir": [],
        "Mempawah Timur": [],
        "Sadaniang": [],
        "Segedong": [],
        "Siantan": [],
        "Sungai Kunyit": [],
        "Sungai Pinyuh": [],
        "Toho": []
    },
    "Sanggau": {
        "Balai": [],
        "Beduai": [],
        "Bonti": [],
        "Entikong": [],
        "Jangkang": [],
        "Kapuas": [],
        "Kembayan": [],
        "Meliau": [],
        "Mukok": [],
        "Noyan": [],
        "Parindu": [],
        "Sekayam": [],
        "Tayan Hilir": [],
        "Tayan Hulu": [],
        "Toba": []
    },
    "Ketapang": {
        "Air Upas": [],
        "Benua Kayong": [],
        "Delta Pawan": [],
        "Hulu Sungai": [],
        "Jelai Hulu": [],
        "Kendawangan": [],
        "Manis Mata": [],
        "Marau": [],
        "Matan Hilir Selatan": [],
        "Matan Hilir Utara": [],
        "Muara Pawan": [],
        "Nanga Tayap": [],
        "Pemahan": [],
        "Sandai": [],
        "Simpang Dua": [],
        "Simpang Hulu": [],
        "Singkup": [],
        "Sungai Laur": [],
        "Sungai Melayu Rayak": [],
        "Tumbang Titi": []
    },
    "Sintang": {
        "Ambalau": [],
        "Binjai Hulu": [],
        "Dedai": [],
        "Kayan Hilir": [],
        "Kayan Hulu": [],
        "Kelam Permai": [],
        "Ketungau Hilir": [],
        "Ketungau Hulu": [],
        "Ketungau Tengah": [],
        "Sintang": [],
        "Sepauk": [],
        "Serawai": [],
        "Sungai Tebelian": [],
        "Tempunak": []
    },
    "Kapuas Hulu": {
        "Badau": [],
        "Batang Lupar": [],
        "Bika": [],
        "Boyan Tanjung": [],
        "Bunut Hilir": [],
        "Bunut Hulu": [],
        "Embaloh Hilir": [],
        "Embaloh Hulu": [],
        "Empanang": [],
        "Hulu Gurung": [],
        "Jongkong": [],
        "Kalis": [],
        "Mentebah": [],
        "Pengkadan": [],
        "Puring Kencana": [],
        "Putussibau Selatan": [],
        "Putussibau Utara": [],
        "Seberuang": [],
        "Selimbau": [],
        "Semitau": [],
        "Silat Hilir": [],
        "Silat Hulu": [],
        "Suhaid": []
    },
    "Bengkayang": {
        "Bengkayang": [],
        "Capkala": [],
        "Jagoi Babang": [],
        "Ledo": [],
        "Lembah Bawang": [],
        "Lumar": [],
        "Monterado": [],
        "Samalantan": [],
        "Sanggau Ledo": [],
        "Seluas": [],
        "Siding": [],
        "Sungai Betung": [],
        "Sungai Raya": [],
        "Sungai Raya Kepulauan": [],
        "Suti Semarang": [],
        "Teriak": [],
        "Tujuh Belas": []
    },
    "Landak": {
        "Air Besar": [],
        "Banyuke Hulu": [],
        "Jelimpo": [],
        "Kuala Behe": [],
        "Mandor": [],
        "Mempawah Hulu": [],
        "Menjalin": [],
        "Menyuke": [],
        "Meranti": [],
        "Ngabang": [],
        "Sebangki": [],
        "Sengah Temila": [],
        "Sompak": []
    },
    "Sekadau": {
        "Belitang": [],
        "Belitang Hilir": [],
        "Belitang Hulu": [],
        "Nanga Mahap": [],
        "Nanga Taman": [],
        "Sekadau Hilir": [],
        "Sekadau Hulu": []
    },
    "Melawi": {
        "Belimbing": [],
        "Belimbing Hulu": [],
        "Ella Hilir": [],
        "Menukung": [],
        "Nanga Pinoh": [],
        "Pinoh Selatan": [],
        "Pinoh Utara": [],
        "Sayan": [],
        "Sokan": [],
        "Tanah Pinoh": [],
        "Tanah Pinoh Barat": []
    },
    "Kayong Utara": {
        "Kepulauan Karimata": [],
        "Pulau Maya": [],
        "Seponti": [],
        "Simpang Hilir": [],
        "Sukadana": [],
        "Teluk Batang": []
    }
};

        const DATA_KOMPLIKASI = ["Diare", "B. Pneumonia", "Kebutaan", "Otitis media", "Pneumonia", "Encephalitis", "Malnutrisi", "Ulkus mukasa mulut", "Lainnya"];
        const ALL_SERVICES = Object.values(LAYANAN_BY_KABUPATEN)
    .flat()
    .map(item => item.nama)
    .filter((value, index, self) => self.indexOf(value) === index);

        const IconBase = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            AlertTriangle: (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Thermometer: (p) => <IconBase {...p}><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Syringe: (p) => <IconBase {...p}><path d="M18 6L6 18"/><path d="M21 12l-6 6"/><path d="M15 3l-3 3"/><path d="M3 21l6-6"/><path d="M9 3l3-3 5 5-3 3"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Shield: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>,
            Plane: (p) => <IconBase {...p}><path d="M2 22h20"/><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            XCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>,
            Gps: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            List: (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Archive: (p) => <IconBase {...p}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></IconBase>,
            Share: (p) => <IconBase {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></IconBase>,
            Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconBase>,
            Send: (p) => <IconBase {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>,
            Inbox: (p) => <IconBase {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></IconBase>,
            XOctagon: (p) => <IconBase {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            Eye: (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></IconBase>,
            Grid: (p) => <IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>,
            Database: (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            Home: (p) => <IconBase {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
            School: (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>,
            Hourglass: (p) => <IconBase {...p}><path d="M5 22h14"/><path d="M5 2h14"/><path d="M12 2v20"/><path d="M12 8l4 4-4 4"/><path d="M8 12l-4 4 4 4"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>
        };

        const mockUserDB = {
    checkAndCreateDefaultAdmin: async () => {
        // HAPUS fungsi pembuatan admin default
        // Biarkan kosong atau hanya log saja
        console.log("Admin default creation disabled - manual admin setup required");
    },
    
    // ... fungsi lainnya tetap sama
    getUsers: async () => { 
        if (!dbStore) return []; 
        try { 
            const snapshot = await dbStore.collection('users').get(); 
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        } catch (e) { 
            return []; 
        } 
    },
    
    addUser: async (user) => { 
        if (!dbStore) return false; 
        try { 
            // Cek duplikasi email
            const snap = await dbStore.collection('users').where('email', '==', user.email).get(); 
            if(!snap.empty) return false; 
            await dbStore.collection('users').add(user); 
            return true; 
        } catch (e) { 
            return false; 
        } 
    },
    
    deleteUser: async (id) => { 
        if (dbStore) await dbStore.collection('users').doc(id).delete(); 
    },
    
    authenticate: async (u, p) => { 
        return null; // Dinonaktifkan
    }
};

        const mockDB = {
    save: async (data) => { 
        console.log("Saving data to Firebase:", data.id);
        if (dbStore) {
            try {
                // Konversi data gejala dan komplikasi ke format Firestore
                const firestoreData = { ...data };
                
                // Konversi gejalaLain objek ke format YA/TIDAK
                if (firestoreData.gejalaLain && typeof firestoreData.gejalaLain === 'object') {
                    Object.keys(firestoreData.gejalaLain).forEach(key => {
                        firestoreData[`gejala_${key.replace(/\s+/g, '_')}`] = firestoreData.gejalaLain[key] ? 'YA' : 'TIDAK';
                    });
                }
                
                // Konversi komplikasi objek ke format YA/TIDAK
                if (firestoreData.komplikasi && typeof firestoreData.komplikasi === 'object') {
                    Object.keys(firestoreData.komplikasi).forEach(key => {
                        firestoreData[`komplikasi_${key.replace(/\s+/g, '_')}`] = firestoreData.komplikasi[key] ? 'YA' : 'TIDAK';
                    });
                }
                
                await dbStore.collection('forms').doc(data.id).set(firestoreData, { merge: true });
                console.log("Data saved successfully with YA/TIDAK format");
            } catch (e) {
                console.error("Error saving to Firebase:", e);
                throw e;
            }
        }
    },
            delete: async (id) => { 
                console.log("Deleting data from Firebase:", id);
                if (dbStore) {
                    try {
                        await dbStore.collection('forms').doc(id).delete();
                        console.log("Data deleted successfully");
                    } catch (e) {
                        console.error("Error deleting from Firebase:", e);
                        throw e;
                    }
                }
            },
            getById: async (id) => { 
                if (!dbStore) return null; 
                const doc = await dbStore.collection('forms').doc(id).get();
                return doc.exists ? doc.data() : null; 
            },
            countFinal: async () => { 
                if (!dbStore) return 0; 
                const snap = await dbStore.collection('forms').where('statusData', 'in', ['Final', 'Rejected']).get(); 
                return snap.size; 
            },
            getAllForms: async () => { 
                if (!dbStore) return []; 
                try {
                    const snap = await dbStore.collection('forms').orderBy('updatedAt', 'desc').get(); 
                    return snap.docs.map(d => d.data());
                } catch (e) {
                    console.error("Error getting all forms:", e);
                    return [];
                }
            },
            getFormsByStatus: async (statuses) => { 
                if (!dbStore) return []; 
                const snap = await dbStore.collection('forms').where('statusData', 'in', statuses).get(); 
                return snap.docs.map(d => d.data()).sort((a, b) => b.updatedAt - a.updatedAt); 
            }
        };
        
        // PERBAIKAN POINT 3: Fungsi untuk menghitung usia dalam format tahun bulan hari
        const calculateAge = (tanggalLahir) => {
            if (!tanggalLahir) return '';
            try {
                const birthDate = new Date(tanggalLahir);
                const today = new Date();
                
                let years = today.getFullYear() - birthDate.getFullYear();
                let months = today.getMonth() - birthDate.getMonth();
                let days = today.getDate() - birthDate.getDate();
                
                if (days < 0) {
                    months--;
                    const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                    days += lastMonth.getDate();
                }
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                return `${years} tahun ${months} bulan ${days} hari`;
            } catch (e) {
                return '';
            }
        };
        
        // Fungsi untuk menentukan current owner dengan logika yang benar
        const determineCurrentOwner = (formData) => {
            if (formData.currentOwner && formData.currentOwner !== '') {
                return formData.currentOwner;
            }
            
            if (formData.transferHistory && formData.transferHistory.length > 0) {
                const successfulTransfers = formData.transferHistory.filter(
                    record => record.action === 'diterima' || record.action === 'dikirim'
                );
                
                if (successfulTransfers.length > 0) {
                    const lastTransfer = successfulTransfers[successfulTransfers.length - 1];
                    
                    if (lastTransfer.newOwner) {
                        return lastTransfer.newOwner;
                    }
                    
                    if (lastTransfer.action === 'dikirim') {
                        return lastTransfer.from;
                    }
                    
                    if (lastTransfer.action === 'diterima') {
                        return lastTransfer.to;
                    }
                }
            }
            
            if (formData.statusData === 'Final' || formData.statusData === 'Baru' || formData.statusData === 'Draft') {
                return formData.createdUnit;
            }
            
            if (formData.statusData === 'Pending') {
                return formData.currentOwner || formData.createdUnit;
            }
            
            if (formData.statusData === 'Proses') {
                return formData.createdUnit;
            }
            
            if (formData.statusData === 'Ditolak') {
                if (formData.transferHistory && formData.transferHistory.length > 0) {
                    const sendRecords = formData.transferHistory.filter(r => r.action === 'dikirim');
                    if (sendRecords.length > 0) {
                        return sendRecords[sendRecords.length - 1].from;
                    }
                }
                return formData.createdUnit;
            }
            
            return formData.createdUnit;
        };

        // PERBAIKAN POINT 6: Export CSV dengan SEMUA kontak erat (maksimal 30)
        const exportToCSV = (data, filename, isRaw = false) => {
    if (!data || data.length === 0) { alert("Tidak ada data."); return; }
    let headers, csvRows;
    
    // Definisikan daftar gejala dan komplikasi
    const gejalaOptions = ['Batuk', 'Pilek', 'Mata Merah', 'Adenopathy', 'Arthralgia', 'Kehamilan', 'Lainnya'];
    const komplikasiOptions = DATA_KOMPLIKASI; // ['Diare', 'B. Pneumonia', 'Kebutaan', ...]
    
    if (isRaw) {
        headers = Object.keys(data[0]);
        csvRows = data.map(item => headers.map(header => `"${String(item[header]||'').replace(/"/g, '""')}"`).join(","));
    } else {
        // Buat headers untuk kontak erat (maksimal 30)
        const kontakEratHeaders = [];
        for (let i = 1; i <= 30; i++) {
            kontakEratHeaders.push(
                `Kontak Erat ${i} - Nama`,
                `Kontak Erat ${i} - Umur`,
                `Kontak Erat ${i} - Alamat`,
                `Kontak Erat ${i} - Hubungan`,
                `Kontak Erat ${i} - Imunisasi Campak/Rubella`,
                `Kontak Erat ${i} - Kondisi`
            );
        }
        
        headers = [
            "Nomor EPID", "Status", "Nama Kasus", "Jenis Kelamin", "Tanggal Lahir", "Usia",
            "Alamat", "Provinsi", "Kabupaten", "Kecamatan", "Kelurahan", "RT", "RW", 
            "Nama Orangtua", "No Kontak Orangtua", "Sumber Laporan", "Unit Pelapor", 
            "Tanggal Terima Laporan", "Tanggal Pelacakan Kasus", "Demam", "Tanggal Mulai Demam",
            "Ruam", "Tanggal Mulai Ruam",
            
            // Headers untuk gejala sebagai kolom terpisah
            ...gejalaOptions.map(g => `Gejala: ${g}`),
            "Gejala Lain Sebutkan", "Lokasi Adenopathy", "Bagian Sendi Arthralgia", "Umur Kehamilan",
            
            // Headers untuk komplikasi sebagai kolom terpisah
            ...komplikasiOptions.map(k => `Komplikasi: ${k}`),
            "Komplikasi Lainnya Sebutkan",
            
            "Dirawat", "Nama Rumah Sakit", "Nomor Rekam Medik", "Tanggal Masuk Rawat", "Tanggal Keluar Rawat",
            "Imunisasi Campak 1", "Sumber Campak 1", "Imunisasi Campak 2", "Sumber Campak 2",
            "Imunisasi BIAS", "Sumber BIAS", "Imunisasi MMR", "Sumber MMR",
            "Imunisasi Tambahan", "Sumber Tambahan", "Tanggal Imunisasi Terakhir",
            "Vitamin A", "Ada Kontak Sakit Sama", "Jumlah Kontak Sakit", "Bepergian",
            "Lokasi Bepergian", "Tanggal Pergi", "Tanggal Kembali", "Spesimen Darah",
            "Jenis Sample Darah", "Tanggal Ambil Darah", "Tanggal Kirim Darah",
            "Spesimen Lain", "Jenis Sampel Lain", "Jenis Sampel Lain Sebutkan",
            "Tanggal Ambil Lain", "Tanggal Kirim Lain", "Keadaan Saat Ini",
            "Pelaksana Investigasi", "Nama Sekolah", "Titik Lokasi", "Petugas Input",
            "Unit Pembuat", "Current Owner", "Tanggal Terakhir Update",
            
            // Headers kontak erat
            ...kontakEratHeaders
        ];
        
        csvRows = data.map(item => {
            // Fungsi helper untuk mendapatkan nilai gejala/komplikasi
            const getGejalaValue = (gejalaName) => {
                if (!item.gejalaLain) return 'TIDAK';
                
                // Jika format baru (objek)
                if (typeof item.gejalaLain === 'object' && !Array.isArray(item.gejalaLain)) {
                    return item.gejalaLain[gejalaName] ? 'YA' : 'TIDAK';
                }
                // Jika format lama (array) - untuk kompatibilitas
                else if (Array.isArray(item.gejalaLain)) {
                    return item.gejalaLain.includes(gejalaName) ? 'YA' : 'TIDAK';
                }
                return 'TIDAK';
            };
            
            const getKomplikasiValue = (komplikasiName) => {
                if (!item.komplikasi) return 'TIDAK';
                
                // Jika format baru (objek)
                if (typeof item.komplikasi === 'object' && !Array.isArray(item.komplikasi)) {
                    return item.komplikasi[komplikasiName] ? 'YA' : 'TIDAK';
                }
                // Jika format lama (array) - untuk kompatibilitas
                else if (Array.isArray(item.komplikasi)) {
                    return item.komplikasi.includes(komplikasiName) ? 'YA' : 'TIDAK';
                }
                return 'TIDAK';
            };
            
            // Fungsi untuk mendapatkan gejalaLainSebutkan (untuk "Lainnya")
            const getGejalaLainSebutkan = () => {
                if (item.gejalaLainSebutkan) return item.gejalaLainSebutkan;
                
                // Jika menggunakan format baru dengan objek Lainnya
                if (item.gejalaLain && item.gejalaLain.Lainnya && item.gejalaLainSebutkan) {
                    return item.gejalaLainSebutkan;
                }
                return '';
            };
            
            const baseRow = [
                `"${item.nomorEPID||''}"`, `"${item.statusData||''}"`, `"${item.namaKasus||''}"`, `"${item.jenisKelamin||''}"`, `"${item.tanggalLahir||''}"`, `"${calculateAge(item.tanggalLahir)}"`,
                `"${(item.alamat||'').replace(/"/g, '""')}"`, `"${item.provinsi||'Kalimantan Barat'}"`, `"${item.kabupaten||'Kota Pontianak'}"`, `"${item.kecamatan||''}"`, `"${item.kelurahan||''}"`, 
                `"${item.rt||''}"`, `"${item.rw||''}"`, `"${item.namaOrangtua||''}"`, `"${item.noKontakOrangtua||''}"`, `"${item.sumberLaporan||''}"`, 
                `"${item.namaUnitPelapor||''}"`, `"${item.tanggalTerimaLaporan||''}"`, `"${item.tanggalPelacakan||''}"`, `"${item.demam||''}"`, 
                `"${item.tanggalMulaiDemam||''}"`, `"${item.ruam||''}"`, `"${item.tanggalMulaiRuam||''}"`,
                
                // Nilai gejala sebagai YA/TIDAK untuk setiap kolom
                ...gejalaOptions.map(g => `"${getGejalaValue(g)}"`),
                
                // Gejala lainnya dan detail
                `"${getGejalaLainSebutkan()||''}"`,
                `"${item.lokasiAdenopathy||''}"`,
                `"${item.bagianSendiArthralgia||''}"`,
                `"${item.umurKehamilan||''}"`,
                
                // Nilai komplikasi sebagai YA/TIDAK untuk setiap kolom
                ...komplikasiOptions.map(k => `"${getKomplikasiValue(k)}"`),
                `"${item.komplikasiLainnyaSebutkan||''}"`,
                
                `"${item.dirawat||''}"`, `"${item.namaRumahSakit||''}"`, `"${item.nomorRekamMedik||''}"`, `"${item.tanggalMasukRawat||''}"`, `"${item.tanggalKeluarRawat||''}"`, 
                `"${item.imunisasiCampak1||''}"`, `"${item.sumberCampak1||''}"`, `"${item.imunisasiCampak2||''}"`, `"${item.sumberCampak2||''}"`, `"${item.imunisasiBIAS||''}"`, 
                `"${item.sumberBIAS||''}"`, `"${item.imunisasiMMR||''}"`, `"${item.sumberMMR||''}"`, `"${item.imunisasiTambahan||''}"`, `"${item.sumberTambahan||''}"`, 
                `"${item.tanggalImunisasiTerakhir||''}"`, `"${item.vitaminA||''}"`, `"${item.adaKontakSakitSama||''}"`, `"${item.jumlahKontakSakit||''}"`, `"${item.bepergian||''}"`, 
                `"${item.lokasiBepergian||''}"`, `"${item.tanggalPergi||''}"`, `"${item.tanggalKembali||''}"`, `"${item.spesimenDarah||''}"`, `"${Array.isArray(item.jenisSampleDarah) ? item.jenisSampleDarah.join(', ') : item.jenisSampleDarah||''}"`, 
                `"${item.tanggalAmbilDarah||''}"`, `"${item.tanggalKirimDarah||''}"`, `"${item.spesimenLain||''}"`, `"${Array.isArray(item.jenisSampelLain) ? item.jenisSampelLain.join(', ') : item.jenisSampelLain||''}"`, 
                `"${item.jenisSampelLainSebutkan||''}"`, `"${item.tanggalAmbilLain||''}"`, `"${item.tanggalKirimLain||''}"`, `"${item.keadaanSaatIni||''}"`, `"${item.pelaksanaInvestigasi||''}"`, 
                `"${item.namaSekolah||''}"`, `"${item.titikLokasi||''}"`, `"${item.createdBy||''}"`, `"${item.createdUnit||''}"`, `"${item.currentOwner || item.createdUnit}"`, 
                `"${new Date(item.updatedAt).toLocaleDateString()}"`
            ];
            
            // PERBAIKAN POINT 6: Tambahkan data kontak erat (maksimal 30)
            const kontakEratData = [];
            if (item.kontakErat && Array.isArray(item.kontakErat)) {
                for (let i = 0; i < 30; i++) {
                    if (i < item.kontakErat.length) {
                        const kontak = item.kontakErat[i];
                        kontakEratData.push(
                            `"${kontak.nama||''}"`,
                            `"${kontak.umur||''}"`,
                            `"${kontak.alamat||''}"`,
                            `"${kontak.hubungan||''}"`,
                            `"${kontak.imunisasiCampakRubella||''}"`,
                            `"${kontak.kondisi||''}"`
                        );
                    } else {
                        kontakEratData.push('', '', '', '', '', '');
                    }
                }
            } else {
                // Isi dengan kosong jika tidak ada kontak erat
                for (let i = 0; i < 30; i++) {
                    kontakEratData.push('', '', '', '', '', '');
                }
            }
            
            return [...baseRow, ...kontakEratData].join(",");
        });
    }
    
    const blob = new Blob([[headers.join(","), ...csvRows].join("\n")], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

        // BAGIAN 2: LOGIC & STATE
        const INITIAL_DATA = {
            id: '', updatedAt: 0, statusData: 'Baru', sharedTo: '', createdBy: '', createdUnit: '',
            originalUnit: '', currentOwner: '', transferHistory: [], nomorEPID: '', kasusKLB: '', 
            klbKe: '', nomorKLB: '', sumberLaporan: '', sumberLainnya: '', namaUnitPelapor: '',
            tanggalTerimaLaporan: '', tanggalPelacakan: '', namaKasus: '', jenisKelamin: '', 
            tanggalLahir: '', alamat: '', provinsi: 'Kalimantan Barat', kabupaten: '', 
            kecamatan: '', kelurahan: '', rw: '', rt: '', namaOrangtua: '', noKontakOrangtua: '',
            demam: '', tanggalMulaiDemam: '', ruam: '', tanggalMulaiRuam: '', 
            
            gejalaLain: {
        Batuk: false,
        Pilek: false,
        'Mata Merah': false,
        Adenopathy: false,
        Arthralgia: false,
        Kehamilan: false,
        Lainnya: false
    }, 
            gejalaLainSebutkan: '', 
            
            komplikasi: {
        Diare: false,
        'B. Pneumonia': false,
        Kebutaan: false,
        'Otitis media': false,
        Pneumonia: false,
        Encephalitis: false,
        Malnutrisi: false,
        'Ulkus mukasa mulut': false,
        Lainnya: false
    }, 
            
            komplikasiLainnyaSebutkan: '',lokasiAdenopathy: '',
            bagianSendiArthralgia: '', umurKehamilan: '', dirawat: '', namaRumahSakit: '', nomorRekamMedik: '', tanggalMasukRawat: '', tanggalKeluarRawat: '',
            imunisasiCampak1: '', sumberCampak1: '', imunisasiCampak2: '', sumberCampak2: '',
            imunisasiBIAS: '', sumberBIAS: '', imunisasiMMR: '', sumberMMR: '', imunisasiTambahan: '', 
            sumberTambahan: '', tanggalImunisasiTerakhir: '', vitaminA: '', adaKontakSakitSama: '', 
            jumlahKontakSakit: '', bepergian: '', lokasiBepergian: '', tanggalPergi: '', tanggalKembali: '',
            spesimenDarah: '', jenisSampleDarah: [], tanggalAmbilDarah: '', tanggalKirimDarah: '',
            spesimenLain: '', jenisSampelLain: [], jenisSampelLainSebutkan: '', tanggalAmbilLain: '', 
            tanggalKirimLain: '', keadaanSaatIni: '', pelaksanaInvestigasi: '', namaSekolah: '', 
            titikLokasi: '', epidManual: false,
            kontakErat: []
        };

        

        let lastEPIDNumber = 0;

        const validateManualEPID = (epid) => {
            if (!epid) return { valid: false, message: 'Nomor EPID tidak boleh kosong' };
            return { valid: true, message: '' };
        };

        

        const createTransferRecord = (action, fromUnit, toUnit, newOwner = null) => {
            const record = {
                action: action,
                from: fromUnit,
                to: toUnit,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            if (newOwner) {
                record.newOwner = newOwner;
                record.ownershipTransferred = true;
            }
            
            return record;
        };

        const sessionManager = {
    save: (user) => {
        const data = JSON.stringify(user);
        try { localStorage.setItem('epid_session', data); } catch (e) {}
        const d = new Date();
        d.setTime(d.getTime() + (7*24*60*60*1000));
        document.cookie = "epid_session=" + encodeURIComponent(data) + ";expires=" + d.toUTCString() + ";path=/;SameSite=None;Secure";
    },
    load: () => {
        try {
            const local = localStorage.getItem('epid_session');
            if (local) return JSON.parse(local);
        } catch (e) {}
        const name = "epid_session=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1);
            if (c.indexOf(name) == 0) {
                try { return JSON.parse(decodeURIComponent(c.substring(name.length, c.length))); } catch(e){}
            }
        }
        return null;
    },
    clear: () => {
        try { localStorage.removeItem('epid_session'); } catch (e) {}
        document.cookie = "epid_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    }
};

        // PERBAIKAN POINT 1: Hapus beforeunload dan popstate, hanya gunakan modal konfirmasi
        const setupPageUnloadWarning = () => {
            // Tidak melakukan apapun, hanya untuk kompatibilitas
        };

        const handleBeforeUnload = () => {
            // Tidak melakukan apapun
        };

        const handlePopState = () => {
            // Tidak melakukan apapun
        };

        // BAGIAN 3: KOMPONEN UI DASAR
        const Card = ({ children, className = "" }) => (<div className={`bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-6 ${className}`}>{children}</div>);

        const Input = ({ label, as = 'input', className, uppercase = false, ...props }) => (
            <div className={`w-full ${className} mb-4`}>
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{label}</label>
                {as === 'textarea' ? (
                    <textarea {...props} rows={3} className={`w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300 ${uppercase ? 'uppercase-input' : ''}`} />
                ) : (
                    <input {...props} className={`w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300 ${uppercase ? 'uppercase-input' : ''}`} />
                )}
            </div>
        );

        const Select = ({ label, children, ...props }) => (
            <div className="w-full mb-4">
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{label}</label>
                <div className="relative">
                    <select {...props} className="w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium appearance-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all outline-none border border-slate-200 text-body hover:border-slate-300">
                        {children}
                    </select>
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"><Icons.ChevronLeft className="-rotate-90 w-4 h-4"/></div>
                </div>
            </div>
        );

        const RadioGroup = ({ name, options, value, onChange }) => (
            <div className="flex flex-wrap gap-2 mb-4">
                {options.map(opt => (
                    <label key={opt} className={`flex-1 min-w-[100px] text-center py-3 px-4 rounded-lg cursor-pointer transition-all duration-300 font-medium text-sm capitalize relative overflow-hidden group ${value === opt ? 'bg-blue-600 text-white shadow-sm shadow-blue-500/30' : 'bg-slate-50 text-slate-600 hover:bg-slate-100 border border-slate-200'}`}>
                        <input type="radio" name={name} value={opt} checked={value === opt} onChange={onChange} className="hidden" />
                        <span className="relative z-10">{opt}</span>
                        {value === opt && <div className="absolute inset-0 bg-gradient-to-tr from-blue-600 to-indigo-500 z-0"></div>}
                    </label>
                ))}
            </div>
        );

        const Checkbox = ({ label, ...props }) => (
            <label className="flex items-center p-4 bg-slate-50 rounded-lg cursor-pointer transition active:scale-95 border border-transparent hover:border-slate-200 text-caption">
                <input type="checkbox" {...props} className="w-5 h-5 accent-blue-600 rounded mr-3" />
                <span className="text-slate-700 font-medium capitalize">{label}</span>
            </label>
        );

        const Label = ({ children }) => <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{children}</label>;

        const ImunisasiSection = ({ label, name, sourceName, data, onChange }) => (
            <div className="bg-slate-50 p-5 rounded-xl border border-slate-100 mb-4">
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 text-micro">{label}</label>
                <RadioGroup 
                    name={name} 
                    options={['Ya', 'Tidak', 'Belum Cukup Umur', 'Tidak Tahu']} 
                    value={data[name]} 
                    onChange={onChange} 
                />
                <div className="mt-3 pt-3 border-t border-slate-200">
                    <label className="text-[10px] font-semibold text-slate-500 uppercase mb-2 block text-micro">Sumber Data:</label>
                    <div className="flex flex-wrap gap-2">
                        {['Catatan Buku KIA/KMS', 'Ingatan Responden', 'Lain-lain'].map(o => (
                            <label key={o} className={`flex items-center p-2 bg-white rounded-lg cursor-pointer border ${data[sourceName] === o ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-slate-300'}`}>
                                <input 
                                    type="radio" 
                                    name={sourceName} 
                                    value={o} 
                                    checked={data[sourceName] === o} 
                                    onChange={onChange} 
                                    className="w-4 h-4 accent-blue-600 rounded mr-2" 
                                />
                                <span className="text-xs text-slate-700">{o}</span>
                            </label>
                        ))}
                    </div>
                </div>
            </div>
        );

        // Step1 dengan input manual untuk nomor EPID
        const Step1 = ({ data, onChange, onSumberChange, Icons }) => {
    // State untuk pencarian
    const [searchTerm, setSearchTerm] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [showSearchResults, setShowSearchResults] = useState(false);
    
    // Fungsi untuk mencari di SEMUA layanan (tanpa filter kabupaten)
    const searchAllLayanan = (term) => {
    if (!term.trim()) {
        setSearchResults([]);
        return;
    }
    
    const lowerTerm = term.toLowerCase();
    const results = [];
    
    // Cari di semua kabupaten
    for (const [kabupaten, layananList] of Object.entries(LAYANAN_BY_KABUPATEN)) {
        const filtered = layananList.filter(item => {
            // Filter berdasarkan jenis layanan sesuai sumber laporan
            // Pastikan data.sumberLaporan ada
            if (data.sumberLaporan) {
                if (data.sumberLaporan === 'Puskesmas' && item.jenis !== 'Puskesmas') return false;
                if (data.sumberLaporan === 'Rumah Sakit' && item.jenis !== 'Rumah Sakit') return false;
            }
            
            // Cari berdasarkan nama
            return item.nama.toLowerCase().includes(lowerTerm);
        });
        
        // Tambahkan dengan informasi kabupaten
        results.push(...filtered.map(item => ({
            ...item,
            kabupaten: kabupaten
        })));
    }
    
    setSearchResults(results);
};
    
    // Fungsi untuk menangani pencarian
    const handleSearchChange = (e) => {
    const value = e.target.value;
    setSearchTerm(value);
    
    if (value.trim()) {
        try {
            searchAllLayanan(value);
            setShowSearchResults(true);
        } catch (error) {
            console.error("Search error:", error);
            setSearchResults([]);
            setShowSearchResults(false);
        }
    } else {
        setSearchResults([]);
        setShowSearchResults(false);
        // Hanya reset pencarian, tidak reset pilihan yang sudah ada
    }
};
    
    // Fungsi untuk memilih hasil pencarian
    const handleSelectLayanan = (layanan) => {
        onChange({ target: { name: 'namaUnitPelapor', value: layanan.nama } });
        onChange({ target: { name: 'kabupatenUnitPelapor', value: layanan.kabupaten } });
        setSearchTerm(layanan.nama);
        setShowSearchResults(false);
    };
    
    // Filter layanan berdasarkan kabupaten yang dipilih (untuk dropdown)
    const layananByKabupaten = data.kabupatenUnitPelapor 
        ? LAYANAN_BY_KABUPATEN[data.kabupatenUnitPelapor] || []
        : [];
    
    const filteredLayanan = (data.sumberLaporan === 'Puskesmas' || data.sumberLaporan === 'Rumah Sakit')
        ? layananByKabupaten.filter(item => {
            if (data.sumberLaporan === 'Puskesmas' && item.jenis !== 'Puskesmas') return false;
            if (data.sumberLaporan === 'Rumah Sakit' && item.jenis !== 'Rumah Sakit') return false;
            return true;
        })
        : [];
    
    // Fungsi untuk reset pencarian saja (tidak reset data yang sudah dipilih)
    const resetSearch = () => {
        setSearchTerm('');
        setSearchResults([]);
        setShowSearchResults(false);
    };
    
    // Fungsi untuk reset pilihan layanan
    const resetPilihanLayanan = () => {
        onChange({ target: { name: 'namaUnitPelapor', value: '' } });
        onChange({ target: { name: 'kabupatenUnitPelapor', value: '' } });
        resetSearch();
    };
    
    // Fungsi untuk menangani perubahan kabupaten
    const handleKabupatenUnitPelaporChange = (e) => {
        const kabupaten = e.target.value;
        onChange({ target: { name: 'kabupatenUnitPelapor', value: kabupaten } });
        onChange({ target: { name: 'namaUnitPelapor', value: '' } });
        resetSearch();
    };
    
    // Fungsi untuk menangani perubahan dropdown layanan
    const handleNamaUnitPelaporChange = (e) => {
        const namaLayanan = e.target.value;
        onChange({ target: { name: 'namaUnitPelapor', value: namaLayanan } });
        
        // Jika memilih layanan dari dropdown, update searchTerm untuk konsistensi
        if (namaLayanan) {
            setSearchTerm(namaLayanan);
        }
    };
    
    return (
        <div className="animate-fadeIn">
            <div className="mb-8">
                <Label>Nomor EPID</Label>
                <input
                    type="text"
                    name="nomorEPID"
                    value={data.nomorEPID}
                    onChange={onChange}
                    placeholder="Masukkan nomor EPID"
                    className="w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300"
                />
                <p className="text-sm text-slate-500 mt-2">Nomor EPID disesuaikan dengan ketentuan</p>
            </div>
            
            <div className="mb-8">
                <Label>Apakah kasus KLB?</Label>
                <RadioGroup name="kasusKLB" options={['ya', 'tidak']} value={data.kasusKLB} onChange={onChange} />
            </div>
            
            {data.kasusKLB === 'ya' && (
                <div className="bg-orange-50 p-5 rounded-xl border border-orange-100 mb-6 animate-fadeIn">
                    <p className="text-sm font-semibold text-orange-700 mb-3">Detail KLB</p>
                    <div className="grid grid-cols-2 gap-4">
                        <Input label="KLB Ke-" name="klbKe" value={data.klbKe} onChange={onChange} className="mb-0" />
                        <Input label="Nomor KLB" name="nomorKLB" value={data.nomorKLB} onChange={onChange} className="mb-0" />
                    </div>
                </div>
            )}

            <div className="mb-6">
                <Label>Sumber Laporan</Label>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3">
                    {['Puskesmas', 'Rumah Sakit', 'Bidan', 'Klinik Swasta', 'Lainnya'].map(src => (
                        <label key={src} className={`p-4 rounded-lg cursor-pointer text-center border transition-all text-sm font-medium ${data.sumberLaporan === src ? 'bg-slate-800 text-white border-slate-800 shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                            <input type="radio" name="sumberLaporan" value={src} checked={data.sumberLaporan === src} onChange={onSumberChange} className="hidden" />
                            <span>{src}</span>
                        </label>
                    ))}
                </div>
            </div>

            {/* PERBAIKAN: Dua cara memilih layanan */}
            {(data.sumberLaporan === 'Puskesmas' || data.sumberLaporan === 'Rumah Sakit') ? (
                <div className="space-y-6">
                    {/* SOLUSI 1: Pilih berdasarkan Kabupaten */}
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-200">
                        <h4 className="font-bold text-lg text-slate-800 mb-3 flex items-center gap-2">
                            <Icons.MapPin className="w-5 h-5 text-blue-600" />
                            Pilih berdasarkan Kabupaten
                        </h4>
                        
                        {/* Pilih Kabupaten */}
                        <Select 
                            label="Pilih Kabupaten/Kota" 
                            name="kabupatenUnitPelapor" 
                            value={data.kabupatenUnitPelapor} 
                            onChange={handleKabupatenUnitPelaporChange}
                        >
                            <option value="">Pilih Kabupaten/Kota...</option>
                            {DAFTAR_KABUPATEN.map(kab => (
                                <option key={kab} value={kab}>{kab}</option>
                            ))}
                        </Select>
                        
                        {/* Pilih Layanan setelah memilih kabupaten */}
                        {data.kabupatenUnitPelapor && (
                            <div className="mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <Label>Pilih {data.sumberLaporan} di {data.kabupatenUnitPelapor}</Label>
                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                        {filteredLayanan.length} tersedia
                                    </span>
                                </div>
                                <select
                                    name="namaUnitPelapor"
                                    value={data.namaUnitPelapor}
                                    onChange={handleNamaUnitPelaporChange}
                                    className="w-full p-4 bg-white rounded-xl text-slate-800 font-medium appearance-none focus:ring-2 focus:ring-blue-500 transition-all outline-none border border-blue-200 text-body hover:border-blue-300"
                                >
                                    <option value="">Pilih {data.sumberLaporan}...</option>
                                    {filteredLayanan.map(layanan => (
                                        <option key={layanan.nama} value={layanan.nama}>
                                            {layanan.nama}
                                        </option>
                                    ))}
                                </select>
                                {data.namaUnitPelapor && (
                                    <div className="mt-2 flex justify-end">
                                        <button
                                            type="button"
                                            onClick={() => onChange({ target: { name: 'namaUnitPelapor', value: '' } })}
                                            className="text-xs text-blue-600 hover:text-blue-800 font-medium"
                                        >
                                            Hapus pilihan
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* SOLUSI 2: Pencarian langsung (MENCARI SEMUA DATA) */}
                    <div className="bg-gradient-to-r from-emerald-50 to-green-50 p-5 rounded-xl border border-emerald-200">
                        <h4 className="font-bold text-lg text-slate-800 mb-3 flex items-center gap-2">
                            <Icons.Search className="w-5 h-5 text-emerald-600" />
                            Cari langsung {data.sumberLaporan}
                        </h4>
                        <p className="text-sm text-slate-500 mb-3">
                            Ketik nama {data.sumberLaporan.toLowerCase()} - akan otomatis mengisi kabupaten
                        </p>
                        
                        <div className="relative">
                            <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400">
                                <Icons.Search className="w-5 h-5" />
                            </div>
                            <input
                                type="text"
                                value={searchTerm}
                                onChange={handleSearchChange}
                                placeholder={`Contoh: ${data.sumberLaporan === 'Puskesmas' ? 'Puskesmas Galing' : 'RS Santa Elizabeth'}...`}
                                className="w-full pl-12 pr-4 py-4 bg-white rounded-xl text-slate-800 font-medium focus:ring-2 focus:ring-emerald-500 transition-all outline-none border border-emerald-200 text-body placeholder-slate-400 hover:border-emerald-300"
                            />
                            {searchTerm && (
                                <button
                                    type="button"
                                    onClick={resetSearch}
                                    className="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"
                                >
                                    <Icons.X className="w-5 h-5" />
                                </button>
                            )}
                        </div>
                        
                        {/* Hasil pencarian - MENCARI DI SEMUA LAYANAN */}
                        {showSearchResults && searchTerm && (
    <div className="mt-3 border border-emerald-200 rounded-lg overflow-hidden max-h-60 overflow-y-auto bg-white shadow-sm">
        {searchResults.length > 0 ? (
            <div className="divide-y divide-emerald-50">
                {searchResults.slice(0, 20).map((layanan, index) => ( // Batasi hasil untuk performa
                    <div
                        key={`${layanan.nama}-${index}-${layanan.kabupaten}`} // Pastikan key unik
                        className={`p-3 cursor-pointer hover:bg-emerald-50 transition ${data.namaUnitPelapor === layanan.nama ? 'bg-emerald-100' : ''}`}
                        onClick={() => handleSelectLayanan(layanan)}
                    >
                        <div className="font-medium text-slate-800">{layanan.nama}</div>
                        <div className="flex items-center gap-2 mt-1 flex-wrap">
                            <span className={`px-2 py-0.5 rounded text-xs ${layanan.jenis === 'Puskesmas' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`}>
                                {layanan.jenis}
                            </span>
                            <span className="text-xs text-slate-500"></span>
                            <span className="text-xs text-slate-600 font-medium">
                                Kabupaten: <span className="text-emerald-700">{layanan.kabupaten}</span>
                            </span>
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <div className="p-4 text-center text-slate-400">
                <Icons.Search className="w-8 h-8 mx-auto mb-2 text-slate-300" />
                <p>Tidak ditemukan {data.sumberLaporan} dengan nama "{searchTerm}"</p>
                <p className="text-xs mt-1">Coba gunakan kata kunci yang lebih spesifik</p>
            </div>
        )}
    </div>
)}
                    </div>
                    
                    {/* Status pilihan saat ini */}
                    {(data.namaUnitPelapor && data.kabupatenUnitPelapor) && (
                        <div className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                            <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                <Icons.CheckCircle className="w-5 h-5 text-green-600" />
                                {data.sumberLaporan} Terpilih
                            </h4>
                            <div className="flex items-start justify-between">
                                <div>
                                    <p className="font-bold text-lg text-slate-800">{data.namaUnitPelapor}</p>
                                    <div className="flex items-center gap-2 mt-2">
                                        <span className="px-2 py-1 bg-slate-200 text-slate-700 text-xs rounded font-medium">
                                            Kabupaten: {data.kabupatenUnitPelapor}
                                        </span>
                                        <span className={`px-2 py-1 text-xs rounded font-medium ${data.sumberLaporan === 'Puskesmas' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`}>
                                            {data.sumberLaporan}
                                        </span>
                                    </div>
                                </div>
                                <button
                                    type="button"
                                    onClick={resetPilihanLayanan}
                                    className="text-sm text-slate-600 hover:text-red-600 font-medium px-3 py-2 bg-white rounded-lg border border-slate-200 hover:border-red-200 transition"
                                >
                                    Ganti
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Informasi bahwa keduanya terhubung */}
                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-center">
                        <p className="text-sm text-slate-600">
                            <span className="font-bold">Catatan:</span> Kedua metode di atas saling terhubung. 
                            Pilihan dari satu metode akan terlihat di metode lainnya.
                        </p>
                    </div>
                </div>
            ) : ['Lainnya', 'Bidan', 'Klinik Swasta'].includes(data.sumberLaporan) ? (
                <Input label="Nama Unit Pelapor" name="namaUnitPelapor" value={data.namaUnitPelapor} onChange={onChange} />
            ) : null}

            <div className="grid grid-cols-2 gap-4 mt-6">
                <Input label="Tanggal Terima Laporan" type="date" name="tanggalTerimaLaporan" value={data.tanggalTerimaLaporan} onChange={onChange} />
                <Input label="Tanggal Pelacakan Kasus" type="date" name="tanggalPelacakan" value={data.tanggalPelacakan} onChange={onChange} />
            </div>
        </div>
    );
};

       // PERBAIKAN POINT 1, 2, 3: Step2 dengan Provinsi, Kabupaten readonly dan usia detail
        const Step2 = ({ data, onChange, Icons }) => {
    // PERBAIKAN POINT 3: Hitung usia detail
    const ageString = calculateAge(data.tanggalLahir);
    
    // PERBAIKAN: Fungsi untuk menangani perubahan kecamatan
    const handleKecamatanChange = (e) => {
        const v = e.target.value;
        onChange({ target: { name: 'kecamatan', value: v } });
        // Reset kelurahan ketika kecamatan berubah
        onChange({ target: { name: 'kelurahan', value: '' } });
    };
    
    // Fungsi untuk mendapatkan daftar kelurahan berdasarkan kecamatan
    const getKelurahanOptions = () => {
        if (!data.kabupaten || !data.kecamatan) return [];
        
        const kabupatenData = DATA_WILAYAH_MAPPING[data.kabupaten];
        if (!kabupatenData) return [];
        
        return kabupatenData[data.kecamatan] || [];
    };
    
    return (
        <div className="animate-fadeIn">
            <Input 
                label="Nama Lengkap Pasien" 
                name="namaKasus" 
                value={data.namaKasus} 
                onChange={onChange} 
                placeholder="Masukkan nama lengkap" 
                uppercase={true} 
            />
            
            <div className="grid grid-cols-2 gap-4">
                <Select 
                    label="Jenis Kelamin" 
                    name="jenisKelamin" 
                    value={data.jenisKelamin} 
                    onChange={onChange}
                >
                    <option value="">Pilih jenis kelamin...</option>
                    <option value="laki-laki">Laki-laki</option>
                    <option value="perempuan">Perempuan</option>
                </Select>
                <div>
                    <Input 
                        label="Tanggal Lahir" 
                        type="date" 
                        name="tanggalLahir" 
                        value={data.tanggalLahir} 
                        onChange={onChange} 
                    />
                    {data.tanggalLahir && (
                        <p className="text-sm text-slate-500 mt-1 ml-1">
                            Usia: <span className="font-semibold">{ageString}</span>
                        </p>
                    )}
                </div>
            </div>
            
            <Input 
                label="Alamat Lengkap" 
                as="textarea" 
                name="alamat" 
                value={data.alamat} 
                onChange={onChange} 
                placeholder="Jl. Nama Jalan, Nomor, RT/RW" 
            />
            
            {/* PERBAIKAN POINT 1 & 2: Field Provinsi dan Kabupaten */}
            <div className="grid grid-cols-2 gap-4 mb-6">
                <div className="mb-4">
                    <Label>Provinsi</Label>
                    <div className="relative">
                        <input
                            type="text"
                            value="Kalimantan Barat"
                            readOnly
                            className="w-full p-4 bg-slate-100 rounded-xl text-slate-800 font-medium border border-slate-200 text-body cursor-not-allowed"
                        />
                        <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                            <Icons.Lock className="w-4 h-4" />
                        </div>
                    </div>
                </div>
                
                <div className="mb-4">
                    <Label>Kabupaten/Kota</Label>
                    <select
                        name="kabupaten"
                        value={data.kabupaten}
                        onChange={(e) => {
                            onChange(e);
                            // Reset kecamatan dan kelurahan ketika kabupaten berubah
                            onChange({ target: { name: 'kecamatan', value: '' } });
                            onChange({ target: { name: 'kelurahan', value: '' } });
                        }}
                        className="w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium appearance-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all outline-none border border-slate-200 text-body hover:border-slate-300"
                    >
                        <option value="">Pilih Kabupaten/Kota...</option>
                        {DAFTAR_KABUPATEN.map(kab => (
                            <option key={kab} value={kab}>{kab}</option>
                        ))}
                    </select>
                </div>
            </div>

            {/* PERBAIKAN: Kecamatan dan Kelurahan */}
            <div className="grid grid-cols-2 gap-4 mb-6">
                <Select 
                    label="Kecamatan" 
                    name="kecamatan" 
                    value={data.kecamatan} 
                    onChange={handleKecamatanChange}
                    disabled={!data.kabupaten}
                >
                    <option value="">Pilih Kecamatan...</option>
                    {data.kabupaten && DATA_WILAYAH_MAPPING[data.kabupaten] 
                        ? Object.keys(DATA_WILAYAH_MAPPING[data.kabupaten]).map(kec => (
                            <option key={kec} value={kec}>{kec}</option>
                        ))
                        : null
                    }
                </Select>
                
                <Select 
                    label="Kelurahan/Desa" 
                    name="kelurahan" 
                    value={data.kelurahan} 
                    onChange={onChange}
                    disabled={!data.kecamatan}
                >
                    <option value="">Pilih Kelurahan...</option>
                    {data.kabupaten && data.kecamatan && DATA_WILAYAH_MAPPING[data.kabupaten] 
                        ? getKelurahanOptions().map(kel => (
                            <option key={kel} value={kel}>{kel}</option>
                        ))
                        : null
                    }
                </Select>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
                <Input label="RT" name="rt" value={data.rt} onChange={onChange} />
                <Input label="RW" name="rw" value={data.rw} onChange={onChange} />
            </div>

            <Input 
                label="Nama Orangtua / Wali" 
                name="namaOrangtua" 
                value={data.namaOrangtua} 
                onChange={onChange} 
                placeholder="Nama lengkap orangtua" 
                uppercase={true} 
            />
            <Input 
                label="Nomor Kontak (HP/WA)" 
                name="noKontakOrangtua" 
                value={data.noKontakOrangtua} 
                onChange={onChange} 
                placeholder="0812XXXXXX" 
            />
        </div>
    );
};

        // PERBAIKAN POINT 4: Step3 dengan input untuk komplikasi lainnya
        const Step3 = ({ data, onChange, Icons }) => {
    const gejalaOptions = ['Batuk', 'Pilek', 'Mata Merah', 'Adenopathy', 'Arthralgia', 'Kehamilan', 'Lainnya'];
    
    return (
        <div className="animate-fadeIn">
            <div className="mb-8">
                <Label>Apakah demam?</Label>
                <RadioGroup name="demam" options={['ya','tidak']} value={data.demam} onChange={onChange}/>
                {data.demam==='ya' && (
                    <div className="mt-4">
                        <Input type="date" label="Tanggal Mulai Demam" name="tanggalMulaiDemam" value={data.tanggalMulaiDemam} onChange={onChange}/>
                    </div>
                )}
            </div>
            
            <div className="mb-8">
                <Label>Apakah ruam?</Label>
                <RadioGroup name="ruam" options={['ya','tidak']} value={data.ruam} onChange={onChange}/>
                {data.ruam==='ya' && (
                    <div className="mt-4">
                        <Input type="date" label="Tanggal Mulai Ruam" name="tanggalMulaiRuam" value={data.tanggalMulaiRuam} onChange={onChange}/>
                    </div>
                )}
            </div>
            
            <div className="mb-8">
                <Label>Gejala Lain</Label>
                <div className="grid grid-cols-2 gap-3 mt-3">
                    {gejalaOptions.map(o => (
                        <label key={o} className="flex items-center p-4 bg-slate-50 rounded-lg cursor-pointer transition active:scale-95 border border-transparent hover:border-slate-200 text-caption">
                            <input 
                                type="checkbox" 
                                name="gejalaLain"
                                value={o}
                                checked={data.gejalaLain?.[o] || false}
                                onChange={onChange}
                                className="w-5 h-5 accent-blue-600 rounded mr-3" 
                            />
                            <span className="text-slate-700 font-medium capitalize">{o}</span>
                        </label>
                    ))}
                </div>
                {data.gejalaLain?.Lainnya && (
                    <Input className="mt-4" placeholder="Sebutkan gejala lainnya..." name="gejalaLainSebutkan" value={data.gejalaLainSebutkan} onChange={onChange}/>
                )}
            </div> 
            
            {/* Input untuk Adenopathy, Arthralgia, Kehamilan */}
            {data.gejalaLain?.Adenopathy && (
                <Input 
                    className="mt-4" 
                    label="Lokasi Adenopathy" 
                    name="lokasiAdenopathy" 
                    value={data.lokasiAdenopathy} 
                    onChange={onChange}
                    placeholder="Misal: Leher, ketiak, lipat paha, dll"
                />
            )}
            
            {data.gejalaLain?.Arthralgia && (
                <Input 
                    className="mt-4" 
                    label="Bagian Sendi" 
                    name="bagianSendiArthralgia" 
                    value={data.bagianSendiArthralgia} 
                    onChange={onChange}
                    placeholder="Misal: Lutut, siku, pergelangan tangan"
                />
            )}
            
            {data.gejalaLain?.Kehamilan && (
                <Input 
                    className="mt-4" 
                    label="Umur Kehamilan" 
                    name="umurKehamilan" 
                    value={data.umurKehamilan} 
                    onChange={onChange}
                    placeholder="Misal: 20 minggu, 8 bulan"
                />
            )}
            
            <div className="mb-8">
                <Label>Komplikasi</Label>
                <div className="grid grid-cols-2 gap-3 mt-3">
                    {DATA_KOMPLIKASI.map(o => (
                        <label key={o} className="flex items-center p-4 bg-slate-50 rounded-lg cursor-pointer transition active:scale-95 border border-transparent hover:border-slate-200 text-caption">
                            <input 
                                type="checkbox" 
                                name="komplikasi"
                                value={o}
                                checked={data.komplikasi?.[o] || false}
                                onChange={onChange}
                                className="w-5 h-5 accent-blue-600 rounded mr-3" 
                            />
                            <span className="text-slate-700 font-medium capitalize">{o}</span>
                        </label>
                    ))}
                </div>
                {/* PERBAIKAN POINT 4: Input untuk komplikasi lainnya */}
                {data.komplikasi?.Lainnya && (
                    <Input className="mt-4" placeholder="Sebutkan komplikasi lainnya..." name="komplikasiLainnyaSebutkan" value={data.komplikasiLainnyaSebutkan} onChange={onChange}/>
                )}
            </div>
            
            <div className="bg-slate-50 p-5 rounded-xl border border-slate-100">
                <Label>Riwayat Rawat Inap</Label>
                <RadioGroup name="dirawat" options={['ya','tidak']} value={data.dirawat} onChange={onChange}/>
                {data.dirawat==='ya' && (
                    <div className="mt-5 space-y-4">
                        <Input label="Nama Rumah Sakit" name="namaRumahSakit" value={data.namaRumahSakit} onChange={onChange} placeholder="Nama rumah sakit"/> 
                        
                        {/* TAMBAHAN: Input untuk Nomor Rekam Medis */}
                        <Input 
                            label="Nomor Rekam Medis" 
                            name="nomorRekamMedik" 
                            value={data.nomorRekamMedik} 
                            onChange={onChange} 
                            placeholder="Nomor rekam medis pasien"
                        />
                        
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="Tanggal Masuk Rawat" type="date" name="tanggalMasukRawat" value={data.tanggalMasukRawat} onChange={onChange}/>
                            <Input label="Tanggal Keluar Rawat" type="date" name="tanggalKeluarRawat" value={data.tanggalKeluarRawat} onChange={onChange}/>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

        const Step4 = ({ data, onChange, Icons }) => (
            <div className="animate-fadeIn">
                <ImunisasiSection
                    label="Imunisasi Campak/Rubela Dosis 1"
                    name="imunisasiCampak1"
                    sourceName="sumberCampak1"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Imunisasi Campak/Rubela Dosis 2"
                    name="imunisasiCampak2"
                    sourceName="sumberCampak2"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Imunisasi Campak/Rubela saat BIAS"
                    name="imunisasiBIAS"
                    sourceName="sumberBIAS"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Pernah menerima imunisasi Measles Mumps Rubella (MMR) sebelumnya?"
                    name="imunisasiMMR"
                    sourceName="sumberMMR"
                    data={data}
                    onChange={onChange}
                />
                
                <ImunisasiSection
                    label="Pernah menerima imunisasi campak-rubela saat imunisasi tambahan Campak/Rubela?"
                    name="imunisasiTambahan"
                    sourceName="sumberTambahan"
                    data={data}
                    onChange={onChange}
                />
                
                <Input
                    label="Tanggal imunisasi campak-rubela terakhir"
                    type="date"
                    name="tanggalImunisasiTerakhir"
                    value={data.tanggalImunisasiTerakhir}
                    onChange={onChange}
                />
                
                <div className="mt-6">
                    <Label>Pemberian Vitamin A</Label>
                    <RadioGroup name="vitaminA" options={['Ya','Tidak']} value={data.vitaminA} onChange={onChange} />
                </div>
            </div>
        );

        // PERBAIKAN POINT 5: Step5 dengan pilihan YA, Tidak, Tidak Tahu
        const Step5 = ({ data, onChange, Icons }) => {
            // Fungsi untuk menambah kontak erat
            const addKontakErat = () => {
                const newKontakErat = [...data.kontakErat, {
                    nama: '',
                    umur: '',
                    alamat: '',
                    hubungan: '',
                    imunisasiCampakRubella: '',
                    kondisi: ''
                }];
                onChange({ target: { name: 'kontakErat', value: newKontakErat } });
            };

            // Fungsi untuk menghapus kontak erat
            const removeKontakErat = (index) => {
                const newKontakErat = [...data.kontakErat];
                newKontakErat.splice(index, 1);
                onChange({ target: { name: 'kontakErat', value: newKontakErat } });
            };

            // Fungsi untuk mengubah kontak erat
            const handleKontakEratChange = (index, field, value) => {
                const newKontakErat = [...data.kontakErat];
                newKontakErat[index] = { ...newKontakErat[index], [field]: value };
                onChange({ target: { name: 'kontakErat', value: newKontakErat } });
            };

            return (
                <div className="animate-fadeIn">
                    {/* PERBAIKAN POINT 5: Ubah pilihan menjadi YA, Tidak, Tidak Tahu */}
                    <div className="mb-8">
                        <Label>Apakah ada kontak dengan kasus serupa?</Label>
                        <RadioGroup name="adaKontakSakitSama" options={['Ya','Tidak','Tidak Tahu']} value={data.adaKontakSakitSama} onChange={onChange}/>
                        {data.adaKontakSakitSama === 'Ya' && (
                            <div className="mt-4">
                                <Input label="Jumlah Kontak Sakit" name="jumlahKontakSakit" value={data.jumlahKontakSakit} onChange={onChange} placeholder="Misal: 3" />
                            </div>
                        )}
                    </div>
                    
                    {/* PERBAIKAN POINT 5: Ubah pilihan menjadi YA, Tidak, Tidak Tahu */}
                    <div className="mb-8">
                        <Label>Riwayat Bepergian</Label>
                        <RadioGroup name="bepergian" options={['Ya','Tidak','Tidak Tahu']} value={data.bepergian} onChange={onChange}/>
                        {data.bepergian==='Ya' && (
                            <div className="bg-slate-50 p-5 rounded-xl border border-slate-100 mt-5">
                                <Input label="Lokasi Bepergian" name="lokasiBepergian" value={data.lokasiBepergian} onChange={onChange} placeholder="Kota, provinsi, atau negara tujuan"/>
                                <div className="grid grid-cols-2 gap-4 mt-4">
                                    <Input label="Tanggal Pergi" type="date" name="tanggalPergi" value={data.tanggalPergi} onChange={onChange}/>
                                    <Input label="Tanggal Pulang" type="date" name="tanggalKembali" value={data.tanggalKembali} onChange={onChange}/>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Bagian Pengumpulan Data Kontak Erat */}
                    <div className="mt-10 pt-6 border-t border-slate-200">
                        <div className="flex items-center justify-between mb-6">
                            <div>
                                <h3 className="text-lg font-bold text-slate-800">Data Kontak Erat</h3>
                                <p className="text-sm text-slate-500 mt-1">Silahkan tambah data!</p>
                            </div>
                            <button
                                type="button"
                                onClick={addKontakErat}
                                className="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                            >
                                <Icons.UserPlus className="w-4 h-4" /> Tambah
                            </button>
                        </div>

                        {/* Daftar Kontak Erat */}
                        <div className="space-y-6 mb-8">
                            {data.kontakErat.map((kontak, index) => (
                                <div key={index} className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-5 rounded-xl relative">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                                                <Icons.User className="w-4 h-4" />
                                            </div>
                                            <h4 className="font-bold text-slate-800">Kontak Erat #{index + 1}</h4>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => removeKontakErat(index)}
                                            className="w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition"
                                        >
                                            <Icons.Trash className="w-4 h-4" />
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <Label>Nama</Label>
                                            <input
                                                type="text"
                                                value={kontak.nama}
                                                onChange={(e) => handleKontakEratChange(index, 'nama', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Nama lengkap"
                                            />
                                        </div>
                                        <div>
                                            <Label>Umur</Label>
                                            <input
                                                type="text"
                                                value={kontak.umur}
                                                onChange={(e) => handleKontakEratChange(index, 'umur', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Contoh: 2 tahun"
                                            />
                                        </div>
                                        <div className="md:col-span-2">
                                            <Label>Alamat</Label>
                                            <textarea
                                                value={kontak.alamat}
                                                onChange={(e) => handleKontakEratChange(index, 'alamat', e.target.value)}
                                                rows={2}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Alamat lengkap"
                                            />
                                        </div>
                                        <div>
                                            <Label>Hubungan</Label>
                                            <input
                                                type="text"
                                                value={kontak.hubungan}
                                                onChange={(e) => handleKontakEratChange(index, 'hubungan', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                                placeholder="Contoh: Saudara, Teman Sekolah"
                                            />
                                        </div>
                                        <div>
                                            <Label>Imunisasi Campak/Rubella</Label>
                                            <select
                                                value={kontak.imunisasiCampakRubella}
                                                onChange={(e) => handleKontakEratChange(index, 'imunisasiCampakRubella', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                <option value="">Belum Pernah</option>
                                                <option value="1 Kali">1 Kali</option>
                                                <option value="2 Kali">2 Kali</option>
                                                <option value="3 Kali">3 Kali</option>
                                            </select>
                                        </div>
                                        <div>
                                            <Label>Kondisi</Label>
                                            <select
                                                value={kontak.kondisi}
                                                onChange={(e) => handleKontakEratChange(index, 'kondisi', e.target.value)}
                                                className="w-full p-3 bg-white rounded-lg border border-blue-100 focus:ring-2 focus:ring-blue-500 outline-none"
                                            >
                                                <option value="">Pilih Kondisi</option>
                                                <option value="sehat">Sehat</option>
                                                <option value="sakit">Sakit</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Tombol Tambah di bawah kartu terakhir */}
                        {data.kontakErat.length > 0 && (
                            <div className="flex justify-center mt-2">
                                <button
                                    type="button"
                                    onClick={addKontakErat}
                                    className="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                                >
                                    <Icons.UserPlus className="w-4 h-4" /> Tambah Kontak Erat Lagi
                                </button>
                            </div>
                        )}

                        {/* Ringkasan Kontak Erat */}
                        {data.kontakErat.length > 0 && (
                            <div className="mt-8 bg-slate-50 p-5 rounded-xl border border-slate-200">
                                <h4 className="font-bold text-slate-800 mb-3">Ringkasan Kontak Erat</h4>
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-600">Total Kontak Erat:</span>
                                        <span className="font-bold text-blue-600">{data.kontakErat.length} orang</span>
                                    </div>
                                    <div className="text-xs text-slate-500 space-y-1">
                                        {data.kontakErat.map((kontak, index) => (
                                            <div key={index} className="flex justify-between border-b border-slate-100 pb-1">
                                                <span>{index + 1}: {kontak.nama || 'Tanpa Nama'}</span>
                                                <span className={`px-2 py-0.5 rounded text-xs ${kontak.kondisi === 'sakit' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                    {kontak.kondisi || 'Tidak diketahui'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Step6 = ({ data, onChange, getGeo, loadingGeo, onSaveToPending, onSaveAndFinal, Icons }) => (
            <div className="animate-fadeIn">
                <div className="mb-8">
                    <Label>Apakah spesimen darah diambil?</Label>
                    <RadioGroup name="spesimenDarah" options={['Ya', 'Tidak']} value={data.spesimenDarah} onChange={onChange} />
                    {data.spesimenDarah === 'Ya' && (
                        <div className="mt-4">
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Tanggal Pengambilan" type="date" name="tanggalAmbilDarah" value={data.tanggalAmbilDarah} onChange={onChange} />
                                <Input label="Tanggal Pengiriman" type="date" name="tanggalKirimDarah" value={data.tanggalKirimDarah} onChange={onChange} />
                            </div>
                            <div className="mt-4">
                                <Label>Jenis Sample Darah</Label>
                                <div className="grid grid-cols-2 gap-3 mt-2">
                                    {['Serum', 'Darah Kering'].map(o => (
                                        <Checkbox key={o} label={o} name="jenisSampleDarah" value={o} checked={data.jenisSampleDarah?.includes(o)} onChange={onChange} />
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                <div className="mb-8">
                    <Label>Apakah spesimen lain diambil?</Label>
                    <RadioGroup name="spesimenLain" options={['Ya', 'Tidak']} value={data.spesimenLain} onChange={onChange} />
                    {data.spesimenLain === 'Ya' && (
                        <div className="mt-4">
                            <Label>Jenis Sampel Lain</Label>
                            <div className="grid grid-cols-2 gap-3 mt-2 mb-4">
                                {['Urin', 'Swap Tenggorok', 'Lainnya'].map(o => (
                                    <Checkbox key={o} label={o} name="jenisSampelLain" value={o} checked={data.jenisSampelLain?.includes(o)} onChange={onChange} />
                                ))}
                            </div>
                            {data.jenisSampelLain?.includes('Lainnya') && (
                                <Input label="Sebutkan" name="jenisSampelLainSebutkan" value={data.jenisSampelLainSebutkan} onChange={onChange} />
                            )}
                            <div className="grid grid-cols-2 gap-4 mt-4">
                                <Input label="Tanggal Pengambilan" type="date" name="tanggalAmbilLain" value={data.tanggalAmbilLain} onChange={onChange} />
                                <Input label="Tanggal Pengiriman" type="date" name="tanggalKirimLain" value={data.tanggalKirimLain} onChange={onChange} />
                            </div>
                        </div>
                    )}
                </div>

                <div className="mb-8">
                    <Label>Keadaan saat ini</Label>
                    <RadioGroup name="keadaanSaatIni" options={['Hidup', 'Meninggal', 'Lost to Follow-Up']} value={data.keadaanSaatIni} onChange={onChange} />
                </div>

                <Input label="Pelaksana Investigasi" name="pelaksanaInvestigasi" value={data.pelaksanaInvestigasi} onChange={onChange} uppercase={true} />
                <Input label="Nama Sekolah (Jika penderita berusia sekolah)" name="namaSekolah" value={data.namaSekolah} onChange={onChange} uppercase={true} />

                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 p-6 rounded-xl">
                    <Label>Titik Lokasi Kasus</Label>
                    <div className="flex gap-3 mt-3">
                        <input 
                            name="titikLokasi"
                            className="w-full p-4 bg-white rounded-lg text-slate-800 font-mono shadow-sm border border-blue-100 outline-none focus:ring-2 focus:ring-blue-500 text-body"
                            value={data.titikLokasi} 
                            onChange={onChange} 
                            placeholder="Contoh: -0.026330, 109.342506" 
                        />
                        <button 
                            type="button"
                            onClick={getGeo} 
                            className="bg-gradient-to-r from-slate-800 to-slate-900 text-white px-6 rounded-lg shadow-lg hover:shadow-xl active:scale-95 transition flex items-center justify-center whitespace-nowrap min-w-[60px]"
                            disabled={loadingGeo}
                        >
                            {loadingGeo ? (
                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            ) : (
                                <Icons.MapPin className="w-5 h-5"/>
                            )}
                        </button>
                    </div>
                </div>

                <div className="mt-10 pt-6 border-t border-slate-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-4">Opsi Penyimpanan</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-200">
                            <div className="flex items-start mb-3">
                                <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <Icons.Hourglass className="w-5 h-5" />
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-800 mb-1">Simpan ke Pending Form</h4>
                                    <p className="text-sm text-slate-600">
                                        Formulir akan masuk ke <strong>Pending Form</strong>.
                                    </p>
                                </div>
                            </div>
                            <button 
                                type="button"
                                onClick={onSaveToPending}
                                className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 mt-2"
                            >
                                <Icons.Save className="w-4 h-4" /> Simpan ke Pending Form
                            </button>
                        </div>

                        <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-5 rounded-xl border border-green-200">
                            <div className="flex items-start mb-3">
                                <div className="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    <Icons.CheckCircle className="w-5 h-5" />
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-800 mb-1">Simpan & Langsung Finalisasi</h4> <p className="text-sm text-slate-600">
                                        Formulir akan masuk ke <strong>Form Final</strong>.
                                    </p>
                                    
                                    
                                </div>
                            </div>
                            <button 
                                type="button"
                                onClick={onSaveAndFinal}
                                className="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center gap-2 mt-2"
                            >
                                <Icons.Check className="w-4 h-4" /> Simpan & Finalisasi
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const LoadingOverlay = () => (
            <div className="fixed inset-0 bg-slate-900/30 flex items-center justify-center z-50">
                <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-slate-700 font-bold">Memproses...</p>
                </div>
            </div>
        );

        const Toast = ({ notification }) => {
            if (!notification) return null;
            
            const bgColor = notification.type === 'success' ? 'bg-green-500' : 
                           notification.type === 'error' ? 'bg-red-500' : 
                           'bg-blue-500';
            
            return (
                <div className={`fixed top-6 right-6 ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-fadeIn`}>
                    <div className="flex items-center gap-3">
                        {notification.type === 'success' && <Icons.CheckCircle className="w-5 h-5" />}
                        {notification.type === 'error' && <Icons.XCircle className="w-5 h-5" />}
                        <span className="font-bold">{notification.msg}</span>
                    </div>
                </div>
            );
        };

        // BAGIAN 4: APP COMPONENT
        const App = () => {
            const [currentUser, setCurrentUser] = useState(sessionManager.load);
            const [view, setView] = useState(() => {
                const user = sessionManager.load();
                if (user) return user.role === 'admin' ? 'admin-dashboard' : 'start';
                return 'login';
            });

            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState(INITIAL_DATA);
            const [notification, setNotification] = useState(null);
            const [hasNewReceived, setHasNewReceived] = useState(false);
            
            // PERBAIKAN POINT 1: State untuk menangani confirm exit
            const [showConfirmExitModal, setShowConfirmExitModal] = useState(false);
            const [pendingExitAction, setPendingExitAction] = useState(null);
            
            // Modals & States
            const [showExitModal, setShowExitModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false); 
            const [showReviewModal, setShowReviewModal] = useState(false); 
            const [showTransferModal, setShowTransferModal] = useState(false);
            const [showViewModal, setShowViewModal] = useState(false);
            const [showAdminDeleteUserModal, setShowAdminDeleteUserModal] = useState(false);
            const [adminUserToDelete, setAdminUserToDelete] = useState(null);
            const [reviewItem, setReviewItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [itemToShare, setItemToShare] = useState(null); 
            const [itemToView, setItemToView] = useState(null);
            const [itemToTransfer, setItemToTransfer] = useState(null);
            
            const [showFinalizeModal, setShowFinalizeModal] = useState(false);
            const [itemToFinalize, setItemToFinalize] = useState(null);
            
            const [showRejectModal, setShowRejectModal] = useState(false);
            const [itemToReject, setItemToReject] = useState(null);
            
            const [showUnfinalizeModal, setShowUnfinalizeModal] = useState(false);
            const [itemToUnfinalize, setItemToUnfinalize] = useState(null);
            
            const [showEditEpidModal, setShowEditEpidModal] = useState(false);
            const [itemToEditEpid, setItemToEditEpid] = useState(null);
            const [newEpidNumber, setNewEpidNumber] = useState('');
            
            const [showLogoutModal, setShowLogoutModal] = useState(false);
            
            const [draftsList, setDraftsList] = useState([]);
            const [pendingList, setPendingList] = useState([]);
            const [formFinalList, setFormFinalList] = useState([]);
            const [outgoingList, setOutgoingList] = useState([]);
            const [receivedList, setReceivedList] = useState([]); 
            const [rejectedList, setRejectedList] = useState([]);
            
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const formContainerRef = useRef(null);
            const [showLoadingOverlay, setShowLoadingOverlay] = useState(false);

            // PERBAIKAN POINT 1: Hapus beforeunload dan popstate listeners
            useEffect(() => {
                return () => {
                    // Cleanup jika ada event listeners
                };
            }, []);

            // PERBAIKAN POINT 1: Handle browser back/forward hanya dengan modal kita
            useEffect(() => {
                const handleBrowserBack = (e) => {
                    if (view === 'form') {
                        e.preventDefault();
                        setShowConfirmExitModal(true);
                        window.history.pushState(null, '', window.location.href);
                    }
                };

                window.history.pushState(null, '', window.location.href);
                window.addEventListener('popstate', handleBrowserBack);

                return () => {
                    window.removeEventListener('popstate', handleBrowserBack);
                };
            }, [view]);

            const showLoading = (show = true, minDelay = 300) => {
                if (show) {
                    setLoading(true);
                    setShowLoadingOverlay(true);
                } else {
                    setTimeout(() => {
                        setLoading(false);
                        setShowLoadingOverlay(false);
                    }, minDelay);
                }
            };

            const checkNewReceived = async () => {
                if (!currentUser) return;
                try {
                    const all = await mockDB.getAllForms();
                    const received = all.filter(i => 
                        i.sharedTo === currentUser.unitName && 
                        i.statusData === 'Proses' &&
                        i.createdUnit !== currentUser.unitName
                    );
                    setHasNewReceived(received.length > 0);
                } catch (e) {
                    console.error("Error checking new received:", e);
                }
            };

            useEffect(() => { 
                const init = async () => { 
                    await mockUserDB.checkAndCreateDefaultAdmin(); 
                    
                    if (view !== 'login' && !currentUser) {
                        setView('login'); 
                    }
                    
                    if (currentUser) {
                        console.log(`Current user: ${currentUser.name}, role: ${currentUser.role}, unit: ${currentUser.unitName}`);
                        
                        if (view === 'start') {
                            await checkNewReceived();
                        }
                        
                        if (['form-final', 'outgoing', 'inbox', 'drafts', 'pending', 'rejected'].includes(view)) {
                            console.log(`Loading data for view: ${view}`);
                            await loadDataForView();
                        }
                    }
                }; 
                init(); 
            }, [view, currentUser]);

            useEffect(() => {
                if (view === 'form' && formContainerRef.current) {
                    setTimeout(() => {
                        formContainerRef.current.scrollTo({ top: 0, behavior: 'auto' });
                    }, 100);
                }
            }, [step, view]);

            const loadDataForView = async () => {
                if (!currentUser) return;
                
                console.log(`Loading data for user: ${currentUser.email}, unit: ${currentUser.unitName}`);
                showLoading(true);
                try {
                    const allForms = await mockDB.getAllForms();
                    console.log(`Total forms loaded: ${allForms.length}`);
                    
                    // 1. Drafts
                    const drafts = allForms.filter(d => 
                        d.createdBy === currentUser.email && 
                        d.statusData === 'Draft'
                    );
                    console.log(`Drafts found: ${drafts.length}`);
                    setDraftsList(drafts);
                    
                    // 2. Pending Form
                    const pending = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isPendingStatus = i.statusData === 'Pending';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        return isPendingStatus && isOwnedByMe;
                    });
                    console.log(`Pending forms: ${pending.length}`);
                    setPendingList(pending);
                    
                    // 3. Form Final
                    const formFinal = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isFinalStatus = i.statusData === 'Final';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        return isFinalStatus && isOwnedByMe;
                    });
                    console.log(`Form Final: ${formFinal.length}`);
                    setFormFinalList(formFinal);
                    
                    // 4. Formulir Keluar
                    // 4. Formulir Keluar - PERBAIKAN DI SINI
const outgoing = allForms.filter(i => {
    // Kriteria 1: Dibuat oleh user yang sedang login
    const isCreatedByMe = i.createdBy === currentUser.email;
    
    // Kriteria 2: Status adalah 'Proses' atau 'Ditolak'
    const isInProcessOrRejected = i.statusData === 'Proses' || i.statusData === 'Ditolak';
    
    // Kriteria 3: Dikirim ke unit lain (bukan ke diri sendiri)
    const isSharedToOtherUnit = i.sharedTo && i.sharedTo !== '' && i.sharedTo !== currentUser.unitName;
    
    // Kriteria 4: Unit pembuat adalah unit user saat ini
    const isFromMyUnit = i.createdUnit === currentUser.unitName;
    
    // Formulir masuk ke Formulir Keluar jika:
    // 1. Dibuat oleh saya, DAN
    // 2. Status Proses/Ditolak, DAN  
    // 3. Dikirim ke unit lain, DAN
    // 4. Dari unit saya
    if (isCreatedByMe && isInProcessOrRejected && isSharedToOtherUnit && isFromMyUnit) {
        return true;
    }
    
    return false;
});
                    console.log(`Outgoing forms: ${outgoing.length}`);
                    setOutgoingList(outgoing);
                    
                    // 5. Inbox
                    const received = allForms.filter(i => {
                        const isSharedToMe = i.sharedTo === currentUser.unitName;
                        const isInProcess = i.statusData === 'Proses';
                        const currentOwner = determineCurrentOwner(i);
                        
                        if (isSharedToMe && isInProcess && currentOwner !== currentUser.unitName) {
                            return true;
                        }
                        
                        return false;
                    });
                    console.log(`Inbox forms: ${received.length}`);
                    setReceivedList(received);
                    
                    // 6. Form Ditolak
                    const rejected = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isRejected = i.statusData === 'Ditolak';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        
                        return isRejected && isOwnedByMe;
                    });
                    console.log(`Rejected forms: ${rejected.length}`);
                    setRejectedList(rejected);
                    
                    setHasNewReceived(received.length > 0);
                    
                } catch (e) {
                    console.error("Error loading data:", e);
                    showNotification('Error memuat data: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            useEffect(() => { 
                if(view === 'form') window.scrollTo({ top: 0, behavior: 'smooth' }); 
            }, [step, view]);
            
            // Listener untuk status auth Firebase
useEffect(() => {
    if (!dbAuth) return;
    const unsubscribe = dbAuth.onAuthStateChanged(async (firebaseUser) => {
        if (firebaseUser) {
            try {
                const snap = await dbStore.collection('users').where('email', '==', firebaseUser.email).limit(1).get();
                if (!snap.empty) {
                    const userData = snap.docs[0].data();
                    const sessionUser = {
                        uid: firebaseUser.uid,
                        email: firebaseUser.email,
                        name: firebaseUser.displayName || userData.name,
                        role: userData.role,
                        unitName: userData.unitName
                    };
                    sessionManager.save(sessionUser);
                    setCurrentUser(sessionUser);
                    // Redirect otomatis jika di halaman login
                    if (view === 'login') {
                        setView(sessionUser.role === 'admin' ? 'admin-dashboard' : 'start');
                    }
                } else {
                    // User tidak terdaftar
                    await dbAuth.signOut();
                    sessionManager.clear();
                    setCurrentUser(null);
                    setView('login');
                    showNotification('Akun tidak terdaftar. Hubungi administrator.', 'error');
                }
            } catch (e) {
                console.error("Error checking user:", e);
            }
        } else {
            // Tidak ada user yang login
            sessionManager.clear();
            setCurrentUser(null);
            if (view !== 'login') {
                setView('login');
            }
        }
    });
    return () => unsubscribe();
}, [dbAuth, dbStore, view]);

            const handleLogin = async (e) => {
    e.preventDefault(); 
    showLoading(true);
    
    try {
        console.log("Starting Google login...");
        
        // Periksa Firebase auth
        if (!dbAuth) {
            throw new Error("Firebase Auth not initialized");
        }
        
        // Buat Google Auth Provider
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('profile');
        provider.addScope('email');
        
        console.log("Signing in with popup...");
        
        // Sign in dengan popup
        const result = await dbAuth.signInWithPopup(provider);
        const user = result.user;
        
        console.log("Google login successful:", user.email);
        
        // Periksa Firestore
        if (!dbStore) {
            throw new Error("Firestore not initialized");
        }
        
        // Cek apakah user terdaftar di Firestore
        const snap = await dbStore.collection('users')
            .where('email', '==', user.email)
            .limit(1)
            .get();
            
        if (snap.empty) {
            // User tidak terdaftar
            showNotification('Akun Google Anda tidak terdaftar. Hubungi administrator.', 'error');
            await dbAuth.signOut();
            showLoading(false);
            return;
        }
        
        // Ambil data user dari Firestore
        const userData = snap.docs[0].data();
        const sessionUser = {
            uid: user.uid,
            email: user.email,
            name: user.displayName || userData.name,
            role: userData.role,
            unitName: userData.unitName
        };
        
        // Simpan session dan update state
        sessionManager.save(sessionUser);
        setCurrentUser(sessionUser);
        
        if (sessionUser.role === 'admin') {
            setView('admin-dashboard');
            showNotification('Welcome Admin', 'success');
        } else {
            setView('start');
            showNotification(`Halo, ${sessionUser.name}`, 'success');
        }
        
    } catch (error) {
        console.error("Login error details:", error);
        console.error("Error code:", error.code);
        console.error("Error message:", error.message);
        
        if (error.code === 'auth/unauthorized-domain') {
            showNotification(
                'DOMAIN TIDAK DIOTORISASI! \n' +
                'Langkah perbaikan:\n' + 
                '1. Buka Firebase Console\n' +
                '2. Pilih proyek "campak-e836a"\n' +
                '3. Buka Authentication  Sign-in method\n' +
                '4. Scroll ke "Authorized domains"\n' +
                '5. Tambahkan: ' + window.location.hostname + '\n' +
                '6. Coba lagi dalam 2 menit',
                'error'
            );
        } else if (error.code === 'auth/popup-blocked') {
            showNotification('Popup login diblokir browser. Izinkan popup untuk situs ini.', 'error');
        } else if (error.code === 'auth/popup-closed-by-user') {
            showNotification('Popup login ditutup sebelum selesai.', 'error');
        } else {
            showNotification('Error login: ' + error.message, 'error');
        }
    } finally {
        showLoading(false);
    }
};
            
            const handleLogout = () => { 
                setShowLogoutModal(true);
            };

            const confirmLogout = async () => {
    try {
        await dbAuth.signOut(); // Logout dari Firebase
    } catch (e) {
        console.error("Error signing out:", e);
    }
    sessionManager.clear(); 
    setCurrentUser(null); 
    setView('login'); 
    setShowLogoutModal(false);
};

            const handleStartNew = async () => { 
                const newId = Date.now().toString(); 
                setFormData({ 
                    ...INITIAL_DATA, 
                    id: newId, 
                    nomorEPID: '', 
                    createdBy: currentUser.email, 
                    createdUnit: currentUser.unitName,
                    originalUnit: currentUser.unitName,
                    currentOwner: currentUser.unitName,
                    epidManual: false,
                    transferHistory: []
                }); 
                setStep(1); 
                setView('form'); 
            };
            
            // PERBAIKAN POINT 1: Handle back to start dengan modal konfirmasi
            const handleBackToStart = () => {
                setShowConfirmExitModal(true);
            };

            // PERBAIKAN POINT 1: Handle confirm exit action
            const handleConfirmExitAction = (action) => {
                setShowConfirmExitModal(false);
                if (action === 'save') {
                    handleSaveDraft().then(() => {
                        setView('start');
                    });
                } else if (action === 'discard') {
                    setView('start');
                }
                // Jika cancel, tidak melakukan apa-apa
            };

            const handleEditForm = (item) => {
                console.log("Editing form:", item);
                
                const currentOwner = determineCurrentOwner(item);
                let canEdit = false;
                
                if (currentOwner === currentUser.unitName) {
                    canEdit = true;
                }
                
                if (!canEdit) {
                    showNotification('Anda tidak memiliki hak akses untuk mengedit formulir ini', 'error');
                    return;
                }
                
                const formDataToEdit = {
                    ...item,
                    updatedAt: Date.now()
                };
                
                showNotification('Formulir dibuka untuk diedit', 'success');
                setFormData(formDataToEdit);
                setStep(1); 
                setView('form'); 
            };
            
            const handleOpenDrafts = async () => { 
                await loadDataForView();
                setView('drafts'); 
            };
            
            const handleOpenPending = async () => { 
                await loadDataForView();
                setView('pending'); 
            };
            
            const handleOpenFormFinal = async () => { 
                await loadDataForView();
                setView('form-final'); 
            };
            
            const handleOpenOutgoing = async () => { 
                await loadDataForView();
                setView('outgoing'); 
            };
            
            const handleOpenInbox = async () => { 
                console.log("Opening inbox...");
                setHasNewReceived(false);
                await loadDataForView();
                setView('inbox');
                showNotification('Inbox dimuat', 'success');
            };

            const handleOpenRejected = async () => { 
                await loadDataForView();
                setView('rejected'); 
            };

            const handleShareForm = (item) => {
                setItemToShare(item);
                setShowShareModal(true);
            };

            const handleViewForm = (item) => {
    console.log("handleViewForm called with item:", item);
    console.log("Opening view modal for item:", item);
    if (!item) {
        showNotification('Data tidak ditemukan', 'error');
        return;
    }
    setItemToView(item);
    setShowViewModal(true);
    console.log("View modal should be visible now");
    console.log("showViewModal state should be true");
};

            const handleCloseViewModal = () => {
                console.log("Closing view modal");
                setShowViewModal(false);
                setItemToView(null);
            };

            const handleTransferForm = (item) => {
    setItemToTransfer(item);
    // Simpan di window untuk diakses modal
    window.itemToTransfer = item;
    setShowTransferModal(true);
};

            const confirmShare = async (target) => {
                if (!target || target === currentUser.unitName) {
                    showNotification('Tidak dapat mengirim ke diri sendiri', 'error');
                    return;
                }
                
                showLoading(true);
                setShowShareModal(false);
                
                try {
                    const transferRecord = createTransferRecord(
                        'dikirim', 
                        currentUser.unitName, 
                        target
                    );
                    
                    const up = { 
                        ...itemToShare, 
                        statusData: 'Proses', 
                        sharedTo: target, 
                        updatedAt: Date.now(),
                        currentOwner: itemToShare.currentOwner || determineCurrentOwner(itemToShare),
                        transferHistory: [...(itemToShare.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setItemToShare(null);
                    showNotification(`Formulir dikirim ke ${target}`, 'success');
                } catch (e) {
                    console.error("Error sharing form:", e);
                    showNotification('Error mengirim formulir', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const confirmTransfer = async (target) => {
    if (!target || target === currentUser.unitName) {
        showNotification('Tidak dapat meneruskan ke diri sendiri', 'error');
        return;
    }
    
    // PERBAIKAN 2: Cegah meneruskan kembali ke pengirim asli
    if (itemToTransfer && itemToTransfer.createdUnit === target) {
        showNotification('Tidak dapat meneruskan kembali ke unit pengirim asli', 'error');
        return;
    }
    
    // Cek riwayat transfer untuk mencegah loop
    if (itemToTransfer.transferHistory) {
        const hasBeenToTarget = itemToTransfer.transferHistory.some(
            record => record.to === target
        );
        
        if (hasBeenToTarget) {
            showNotification('Formulir sudah pernah dikirim ke unit ini', 'error');
            return;
        }
    }
    
    showLoading(true);
    setShowTransferModal(false);
    // Reset window item
    window.itemToTransfer = null;
    
    try {
        const transferRecord = createTransferRecord(
            'diteruskan', 
            currentUser.unitName, 
            target
        );
        
        const up = { 
            ...itemToTransfer, 
            statusData: 'Proses',
            sharedTo: target,
            updatedAt: Date.now(),
            currentOwner: itemToTransfer.currentOwner || determineCurrentOwner(itemToTransfer),
            transferHistory: [...(itemToTransfer.transferHistory || []), transferRecord]
        };
        
        await mockDB.save(up);
        await loadDataForView();
        setItemToTransfer(null);
        showNotification(`Formulir diteruskan ke ${target}`, 'success');
    } catch (e) {
        console.error("Error transferring form:", e);
        showNotification('Error meneruskan formulir', 'error');
    } finally {
        showLoading(false);
    }
};
            
            const handleAcceptTransfer = async (item) => { 
                showLoading(true); 
                try {
                    const transferRecord = createTransferRecord(
                        'diterima',
                        item.currentOwner || item.createdUnit,
                        currentUser.unitName,
                        currentUser.unitName
                    );
                    
                    const up = { 
                        ...item, 
                        statusData: 'Pending',
                        currentOwner: currentUser.unitName,
                        updatedAt: Date.now(),
                        transferHistory: [...(item.transferHistory || []), transferRecord]
                    }; 
                    
                    await mockDB.save(up); 
                    await loadDataForView();
                    setShowReviewModal(false); 
                    showNotification('Formulir diterima - Masuk ke menu Pending Form', 'success');
                } catch (e) {
                    console.error("Error accepting transfer:", e);
                    showNotification('Error menerima formulir', 'error');
                } finally {
                    showLoading(false); 
                }
            };
            
            const handleRejectTransfer = (item) => { 
                setItemToReject(item);
                setShowRejectModal(true);
            };
            
            const confirmRejectTransfer = async () => {
                if (!itemToReject) return;
                
                showLoading(true); 
                try {
                    const transferRecord = createTransferRecord(
                        'ditolak',
                        currentUser.unitName,
                        itemToReject.currentOwner || itemToReject.createdUnit
                    );
                    
                    const up = { 
                        ...itemToReject, 
                        statusData: 'Ditolak', 
                        currentOwner: itemToReject.currentOwner || determineCurrentOwner(itemToReject),
                        updatedAt: Date.now(),
                        transferHistory: [...(itemToReject.transferHistory || []), transferRecord]
                    }; 
                    
                    await mockDB.save(up); 
                    await loadDataForView();
                    setShowRejectModal(false); 
                    setItemToReject(null);
                    showNotification('Formulir ditolak - Kembali ke pengirim', 'error');
                } catch (e) {
                    console.error("Error rejecting transfer:", e);
                    showNotification('Error menolak formulir', 'error');
                } finally {
                    showLoading(false); 
                }
            };

            const handleFinalizeFromPending = (item) => {
                setItemToFinalize(item);
                setShowFinalizeModal(true);
            };

            const confirmFinalize = async () => {
                if (!itemToFinalize) return;
                
                showLoading(true); 
                try {
                    let finalData = { ...itemToFinalize };
                    
                    if (finalData.nomorEPID) {
                        finalData.epidManual = true;
                    }
                    
                    finalData.updatedAt = Date.now();
                    finalData.statusData = 'Final';
                    finalData.sharedTo = '';
                    finalData.currentOwner = finalData.currentOwner || finalData.createdUnit;
                    
                    await mockDB.save(finalData); 
                    await loadDataForView();
                    setShowFinalizeModal(false);
                    setItemToFinalize(null);
                    showNotification('Formulir berhasil difinalkan!', 'success');
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error menyimpan: ' + e.message, 'error'); 
                } finally {
                    showLoading(false);
                }
            };

            const handleUnfinalizeForm = (item) => {
                setItemToUnfinalize(item);
                setShowUnfinalizeModal(true);
            };

            const confirmUnfinalize = async () => {
                if (!itemToUnfinalize) return;
                
                showLoading(true);
                try {
                    const currentOwner = determineCurrentOwner(itemToUnfinalize);
                    
                    const transferRecord = createTransferRecord(
                        'dibatalkan_finalisasi',
                        'admin',
                        currentOwner
                    );
                    
                    const up = {
                        ...itemToUnfinalize,
                        statusData: 'Pending',
                        updatedAt: Date.now(),
                        currentOwner: currentOwner,
                        transferHistory: [...(itemToUnfinalize.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setShowUnfinalizeModal(false);
                    setItemToUnfinalize(null);
                    showNotification('Formulir berhasil dibatalkan finalisasi! Kembali ke Pending Form ' + currentOwner, 'success');
                } catch (e) {
                    console.error("Error unfinalizing form:", e);
                    showNotification('Error membatalkan finalisasi: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            const handleEditEpidForm = (item) => {
                setItemToEditEpid(item);
                setNewEpidNumber(item.nomorEPID || '');
                setShowEditEpidModal(true);
            };

            const confirmEditEpid = async () => {
                if (!itemToEditEpid) return;
                
                const validation = validateManualEPID(newEpidNumber);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
                
                showLoading(true);
                try {
                    const up = {
                        ...itemToEditEpid,
                        nomorEPID: newEpidNumber,
                        epidManual: true,
                        updatedAt: Date.now()
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setShowEditEpidModal(false);
                    setItemToEditEpid(null);
                    setNewEpidNumber('');
                    showNotification('Nomor EPID berhasil diubah!', 'success');
                } catch (e) {
                    console.error("Error editing EPID:", e);
                    showNotification('Error mengubah nomor EPID: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            const handleResumeDraft = (d) => { 
                setFormData(d); 
                setStep(1); 
                setView('form'); 
            };
            
            const handleExportMyData = () => { 
                if (formFinalList.length===0) {
                    showNotification('Tidak ada data untuk diexport', 'error'); 
                    return;
                }
                
                const enhancedData = formFinalList.map(item => {
                    const currentOwner = determineCurrentOwner(item);
                    return {
                        ...item,
                        currentOwner: currentOwner
                    };
                });
                
                exportToCSV(enhancedData, `Epid_${currentUser.unitName}_${new Date().toISOString().split('T')[0]}.csv`); 
            };
            
            const handleOpenReview = (i) => { 
                setReviewItem(i); 
                setShowReviewModal(true); 
            };
            
            const confirmDelete = (i) => { 
                setItemToDelete(i); 
                setShowDeleteModal(true); 
            };
            
            const handleDeleteForm = async () => { 
                if (itemToDelete && currentUser?.role === 'admin') { 
                    showLoading(true);
                    try {
                        await mockDB.delete(itemToDelete.id); 
                        await loadDataForView();
                        setShowDeleteModal(false); 
                        showNotification('Formulir dihapus', 'success');
                    } catch (e) {
                        console.error("Error deleting form:", e);
                        showNotification('Error menghapus formulir', 'error');
                    } finally {
                        showLoading(false);
                    }
                } else {
                    showNotification('Hanya admin yang dapat menghapus formulir', 'error');
                }
            };

            const handleChange = (e) => { 
    const { name, value, type, checked } = e.target; 
    
    let processedValue = value;
    if (name === 'namaKasus' || name === 'namaOrangtua' || name === 'pelaksanaInvestigasi' || name === 'namaSekolah') {
        processedValue = value.toUpperCase();
    }
    
    if (name === 'noKontakOrangtua') {
        processedValue = value.replace(/\D/g, '');
    }
    
    if (name === 'nomorEPID') {
        processedValue = value.toUpperCase();
    } 
    
    if (type === 'checkbox') { 
        if (name === 'gejalaLain' || name === 'komplikasi') {
            const fieldName = value; // Nama field seperti "Diare", "Pilek", dll
            setFormData(prev => ({ 
                ...prev, 
                [name]: {
                    ...prev[name],
                    [fieldName]: checked
                }
            })); 
        }
        else if (['jenisSampleDarah', 'jenisSampelLain'].some(k => name.includes(k))) { 
            setFormData(prev => { 
                const cur = prev[name] || []; 
                const nv = checked ? [...cur, value] : cur.filter(v => v !== value); 
                return { ...prev, [name]: nv }; 
            }); 
        } else { 
            setFormData(prev => ({ ...prev, [name]: checked })); 
        } 
    } else if (type === 'radio') {
        if (name.includes('sumber')) {
            setFormData(prev => ({ ...prev, [name]: value }));
        } else {
            setFormData(prev => ({ ...prev, [name]: processedValue }));
        }
    } else { 
        setFormData(prev => ({ ...prev, [name]: processedValue })); 
    } 
};


            const handleKecamatanChange = (e) => { 
                const v = e.target.value; 
                setFormData(p => ({ ...p, kecamatan: v, kelurahan: '' })); 
            };
            
            const handleSumberLaporanChange = (e) => { 
    const v = e.target.value; 
    setFormData(p => ({ 
        ...p, 
        sumberLaporan: v, 
        namaUnitPelapor: '', 
        sumberLainnya: '',
        // Reset kabupaten saat sumber laporan berubah
        kabupatenUnitPelapor: ''
    })); 
};
            
            const getGeoLocation = () => { 
                showLoading(true); 
                navigator.geolocation.getCurrentPosition( 
                    (p) => { 
                        setFormData(pr => ({ ...pr, titikLokasi: `${p.coords.latitude}, ${p.coords.longitude}` })); 
                        showLoading(false); 
                        showNotification('Koordinat berhasil direkam', 'success');
                    }, 
                    (e) => { 
                        showLoading(false); 
                        showNotification('GPS Error: ' + e.message, 'error'); 
                    } 
                ); 
            };
            
            // GANTI fungsi handleSaveDraft menjadi:
const handleSaveDraft = async () => { 
    showLoading(true); 
    try { 
        const d = { 
            ...formData, 
            statusData: 'Draft', 
            updatedAt: Date.now(), 
            createdBy: currentUser?.email, 
            createdUnit: currentUser?.unitName,
            originalUnit: currentUser?.unitName,
            currentOwner: formData.currentOwner || currentUser?.unitName
        }; 
        
        await mockDB.save(d); 
        setFormData(d); 
        showLoading(false); 
        showNotification('Draft tersimpan', 'success'); 
        return Promise.resolve();
    } catch (e) { 
        showLoading(false); 
        showNotification('Error Save: ' + e.message, 'error'); 
        return Promise.reject(e);
    } 
};
            
            const handleSaveToPending = async () => { 
                if (!formData.namaKasus) { 
                    showNotification('Nama Kasus wajib!', 'error'); 
                    return; 
                } 
                
                if (!formData.nomorEPID) {
                    showNotification('Nomor EPID wajib diisi!', 'error');
                    return;
                }
                
                if (!formData.kabupaten) { 
    showNotification('Kabupaten/Kota wajib dipilih!', 'error'); 
    return; 
}; 
                    
                
                showLoading(true); 
                try { 
                    const d = { 
                        ...formData, 
                        statusData: 'Pending',
                        updatedAt: Date.now(), 
                        createdBy: currentUser?.email, 
                        createdUnit: currentUser?.unitName,
                        originalUnit: currentUser?.unitName,
                        currentOwner: currentUser?.unitName
                    }; 
                    
                    await mockDB.save(d); 
                    setFormData(d); 
                    showLoading(false); 
                    showNotification('Formulir disimpan ke Pending Form', 'success');
                    
                    setTimeout(() => {
                        setView('pending'); 
                    }, 1000);
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error Save: ' + e.message, 'error'); 
                } 
            };
            
            const handleSaveAndFinal = async () => {
                if (!formData.namaKasus) { 
                    showNotification('Nama Kasus wajib!', 'error'); 
                    return; 
                } 
                
                if (!formData.tanggalLahir) {
                    showNotification('Tanggal Lahir wajib!', 'error');
                    return;
                }
                
                if (!formData.kecamatan || !formData.kelurahan) {
                    showNotification('Kecamatan dan Kelurahan wajib!', 'error');
                    return;
                }
                
                if (!formData.nomorEPID) {
                    showNotification('Nomor EPID wajib diisi!', 'error');
                    return;
                }
                
                showLoading(true); 
                try { 
                    let finalData = { ...formData };
                    
                    if (finalData.nomorEPID) {
                        finalData.epidManual = true;
                    }
                    
                    finalData.updatedAt = Date.now();
                    finalData.statusData = 'Final';
                    finalData.sharedTo = '';
                    finalData.currentOwner = finalData.currentOwner || finalData.createdUnit;
                    
                    await mockDB.save(finalData); 
                    setFormData(finalData); 
                    showLoading(false); 
                    
                    showNotification('Formulir berhasil difinalkan!', 'success');
                    
                    setTimeout(() => {
                        setView('success'); 
                    }, 500);
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error menyimpan: ' + e.message, 'error'); 
                } 
            };
            
            const showNotification = (msg, type) => { 
                setNotification({ msg, type }); 
                setTimeout(() => setNotification(null), 3000); 
            };
            
            const nextStep = () => {
                setStep(p => Math.min(p + 1, 6));
                setTimeout(() => {
                    if (formContainerRef.current) {
                        formContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 50);
            };
            
            const prevStep = () => {
                setStep(p => Math.max(p - 1, 1));
                setTimeout(() => {
                    if (formContainerRef.current) {
                        formContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 50);
            };

            const STEP_LABELS = [
                { id: 1, label: 'Laporan', icon: Icons.FileText }, 
                { id: 2, label: 'Kasus', icon: Icons.User }, 
                { id: 3, label: 'Klinis', icon: Icons.Thermometer }, 
                { id: 4, label: 'Imunisasi', icon: Icons.Shield }, 
                { id: 5, label: 'Kontak', icon: Icons.Plane }, 
                { id: 6, label: 'Spesimen', icon: Icons.Syringe }
            ];
                                        
            const renderCurrentView = () => {
                if (view === 'login') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-gradient-to-br from-slate-900 to-slate-800 overflow-y-auto">
        <div className="min-h-full flex items-center justify-center p-6 relative z-10">
            <div className="w-full max-w-sm bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl">
                <div className="text-center mb-8">
                    <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-500 to-indigo-500 shadow-lg shadow-blue-500/40 mb-4">
                        <Icons.Shield className="w-8 h-8 text-white" />
                    </div>
                    <h1 className="text-3xl font-black text-white mb-2 tracking-tight">Surveilans Campak/Rubella</h1>
                    <p className="text-slate-300 text-body font-medium">Login dengan akun Google</p>
                    <p className="text-slate-400 text-sm mt-2">*Akun harus didaftarkan oleh administrator</p>
                </div>
                
                {/* Tombol Login Google */}
                <button 
    onClick={handleLogin}
    className="w-full py-4 bg-white text-slate-800 rounded-xl font-bold border border-slate-200 text-subtitle flex items-center justify-center gap-3"
>
    {/* Ikon Google SVG */}
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
    </svg>
    Sign-In
</button>
                                
                                {/* Tombol Beranda di Login */}
                                <div className="mt-6">
                                    <button 
                                        onClick={() => window.location.href = 'index.html'}
                                        className="w-full py-3.5 bg-gradient-to-r from-slate-700 to-slate-800 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:shadow-slate-800/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2"
                                    >
                                        <Icons.Home className="w-5 h-5" /> Kembali ke Beranda
                                    </button>
                                </div>
                                
                                <div className="mt-8 text-center">
                                    <p className="text-[11px] font-bold text-slate-500 uppercase tracking-widest text-micro">by UPT Puskesmas Kampung Dalam</p>
                                </div>
                            </div>
                        </div>
                        {showLoadingOverlay && <LoadingOverlay />} 
                        <Toast notification={notification} />
                    </div>
                );

                if (view === 'admin-dashboard') return <AdminDashboard 
                    currentUser={currentUser} 
                    onLogout={handleLogout} 
                    mockDB={mockDB} 
                    mockUserDB={mockUserDB} 
                    showNotification={showNotification} 
                    exportToCSV={exportToCSV} 
                    loadDataForView={loadDataForView} 
                    ALL_SERVICES={ALL_SERVICES}
                    onViewForm={handleViewForm}
                    onUnfinalizeForm={handleUnfinalizeForm}
                    onEditEpidForm={handleEditEpidForm}
                    showAdminDeleteUserModal={showAdminDeleteUserModal}
                    setShowAdminDeleteUserModal={setShowAdminDeleteUserModal}
                    adminUserToDelete={adminUserToDelete}
                    setAdminUserToDelete={setAdminUserToDelete}
                    rejectedList={rejectedList}
                />;

                if (view === 'start') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                        <div className="p-6 pt-8 bg-white pb-6 rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <p className="text-slate-500 text-sm font-semibold uppercase tracking-wider mb-1 text-micro">Selamat datang,</p>
                                    <h1 className="text-2xl font-bold text-slate-800 tracking-tight">{currentUser?.name || 'Pengguna'}</h1>
                                    <div className="flex items-center gap-1 mt-2 text-blue-600 font-medium text-caption">
                                        <Icons.MapPin className="w-3.5 h-3.5"/> 
                                        {currentUser?.unitName}
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition">
                                    <Icons.LogOut className="w-5 h-5"/>
                                </button>
                            </div>
                            
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                                <p className="text-slate-700 font-medium text-caption">Sistem ini dikembangkan oleh UPT Puskesmas Kampung Dalam</p>
                                <p className="text-slate-900 font-bold text-subtitle">Sistem Epidemiologi Campak</p>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={handleStartNew} className="col-span-2 bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl shadow-blue-500/30 flex items-center justify-between group active:scale-[0.98] transition-all">
                                    <div className="text-left">
                                        <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mb-3 text-white">
                                            <Icons.FileText className="w-6 h-6"/>
                                        </div>
                                        <h3 className="font-bold text-lg tracking-tight">Buat formulir MR-01</h3>
                                        <p className="text-blue-100 text-body font-medium">Input kasus Campak/Rubella</p>
                                    </div>
                                    <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                        <Icons.ChevronLeft className="rotate-180 w-5 h-5"/>
                                    </div>
                                </button>

                                <button onClick={handleOpenDrafts} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-orange-50 text-orange-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.List className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Draft Tersimpan</h3>
                                    <p className="text-slate-500 text-caption mt-1">Lanjutkan Editing Formulir</p>
                                    {draftsList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {draftsList.length}
                                        </div>
                                    )}
                                </button>
                                
                                <button onClick={handleOpenPending} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Hourglass className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Pending Form</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir dalam verifikasi</p>
                                    {pendingList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-amber-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {pendingList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenFormFinal} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Archive className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Final</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir yang difinalisasi</p>
                                    {formFinalList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-emerald-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {formFinalList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenOutgoing} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Send className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Keluar</h3>
                                    <p className="text-slate-500 text-caption mt-1">Proses Pengiriman Formulir</p>
                                    {outgoingList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-indigo-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {outgoingList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenInbox} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative overflow-hidden group">
                                    <div className="w-10 h-10 bg-rose-50 text-rose-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Inbox className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Inbox</h3>
                                    <p className="text-slate-500 text-caption mt-1">Penerimaan formulir</p>
                                    {hasNewReceived && (
                                        <div className="absolute top-4 right-4">
                                            <div className="w-3 h-3 bg-rose-500 rounded-full animate-ping"></div>
                                            <div className="absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full"></div>
                                        </div>
                                    )}
                                    {receivedList.length > 0 && !hasNewReceived && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-rose-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {receivedList.length}
                                        </div>
                                    )}
                                </button>
                                
                                <button onClick={handleOpenRejected} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-red-50 text-red-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.XOctagon className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Ditolak</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir yang ditolak</p>
                                    {rejectedList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {rejectedList.length}
                                        </div>
                                    )}
                                </button>
                            </div>
                            
                            <div className="mt-10 text-center">
                                <p className="text-slate-300 text-xs font-bold uppercase tracking-[0.2em] text-micro">Kampung Surveilans v1.0</p>
                            </div>
                        </div>
                        
                        {showLoadingOverlay && <LoadingOverlay />} 
                        <Toast notification={notification} />
                    </div>
                );

                if (view === 'form') {
    const progressPercent = ((step - 1) / (STEP_LABELS.length - 1)) * 100;
    
    return (
        <div className="fixed inset-0 h-[100dvh] w-full flex flex-col bg-slate-50 overflow-hidden">
            <div className="flex-none z-50 px-4 py-4 bg-white/90 backdrop-blur-sm border-b border-slate-100 shadow-sm">
                <div className="max-w-3xl mx-auto">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                            <button onClick={step === 1 ? handleBackToStart : prevStep} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm hover:shadow-md active:scale-90 transition">
                                {step === 1 ? (
                                    <Icons.Home className="w-5 h-5" />
                                ) : (
                                    <Icons.ChevronLeft className="w-5 h-5" />
                                )}
                            </button>
                            {step > 1 && (
                                <button onClick={handleBackToStart} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm hover:shadow-md active:scale-90 transition" title="Kembali ke Menu Utama">
                                    <Icons.Home className="w-5 h-5" />
                                </button>
                            )}
                        </div>
                        
                        <div className="flex flex-col items-center">
                            <span className="text-[11px] font-bold text-blue-600 uppercase tracking-wider mb-0.5 text-micro">
                                Langkah {step} dari 6
                            </span>
                            <h2 className="text-lg font-bold text-slate-800 tracking-tight">
                                {STEP_LABELS[step-1].label}
                            </h2>
                        </div>

                        {step < 6 ? (
                            <button onClick={nextStep} className="h-10 px-5 rounded-full bg-slate-900 text-white text-sm font-bold shadow-md hover:shadow-lg active:scale-90 transition flex items-center gap-2">
                                Lanjut <Icons.ChevronLeft className="rotate-180 w-3.5 h-3.5"/>
                            </button>
                        ) : (
                            <div className="w-20"></div>
                        )}
                    </div>
                    
                    <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-500 ease-out" style={{ width: `${progressPercent}%` }}></div>
                    </div>
                </div>
            </div>

            <div ref={formContainerRef} className="flex-1 overflow-y-auto p-4 pb-32 scroll-smooth">
                <div className="max-w-3xl mx-auto animate-fadeIn">
                    <Card className="min-h-[60vh]">
                        <div className="flex justify-between items-start mb-8">
                                            <div>
                                                <h3 className="font-bold text-2xl text-slate-800 mb-2 tracking-tight">
                                                    {STEP_LABELS[step-1].label}
                                                </h3>
                                                <p className="text-slate-500 text-body font-medium">
                                                    Lengkapi data berikut dengan benar dan teliti.
                                                </p>
                                            </div>
                                            <button onClick={handleSaveDraft} className="text-blue-600 bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-100 transition flex items-center gap-2 border border-blue-100">
                                                <Icons.Save className="w-4 h-4"/> Draft
                                            </button>
                                        </div>

                                        {step === 1 && <Step1 data={formData} onChange={handleChange} onSumberChange={handleSumberLaporanChange} Icons={Icons} />}
                                        {step === 2 && <Step2 data={formData} onChange={handleChange} onChangeKecamatan={handleKecamatanChange} Icons={Icons} />}
                                        {step === 3 && <Step3 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 4 && <Step4 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 5 && <Step5 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 6 && <Step6 
                                            data={formData} 
                                            onChange={handleChange} 
                                            getGeo={getGeoLocation} 
                                            loadingGeo={loading} 
                                            onSaveToPending={handleSaveToPending}
                                            onSaveAndFinal={handleSaveAndFinal}
                                            Icons={Icons} 
                                        />}
                    </Card>
                </div>
            </div>

            {/* PERBAIKAN POINT 1: Modal Konfirmasi Keluar */}
            {showConfirmExitModal && (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                        <div className="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Icons.AlertTriangle className="w-8 h-8" />
                        </div>
                        <h3 className="font-bold text-xl mb-2 text-blue-600">Keluar dari Formulir?</h3>
                        <p className="text-slate-500 mb-6 text-body">
                            Apakah Anda ingin menyimpan draft sebelum keluar? Perubahan yang belum disimpan akan hilang.
                        </p>
                        <div className="flex flex-col gap-3">
                            <button 
                                onClick={() => handleConfirmExitAction('save')} 
                                className="w-full p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                            >
                                Simpan sebagai Draft
                            </button>
                            <button 
                                onClick={() => handleConfirmExitAction('discard')} 
                                className="w-full p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                            >
                                Keluar Tanpa Menyimpan
                            </button>
                            <button 
                                onClick={() => handleConfirmExitAction('cancel')} 
                                className="w-full p-3.5 border border-slate-200 text-slate-500 rounded-lg font-bold hover:bg-slate-50 transition"
                            >
                                Batal & Lanjutkan Editing
                            </button>
                        </div>
                    </div>
                </div>
            )}
            
            {showLoadingOverlay && <LoadingOverlay />} 
            <Toast notification={notification} />
        </div>
    );
}
                
                if (view === 'drafts') return (
                    <ListView 
                        title="Draft Tersimpan" 
                        data={draftsList} 
                        type="draft" 
                        onBack={() => setView('start')} 
                        onAction={handleResumeDraft} 
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        notification={notification} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        currentUser={currentUser}
                        count={draftsList.length}
                    />
                );
                
                if (view === 'pending') return (
                    <PendingListView 
                        title="Pending Form" 
                        data={pendingList} 
                        type="pending" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onEdit={handleEditForm}
                        onFinalize={handleFinalizeFromPending}
                        onShare={handleShareForm}
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        showShareModal={showShareModal} 
                        setShowShareModal={setShowShareModal} 
                        confirmShare={confirmShare} 
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={pendingList.length}
                    />
                );
                
                if (view === 'form-final') return (
                    <FormFinalListView 
                        title="Form Final" 
                        data={formFinalList} 
                        type="form-final" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onExport={handleExportMyData} 
                        Icons={Icons} 
                        notification={notification} 
                        currentUser={currentUser}
                        count={formFinalList.length}
                    />
                );
                
                if (view === 'outgoing') return (
                    <OutgoingListView 
                        title="Formulir Keluar" 
                        data={outgoingList} 
                        type="outgoing" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        Icons={Icons} 
                        notification={notification} 
                        currentUser={currentUser}
                        count={outgoingList.length}
                    />
                );
                
                if (view === 'inbox') return (
                    <InboxListView 
                        title="Inbox" 
                        data={receivedList} 
                        type="inbox" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm} 
                        onAccept={handleAcceptTransfer} 
                        onReject={handleRejectTransfer}
                        onTransfer={handleTransferForm}
                        Icons={Icons} 
                        showReviewModal={showReviewModal} 
                        reviewItem={reviewItem} 
                        setShowReviewModal={setShowReviewModal} 
                        setReviewItem={setReviewItem} 
                        showTransferModal={showTransferModal}
                        setShowTransferModal={setShowTransferModal}
                        confirmTransfer={confirmTransfer}
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={receivedList.length}
                        showRejectModal={showRejectModal}
                        setShowRejectModal={setShowRejectModal}
                        confirmRejectTransfer={confirmRejectTransfer}
                    />
                );

                if (view === 'rejected') return (
                    <RejectedListView 
                        title="Form Ditolak" 
                        data={rejectedList} 
                        type="rejected" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onEdit={handleEditForm}
                        onShare={handleShareForm}
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        showShareModal={showShareModal} 
                        setShowShareModal={setShowShareModal} 
                        confirmShare={confirmShare} 
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={rejectedList.length}
                    />
                );

                if (view === 'success') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-white flex items-center justify-center p-6">
                        <div className="text-center w-full max-w-sm animate-fadeIn">
                            <div className="w-24 h-24 bg-gradient-to-br from-green-50 to-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-green-100">
                                <Icons.CheckCircle className="w-12 h-12 text-green-500" />
                            </div>
                            <h2 className="text-3xl font-black text-slate-800 mb-3 tracking-tight">Berhasil Disimpan!</h2>
                            <p className="text-slate-500 mb-8 font-medium text-body">Data surveilans telah tersimpan dengan aman.</p>
                            
                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-100 mb-8">
                                <p className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 text-micro">Nomor EPID</p>
                                <p className="text-2xl font-mono font-bold text-slate-800 tracking-tight">{formData.nomorEPID}</p>
                                <p className="text-sm text-slate-500 mt-2">
                                    {formData.epidManual ? '(EPID Manual)' : '(EPID Otomatis)'}
                                </p>
                            </div>
                            
                            <button onClick={() => setView('start')} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:shadow-slate-900/20 active:scale-95 transition text-subtitle">
                                Kembali ke Menu Utama
                            </button>
                        </div>
                    </div>
                );

                return (
                    <div className="fixed inset-0 bg-slate-900 text-white flex items-center justify-center">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold mb-4">Terjadi Kesalahan</h1>
                            <p>View tidak ditemukan: {view}</p>
                            <button onClick={() => setView('start')} className="mt-4 px-4 py-2 bg-blue-600 rounded-lg">
                                Kembali ke Start
                            </button>
                        </div>
                    </div>
                );
            };

            const StableLoadingOverlay = () => (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center min-w-[200px] min-h-[200px] justify-center">
                        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-slate-700 font-bold">Memproses...</p>
                        <p className="text-slate-500 text-sm mt-2">Harap tunggu sebentar</p>
                    </div>
                </div>
            );

            return (
                <div id="root">
                    {renderCurrentView()}
                    
                    {showViewModal && (
                        <ViewModal 
                            item={itemToView} 
                            onClose={() => {
                                console.log("Closing view modal");
                                setShowViewModal(false);
                                setItemToView(null);
                            }} 
                            Icons={Icons} 
                        />
                    )}
                    
                    {showEditEpidModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.Edit className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-blue-600">Edit Nomor EPID</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Formulir: <strong>{itemToEditEpid?.namaKasus || 'Tanpa Nama'}</strong>
                                </p>
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold text-slate-600 mb-2">Nomor EPID Baru</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-center"
                                        value={newEpidNumber}
                                        onChange={(e) => setNewEpidNumber(e.target.value.toUpperCase())}
                                        placeholder="Masukkan nomor EPID (bebas)"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">Bebas mengisi nomor EPID</p>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowEditEpidModal(false);
                                            setItemToEditEpid(null);
                                            setNewEpidNumber('');
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmEditEpid} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Simpan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showFinalizeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.CheckCircle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-green-600">Finalisasi Formulir?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Apakah Anda yakin data ini sudah valid dan ingin difinalisasi?
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowFinalizeModal(false);
                                            setItemToFinalize(null);
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmFinalize} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Finalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                   {showLogoutModal && (
    <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
            <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <Icons.LogOut className="w-8 h-8" />
            </div>
            <h3 className="font-bold text-xl mb-2 text-red-600">Konfirmasi Logout</h3>
            <p className="text-slate-500 mb-6 text-body">Apakah Anda yakin ingin keluar dari akun ini?</p>
            <div className="flex flex-col gap-3">
                
                <button 
                    onClick={confirmLogout} 
                    className="w-full p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                >
                    Keluar Akun Campak
                </button>
                
                <button 
                    onClick={() => {
                        setShowLogoutModal(false);
                        window.location.href = 'index.html';
                    }} 
                    className="w-full p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                >
                    Ke Beranda
                </button>
                
                <button 
                    onClick={() => setShowLogoutModal(false)} 
                    className="w-full p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                >
                    Batal
                </button>
                
            </div>
        </div>
    </div>
)}
                   
                    {showUnfinalizeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-amber-600">Batalkan Finalisasi?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Formulir akan dikembalikan ke Pending Form current owner.
                                </p>
                                <div className="mb-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                                    <p className="text-sm text-amber-700 font-medium">
                                        Status: <strong>Pending</strong><br/>
                                        Current Owner: <strong>{itemToUnfinalize ? determineCurrentOwner(itemToUnfinalize) : ''}</strong>
                                    </p>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowUnfinalizeModal(false);
                                            setItemToUnfinalize(null);
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmUnfinalize} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Batalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showTransferModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmTransfer} onCancel={() => setShowTransferModal(false)} />}
                    
                    {showRejectModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Tolak Formulir?</h3>
                                <p className="text-slate-500 mb-6 text-body">Formulir akan dikembalikan ke pengirim dengan status "Ditolak".</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowRejectModal(false)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={confirmRejectTransfer} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Tolak
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showLoadingOverlay && <StableLoadingOverlay />}
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        // BAGIAN 5: KOMPONEN LIST VIEW
        const ListView = ({ title, data, type, onBack, onAction, onDelete, Icons, notification, showDeleteModal, setShowDeleteModal, handleDelete, currentUser, count }) => (
            <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                    <div className="flex items-center justify-between mb-6">
                        <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                            <Icons.ChevronLeft className="w-5 h-5"/>
                        </button>
                        <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-blue-600 text-sm">({count})</span></h2>
                        <div className="w-10"></div>
                    </div>
                </div>
                
                <div className="flex-1 overflow-y-auto p-6 pb-24">
                    {data.length === 0 ? (
                        <div className="text-center text-slate-400 py-20 font-medium italic">
                            Tidak ada data untuk ditampilkan
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {data.map(item => (
                                <div key={item.id} className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                            {item.nomorEPID || 'DRAFT'}
                                        </div>
                                        <div className="text-xs text-slate-500 font-medium">
                                            {new Date(item.updatedAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    
                                    <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                    <p className="text-sm text-slate-600 font-medium mb-1">
                                        {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                    </p>
                                    <p className="text-sm text-slate-500 mb-5">
                                        {item.kelurahan || 'Lokasi tidak diketahui'}
                                    </p>
                                    
                                    <div className="flex gap-2 border-t border-slate-100 pt-4">
                                        <button onClick={() => onAction(item)} className="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition">
                                            Edit Draft
                                        </button>
                                        {currentUser?.role === 'admin' && (
                                            <button onClick={() => onDelete(item)} className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100">
                                                <Icons.Trash className="w-4.5 h-4.5"/>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                
                {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                <Toast notification={notification} />
            </div>
        );

        const PendingListView = ({ title, data, type, onBack, onView, onEdit, onFinalize, onShare, onDelete, Icons, showDeleteModal, setShowDeleteModal, handleDelete, showShareModal, setShowShareModal, confirmShare, notification, loading, ALL_SERVICES, currentUser, count }) => {
            const getStatusBadge = (status, isFromOtherUnit = false) => {
                const statusColors = {
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Draft': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200'
                };
                
                const color = statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                const fromOtherBadge = isFromOtherUnit ? 'bg-purple-100 text-purple-800 ml-1 border border-purple-200' : '';
                
                return (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`status-badge ${color}`}>
                            {status}
                        </span>
                       
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-amber-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                    const currentOwner = determineCurrentOwner(item);
                                    const isCurrentOwner = currentOwner === currentUser.unitName;
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData, isFromOtherUnit)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                {isFromOtherUnit && (
                                                    <span className="block text-xs text-purple-600 mt-1 font-semibold">
                                                        Dari: {item.createdUnit}
                                                    </span>
                                                )}
                                                <span className="block text-xs text-green-600 mt-1">
                                                    Current Owner: {currentOwner}
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onEdit(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 border border-blue-100 hover:border-blue-200 hover:bg-blue-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Edit className="w-4 h-4"/> Edit
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onFinalize(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-green-50 to-emerald-50 text-green-600 border border-green-100 hover:border-green-200 hover:bg-green-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Check className="w-4 h-4"/> Finalisasi
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onShare(item) : null} 
                                                    disabled={!isCurrentOwner || isFromOtherUnit}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        (isCurrentOwner && !isFromOtherUnit)
                                                            ? 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-600 border border-purple-100 hover:border-purple-200 hover:bg-purple-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Share className="w-4 h-4"/> Bagikan
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onDelete(item)} 
                                                    className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100"
                                                >
                                                    <Icons.Trash className="w-4.5 h-4.5"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                    {showShareModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmShare} onCancel={() => setShowShareModal(false)} />}
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const FormFinalListView = ({ title, data, type, onBack, onView, onExport, Icons, notification, currentUser, count }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            const filteredData = data.filter(item => 
                item.namaKasus?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.nomorEPID?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.kelurahan?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.createdUnit?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredData.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            const nextPage = () => {
                if (currentPage < totalPages) setCurrentPage(currentPage + 1);
            };

            const prevPage = () => {
                if (currentPage > 1) setCurrentPage(currentPage - 1);
            };

            const getStatusBadge = (status) => {
                return (
                    <span className={`status-badge bg-green-100 text-green-800 border border-green-200`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-green-600 text-sm">({count})</span></h2>
                            <button onClick={onExport} className="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100">
                                <Icons.Download className="w-5 h-5"/>
                            </button>
                        </div>
                        
                        <div className="mt-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Cari di Form Final..."
                                    className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => {
                                        setSearchTerm(e.target.value);
                                        setCurrentPage(1);
                                    }}
                                />
                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
                            </div>
                            <p className="text-xs text-slate-500 mt-2">
                                Menampilkan {Math.min(filteredData.length, itemsPerPage)} data per halaman
                            </p>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {filteredData.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                {searchTerm ? 'Tidak ada data yang sesuai dengan pencarian' : 'Tidak ada data untuk ditampilkan'}
                            </div>
                        ) : (
                            <>
                                <div className="grid gap-4">
                                    {currentItems.map(item => {
                                        const currentOwner = determineCurrentOwner(item);
                                        const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                        
                                        return (
                                            <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-2 flex-nowrap">
                                                        <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                            {item.nomorEPID || 'NO-EPID'}
                                                        </div>
                                                        {getStatusBadge(item.statusData)}
                                                        {isFromOtherUnit && (
                                                            <span className="status-badge bg-purple-100 text-purple-800 border border-purple-200">
                                                                Rujukan
                                                            </span>
                                                        )}
                                                    
                                                    </div>
                                                </div>
                                                
                                                <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                                <p className="text-sm text-slate-600 font-medium mb-1">
                                                    {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                                </p>
                                                <p className="text-sm text-slate-500 mb-5">
                                                    {item.kelurahan || 'Lokasi tidak diketahui'}
                                                    {isFromOtherUnit && (
                                                        <span className="block text-xs text-purple-600 mt-1">
                                                            Asal: {item.createdUnit}
                                                        </span>
                                                    )}
                                                    <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                        Current Owner: {currentOwner}
                                                    </span>
                                                </p>
                                                
                                                <div className="flex gap-2 border-t border-slate-100 pt-4">
                                                    <button 
                                                        onClick={() => onView(item)} 
                                                        className="w-full py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                    >
                                                        <Icons.Eye className="w-4 h-4"/> Lihat Detail
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {filteredData.length > itemsPerPage && (
                                    <div className="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                        <p className="text-sm text-slate-600">
                                            Menampilkan {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, filteredData.length)} dari {filteredData.length} data
                                        </p>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={prevPage}
                                                disabled={currentPage === 1}
                                                className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                            >
                                                Sebelumnya
                                            </button>
                                            <span className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium">
                                                Halaman {currentPage} dari {totalPages}
                                            </span>
                                            <button
                                                onClick={nextPage}
                                                disabled={currentPage === totalPages}
                                                className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                            >
                                                Selanjutnya
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        const OutgoingListView = ({ title, data, type, onBack, onView, Icons, notification, currentUser, count }) => {
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Diterima': 'bg-emerald-100 text-emerald-800 border border-emerald-200',
                    'Transferred': 'bg-purple-100 text-purple-800 border border-purple-200'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-indigo-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const currentOwner = determineCurrentOwner(item);
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData)}
                                                </div>
                                               
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-indigo-600 mt-1">
                                                    Dikirim ke: {item.sharedTo}
                                                </span>
                                                {item.statusData === 'Ditolak' && (
                                                    <span className="block text-xs text-red-600 mt-1">
                                                        Status: Ditolak oleh penerima
                                                    </span>
                                                )}
                                                {item.statusData === 'Diterima' && (
                                                    <span className="block text-xs text-green-600 mt-1">
                                                        Status: Diterima oleh penerima (masuk Pending Form)
                                                    </span>
                                                )}
                                            </p>
                                            
                                            <div className="flex gap-2 border-t border-slate-100 pt-4">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat Detail
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        const InboxListView = ({ title, data, type, onBack, onView, onAccept, onReject, onTransfer, Icons, showReviewModal, reviewItem, setShowReviewModal, setReviewItem, showTransferModal, setShowTransferModal, confirmTransfer, notification, loading, ALL_SERVICES, currentUser, count, showRejectModal, setShowRejectModal, confirmRejectTransfer }) => {
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-rose-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const currentOwner = determineCurrentOwner(item);
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-indigo-600 mt-1">
                                                    Dari: {item.createdUnit}
                                                </span>
                                                <span className="block text-xs text-blue-600 mt-1">
                                                    Status: Menunggu tindakan Anda
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => { 
                                                        console.log("Accepting item:", item);
                                                        setReviewItem(item); 
                                                        setShowReviewModal(true); 
                                                    }} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-green-50 text-green-600 rounded-lg text-sm font-bold border border-green-100 hover:border-green-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Check className="w-4 h-4"/> Terima
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onReject(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-red-50 text-red-600 rounded-lg text-sm font-bold border border-red-100 hover:border-red-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.XCircle className="w-4 h-4"/> Tolak
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onTransfer(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold border border-indigo-100 hover:border-indigo-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Send className="w-4 h-4"/> Teruskan
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showReviewModal && reviewItem && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.CheckCircle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-slate-800">Yakin Terima Formulir?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    <strong>{reviewItem.namaKasus || 'Formulir'}</strong>
                                </p>
                                <p className="text-slate-500 mb-6 text-sm">
                                    Formulir akan masuk ke <strong>Pending Form</strong> untuk verifikasi.
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowReviewModal(false)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={() => onAccept(reviewItem)} className="flex-1 p-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Terima
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    
                    
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const RejectedListView = ({ title, data, type, onBack, onView, onEdit, onShare, onDelete, Icons, showDeleteModal, setShowDeleteModal, handleDelete, showShareModal, setShowShareModal, confirmShare, notification, loading, ALL_SERVICES, currentUser, count }) => {
            const getStatusBadge = (status, isFromOtherUnit = false) => {
                const statusColors = {
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200'
                };
                
                const color = statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                const fromOtherBadge = isFromOtherUnit ? 'bg-purple-100 text-purple-800 ml-1 border border-purple-200' : '';
                
                return (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`status-badge ${color}`}>
                            {status}
                        </span>
                    
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-red-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                    const currentOwner = determineCurrentOwner(item);
                                    const isCurrentOwner = currentOwner === currentUser.unitName;
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.nomorEPID || 'NO-EPID'}
                                                    </div>
                                                    {getStatusBadge(item.statusData, isFromOtherUnit)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaKasus || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.tanggalLahir ? new Date(item.tanggalLahir).toLocaleDateString() : '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                {isFromOtherUnit && (
                                                    <span className="block text-xs text-purple-600 mt-1 font-semibold">
                                                        Dari: {item.createdUnit}
                                                    </span>
                                                )}
                                                <span className="block text-xs text-green-600 mt-1">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-red-600 mt-1 font-semibold">
                                                    Ditolak oleh: {item.sharedTo || 'Unit Lain'}
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onEdit(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 border border-blue-100 hover:border-blue-200 hover:bg-blue-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Edit className="w-4 h-4"/> Edit
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onShare(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-600 border border-purple-100 hover:border-purple-200 hover:bg-purple-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Share className="w-4 h-4"/> Bagikan Ulang
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onDelete(item)} 
                                                    className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100"
                                                >
                                                    <Icons.Trash className="w-4.5 h-4.5"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                    {showShareModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmShare} onCancel={() => setShowShareModal(false)} />}
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const SharePuskesmasModalWithSearch = ({ servicesList, currentUnit, onConfirm, onCancel, title = "Kirim ke Unit Lain", description = "Pilih unit layanan yang akan menerima formulir ini." }) => {
    const [search, setSearch] = useState('');
    const [selected, setSelected] = useState('');
    const [filteredServices, setFilteredServices] = useState([]);
    const [activeFilter, setActiveFilter] = useState('semua');
    const [isTransferModal, setIsTransferModal] = useState(title.includes('Teruskan'));
    
    useEffect(() => {
        const filterServices = () => {
            let filtered = servicesList.filter(s => {
                const matchesSearch = s.toLowerCase().includes(search.toLowerCase());
                const isNotCurrentUnit = s !== currentUnit;
                let isNotOriginalSender = true;
                if (isTransferModal && window.itemToTransfer) {
                    isNotOriginalSender = s !== window.itemToTransfer.createdUnit;
                }
                return matchesSearch && isNotCurrentUnit && isNotOriginalSender;
            });
            
            if (activeFilter === 'puskesmas') {
                filtered = filtered.filter(s => s.toLowerCase().includes('puskesmas'));
            } else if (activeFilter === 'rumah sakit') {
                filtered = filtered.filter(s => 
                    s.toLowerCase().includes('rs') || 
                    s.toLowerCase().includes('rumah sakit') ||
                    s.toLowerCase().includes('rsu') ||
                    s.toLowerCase().includes('rsia')
                );
            }
            
            setFilteredServices(
                filtered
                    .sort((a, b) => a.localeCompare(b))
                    .slice(0, 400)
            );
        };
        
        filterServices();
    }, [search, activeFilter, servicesList, currentUnit, isTransferModal]);
    
    const handleSelect = (service) => {
        setSelected(service);
    };
    
    const handleConfirm = () => {
        if (selected) {
            onConfirm(selected);
        }
    };
    
    const resetSearch = () => {
        setSearch('');
        setActiveFilter('semua');
    };
    
    const handleCancel = () => {
        if (isTransferModal) {
            window.itemToTransfer = null;
        }
        onCancel();
    };
    
    const groupedServices = filteredServices.reduce((groups, service) => {
        let kabupaten = "Lainnya";
        
        for (const [kab, layananList] of Object.entries(LAYANAN_BY_KABUPATEN)) {
            if (layananList.some(item => item.nama === service)) {
                kabupaten = kab;
                break;
            }
        }
        
        if (!groups[kabupaten]) {
            groups[kabupaten] = [];
        }
        groups[kabupaten].push(service);
        return groups;
    }, {});
    
    return (
        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
            {/* PERBAIKAN: Gunakan rounded-xl yang konsisten untuk semua sisi */}
            <div className="bg-white rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
                {/* Header dengan rounded top */}
                <div className="p-4 border-b border-slate-200">
                    <div className="flex justify-between items-center">
                        <div className="flex-1">
                            {title && (
                                <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                            )}
                        </div>
                        <button onClick={handleCancel} className="text-slate-400 hover:text-slate-600 ml-4">
                            <Icons.XCircle className="w-6 h-6" />
                        </button>
                    </div>
                </div>
                
                {/* Konten - area utama */}
                <div className="p-4 flex-1 overflow-hidden flex flex-col">
                    <div className="space-y-3 mb-4">
                        <div className="relative">
                            <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                                <Icons.Search className="w-4 h-4" />
                            </div>
                            <input
                                type="text"
                                className="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                placeholder="Cari unit layanan..."
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                                autoFocus
                            />
                            {search && (
                                <button
                                    onClick={resetSearch}
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"
                                >
                                    <Icons.X className="w-4 h-4" />
                                </button>
                            )}
                        </div>
                        
                        <div className="flex flex-wrap gap-1">
                            <button
                                onClick={() => setActiveFilter('semua')}
                                className={`px-2.5 py-1 text-xs rounded-full font-medium transition ${
                                    activeFilter === 'semua' 
                                        ? 'bg-blue-100 text-blue-700 border border-blue-200' 
                                        : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200'
                                }`}
                            >
                                Semua
                            </button>
                            <button
                                onClick={() => setActiveFilter('puskesmas')}
                                className={`px-2.5 py-1 text-xs rounded-full font-medium transition ${
                                    activeFilter === 'puskesmas' 
                                        ? 'bg-green-100 text-green-700 border border-green-200' 
                                        : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200'
                                }`}
                            >
                                Puskesmas
                            </button>
                            <button
                                onClick={() => setActiveFilter('rumah sakit')}
                                className={`px-2.5 py-1 text-xs rounded-full font-medium transition ${
                                    activeFilter === 'rumah sakit' 
                                        ? 'bg-red-100 text-red-700 border border-red-200' 
                                        : 'bg-slate-100 text-slate-600 border border-slate-200 hover:bg-slate-200'
                                }`}
                            >
                                Rumah Sakit
                            </button>
                        </div>
                        
                        <div className="flex justify-between items-center text-xs text-slate-500">
                            <span>
                                {filteredServices.length} hasil ditemukan
                                {search && ` untuk "${search}"`}
                            </span>
                        </div>
                    </div>
                    
                    {/* PERBAIKAN: Gunakan rounded-lg yang konsisten, hapus overflow-hidden jika tidak perlu */}
                    <div className="flex-1 overflow-y-auto">
                        <div className="border border-slate-200 rounded-lg">
                            {filteredServices.length === 0 ? (
                                <div className="text-center p-6 text-slate-400">
                                    <Icons.Search className="w-8 h-8 mx-auto mb-2 text-slate-300" />
                                    <p className="font-medium text-sm">Tidak ditemukan unit layanan</p>
                                    <p className="text-xs mt-1">Coba kata kunci lain atau pilih filter berbeda</p>
                                </div>
                            ) : (
                                <div className="divide-y divide-slate-100">
                                    {filteredServices.length <= 30 ? (
                                        filteredServices.map(service => (
                                            <ServiceItem 
                                                key={service} 
                                                service={service} 
                                                selected={selected} 
                                                onSelect={handleSelect}
                                            />
                                        ))
                                    ) : (
                                        Object.entries(groupedServices).map(([kabupaten, services]) => (
                                            <div key={kabupaten}>
                                                <div className="bg-slate-50 p-2 border-b border-slate-200 sticky top-0 z-10">
                                                    <h4 className="font-bold text-slate-700 text-xs flex items-center gap-1">
                                                        <Icons.MapPin className="w-3 h-3" />
                                                        {kabupaten}
                                                        <span className="text-xs font-normal text-slate-500 ml-1">
                                                            ({services.length})
                                                        </span>
                                                    </h4>
                                                </div>
                                                {services.map(service => (
                                                    <ServiceItem 
                                                        key={service} 
                                                        service={service} 
                                                        selected={selected} 
                                                        onSelect={handleSelect}
                                                    />
                                                ))}
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}
                            
                            {filteredServices.length >= 50 && (
                                <div className="bg-amber-50 border-t border-amber-200 p-2 text-center rounded-b-lg">
                                    <p className="text-amber-700 text-xs">
                                        Gunakan fitur pencarian lebih spesifik
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {selected && (
                        <div className="mt-3 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-xs text-blue-600 font-semibold mb-1">Layanan Terpilih:</p>
                                    <p className="font-bold text-slate-800 text-sm">{selected}</p>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`px-1.5 py-0.5 text-xs rounded ${
                                            selected.toLowerCase().includes('puskesmas') 
                                                ? 'bg-green-100 text-green-700' 
                                                : 'bg-red-100 text-red-700'
                                        }`}>
                                            {selected.toLowerCase().includes('puskesmas') ? 'Puskesmas' : 'Rumah Sakit'}
                                        </span>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setSelected('')}
                                    className="text-slate-500 hover:text-slate-700"
                                >
                                    <Icons.X className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    )}
                </div>
                
                {/* PERBAIKAN: Footer dengan rounded bottom yang konsisten */}
                <div className="p-4 border-t border-slate-200 bg-slate-50">
                    <div className="flex gap-2">
                        <button 
                            onClick={handleCancel} 
                            className="flex-1 p-3 bg-white text-slate-700 rounded-lg font-medium border border-slate-200 hover:bg-slate-50 transition text-sm"
                        >
                            Batal
                        </button>
                        <button 
                            onClick={handleConfirm} 
                            className="flex-1 p-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                            disabled={!selected}
                        >
                            Konfirmasi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// ServiceItem tetap sama
const ServiceItem = ({ service, selected, onSelect }) => {
    const isPuskesmas = service.toLowerCase().includes('puskesmas');
    
    return (
        <div
            className={`p-3 border-b border-slate-100 last:border-b-0 cursor-pointer transition-colors ${
                selected === service 
                    ? 'bg-blue-50 border-l-2 border-l-blue-500' 
                    : 'hover:bg-slate-50'
            }`}
            onClick={() => onSelect(service)}
        >
            <div className="flex items-start">
                <div className={`w-4 h-4 rounded-full border mt-0.5 mr-3 flex items-center justify-center flex-shrink-0 ${
                    selected === service 
                        ? 'bg-blue-500 border-blue-500' 
                        : 'border-slate-300'
                }`}>
                    {selected === service && <Icons.Check className="w-2.5 h-2.5 text-white" />}
                </div>
                <div className="flex-1 min-w-0">
                    <div className="flex items-start justify-between">
                        <div className="flex-1 min-w-0">
                            <span className={`text-sm font-medium ${
                                selected === service ? 'text-blue-700' : 'text-slate-800'
                            } truncate block`}>
                                {service}
                            </span>
                            <div className="flex items-center gap-1 mt-0.5">
                                <span className={`px-1.5 py-0.5 text-xs rounded ${
                                    isPuskesmas 
                                        ? 'bg-green-100 text-green-700' 
                                        : 'bg-red-100 text-red-700'
                                }`}>
                                    {isPuskesmas ? 'Puskesmas' : 'Rumah Sakit'}
                                </span>
                                {(() => {
                                    for (const [kab, layananList] of Object.entries(LAYANAN_BY_KABUPATEN)) {
                                        if (layananList.some(item => item.nama === service)) {
                                            return (
                                                <span className="text-xs text-slate-500 ml-1">
                                                    Kab. {kab}
                                                </span>
                                            );
                                        }
                                    }
                                    return null;
                                })()}
                            </div>
                        </div>
                        {selected === service && (
                            <Icons.CheckCircle className="w-4 h-4 text-green-500 ml-2 flex-shrink-0" />
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

        const ExitConfirmationModal = ({ onSave, onDiscard, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icons.AlertTriangle className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-xl mb-2 text-slate-800">Simpan Perubahan?</h3>
                    <p className="text-slate-500 mb-6 text-body">Konfirmasi sebelum meninggalkan halaman</p>
                    <div className="flex flex-col gap-3">
                        <button onClick={onSave} className="w-full p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Simpan sebagai Draft
                        </button>
                        <button onClick={onDiscard} className="w-full p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Buang Perubahan
                        </button>
                        <button onClick={onCancel} className="w-full p-3.5 border border-slate-200 text-slate-500 rounded-lg font-bold hover:bg-slate-50 transition">
                            Kembali ke Form
                        </button>
                    </div>
                </div>
            </div>
        );

        const DeleteConfirmationModal = ({ onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icons.AlertTriangle className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-xl mb-2 text-red-600">Hapus Formulir?</h3>
                    <p className="text-slate-500 mb-6 text-body">Formulir akan dihapus secara permanen dan tidak dapat dikembalikan.</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                            Batal
                        </button>
                        <button onClick={onConfirm} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            </div>
        );

        // PERBAIKAN POINT 2: Modal konfirmasi hapus akun di admin
        const DeleteUserConfirmationModal = ({ user, onConfirm, onCancel }) => {
            if (!user) return null;
            
            return (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                        <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <Icons.AlertTriangle className="w-8 h-8" />
                        </div>
                        <h3 className="font-bold text-xl mb-2 text-red-600">Hapus User?</h3>
                        <p className="text-slate-500 mb-4 text-body">
                            User: <strong>{user.name}</strong><br/>
                            Username: <strong>{user.username}</strong><br/>
                            Unit: <strong>{user.unitName}</strong>
                        </p>
                        <p className="text-slate-500 mb-6 text-sm">User akan dihapus permanen dan tidak dapat dikembalikan.</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                Batal
                            </button>
                            <button onClick={onConfirm} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                Ya, Hapus
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // AdminDashboard yang diperbaiki
        const AdminDashboard = ({ currentUser, onLogout, mockDB, mockUserDB, showNotification, exportToCSV, loadDataForView, ALL_SERVICES, onViewForm, onUnfinalizeForm, onEditEpidForm, showAdminDeleteUserModal, setShowAdminDeleteUserModal, adminUserToDelete, setAdminUserToDelete, rejectedList }) => {
            const [activeTab, setActiveTab] = useState('forms');
            const [allForms, setAllForms] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [newUser, setNewUser] = useState({ 
    name: '', 
    email: '', 
    role: 'user', 
    unitName: '' 
});
            const [deleteFormId, setDeleteFormId] = useState(null);
            const [editingUser, setEditingUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [userSearchTerm, setUserSearchTerm] = useState('');
            
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage] = useState(10);

            const getStatusBadge = (status) => {
                const statusColors = {
                    'Draft': 'bg-yellow-100 text-yellow-800',
                    'Pending': 'bg-amber-100 text-amber-800',
                    'Final': 'bg-green-100 text-green-800',
                    'Proses': 'bg-blue-100 text-blue-800',
                    'Ditolak': 'bg-red-100 text-red-800',
                    'Diterima': 'bg-emerald-100 text-emerald-800',
                    'Transferred': 'bg-purple-100 text-purple-800',
                    'Baru': 'bg-gray-100 text-gray-800'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800'}`}>
                        {status}
                    </span>
                );
            };

            const calculateAge = (dob) => { 
                if (!dob) return '-'; 
                const birth = new Date(dob); 
                const now = new Date(); 
                let age = now.getFullYear() - birth.getFullYear(); 
                const m = now.getMonth() - birth.getMonth(); 
                if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--; 
                return age + ' Thn'; 
            };

            const loadAllData = async () => {
                try {
                    const forms = await mockDB.getAllForms();
                    const formsWithOwner = forms.map(form => ({
                        ...form,
                        currentOwner: determineCurrentOwner(form)
                    }));
                    setAllForms(formsWithOwner);
                    
                    const users = await mockUserDB.getUsers();
                    setAllUsers(users);
                } catch (e) {
                    console.error("Error loading admin data:", e);
                    showNotification('Error memuat data', 'error');
                }
            };

            useEffect(() => { 
                loadAllData();
            }, [activeTab]);

            const filteredForms = searchTerm ? allForms.filter(form => 
                form.namaKasus?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.nomorEPID?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.currentOwner?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.statusData?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.createdUnit?.toLowerCase().includes(searchTerm.toLowerCase())
            ) : allForms;

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentForms = filteredForms.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredForms.length / itemsPerPage);

            const nextPage = () => {
                if (currentPage < totalPages) setCurrentPage(currentPage + 1);
            };

            const prevPage = () => {
                if (currentPage > 1) setCurrentPage(currentPage - 1);
            };

            const filteredUsers = userSearchTerm ? allUsers.filter(user => 
                user.name?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.username?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.unitName?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.role?.toLowerCase().includes(userSearchTerm.toLowerCase())
            ) : allUsers;

            const handleAddUser = async (e) => { 
    e.preventDefault(); 
    
    if (!newUser.name || !newUser.email || !newUser.unitName) {
        showNotification('Semua field wajib diisi', 'error');
        return;
    }
    
    // Cek duplikasi email
    const existingUser = allUsers.find(u => u.email === newUser.email);
    if (existingUser) {
        showNotification('Email sudah terdaftar', 'error');
        return;
    }
    
    try {
        const userToSave = {
            name: newUser.name,
            email: newUser.email,
            role: newUser.role,
            unitName: newUser.unitName,
            createdAt: new Date().toISOString()
        };
        
        await dbStore.collection('users').add(userToSave);
        
        showNotification('User berhasil ditambahkan', 'success'); 
        setNewUser({ name: '', email: '', role: 'user', unitName: '' });
        
        // Refresh user list
        const users = await mockUserDB.getUsers();
        setAllUsers(users);
        
    } catch (error) {
        console.error("Error adding user:", error);
        showNotification('Gagal menambahkan user: ' + error.message, 'error'); 
    }
};
            
            const handleUpdateUser = async (e) => {
    e.preventDefault();
    if (!editingUser) return;
    
    if (!editingUser.name || !editingUser.email || !editingUser.unitName) {
        showNotification('Semua field wajib diisi', 'error');
        return;
    }
    
    try {
        if (dbStore) {
            await dbStore.collection('users').doc(editingUser.id).update({
                name: editingUser.name,
                email: editingUser.email,
                role: editingUser.role,
                unitName: editingUser.unitName
            });
            showNotification('User berhasil diperbarui', 'success');
            setEditingUser(null);
            setAllUsers(await mockUserDB.getUsers());
        } else {
            showNotification('Database tidak tersedia', 'error');
        }
    } catch (e) {
        console.error("Error updating user:", e);
        showNotification('Error memperbarui user: ' + e.message, 'error');
    }
};
            
            // PERBAIKAN POINT 2: Fungsi untuk menghapus user
            const handleDeleteUser = async (user) => {
                if (!user) return;
                
                try {
                    if (dbStore) {
                        await dbStore.collection('users').doc(user.id).delete();
                        showNotification('User berhasil dihapus', 'success');
                        setAdminUserToDelete(null);
                        setShowAdminDeleteUserModal(false);
                        setAllUsers(await mockUserDB.getUsers());
                    } else {
                        showNotification('Database tidak tersedia', 'error');
                    }
                } catch (e) {
                    console.error("Error deleting user:", e);
                    showNotification('Error menghapus user: ' + e.message, 'error');
                }
            };
            
            const handleExportAll = () => { 
                if(allForms.length > 0) {
                    exportToCSV(allForms, 'SEMUA_DATA_SURVEILANS.csv', false);
                } else {
                    showNotification('Tidak ada data untuk didownload', 'error'); 
                }
            };

            const handleDeleteForm = async (formId) => {
                if (!formId) return;
                
                try {
                    await mockDB.delete(formId);
                    showNotification('Formulir dihapus', 'success');
                    setDeleteFormId(null);
                    await loadAllData();
                } catch (e) {
                    console.error("Error deleting form:", e);
                    showNotification('Error menghapus formulir: ' + e.message, 'error');
                }
            };

            const handleViewFormInAdmin = (form) => {
                onViewForm(form);
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full flex flex-col bg-slate-50 overflow-hidden">
                    <div className="flex-none bg-gradient-to-r from-slate-800 to-slate-900 text-white p-4 shadow-lg z-20">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="font-bold text-xl tracking-tight">Admin Panel Surveilans</h1>
                                <p className="text-slate-300 text-sm font-medium mt-1">Manajemen data dan pengguna</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={onLogout} className="bg-red-600 hover:bg-red-700 px-5 py-2.5 rounded-lg text-sm font-bold shadow-sm">
                                    Keluar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 w-full">
                        <div className="max-w-6xl mx-auto">
                            <div className="flex gap-8 border-b border-slate-300 mb-8 overflow-x-auto">
                                <button 
                                    onClick={() => setActiveTab('forms')} 
                                    className={`pb-4 px-1 font-bold transition text-lg whitespace-nowrap ${activeTab === 'forms' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    Data Formulir
                                </button>
                                <button 
                                    onClick={() => setActiveTab('users')} 
                                    className={`pb-4 px-1 font-bold transition text-lg whitespace-nowrap ${activeTab === 'users' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    Manajemen User
                                </button>
                            </div>
                            
                            {activeTab === 'forms' && (
                                <div className="bg-white rounded-xl shadow border border-slate-200 p-4 md:p-6 fade-in">
                                    <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
                                        <div>
                                            <h3 className="font-bold text-xl text-slate-800 mb-1">Semua Data Formulir</h3>
                                            <p className="text-slate-500 text-body">Total: {allForms.length} formulir</p>
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-2">
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Cari formulir..."
                                                    className="w-full md:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                    value={searchTerm}
                                                    onChange={(e) => {
                                                        setSearchTerm(e.target.value);
                                                        setCurrentPage(1);
                                                    }}
                                                />
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            </div>
                                            <button onClick={handleExportAll} className="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                                <Icons.Download className="w-4 h-4"/> Download CSV
                                            </button>
                                            <button onClick={loadAllData} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                                <Icons.Database className="w-4 h-4"/> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto border border-slate-200 rounded-lg mobile-scroll">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-600 uppercase text-xs font-bold">
                                                <tr>
                                                    <th className="px-4 py-3">No EPID</th>
                                                    <th className="px-4 py-3">Status</th>
                                                    <th className="px-4 py-3">Nama Kasus</th>
                                                    <th className="px-4 py-3">Usia</th>
                                                    <th className="px-4 py-3">Current Owner</th>
                                                    <th className="px-4 py-3">Tgl Update</th>
                                                    <th className="px-4 py-3">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {currentForms.map(form => (
                                                    <tr key={form.id} className="hover:bg-slate-50">
                                                        <td className="px-4 py-3 font-mono">
                                                            {form.nomorEPID || 'DRAFT'}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            {getStatusBadge(form.statusData)}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="font-semibold text-slate-800">{form.namaKasus || 'Tanpa Nama'}</div>
                                                            <div className="text-[10px] text-slate-400 mt-0.5">{form.jenisKelamin}</div>
                                                        </td>
                                                        <td className="px-4 py-3 font-medium text-slate-600">{calculateAge(form.tanggalLahir)}</td>
                                                        <td className="px-4 py-3">
                                                            <span className="text-slate-700 text-xs font-medium">
                                                                {form.currentOwner || determineCurrentOwner(form)}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-slate-500">
                                                            {new Date(form.updatedAt).toLocaleDateString()}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex gap-1">
                                                                <button 
                                                                    onClick={() => handleViewFormInAdmin(form)}
                                                                    className="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Lihat Detail"
                                                                >
                                                                    <Icons.Eye className="w-4 h-4"/>
                                                                </button>
                                                                {form.statusData === 'Final' && (
                                                                    <button 
                                                                        onClick={() => onUnfinalizeForm(form)}
                                                                        className="text-amber-500 bg-amber-50 hover:bg-amber-100 p-2 rounded-lg text-xs font-bold transition"
                                                                        title="Batalkan Finalisasi"
                                                                    >
                                                                        <Icons.AlertTriangle className="w-4 h-4"/>
                                                                    </button>
                                                                )}
                                                                <button 
                                                                    onClick={() => onEditEpidForm(form)}
                                                                    className="text-green-500 bg-green-50 hover:bg-green-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Edit Nomor EPID"
                                                                >
                                                                    <Icons.Edit className="w-4 h-4"/>
                                                                </button>
                                                                <button 
                                                                    onClick={() => setDeleteFormId(form.id)}
                                                                    className="text-red-500 bg-red-50 hover:bg-red-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Hapus Formulir"
                                                                >
                                                                    <Icons.Trash className="w-4 h-4"/>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {currentForms.length === 0 && (
                                            <div className="text-center p-8 text-slate-400 italic">
                                                {searchTerm ? 'Tidak ada formulir yang sesuai dengan pencarian' : 'Belum ada data formulir.'}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {filteredForms.length > itemsPerPage && (
                                        <div className="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                            <p className="text-sm text-slate-600">
                                                Menampilkan {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, filteredForms.length)} dari {filteredForms.length} formulir
                                            </p>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={prevPage}
                                                    disabled={currentPage === 1}
                                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                                >
                                                    Sebelumnya
                                                </button>
                                                <span className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium">
                                                    Halaman {currentPage} dari {totalPages}
                                                </span>
                                                <button
                                                    onClick={nextPage}
                                                    disabled={currentPage === totalPages}
                                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                                >
                                                    Selanjutnya
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="mt-6 grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <p className="text-xs text-blue-600 font-bold mb-1">Draft</p>
                                            <p className="text-2xl font-bold text-blue-800">
                                                {allForms.filter(f => f.statusData === 'Draft').length}
                                            </p>
                                        </div>
                                        <div className="bg-amber-50 p-4 rounded-lg border border-amber-200">
                                            <p className="text-xs text-amber-600 font-bold mb-1">Pending Form</p>
                                            <p className="text-2xl font-bold text-amber-800">
                                                {allForms.filter(f => f.statusData === 'Pending').length}
                                            </p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-xs text-green-600 font-bold mb-1">Form Final</p>
                                            <p className="text-2xl font-bold text-green-800">
                                                {allForms.filter(f => f.statusData === 'Final').length}
                                            </p>
                                        </div>
                                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                            <p className="text-xs text-indigo-600 font-bold mb-1">Proses</p>
                                            <p className="text-2xl font-bold text-indigo-800">
                                                {allForms.filter(f => f.statusData === 'Proses').length}
                                            </p>
                                        </div>
                                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                                            <p className="text-xs text-red-600 font-bold mb-1">Ditolak</p>
                                            <p className="text-2xl font-bold text-red-800">
                                                {allForms.filter(f => f.statusData === 'Ditolak').length}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'users' && (
                                <div className="grid md:grid-cols-2 gap-8 fade-in">
                                    <div className="bg-white rounded-xl shadow border border-slate-200 p-6 h-fit">
                                        <h3 className="font-bold text-xl text-slate-800 mb-6 pb-3 border-b border-slate-100">
                                            {editingUser ? 'Edit User' : 'Tambah User Baru'}
                                        </h3>
                                        <form onSubmit={editingUser ? handleUpdateUser : handleAddUser} className="space-y-5">
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Nama Lengkap</label>
                                                <input 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    placeholder="Contoh: John Doe" 
                                                    value={editingUser ? editingUser.name : newUser.name} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, name:e.target.value}) 
                                                        : setNewUser({...newUser, name:e.target.value})} 
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Role / Peran</label>
                                                <select 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    value={editingUser ? editingUser.role : newUser.role} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, role:e.target.value}) 
                                                        : setNewUser({...newUser, role:e.target.value})}
                                                >
                                                    <option value="user">User (Petugas)</option>
                                                    <option value="admin">Admin (Dinkes)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Unit Layanan</label>
                                                <select 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    value={editingUser ? editingUser.unitName : newUser.unitName} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, unitName:e.target.value}) 
                                                        : setNewUser({...newUser, unitName:e.target.value})} 
                                                    required
    >
        <option value="">-- Pilih Unit --</option>
        {Object.values(LAYANAN_BY_KABUPATEN)
            .flat()
            .map(p => <option key={p.nama} value={p.nama}>{p.nama}</option>)
        }
    </select>
</div>
                                            <div>
    <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Email</label>
    <input 
        className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
        placeholder="contoh: user@example.com" 
        value={editingUser ? editingUser.email : newUser.email} 
        onChange={e => editingUser 
            ? setEditingUser({...editingUser, email:e.target.value}) 
            : setNewUser({...newUser, email:e.target.value})} 
        required
        type="email"
    />
</div>
                                            <div className="flex gap-3">
                                                {editingUser && (
                                                    <button 
                                                        type="button"
                                                        onClick={() => {
                                                            setEditingUser(null);
                                                            setNewUser({ name: '', username: '', password: '', role: 'user', unitName: '' });
                                                        }}
                                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                                    >
                                                        Batal
                                                    </button>
                                                )}
                                                <button 
                                                    type="submit"
                                                    className={`${editingUser ? 'flex-1' : 'w-full'} p-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition transform active:scale-95 text-subtitle`}
                                                >
                                                    {editingUser ? 'Simpan Perubahan' : 'Simpan User Baru'}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div className="bg-white rounded-xl shadow border border-slate-200 p-6">
                                        <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6 pb-3 border-b border-slate-100">
                                            <h3 className="font-bold text-xl text-slate-800">Daftar User Terdaftar ({filteredUsers.length})</h3>
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Cari user..."
                                                    className="w-full md:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                                    value={userSearchTerm}
                                                    onChange={(e) => setUserSearchTerm(e.target.value)}
                                                />
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            </div>
                                        </div>
                                        <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                            {filteredUsers.map(u => (
                                                <div key={u.id} className="flex justify-between items-center p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition group">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-slate-800">{u.name}</p>
                                                        <p className="text-sm text-slate-500 mt-1">
                                                            {u.unitName}  
                                                            <span className={`ml-2 px-2 py-0.5 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                {u.role}
                                                            </span>
                                                        </p>
                                                        <p className="text-xs text-slate-400 font-mono mt-2">
                                                            Email: {u.email}
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => setEditingUser(u)} 
                                                            className="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2.5 rounded-lg text-sm font-bold transition border border-blue-100"
                                                            title="Edit User"
                                                        >
                                                            <Icons.Edit className="w-4 h-4" />
                                                        </button>
                                                        {u.role !== 'admin' && u.username !== 'admin' && (
                                                            <button 
                                                                onClick={() => {
                                                                    setAdminUserToDelete(u);
                                                                    setShowAdminDeleteUserModal(true);
                                                                }} 
                                                                className="text-red-500 bg-red-50 hover:bg-red-100 p-2.5 rounded-lg text-sm font-bold transition border border-red-100"
                                                                title="Hapus User"
                                                            >
                                                                <Icons.Trash className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredUsers.length === 0 && (
                                                <div className="text-center p-8 text-slate-400 italic">
                                                    {userSearchTerm ? 'Tidak ada user yang sesuai dengan pencarian' : 'Belum ada user terdaftar.'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {deleteFormId && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Hapus Formulir?</h3>
                                <p className="text-slate-500 mb-6 text-body">Formulir akan dihapus permanen dan nomor EPID dapat digunakan kembali.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteFormId(null)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={() => handleDeleteForm(deleteFormId)} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* PERBAIKAN POINT 2: Modal konfirmasi hapus user */}
                    {showAdminDeleteUserModal && adminUserToDelete && (
                        <DeleteUserConfirmationModal 
                            user={adminUserToDelete}
                            onConfirm={() => handleDeleteUser(adminUserToDelete)}
                            onCancel={() => {
                                setShowAdminDeleteUserModal(false);
                                setAdminUserToDelete(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        // PERBAIKAN POINT 4: MODAL VIEW FORMULIR (tanpa kontak erat, dengan informasi orang tua)
        const ViewModal = ({ item, onClose, Icons }) => {
    if (!item) {
        console.log("ViewModal: No item provided");
        return null;
    }
    
    console.log("ViewModal rendering with item:", item);
    
    // Helper function untuk menentukan current owner (dipindahkan ke dalam komponen)
    const determineCurrentOwnerForModal = (formData) => {
        if (formData.currentOwner && formData.currentOwner !== '') {
            return formData.currentOwner;
        }
        
        if (formData.transferHistory && formData.transferHistory.length > 0) {
            const successfulTransfers = formData.transferHistory.filter(
                record => record.action === 'diterima' || record.action === 'dikirim'
            );
            
            if (successfulTransfers.length > 0) {
                const lastTransfer = successfulTransfers[successfulTransfers.length - 1];
                
                if (lastTransfer.newOwner) {
                    return lastTransfer.newOwner;
                }
                
                if (lastTransfer.action === 'dikirim') {
                    return lastTransfer.from;
                }
                
                if (lastTransfer.action === 'diterima') {
                    return lastTransfer.to;
                }
            }
        }
        
        if (formData.statusData === 'Final' || formData.statusData === 'Baru' || formData.statusData === 'Draft') {
            return formData.createdUnit;
        }
        
        if (formData.statusData === 'Pending') {
            return formData.currentOwner || formData.createdUnit;
        }
        
        if (formData.statusData === 'Proses') {
            return formData.createdUnit;
        }
        
        if (formData.statusData === 'Ditolak') {
            if (formData.transferHistory && formData.transferHistory.length > 0) {
                const sendRecords = formData.transferHistory.filter(r => r.action === 'dikirim');
                if (sendRecords.length > 0) {
                    return sendRecords[sendRecords.length - 1].from;
                }
            }
            return formData.createdUnit;
        }
        
        return formData.createdUnit;
    };
    
    const currentOwner = determineCurrentOwnerForModal(item);
    const isFromOtherUnit = item.createdUnit !== currentOwner;
    
    const formatDate = (dateString) => {
        if (!dateString) return '-';
        try {
            if (typeof dateString === 'number') {
                return new Date(dateString).toLocaleDateString('id-ID');
            }
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        } catch (e) {
            console.log("Date formatting error:", e);
            return dateString;
        }
    };
    
    const formatDateTime = (timestamp) => {
        if (!timestamp) return '-';
        try {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) return timestamp;
            return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return timestamp;
        }
    };
    
    const calculateAgeFromDOB = (dob) => {
        if (!dob) return '';
        try {
            const birthDate = new Date(dob);
            const today = new Date();
            
            let years = today.getFullYear() - birthDate.getFullYear();
            let months = today.getMonth() - birthDate.getMonth();
            
            if (months < 0) {
                years--;
                months += 12;
            }
            
            return `${years} tahun, ${months} bulan`;
        } catch (e) {
            return dob;
        }
    };
    
    const getStatusBadge = (status) => {
        const statusColors = {
            'Draft': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
            'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
            'Final': 'bg-green-100 text-green-800 border border-green-200',
            'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
            'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
            'Diterima': 'bg-emerald-100 text-emerald-800 border border-emerald-200',
            'Transferred': 'bg-purple-100 text-purple-800 border border-purple-200',
            'Baru': 'bg-gray-100 text-gray-800 border border-gray-200'
        };
        
        return (
            <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${statusColors[status] || 'bg-gray-100 text-gray-800'}`}>
                {status || 'Unknown'}
            </span>
        );
    };
    
    // Helper untuk mengekstrak gejala dari format objek atau array
    const getGejalaList = () => {
        if (!item.gejalaLain) return [];
        
        if (Array.isArray(item.gejalaLain)) {
            return item.gejalaLain;
        }
        
        if (typeof item.gejalaLain === 'object') {
            return Object.keys(item.gejalaLain).filter(key => item.gejalaLain[key] === true);
        }
        
        return [];
    };
    
    // Helper untuk mengekstrak komplikasi dari format objek atau array
    const getKomplikasiList = () => {
        if (!item.komplikasi) return [];
        
        if (Array.isArray(item.komplikasi)) {
            return item.komplikasi;
        }
        
        if (typeof item.komplikasi === 'object') {
            return Object.keys(item.komplikasi).filter(key => item.komplikasi[key] === true);
        }
        
        return [];
    };
    
    const gejalaList = getGejalaList();
    const komplikasiList = getKomplikasiList();
    
    return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="relative bg-white rounded-2xl w-full sm:w-[95%] md:w-[80%] lg:w-[70%] max-w-4xl shadow-2xl border border-slate-200 flex flex-col max-h-[80vh] overflow-hidden">
                
                {/* HEADER */}
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 border-b border-slate-200 flex-none">
                    <div className="flex justify-between items-start">
                        <div className="flex-1">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="bg-white p-2 rounded-lg shadow-sm">
                                    <Icons.FileText className="w-6 h-6 text-blue-600" />        
                                </div>        
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">Ringkasan Data</h2>
                                    <div className="flex items-center gap-3 mt-1 flex-nowrap">
                                        <span className="font-mono font-bold bg-gradient-to-r from-blue-500 to-indigo-500 text-white bg-black px-3 py-1 rounded shrink-0">
                                            {item.nomorEPID ||'NO-EPID'}
                                        </span>
                                  
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-4 mt-3 text-sm text-slate-600">
                                <div className="flex items-center gap-1">
                                    <Icons.Shield className="w-4 h-4" />
                                    <span>Owner: <strong>{currentOwner}</strong></span>
                                </div>
                                <div className="flex items-center gap-1">
                                    <Icons.Clock className="w-4 h-4" />
                                    <span>Update: <strong>{formatDateTime(item.updatedAt)}</strong></span>
                                </div>
                            </div>
                        </div>
                        <button 
                            onClick={onClose}
                            className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors z-10"
                        >
                            <Icons.XCircle className="w-8 h-8" />
                        </button>
                    </div>
                </div>
                
                {/* KONTEN ISI */}
                <div className="p-6 overflow-y-auto flex-1">
                    <div className="mb-8">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <Icons.FileText className="w-5 h-5 text-amber-500" />
                            Informasi Workflow
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Status Card */}
                            <div className={`p-4 rounded-lg border ${
                                item.statusData === 'Pending' 
                                    ? 'bg-amber-50 border-amber-100' 
                                    : item.statusData === 'Final'
                                    ? 'bg-green-50 border-green-100'
                                    : item.statusData === 'Ditolak'
                                    ? 'bg-red-50 border-red-100'
                                    : 'bg-blue-50 border-blue-100'
                            }`}>
                                <p className="text-sm font-semibold mb-1">Status Saat Ini</p>
                                <p className={`text-lg font-bold ${
                                    item.statusData === 'Pending' 
                                        ? 'text-amber-800' 
                                        : item.statusData === 'Final'
                                        ? 'text-green-800'
                                        : item.statusData === 'Ditolak'
                                        ? 'text-red-800'
                                        : 'text-blue-800'
                                }`}>
                                    {item.statusData}
                                </p>
                                <p className="text-xs mt-1">
                                    {item.statusData === 'Pending' 
                                        ? 'Formulir dalam proses verifikasi di Pending Form'
                                        : item.statusData === 'Final'
                                        ? 'Formulir sudah final'
                                        : item.statusData === 'Ditolak'
                                        ? 'Formulir ditolak oleh unit lain'
                                        : 'Formulir dalam proses lainnya'}
                                </p>
                            </div>

                            {/* Tombol Lokasi */}
                            {item.titikLokasi ? (
                                <button 
                                    onClick={() => {
                                        if (item.titikLokasi) {
                                            const coords = item.titikLokasi.split(',').map(c => c.trim());
                                            if (coords.length === 2) {
                                                const url = `https://www.google.com/maps?q=${coords[0]},${coords[1]}`;
                                                window.open(url, '_blank');
                                            }
                                        }
                                    }}
                                    className="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg border border-blue-700 flex flex-col items-center justify-center gap-2 transition-all shadow-sm group h-full min-h-[100px]"
                                >
                                    <div className="p-2 bg-white/20 rounded-full group-hover:scale-110 transition-transform">
                                        <Icons.MapPin className="w-6 h-6 text-white" />
                                    </div>
                                    <span className="font-bold text-sm">Lihat Titik Lokasi</span>
                                </button>
                            ) : (
                                <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 flex flex-col items-center justify-center text-slate-400 min-h-[100px]">
                                    <Icons.MapPin className="w-6 h-6 mb-1 text-slate-300" />
                                    <p className="text-sm">Lokasi tidak tersedia</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Informasi Umum dengan data orang tua */}
                    <div className="mb-8">
                        <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                            <Icons.User className="w-5 h-5 text-blue-500" />
                            Informasi Umum
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Nama Lengkap Kasus</p>
                                <p className="font-bold text-slate-800 text-lg">{item.namaKasus || '-'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Jenis Kelamin</p>
                                <p className="font-medium text-slate-800">{item.jenisKelamin || '-'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Tanggal Lahir / Usia</p>
                                <p className="font-medium text-slate-800">
                                    {formatDate(item.tanggalLahir)} 
                                    {item.tanggalLahir && (
                                        <span className="ml-2 text-blue-600">({calculateAgeFromDOB(item.tanggalLahir)})</span>
                                    )}
                                </p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Alamat Lengkap</p>
                                <p className="font-medium text-slate-800">{item.alamat || '-'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Kecamatan</p>
                                <p className="font-medium text-slate-800">{item.kecamatan || '-'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Kelurahan</p>
                                <p className="font-medium text-slate-800">{item.kelurahan || '-'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">RT/RW</p>
                                <p className="font-medium text-slate-800">{item.rt || '-'}/{item.rw || '-'}</p>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="text-sm text-slate-500 mb-1">Sumber Laporan</p>
                                <p className="font-medium text-slate-800">{item.sumberLaporan || '-'}</p>
                            </div>
                            {/* Tambah informasi orang tua */}
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                                <p className="text-sm text-blue-600 mb-1 font-semibold">Nama Orang Tua/Wali</p>
                                <p className="font-bold text-slate-800 text-lg">{item.namaOrangtua || '-'}</p>
                            </div>
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                                <p className="text-sm text-blue-600 mb-1 font-semibold">Nomor Kontak Orang Tua/Wali</p>
                                <p className="font-bold text-slate-800 text-lg">{item.noKontakOrangtua || '-'}</p>
                            </div>
                        </div>
                    </div>
                    
                    {(item.demam || item.ruam || item.dirawat || gejalaList.length > 0 || komplikasiList.length > 0) && (
                        <div className="mb-8">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                <Icons.Thermometer className="w-5 h-5 text-red-500" />
                                Data Klinis
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {item.demam && (
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Demam</p>
                                        <p className="font-medium text-red-800">{item.demam === 'ya' ? 'Ya' : 'Tidak'}</p>
                                        {item.demam === 'ya' && item.tanggalMulaiDemam && (
                                            <p className="text-xs text-red-500 mt-1">
                                                {formatDate(item.tanggalMulaiDemam)}
                                            </p>
                                        )}
                                    </div>
                                )}
                                
                                {item.ruam && (
                                    <div className="bg-orange-50 p-4 rounded-lg">
                                        <p className="text-sm text-orange-600 mb-1">Ruam</p>
                                        <p className="font-medium text-orange-800">{item.ruam === 'ya' ? 'Ya' : 'Tidak'}</p>
                                        {item.ruam === 'ya' && item.tanggalMulaiRuam && (
                                            <p className="text-xs text-orange-500 mt-1">
                                                {formatDate(item.tanggalMulaiRuam)}
                                            </p>
                                        )}
                                    </div>
                                )}
                                
                                {gejalaList.length > 0 && (
                                    <div className="bg-yellow-50 p-4 rounded-lg col-span-2">
                                        <p className="text-sm text-yellow-600 mb-1">Gejala Lain</p>
                                        <div className="flex flex-wrap gap-2">
                                            {gejalaList.map((gejala, idx) => (
                                                <span key={idx} className="bg-white px-3 py-1 rounded-full text-sm font-medium text-yellow-800 border border-yellow-200">
                                                    {gejala}
                                                </span>
                                            ))}
                                        </div>
                                        {item.gejalaLainSebutkan && (
                                            <p className="text-sm text-yellow-700 mt-2">
                                                <strong>Sebutkan:</strong> {item.gejalaLainSebutkan}
                                            </p>
                                        )}
                                    </div>
                                )} 
                                
                                {gejalaList.includes('Adenopathy') && item.lokasiAdenopathy && (
                                    <div className="bg-blue-50 p-3 rounded-lg">
                                        <p className="text-sm text-blue-600 mb-1">Lokasi Adenopathy:</p>
                                        <p className="font-medium text-blue-800">{item.lokasiAdenopathy}</p>
                                    </div>
                                )}

                                {gejalaList.includes('Arthralgia') && item.bagianSendiArthralgia && (
                                    <div className="bg-orange-50 p-3 rounded-lg">
                                        <p className="text-sm text-orange-600 mb-1">Bagian Sendi Arthralgia:</p>
                                        <p className="font-medium text-orange-800">{item.bagianSendiArthralgia}</p>
                                    </div>
                                )}

                                {gejalaList.includes('Kehamilan') && item.umurKehamilan && (
                                    <div className="bg-pink-50 p-3 rounded-lg">
                                        <p className="text-sm text-pink-600 mb-1">Umur Kehamilan:</p>
                                        <p className="font-medium text-pink-800">{item.umurKehamilan}</p>
                                    </div>
                                )}
                                
                                {komplikasiList.length > 0 && (
                                    <div className="bg-red-50 p-4 rounded-lg col-span-2">
                                        <p className="text-sm text-red-600 mb-1">Komplikasi</p>
                                        <div className="flex flex-wrap gap-2">
                                            {komplikasiList.map((komp, idx) => (
                                                <span key={idx} className="bg-white px-3 py-1 rounded-full text-sm font-medium text-red-800 border border-red-200">
                                                    {komp}
                                                </span>
                                            ))}
                                        </div>
                                        {item.komplikasiLainnyaSebutkan && (
                                            <p className="text-sm text-red-700 mt-2">
                                                <strong>Sebutkan:</strong> {item.komplikasiLainnyaSebutkan}
                                            </p>
                                        )}
                                    </div>
                                )}
                                
                                {item.dirawat && (
                                    <div className="bg-purple-50 p-4 rounded-lg col-span-2">
                                        <p className="text-sm text-purple-600 mb-1">Rawat Inap</p>
                                        <p className="font-medium text-purple-800">{item.dirawat === 'ya' ? 'Ya' : 'Tidak'}</p>
                                        {item.dirawat === 'ya' && item.namaRumahSakit && (
                                            <div className="mt-2 space-y-2">
                                                <p className="text-sm font-medium">Dirawat di: {item.namaRumahSakit}</p>
                                                {item.tanggalMasukRawat && (
                                                    <p className="text-xs">Masuk: {formatDate(item.tanggalMasukRawat)}</p>
                                                )}
                                                {item.tanggalKeluarRawat && (
                                                    <p className="text-xs">Keluar: {formatDate(item.tanggalKeluarRawat)}</p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Kontak Erat (Jika ada) */}
                    {item.kontakErat && item.kontakErat.length > 0 && (
                        <div className="mb-8">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                <Icons.Users className="w-5 h-5 text-green-500" />
                                Data Kontak Erat ({item.kontakErat.length} orang)
                            </h3>
                            <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                                {item.kontakErat.slice(0, 10).map((kontak, index) => (
                                    <div key={index} className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <p className="font-medium text-slate-800">{kontak.nama || 'Tanpa Nama'}</p>
                                                <div className="text-sm text-slate-600 mt-1 space-y-1">
                                                    <p>Umur: {kontak.umur || '-'}</p>
                                                    <p>Hubungan: {kontak.hubungan || '-'}</p>
                                                    <p>Kondisi: 
                                                        <span className={`ml-1 px-2 py-0.5 rounded text-xs ${kontak.kondisi === 'sakit' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                            {kontak.kondisi || 'Tidak diketahui'}
                                                        </span>
                                                    </p>
                                                    <p>Imunisasi: {kontak.imunisasiCampakRubella || '-'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {item.kontakErat.length > 10 && (
                                    <p className="text-sm text-slate-500 text-center">
                                        + {item.kontakErat.length - 10} kontak erat lainnya...
                                    </p>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {item.transferHistory && item.transferHistory.length > 0 && (
                        <div className="mb-8">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                <Icons.Share className="w-5 h-5 text-green-500" />
                                Riwayat Transfer
                            </h3>
                            <div className="space-y-3">
                                {item.transferHistory.map((record, idx) => (
                                    <div key={idx} className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${
                                                    record.action === 'dikirim' ? 'bg-blue-100 text-blue-800' :
                                                    record.action === 'diterima' ? 'bg-green-100 text-green-800' :
                                                    record.action === 'ditolak' ? 'bg-red-100 text-red-800' :
                                                    record.action === 'diteruskan' ? 'bg-purple-100 text-purple-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`}>
                                                    {record.action || 'transfer'}
                                                </span>
                                                <p className="text-sm text-slate-700 mt-2">
                                                    Dari: <span className="font-bold">{record.from}</span> 
                                                    <Icons.ChevronLeft className="inline w-4 h-4 mx-2 rotate-180" />
                                                    Ke: <span className="font-bold">{record.to}</span>
                                                </p>
                                                {record.newOwner && (
                                                    <p className="text-sm text-green-700 mt-1">
                                                        <span className="font-bold">Ownership berpindah ke:</span> {record.newOwner}
                                                    </p>
                                                )}
                                            </div>
                                            <span className="text-sm text-slate-500">
                                                {new Date(record.date).toLocaleDateString('id-ID')}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
                
            </div>
        </div>
    );
};

        // BAGIAN 7: RENDER UTAMA
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
