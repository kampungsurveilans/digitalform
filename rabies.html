<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Sistem Surveilans GHPR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.015em;
            -webkit-tap-highlight-color: transparent; 
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            letter-spacing: -0.025em;
            line-height: 1.2;
        }
        
        .text-display {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -0.03em;
            line-height: 1.1;
        }
        
        .text-title {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .text-subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            line-height: 1.4;
        }
        
        .text-body {
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .text-caption {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .text-micro {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        input, select, textarea, button {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        
        .font-mono {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Fira Mono', 'Droid Sans Mono', 'Courier New', monospace;
            letter-spacing: -0.01em;
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        :focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        .typography-spacing > * + * {
            margin-top: 1.5em;
        }
        
        .readable-text {
            max-width: 65ch;
            line-height: 1.75;
        }
        
        .uppercase-input {
            text-transform: uppercase;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .pulse-notification {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Responsive improvements for mobile */
        @media (max-width: 640px) {
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-scroll table {
                min-width: 768px;
            }
            
            .mobile-stack {
                flex-direction: column;
            }
            
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            
            .mobile-button-group {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .mobile-button-group button {
                flex: 1;
                min-width: 120px;
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // BAGIAN 1: KONFIGURASI DAN DATA
        const { useState, useEffect, useRef } = React;

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCPfsbXK3GE-wY7qzRViYrfdjc6rrMTD4g",
            authDomain: "ghpr-55960.firebaseapp.com",
            projectId: "ghpr-55960",
            storageBucket: "ghpr-55960.firebasestorage.app",
            messagingSenderId: "1037177779526",
            appId: "1:1037177779526:web:08db5ea665791860d9e147",
            measurementId: "G-9BJ724C1XW"
        };

        let dbAuth, dbStore;
        try {
            if (!firebase.apps.length) { firebase.initializeApp(FIREBASE_CONFIG); }
            dbAuth = firebase.auth();
            dbStore = firebase.firestore();
        } catch (e) { console.error("Firebase Error:", e); }

        const DATA_PUSKESMAS = [
            "Puskesmas Alianyang", "Puskesmas Banjar Serasan", "Puskesmas Gang Sehat",
            "Puskesmas Kampung Bali", "Puskesmas Kampung Bangka", "Puskesmas Kampung Dalam",
            "Puskesmas Karya Mulia", "Puskesmas Khatulistiwa", "Puskesmas Kom. Yos Sudarso",
            "Puskesmas Pal Lima", "Puskesmas Pal Tiga", "Puskesmas Parit Haji Husin II",
            "Puskesmas Parit Mayor", "Puskesmas Perumnas I", "Puskesmas Perumnas II",
            "Puskesmas Purnama", "Puskesmas Saigon", "Puskesmas Siantan Hilir",
            "Puskesmas Siantan Hulu", "Puskesmas Siantan Tengah", "Puskesmas Tambelan Sampit",
            "Puskesmas Tanjung Hulu", "Puskesmas Telaga Biru"
        ];

        const DATA_RUMAH_SAKIT = [
            "RS Anugerah Bunda Khatulistiwa", "RS Bersalin Jeumpa Pontianak",
            "RS Bhayangkara Tk. III Anton Soedjarwo Pontianak", "RS Islam Yarsi Pontianak",
            "RS Jiwa Daerah Sungai Bangkong", "RS Kharitas Bhakti", "RS Medika Djaya",
            "RS Mitra Medika Pontianak", "RS Pro Medika Pontianak", "RS St. Antonius",
            "RS Universitas Tanjungpura", "RSIA Nabasa", "RSUD dr. Soedarso",
            "RSUD Pontianak Utara", "RSUD Sultan Syarif Mohammad Alkadrie"
        ];

        const DATA_WILAYAH_MAPPING = {
            "Kecamatan Pontianak Kota": ["Darat sekip", "Mariana", "Sungai bangkong", "Sungai jawi", "Tengah"],
            "Kecamatan Pontianak Timur": ["Dalam Bugis", "Parit Mayor", "Saigon", "Tanjung Hulu", "Tanjung Hilir", "Tambelan Sampit", "Banjar Serasan"],
            "Kecamatan Pontianak Barat": ["Pal Lima", "Sungai Beliung", "Sungai Jawi Luar", "Sungai Jawi Dalam", "Kota Baru"],
            "Kecamatan Pontianak Selatan": ["Akcaya", "Benua melayu Darat", "Benua melayu Laut", "Kotabaru", "Parit tokaya"],
            "Kecamatan Pontianak Utara": ["Batulayang", "Siantan Hilir", "Siantan Hulu", "Siantan Tengah"],
            "Kecamatan Pontianak Tenggara": ["Bangka Belitung Laut", "Bangka Belitung Darat", "Bansir Laut", "Bansir Darat"]
        };

        const ALL_SERVICES = [...DATA_PUSKESMAS, ...DATA_RUMAH_SAKIT].filter((value, index, self) => self.indexOf(value) === index);

        const IconBase = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Icons = {
            AlertTriangle: (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Thermometer: (p) => <IconBase {...p}><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Syringe: (p) => <IconBase {...p}><path d="M18 6L6 18"/><path d="M21 12l-6 6"/><path d="M15 3l-3 3"/><path d="M3 21l6-6"/><path d="M9 3l3-3 5 5-3 3"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Shield: (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>,
            Plane: (p) => <IconBase {...p}><path d="M2 22h20"/><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            XCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            ChevronLeft: (p) => <IconBase {...p}><polyline points="15 18 9 12 15 6"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>,
            Gps: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></IconBase>,
            Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
            List: (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Archive: (p) => <IconBase {...p}><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></IconBase>,
            Share: (p) => <IconBase {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></IconBase>,
            Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconBase>,
            Send: (p) => <IconBase {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>,
            Inbox: (p) => <IconBase {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></IconBase>,
            XOctagon: (p) => <IconBase {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>,
            Eye: (p) => <IconBase {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></IconBase>,
            Grid: (p) => <IconBase {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>,
            Cloud: (p) => <IconBase {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></IconBase>,
            Database: (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>,
            Home: (p) => <IconBase {...p}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
            School: (p) => <IconBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>,
            Hourglass: (p) => <IconBase {...p}><path d="M5 22h14"/><path d="M5 2h14"/><path d="M12 2v20"/><path d="M12 8l4 4-4 4"/><path d="M8 12l-4 4 4 4"/></IconBase>,
            Heart: (p) => <IconBase {...p}><path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"/></IconBase>,
            Activity: (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>,
            Plus: (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            Minus: (p) => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"/></IconBase>,
            Clipboard: (p) => <IconBase {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconBase>,
            Dog: (p) => <IconBase {...p}><path d="M18 15l-4-4"/><path d="M6 15l4-4"/><path d="M14 5l-2 2"/><path d="M10 5l2 2"/><path d="M10 21v-8l-5-5"/><path d="M14 21v-8l5-5"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="12" r="3"/></IconBase>,
            Cat: (p) => <IconBase {...p}><path d="M12 5c.67 0 1.35.09 2 .26 1.78-2 5.03-2.84 6.42-2.26 1.4.58-.42 7-.42 7 .57 1.07 1 2.24 1 3.44C21 17.9 16.97 21 12 21s-9-3-9-7.56c0-1.25.5-2.4 1-3.44 0 0-1.89-6.42-.5-7 1.39-.58 4.72.23 6.5 2.23A9.04 9.04 0 0 1 12 5z"/><path d="M8 14v.5"/><path d="M16 14v.5"/><path d="M11.25 16.25h1.5L12 17l-.75-.75z"/></IconBase>,
            Monkey: (p) => <IconBase {...p}><path d="M10 2s2.5.5 4.5 2.5c2 2 2 5 2 5"/><path d="M14 2s-2.5.5-4.5 2.5c-2 2-2 5-2 5"/><path d="M8 15h8"/><path d="M8 19h8"/><circle cx="9" cy="9" r="1"/><circle cx="15" cy="9" r="1"/><path d="M12 15v4"/></IconBase>,
            Stethoscope: (p) => <IconBase {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></IconBase>,
            FilePlus: (p) => <IconBase {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></IconBase>,
            Briefcase: (p) => <IconBase {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>
        };

        // Data untuk dropdown pekerjaan
        const DATA_PEKERJAAN = [
            "Pelajar/Mahasiswa", "Ibu Rumah Tangga", "PNS", "TNI/Polri", "Pegawai Swasta", 
            "Wiraswasta", "Petani", "Nelayan", "Buruh", "Pensiunan", "Lainnya"
        ];

        // Data untuk lokasi gigitan
        const DATA_LOKASI_GIGITAN = [
            "Kepala", "Leher", "Bahu", "Lengan", "Tangan", "Jari Tangan",
            "Dada", "Punggung", "Perut", "Pinggang", "Paha", "Kaki", 
            "Jari Kaki", "Wajah", "Telinga"
        ];

        const mockUserDB = {
            checkAndCreateDefaultAdmin: async () => {
                if(!dbStore) return;
                try {
                    const snap = await dbStore.collection('users').limit(1).get();
                    if(snap.empty) await dbStore.collection('users').add({ 
                        username: 'admin', 
                        password: 'admin123', 
                        role: 'admin', 
                        name: 'Administrator Utama', 
                        unitName: 'Puskesmas Alianyang'
                    });
                } catch(e) {}
            },
            getUsers: async () => { 
                if (!dbStore) return []; 
                try { 
                    const snapshot = await dbStore.collection('users').get(); 
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                } catch (e) { 
                    return []; 
                } 
            },
            addUser: async (user) => { 
                if (!dbStore) return false; 
                try { 
                    const snap = await dbStore.collection('users').where('username', '==', user.username).get(); 
                    if(!snap.empty) return false; 
                    await dbStore.collection('users').add(user); 
                    return true; 
                } catch (e) { 
                    return false; 
                } 
            },
            updateUser: async (id, userData) => {
                if (!dbStore) return false;
                try {
                    await dbStore.collection('users').doc(id).update(userData);
                    return true;
                } catch (e) {
                    console.error("Error updating user:", e);
                    return false;
                }
            },
            deleteUser: async (id) => { 
                if (dbStore) await dbStore.collection('users').doc(id).delete(); 
            },
            authenticate: async (u, p) => { 
                if (!dbStore) return null; 
                try { 
                    const snap = await dbStore.collection('users').where('username', '==', u).where('password', '==', p).get(); 
                    return snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() }; 
                } catch(e) { 
                    return null; 
                } 
            }
        };

        const mockDB = {
            save: async (data) => { 
                console.log("Saving data to Firebase:", data.id);
                if (dbStore) {
                    try {
                        await dbStore.collection('forms').doc(data.id).set(data);
                        console.log("Data saved successfully");
                    } catch (e) {
                        console.error("Error saving to Firebase:", e);
                        throw e;
                    }
                }
            },
            delete: async (id) => { 
                console.log("Deleting data from Firebase:", id);
                if (dbStore) {
                    try {
                        await dbStore.collection('forms').doc(id).delete();
                        console.log("Data deleted successfully");
                    } catch (e) {
                        console.error("Error deleting from Firebase:", e);
                        throw e;
                    }
                }
            },
            getById: async (id) => { 
                if (!dbStore) return null; 
                const doc = await dbStore.collection('forms').doc(id).get();
                return doc.exists ? doc.data() : null; 
            },
            countFinal: async () => { 
                if (!dbStore) return 0; 
                const snap = await dbStore.collection('forms').where('statusData', 'in', ['Final', 'Rejected']).get(); 
                return snap.size; 
            },
            getAllForms: async () => { 
                if (!dbStore) return []; 
                try {
                    const snap = await dbStore.collection('forms').orderBy('updatedAt', 'desc').get(); 
                    return snap.docs.map(d => d.data());
                } catch (e) {
                    console.error("Error getting all forms:", e);
                    return [];
                }
            },
            getFormsByStatus: async (statuses) => { 
                if (!dbStore) return []; 
                const snap = await dbStore.collection('forms').where('statusData', 'in', statuses).get(); 
                return snap.docs.map(d => d.data()).sort((a, b) => b.updatedAt - a.updatedAt); 
            }
        };

        const exportToCSV = (data, filename, isRaw = false) => {
            if (!data || data.length === 0) { alert("Tidak ada data."); return; }
            let headers, csvRows;
            if (isRaw) {
                headers = Object.keys(data[0]);
                csvRows = data.map(item => headers.map(header => `"${String(item[header]||'').replace(/"/g, '""')}"`).join(","));
            } else {
                // Format CSV sesuai urutan pertanyaan formulir GHPR + tambahan kontak erat
                headers = [
                    "ID", "No. RM", "Nama Penderita", "Umur", "Jenis Kelamin", "Pekerjaan", 
                    "Alamat", "Kecamatan", "Kelurahan", "RT", "RW", "Tanggal Laporan",
                    "Tanggal Kejadian", "Tanggal Berobat", "Tempat Berobat", "Cuci Luka",
                    "Tanggal Cuci Luka", "Alasan Tidak Cuci Luka", "Lokasi Gigitan", "Jenis Luka Gigitan",
                    "Deskripsi Luka", "Kondisi Penderita", "Tanggal Meninggal", "Diagnosa Meninggal",
                    "Gejala Sebelum Meninggal", "Jenis HPR", "Alasan HPR Menggigit", "Kronologi Singkat",
                    "Kondisi HPR", "Tanggal HPR Mati", "Tanggal HPR Dibunuh", "Diberikan VAR",
                    "Jumlah Riwayat VAR", "Riwayat VAR", "Jumlah Petugas", "Data Petugas",
                    "Kontak Erat - Nama", "Kontak Erat - NIP", "Kontak Erat - Jabatan", 
                    "Kontak Erat - Tanggal Kunjungan", "Kontak Erat - Unit Kerja",
                    "Status Data", "Dibuat Oleh", "Unit Pembuat", "Current Owner", "Tanggal Update"
                ];
                
                csvRows = data.map(item => {
                    // Ambil data petugas sebagai kontak erat
                    const kontakErat = item.petugasPengumpulData || [];
                    const kontakEratText = kontakErat.map(p => 
                        `${p.nama || ''} (${p.nip || ''}) - ${p.jabatan || ''}`
                    ).join('; ');
                    
                    return [
                        `"${item.id||''}"`, 
                        `"${item.noRM||''}"`, 
                        `"${item.namaPenderita||''}"`, 
                        `"${item.umur||''}"`, 
                        `"${item.jenisKelamin||''}"`, 
                        `"${item.pekerjaan||''}"`, 
                        `"${(item.alamat||'').replace(/"/g, '""')}"`, 
                        `"${item.kecamatan||''}"`, 
                        `"${item.kelurahan||''}"`, 
                        `"${item.rt||''}"`, 
                        `"${item.rw||''}"`, 
                        `"${item.tanggalLaporan||''}"`, 
                        `"${item.tanggalKejadian||''}"`, 
                        `"${item.tanggalBerobat||''}"`, 
                        `"${item.tempatBerobat||''}"`, 
                        `"${item.cuciLuka||''}"`, 
                        `"${item.tanggalCuciLuka||''}"`, 
                        `"${item.alasanTidakCuciLuka||''}"`, 
                        `"${Array.isArray(item.lokasiGigitan) ? item.lokasiGigitan.join(', ') : item.lokasiGigitan||''}"`, 
                        `"${item.jenisLukaGigitan||''}"`, 
                        `"${item.deskripsiLuka||''}"`, 
                        `"${item.kondisiPenderita||''}"`, 
                        `"${item.tanggalMeninggal||''}"`, 
                        `"${item.diagnosaMeninggal||''}"`, 
                        `"${item.gejalaSebelumMeninggal||''}"`, 
                        `"${item.jenisHPR||''}"`, 
                        `"${item.alasanHPRMenggigit||''}"`, 
                        `"${item.kronologiSingkat||''}"`, 
                        `"${item.kondisiHPR||''}"`, 
                        `"${item.tanggalHPRMati||''}"`, 
                        `"${item.tanggalHPRDibunuh||''}"`, 
                        `"${item.diberikanVAR||''}"`, 
                        `"${item.riwayatVAR ? item.riwayatVAR.length : 0}"`, 
                        `"${JSON.stringify(item.riwayatVAR||[])}"`, 
                        `"${item.petugasPengumpulData ? item.petugasPengumpulData.length : 0}"`, 
                        `"${JSON.stringify(item.petugasPengumpulData||[])}"`,
                        // Data kontak erat (petugas) dipisah per kolom
                        `"${kontakErat.map(p => p.nama).join(', ') || ''}"`,
                        `"${kontakErat.map(p => p.nip).join(', ') || ''}"`,
                        `"${kontakErat.map(p => p.jabatan).join(', ') || ''}"`,
                        `"${kontakErat.map(p => p.tanggalKunjungan).join(', ') || ''}"`,
                        `"${kontakErat.map(p => p.unitKerja).join(', ') || ''}"`,
                        `"${item.statusData||''}"`, 
                        `"${item.createdBy||''}"`, 
                        `"${item.createdUnit||''}"`, 
                        `"${item.currentOwner || item.createdUnit}"`, 
                        `"${new Date(item.updatedAt).toLocaleDateString()}"`
                    ].join(",");
                });
            }
            const blob = new Blob([[headers.join(","), ...csvRows].join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // BAGIAN 2: LOGIC & STATE
        const INITIAL_DATA = {
            // Data dasar
            id: '', updatedAt: 0, statusData: 'Baru', sharedTo: '', createdBy: '', createdUnit: '',
            originalUnit: '', currentOwner: '', transferHistory: [],
            
            // STEP 1: PASIEN GHPR
            noRM: '',
            namaPenderita: '',
            umur: '',
            jenisKelamin: '',
            pekerjaan: '',
            alamat: '',
            provinsi: 'Kalimantan Barat',
            kabupaten: 'Kota Pontianak',
            kecamatan: '',
            kelurahan: '',
            rw: '',
            rt: '',
            
            // STEP 2: DATA KASUS GHPR
            tanggalLaporan: '',
            tanggalKejadian: '',
            tanggalBerobat: '',
            tempatBerobat: '',
            cuciLuka: '',
            tanggalCuciLuka: '',
            alasanTidakCuciLuka: '',
            lokasiGigitan: [],
            jenisLukaGigitan: '',
            deskripsiLuka: '',
            kondisiPenderita: '',
            tanggalMeninggal: '',
            diagnosaMeninggal: '',
            gejalaSebelumMeninggal: '',
            
            // STEP 3: DATA HPR
            jenisHPR: '',
            alasanHPRMenggigit: '',
            kronologiSingkat: '',
            kondisiHPR: '',
            tanggalHPRMati: '',
            tanggalHPRDibunuh: '',
            
            // STEP 4: DATA PEMBERIAN VAR
            diberikanVAR: '',
            riwayatVAR: [], // Array of VAR records
            
            // STEP 5: PETUGAS PENGUMPUL DATA (KONTAK ERAT)
            petugasPengumpulData: [] // Array of petugas records
        };

        const calculateAge = (tanggalLahir) => {
            if (!tanggalLahir) return '';
            try {
                const birthDate = new Date(tanggalLahir);
                const today = new Date();
                let years = today.getFullYear() - birthDate.getFullYear();
                let months = today.getMonth() - birthDate.getMonth();
                if (months < 0) {
                    years--;
                    months += 12;
                }
                return `${years} tahun, ${months} bulan`;
            } catch (e) {
                return '';
            }
        };

        const determineCurrentOwner = (formData) => {
            if (formData.currentOwner && formData.currentOwner !== '') {
                return formData.currentOwner;
            }
            
            if (formData.transferHistory && formData.transferHistory.length > 0) {
                const successfulTransfers = formData.transferHistory.filter(
                    record => record.action === 'diterima' || record.action === 'dikirim'
                );
                
                if (successfulTransfers.length > 0) {
                    const lastTransfer = successfulTransfers[successfulTransfers.length - 1];
                    
                    if (lastTransfer.newOwner) {
                        return lastTransfer.newOwner;
                    }
                    
                    if (lastTransfer.action === 'dikirim') {
                        return lastTransfer.from;
                    }
                    
                    if (lastTransfer.action === 'diterima') {
                        return lastTransfer.to;
                    }
                }
            }
            
            if (formData.statusData === 'Final' || formData.statusData === 'Baru' || formData.statusData === 'Draft') {
                return formData.createdUnit;
            }
            
            if (formData.statusData === 'Pending') {
                return formData.currentOwner || formData.createdUnit;
            }
            
            if (formData.statusData === 'Proses') {
                return formData.createdUnit;
            }
            
            if (formData.statusData === 'Ditolak') {
                if (formData.transferHistory && formData.transferHistory.length > 0) {
                    const sendRecords = formData.transferHistory.filter(r => r.action === 'dikirim');
                    if (sendRecords.length > 0) {
                        return sendRecords[sendRecords.length - 1].from;
                    }
                }
                return formData.createdUnit;
            }
            
            return formData.createdUnit;
        };

        const createTransferRecord = (action, fromUnit, toUnit, newOwner = null) => {
            const record = {
                action: action,
                from: fromUnit,
                to: toUnit,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            if (newOwner) {
                record.newOwner = newOwner;
                record.ownershipTransferred = true;
            }
            
            return record;
        };

        const sessionManager = {
            save: (user) => {
                const data = JSON.stringify(user);
                try { localStorage.setItem('epid_session', data); } catch (e) {}
                const d = new Date();
                d.setTime(d.getTime() + (7*24*60*60*1000));
                document.cookie = "epid_session=" + encodeURIComponent(data) + ";expires=" + d.toUTCString() + ";path=/;SameSite=None;Secure";
            },
            load: () => {
                try {
                    const local = localStorage.getItem('epid_session');
                    if (local) return JSON.parse(local);
                } catch (e) {}
                const name = "epid_session=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') c = c.substring(1);
                    if (c.indexOf(name) == 0) {
                        try { return JSON.parse(decodeURIComponent(c.substring(name.length, c.length))); } catch(e){}
                    }
                }
                return null;
            },
            clear: () => {
                try { localStorage.removeItem('epid_session'); } catch (e) {}
                document.cookie = "epid_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }
        };

        // BAGIAN 3: KOMPONEN UI DASAR
        const Card = ({ children, className = "" }) => (<div className={`bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 p-6 ${className}`}>{children}</div>);

        const Input = ({ label, as = 'input', className, uppercase = false, ...props }) => (
            <div className={`w-full ${className} mb-4`}>
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{label}</label>
                {as === 'textarea' ? (
                    <textarea {...props} rows={3} className={`w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300 ${uppercase ? 'uppercase-input' : ''}`} />
                ) : (
                    <input {...props} className={`w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 focus:shadow-sm transition-all outline-none border border-slate-200 text-body placeholder-slate-400 hover:border-slate-300 ${uppercase ? 'uppercase-input' : ''}`} />
                )}
            </div>
        );

        const Select = ({ label, children, ...props }) => (
            <div className="w-full mb-4">
                <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{label}</label>
                <div className="relative">
                    <select {...props} className="w-full p-4 bg-slate-50 rounded-xl text-slate-800 font-medium appearance-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all outline-none border border-slate-200 text-body hover:border-slate-300">
                        {children}
                    </select>
                    <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"><Icons.ChevronLeft className="-rotate-90 w-4 h-4"/></div>
                </div>
            </div>
        );

        const RadioGroup = ({ name, options, value, onChange }) => (
            <div className="flex flex-wrap gap-2 mb-4">
                {options.map(opt => (
                    <label key={opt} className={`flex-1 min-w-[100px] text-center py-3 px-4 rounded-lg cursor-pointer transition-all duration-300 font-medium text-sm capitalize relative overflow-hidden group ${value === opt ? 'bg-blue-600 text-white shadow-sm shadow-blue-500/30' : 'bg-slate-50 text-slate-600 hover:bg-slate-100 border border-slate-200'}`}>
                        <input type="radio" name={name} value={opt} checked={value === opt} onChange={onChange} className="hidden" />
                        <span className="relative z-10">{opt}</span>
                        {value === opt && <div className="absolute inset-0 bg-gradient-to-tr from-blue-600 to-indigo-500 z-0"></div>}
                    </label>
                ))}
            </div>
        );

        const Checkbox = ({ label, ...props }) => (
            <label className="flex items-center p-4 bg-slate-50 rounded-lg cursor-pointer transition active:scale-95 border border-transparent hover:border-slate-200 text-caption">
                <input type="checkbox" {...props} className="w-5 h-5 accent-blue-600 rounded mr-3" />
                <span className="text-slate-700 font-medium capitalize">{label}</span>
            </label>
        );

        const Label = ({ children }) => <label className="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 ml-1 text-micro">{children}</label>;

        const LoadingOverlay = () => (
            <div className="fixed inset-0 bg-slate-900/30 flex items-center justify-center z-50">
                <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="text-slate-700 font-bold">Memproses...</p>
                </div>
            </div>
        );

        const Toast = ({ notification }) => {
            if (!notification) return null;
            
            const bgColor = notification.type === 'success' ? 'bg-green-500' : 
                           notification.type === 'error' ? 'bg-red-500' : 
                           'bg-blue-500';
            
            return (
                <div className={`fixed top-6 right-6 ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-fadeIn`}>
                    <div className="flex items-center gap-3">
                        {notification.type === 'success' && <Icons.CheckCircle className="w-5 h-5" />}
                        {notification.type === 'error' && <Icons.XCircle className="w-5 h-5" />}
                        <span className="font-bold">{notification.msg}</span>
                    </div>
                </div>
            );
        };

        // KOMPONEN STEP UNTUK GHPR
        const Step1 = ({ data, onChange, onChangeKecamatan, Icons }) => {
            return (
                <div className="animate-fadeIn">
                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <Icons.User className="w-5 h-5 text-blue-500" />
                        Data Pasien GHPR
                    </h3>
                    
                    <Input 
                        label="No. RM" 
                        name="noRM" 
                        value={data.noRM} 
                        onChange={onChange} 
                        placeholder="Nomor Rekam Medik" 
                    />
                    
                    <Input 
                        label="Nama Penderita (HURUF KAPITAL)" 
                        name="namaPenderita" 
                        value={data.namaPenderita} 
                        onChange={onChange} 
                        placeholder="NAMA LENGKAP PENDERITA"
                        uppercase={true}
                    />
                    
                    <div className="grid grid-cols-2 gap-4">
                        <Input 
                            label="Umur" 
                            name="umur" 
                            value={data.umur} 
                            onChange={onChange} 
                            placeholder="Contoh: 25 tahun" 
                        />
                        <Select 
                            label="Jenis Kelamin" 
                            name="jenisKelamin" 
                            value={data.jenisKelamin} 
                            onChange={onChange}
                        >
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </Select>
                    </div>
                    
                    <Select 
                        label="Pekerjaan" 
                        name="pekerjaan" 
                        value={data.pekerjaan} 
                        onChange={onChange}
                    >
                        <option value="">Pilih Pekerjaan</option>
                        {DATA_PEKERJAAN.map(p => <option key={p} value={p}>{p}</option>)}
                    </Select>
                    
                    <Input 
                        label="Alamat" 
                        as="textarea" 
                        name="alamat" 
                        value={data.alamat} 
                        onChange={onChange} 
                        placeholder="Jl. Nama Jalan, Nomor Rumah" 
                    />
                    
                    <div className="bg-slate-50 p-5 rounded-xl border border-slate-100 mb-6">
                        <Label>Wilayah Administrasi</Label>
                        <div className="space-y-4 mt-3">
                            <Select label="Kecamatan" name="kecamatan" value={data.kecamatan} onChange={onChangeKecamatan}>
                                <option value="">Pilih Kecamatan</option>
                                {Object.keys(DATA_WILAYAH_MAPPING).map(k=>
                                    <option key={k} value={k}>{k}</option>
                                )}
                            </Select>
                            <Select label="Kelurahan" name="kelurahan" value={data.kelurahan} onChange={onChange} disabled={!data.kecamatan}>
                                <option value="">Pilih Kelurahan</option>
                                {data.kecamatan && DATA_WILAYAH_MAPPING[data.kecamatan]?.map(k=>
                                    <option key={k} value={k}>{k}</option>
                                )}
                            </Select>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="RT" name="rt" value={data.rt} onChange={onChange} placeholder="001" />
                                <Input label="RW" name="rw" value={data.rw} onChange={onChange} placeholder="002" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Step2 = ({ data, onChange, Icons }) => {
            const handleCheckboxChange = (e) => {
                const { name, value, checked } = e.target;
                let newValue;
                if (checked) {
                    newValue = [...(data[name] || []), value];
                } else {
                    newValue = (data[name] || []).filter(item => item !== value);
                }
                onChange({ target: { name, value: newValue } });
            };

            return (
                <div className="animate-fadeIn">
                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <Icons.Activity className="w-5 h-5 text-red-500" />
                        Data Kasus GHPR
                    </h3>
                    
                    <div className="grid grid-cols-3 gap-4">
                        <Input 
                            label="Tanggal Laporan" 
                            type="date" 
                            name="tanggalLaporan" 
                            value={data.tanggalLaporan} 
                            onChange={onChange} 
                        />
                        <Input 
                            label="Tanggal Kejadian" 
                            type="date" 
                            name="tanggalKejadian" 
                            value={data.tanggalKejadian} 
                            onChange={onChange} 
                        />
                        <Input 
                            label="Tanggal Berobat" 
                            type="date" 
                            name="tanggalBerobat" 
                            value={data.tanggalBerobat} 
                            onChange={onChange} 
                        />
                    </div>
                    
                    <Input 
                        label="Tempat Berobat" 
                        name="tempatBerobat" 
                        value={data.tempatBerobat} 
                        onChange={onChange} 
                        placeholder="Nama rumah sakit/puskesmas/klinik" 
                    />
                    
                    <div className="mb-6">
                        <Label>Cuci Luka</Label>
                        <RadioGroup 
                            name="cuciLuka" 
                            options={['Ya', 'Tidak']} 
                            value={data.cuciLuka} 
                            onChange={onChange} 
                        />
                        {data.cuciLuka === 'Ya' && (
                            <div className="mt-4">
                                <Input 
                                    label="Tanggal Cuci Luka" 
                                    type="date" 
                                    name="tanggalCuciLuka" 
                                    value={data.tanggalCuciLuka} 
                                    onChange={onChange} 
                                />
                            </div>
                        )}
                        {data.cuciLuka === 'Tidak' && (
                            <div className="mt-4">
                                <Input 
                                    label="Mengapa tidak cuci luka?" 
                                    name="alasanTidakCuciLuka" 
                                    value={data.alasanTidakCuciLuka} 
                                    onChange={onChange} 
                                    placeholder="Alasan tidak mencuci luka" 
                                />
                            </div>
                        )}
                    </div>
                    
                    <div className="mb-6">
                        <Label>Lokasi Gigitan</Label>
                        <div className="grid grid-cols-3 gap-3 mt-3">
                            {DATA_LOKASI_GIGITAN.map(lokasi => (
                                <Checkbox 
                                    key={lokasi}
                                    label={lokasi}
                                    name="lokasiGigitan"
                                    value={lokasi}
                                    checked={(data.lokasiGigitan || []).includes(lokasi)}
                                    onChange={handleCheckboxChange}
                                />
                            ))}
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <Label>Jenis Luka Gigitan</Label>
                        <RadioGroup 
                            name="jenisLukaGigitan" 
                            options={['Ringan', 'Berat']} 
                            value={data.jenisLukaGigitan} 
                            onChange={onChange} 
                        />
                        {data.jenisLukaGigitan && (
                            <div className="mt-4 p-4 bg-slate-50 rounded-xl">
                                <p className="text-sm text-slate-600">
                                    {data.jenisLukaGigitan === 'Ringan' 
                                        ? 'Ringan: Bila dicakar dan luka kecil'
                                        : 'Berat: Bila luka Multipel (Banyak), Luka Robekan Besar, Luka di daerah leher, Kepala, Jari Tangan dan Jari Kaki'
                                    }
                                </p>
                                <Input 
                                    label="Deskripsi Luka" 
                                    name="deskripsiLuka" 
                                    value={data.deskripsiLuka} 
                                    onChange={onChange} 
                                    placeholder="Deskripsi detail luka gigitan" 
                                    className="mt-3"
                                />
                            </div>
                        )}
                    </div>
                    
                    <div className="mb-6">
                        <Label>Kondisi Penderita</Label>
                        <RadioGroup 
                            name="kondisiPenderita" 
                            options={['Hidup', 'Meninggal']} 
                            value={data.kondisiPenderita} 
                            onChange={onChange} 
                        />
                        {data.kondisiPenderita === 'Meninggal' && (
                            <div className="mt-4 space-y-4">
                                <Input 
                                    label="Tanggal Meninggal" 
                                    type="date" 
                                    name="tanggalMeninggal" 
                                    value={data.tanggalMeninggal} 
                                    onChange={onChange} 
                                />
                                <Input 
                                    label="Diagnosa ketika meninggal" 
                                    name="diagnosaMeninggal" 
                                    value={data.diagnosaMeninggal} 
                                    onChange={onChange} 
                                    placeholder="Diagnosa penyebab kematian" 
                                />
                                <Input 
                                    label="Gejala apa sebelum meninggal" 
                                    name="gejalaSebelumMeninggal" 
                                    value={data.gejalaSebelumMeninggal} 
                                    onChange={onChange} 
                                    placeholder="Gejala yang dialami sebelum meninggal" 
                                />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Step3 = ({ data, onChange, Icons }) => {
            const getHPRIcon = (jenis) => {
                switch(jenis) {
                    case 'Anjing': return <Icons.Dog className="w-5 h-5" />;
                    case 'Kucing': return <Icons.Cat className="w-5 h-5" />;
                    case 'Monyet': return <Icons.Monkey className="w-5 h-5" />;
                    default: return <Icons.Activity className="w-5 h-5" />;
                }
            };

            return (
                <div className="animate-fadeIn">
                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <Icons.Shield className="w-5 h-5 text-orange-500" />
                        Data HPR (Hewan Penular Rabies)
                    </h3>
                    
                    <div className="mb-6">
                        <Label>Jenis HPR</Label>
                        <div className="grid grid-cols-3 gap-3 mt-3">
                            {['Anjing', 'Kucing', 'Monyet'].map(jenis => (
                                <label key={jenis} className={`flex flex-col items-center justify-center p-4 rounded-xl cursor-pointer transition-all border ${data.jenisHPR === jenis ? 'bg-orange-50 border-orange-300 text-orange-700' : 'bg-slate-50 border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                    <input 
                                        type="radio" 
                                        name="jenisHPR" 
                                        value={jenis} 
                                        checked={data.jenisHPR === jenis} 
                                        onChange={onChange} 
                                        className="hidden" 
                                    />
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-2 ${data.jenisHPR === jenis ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-500'}`}>
                                        {getHPRIcon(jenis)}
                                    </div>
                                    <span className="font-medium text-sm">{jenis}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <Label>Alasan HPR Menggigit</Label>
                        <RadioGroup 
                            name="alasanHPRMenggigit" 
                            options={['Diganggu', 'Tidak Diganggu']} 
                            value={data.alasanHPRMenggigit} 
                            onChange={onChange} 
                        />
                        <div className="mt-4">
                            <Input 
                                label="Kronologi Singkat" 
                                as="textarea" 
                                name="kronologiSingkat" 
                                value={data.kronologiSingkat} 
                                onChange={onChange} 
                                placeholder="Ceritakan kronologi kejadian secara singkat" 
                            />
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <Label>Kondisi HPR</Label>
                        <div className="space-y-3">
                            <label className={`flex items-center p-4 rounded-lg cursor-pointer border ${data.kondisiHPR === 'Mati Sendiri' ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200 hover:border-slate-300'}`}>
                                <input 
                                    type="radio" 
                                    name="kondisiHPR" 
                                    value="Mati Sendiri" 
                                    checked={data.kondisiHPR === 'Mati Sendiri'} 
                                    onChange={onChange} 
                                    className="w-5 h-5 accent-red-600 mr-3" 
                                />
                                <div className="flex-1">
                                    <span className="font-medium text-slate-800">Mati Sendiri</span>
                                    {data.kondisiHPR === 'Mati Sendiri' && (
                                        <div className="mt-2">
                                            <Input 
                                                label="Tanggal" 
                                                type="date" 
                                                name="tanggalHPRMati" 
                                                value={data.tanggalHPRMati} 
                                                onChange={onChange} 
                                                className="mb-0" 
                                            />
                                        </div>
                                    )}
                                </div>
                            </label>
                            
                            <label className={`flex items-center p-4 rounded-lg cursor-pointer border ${data.kondisiHPR === 'Dibunuh' ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200 hover:border-slate-300'}`}>
                                <input 
                                    type="radio" 
                                    name="kondisiHPR" 
                                    value="Dibunuh" 
                                    checked={data.kondisiHPR === 'Dibunuh'} 
                                    onChange={onChange} 
                                    className="w-5 h-5 accent-red-600 mr-3" 
                                />
                                <div className="flex-1">
                                    <span className="font-medium text-slate-800">Dibunuh</span>
                                    {data.kondisiHPR === 'Dibunuh' && (
                                        <div className="mt-2">
                                            <Input 
                                                label="Tanggal" 
                                                type="date" 
                                                name="tanggalHPRDibunuh" 
                                                value={data.tanggalHPRDibunuh} 
                                                onChange={onChange} 
                                                className="mb-0" 
                                            />
                                        </div>
                                    )}
                                </div>
                            </label>
                            
                            <label className={`flex items-center p-4 rounded-lg cursor-pointer border ${data.kondisiHPR === 'Hilang/Tdk dikenal' ? 'bg-yellow-50 border-yellow-200' : 'bg-slate-50 border-slate-200 hover:border-slate-300'}`}>
                                <input 
                                    type="radio" 
                                    name="kondisiHPR" 
                                    value="Hilang/Tdk dikenal" 
                                    checked={data.kondisiHPR === 'Hilang/Tdk dikenal'} 
                                    onChange={onChange} 
                                    className="w-5 h-5 accent-yellow-600 mr-3" 
                                />
                                <span className="font-medium text-slate-800">Hilang/Tidak dikenal</span>
                            </label>
                        </div>
                    </div>
                </div>
            );
        };

        const Step4 = ({ data, onChange, Icons }) => {
            const [varRecords, setVarRecords] = useState(data.riwayatVAR || []);

            useEffect(() => {
                setVarRecords(data.riwayatVAR || []);
            }, [data.riwayatVAR]);

            const addVarRecord = () => {
                const newRecord = {
                    id: Date.now(),
                    layanan: '',
                    layananLuarKota: '',
                    tanggalVAR: '',
                    namaPetugas: '',
                    namaVAR: '',
                    noBatch: ''
                };
                const newRecords = [...varRecords, newRecord];
                setVarRecords(newRecords);
                onChange({ target: { name: 'riwayatVAR', value: newRecords } });
            };

            const updateVarRecord = (index, field, value) => {
                const newRecords = [...varRecords];
                newRecords[index] = { ...newRecords[index], [field]: value };
                setVarRecords(newRecords);
                onChange({ target: { name: 'riwayatVAR', value: newRecords } });
            };

            const removeVarRecord = (index) => {
                const newRecords = varRecords.filter((_, i) => i !== index);
                setVarRecords(newRecords);
                onChange({ target: { name: 'riwayatVAR', value: newRecords } });
            };

            return (
                <div className="animate-fadeIn">
                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <Icons.Syringe className="w-5 h-5 text-green-500" />
                        Data Pemberian VAR
                    </h3>
                    
                    <div className="mb-8">
                        <Label>Apakah diberikan VAR?</Label>
                        <RadioGroup 
                            name="diberikanVAR" 
                            options={['YA', 'TIDAK']} 
                            value={data.diberikanVAR} 
                            onChange={onChange} 
                        />
                    </div>
                    
                    {data.diberikanVAR === 'YA' && (
                        <div>
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="font-bold text-slate-700">Riwayat Pemberian VAR</h4>
                                <button
                                    type="button"
                                    onClick={addVarRecord}
                                    className="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                                >
                                    <Icons.Plus className="w-4 h-4" /> Tambah Riwayat VAR
                                </button>
                            </div>
                            
                            <div className="space-y-6">
                                {varRecords.map((record, index) => (
                                    <div key={record.id} className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-6 rounded-xl relative">
                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex items-center gap-2">
                                                <div className="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                                                    <Icons.Syringe className="w-4 h-4" />
                                                </div>
                                                <h4 className="font-bold text-slate-800">VAR {index + 1}</h4>
                                            </div>
                                            <button
                                                type="button"
                                                onClick={() => removeVarRecord(index)}
                                                className="w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition"
                                            >
                                                <Icons.Trash className="w-4 h-4" />
                                            </button>
                                        </div>
                                        
                                        <div className="mb-4">
                                            <Label>Layanan</Label>
                                            <div className="space-y-3">
                                                <label className="flex items-center p-3 bg-white rounded-lg border border-green-100 cursor-pointer">
                                                    <input 
                                                        type="radio" 
                                                        name={`layanan-${record.id}`}
                                                        value="pilihan"
                                                        checked={record.layanan === 'pilihan'}
                                                        onChange={() => updateVarRecord(index, 'layanan', 'pilihan')}
                                                        className="w-4 h-4 accent-green-600 mr-3"
                                                    />
                                                    <span className="text-slate-700">Pilihan Layanan</span>
                                                </label>
                                                <label className="flex items-center p-3 bg-white rounded-lg border border-green-100 cursor-pointer">
                                                    <input 
                                                        type="radio" 
                                                        name={`layanan-${record.id}`}
                                                        value="luar_kota"
                                                        checked={record.layanan === 'luar_kota'}
                                                        onChange={() => updateVarRecord(index, 'layanan', 'luar_kota')}
                                                        className="w-4 h-4 accent-green-600 mr-3"
                                                    />
                                                    <span className="text-slate-700">Layanan Luar Kota Pontianak</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        {record.layanan === 'pilihan' && (
                                            <div className="mb-4">
                                                <Select 
                                                    label="Pilih Layanan" 
                                                    value={record.layananLuarKota}
                                                    onChange={(e) => updateVarRecord(index, 'layananLuarKota', e.target.value)}
                                                >
                                                    <option value="">Pilih Layanan...</option>
                                                    {ALL_SERVICES.map(service => (
                                                        <option key={service} value={service}>{service}</option>
                                                    ))}
                                                </Select>
                                            </div>
                                        )}
                                        
                                        {record.layanan === 'luar_kota' && (
                                            <div className="mb-4">
                                                <Input 
                                                    label="Layanan Luar Kota Pontianak" 
                                                    value={record.layananLuarKota}
                                                    onChange={(e) => updateVarRecord(index, 'layananLuarKota', e.target.value)}
                                                    placeholder="Tulis nama layanan luar kota"
                                                />
                                            </div>
                                        )}
                                        
                                        {(record.layanan === 'pilihan' || record.layanan === 'luar_kota') && (
                                            <div className="grid grid-cols-2 gap-4">
                                                <Input 
                                                    label="Tanggal VAR" 
                                                    type="date" 
                                                    value={record.tanggalVAR}
                                                    onChange={(e) => updateVarRecord(index, 'tanggalVAR', e.target.value)}
                                                />
                                                <Input 
                                                    label="Nama Petugas" 
                                                    value={record.namaPetugas}
                                                    onChange={(e) => updateVarRecord(index, 'namaPetugas', e.target.value)}
                                                    placeholder="Nama petugas pemberi VAR"
                                                />
                                                <Input 
                                                    label="Nama VAR" 
                                                    value={record.namaVAR}
                                                    onChange={(e) => updateVarRecord(index, 'namaVAR', e.target.value)}
                                                    placeholder="Nama VAR yang diberikan"
                                                />
                                                <Input 
                                                    label="No. Batch" 
                                                    value={record.noBatch}
                                                    onChange={(e) => updateVarRecord(index, 'noBatch', e.target.value)}
                                                    placeholder="Nomor batch VAR"
                                                />
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            
                            {varRecords.length > 0 && (
                                <div className="mt-6 flex justify-center">
                                    <button
                                        type="button"
                                        onClick={addVarRecord}
                                        className="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                                    >
                                        <Icons.Plus className="w-4 h-4" /> Tambah Riwayat VAR Lagi
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const Step5 = ({ data, onChange, getGeo, loadingGeo, onSaveToPending, onSaveAndFinal, Icons }) => {
            const [petugasRecords, setPetugasRecords] = useState(data.petugasPengumpulData || []);

            useEffect(() => {
                setPetugasRecords(data.petugasPengumpulData || []);
            }, [data.petugasPengumpulData]);

            const addPetugasRecord = () => {
                const newRecord = {
                    id: Date.now(),
                    nama: '',
                    nip: '',
                    jabatan: '',
                    tanggalKunjungan: '',
                    unitKerja: ''
                };
                const newRecords = [...petugasRecords, newRecord];
                setPetugasRecords(newRecords);
                onChange({ target: { name: 'petugasPengumpulData', value: newRecords } });
            };

            const updatePetugasRecord = (index, field, value) => {
                const newRecords = [...petugasRecords];
                newRecords[index] = { ...newRecords[index], [field]: value };
                setPetugasRecords(newRecords);
                onChange({ target: { name: 'petugasPengumpulData', value: newRecords } });
            };

            const removePetugasRecord = (index) => {
                const newRecords = petugasRecords.filter((_, i) => i !== index);
                setPetugasRecords(newRecords);
                onChange({ target: { name: 'petugasPengumpulData', value: newRecords } });
            };

            return (
                <div className="animate-fadeIn">
                    <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <Icons.Users className="w-5 h-5 text-purple-500" />
                        Petugas Pengumpul Data (Kontak Erat)
                    </h3>
                    
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <p className="text-slate-600">Tambahkan data petugas yang melakukan pengumpulan data</p>
                            <p className="text-sm text-slate-500">Bisa lebih dari satu petugas berdasarkan kunjungan</p>
                        </div>
                        <button
                            type="button"
                            onClick={addPetugasRecord}
                            className="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                        >
                            <Icons.UserPlus className="w-4 h-4" /> Tambah Petugas
                        </button>
                    </div>
                    
                    <div className="space-y-6 mb-8">
                        {petugasRecords.map((record, index) => (
                            <div key={record.id} className="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 p-6 rounded-xl relative">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-2">
                                        <div className="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center">
                                            <Icons.User className="w-4 h-4" />
                                        </div>
                                        <h4 className="font-bold text-slate-800">Petugas {index + 1}</h4>
                                    </div>
                                    <button
                                        type="button"
                                        onClick={() => removePetugasRecord(index)}
                                        className="w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition"
                                    >
                                        <Icons.Trash className="w-4 h-4" />
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <Input 
                                        label="Nama Petugas" 
                                        value={record.nama}
                                        onChange={(e) => updatePetugasRecord(index, 'nama', e.target.value)}
                                        placeholder="Nama lengkap petugas"
                                        uppercase={true}
                                    />
                                    <Input 
                                        label="NIP" 
                                        value={record.nip}
                                        onChange={(e) => updatePetugasRecord(index, 'nip', e.target.value)}
                                        placeholder="Nomor Induk Pegawai"
                                    />
                                    <Input 
                                        label="Jabatan" 
                                        value={record.jabatan}
                                        onChange={(e) => updatePetugasRecord(index, 'jabatan', e.target.value)}
                                        placeholder="Jabatan petugas"
                                    />
                                    <Input 
                                        label="Tanggal Kunjungan" 
                                        type="date" 
                                        value={record.tanggalKunjungan}
                                        onChange={(e) => updatePetugasRecord(index, 'tanggalKunjungan', e.target.value)}
                                    />
                                    <div className="md:col-span-2">
                                        <Input 
                                            label="Unit Kerja" 
                                            value={record.unitKerja}
                                            onChange={(e) => updatePetugasRecord(index, 'unitKerja', e.target.value)}
                                            placeholder="Unit kerja petugas"
                                        />
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {petugasRecords.length > 0 && (
                        <div className="mt-6 flex justify-center">
                            <button
                                type="button"
                                onClick={addPetugasRecord}
                                className="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-bold hover:shadow-lg transition flex items-center gap-2"
                            >
                                <Icons.UserPlus className="w-4 h-4" /> Tambah Petugas Lagi
                            </button>
                        </div>
                    )}
                    
                    <div className="mt-10 pt-6 border-t border-slate-200">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Opsi Penyimpanan</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-200">
                                <div className="flex items-start mb-3">
                                    <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                        <Icons.Hourglass className="w-5 h-5" />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-800 mb-1">Simpan ke Pending Form</h4>
                                        <p className="text-sm text-slate-600">
                                            Formulir akan masuk ke <strong>Pending Form</strong>.
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    type="button"
                                    onClick={onSaveToPending}
                                    className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 mt-2"
                                >
                                    <Icons.Save className="w-4 h-4" /> Simpan ke Pending Form
                                </button>
                            </div>

                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-5 rounded-xl border border-green-200">
                                <div className="flex items-start mb-3">
                                    <div className="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                        <Icons.CheckCircle className="w-5 h-5" />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-800 mb-1">Simpan & Langsung Finalisasi</h4>
                                        <p className="text-sm text-slate-600">
                                            Formulir akan masuk ke <strong>Form Final</strong>.
                                        </p>
                                    </div>
                                </div>
                                <button 
                                    type="button"
                                    onClick={onSaveAndFinal}
                                    className="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center gap-2 mt-2"
                                >
                                    <Icons.Check className="w-4 h-4" /> Simpan & Finalisasi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // BAGIAN 4: APP COMPONENT
        const App = () => {
            const [currentUser, setCurrentUser] = useState(sessionManager.load);
            const [view, setView] = useState(() => {
                const user = sessionManager.load();
                if (user) return user.role === 'admin' ? 'admin-dashboard' : 'start';
                return 'login';
            });

            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState(INITIAL_DATA);
            const [notification, setNotification] = useState(null);
            const [hasNewReceived, setHasNewReceived] = useState(false);
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);

            // Modals & States
            const [showExitModal, setShowExitModal] = useState(false);
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [showShareModal, setShowShareModal] = useState(false); 
            const [showReviewModal, setShowReviewModal] = useState(false); 
            const [showTransferModal, setShowTransferModal] = useState(false);
            const [showViewModal, setShowViewModal] = useState(false);
            const [showAdminDeleteUserModal, setShowAdminDeleteUserModal] = useState(false);
            const [adminUserToDelete, setAdminUserToDelete] = useState(null);
            const [reviewItem, setReviewItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [itemToShare, setItemToShare] = useState(null); 
            const [itemToView, setItemToView] = useState(null);
            const [itemToTransfer, setItemToTransfer] = useState(null);
            
            const [showFinalizeModal, setShowFinalizeModal] = useState(false);
            const [itemToFinalize, setItemToFinalize] = useState(null);
            
            const [showRejectModal, setShowRejectModal] = useState(false);
            const [itemToReject, setItemToReject] = useState(null);
            
            const [showUnfinalizeModal, setShowUnfinalizeModal] = useState(false);
            const [itemToUnfinalize, setItemToUnfinalize] = useState(null);
            
            const [showLogoutModal, setShowLogoutModal] = useState(false);
            
            const [draftsList, setDraftsList] = useState([]);
            const [pendingList, setPendingList] = useState([]);
            const [formFinalList, setFormFinalList] = useState([]);
            const [outgoingList, setOutgoingList] = useState([]);
            const [receivedList, setReceivedList] = useState([]); 
            const [rejectedList, setRejectedList] = useState([]);
            
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const topRef = useRef(null);
            const [showLoadingOverlay, setShowLoadingOverlay] = useState(false);

            // PERBAIKAN 1: Event listener untuk beforeunload
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    if (hasUnsavedChanges && view === 'form') {
                        e.preventDefault();
                        e.returnValue = 'Ada perubahan yang belum disimpan. Yakin ingin meninggalkan halaman?';
                        return e.returnValue;
                    }
                };

                window.addEventListener('beforeunload', handleBeforeUnload);
                
                return () => {
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                };
            }, [hasUnsavedChanges, view]);

            // PERBAIKAN 2: History management untuk navigasi step
            useEffect(() => {
                if (view === 'form') {
                    // Simpan state awal ke history
                    window.history.pushState({ view: 'form', step: step }, '');
                    
                    const handlePopState = (event) => {
                        if (view === 'form') {
                            if (event.state && event.state.view === 'form') {
                                // Kembali ke step sebelumnya
                                if (event.state.step && event.state.step !== step) {
                                    if (hasUnsavedChanges) {
                                        if (window.confirm('Ada perubahan yang belum disimpan. Yakin ingin kembali?')) {
                                            setStep(event.state.step);
                                            setHasUnsavedChanges(false);
                                        } else {
                                            // Batalkan navigasi
                                            window.history.pushState({ view: 'form', step: step }, '');
                                        }
                                    } else {
                                        setStep(event.state.step);
                                    }
                                }
                            } else {
                                // Kembali ke menu utama
                                if (hasUnsavedChanges) {
                                    if (window.confirm('Ada perubahan yang belum disimpan. Yakin ingin keluar dari form?')) {
                                        setView('start');
                                        setHasUnsavedChanges(false);
                                    } else {
                                        window.history.pushState({ view: 'form', step: step }, '');
                                    }
                                } else {
                                    setView('start');
                                }
                            }
                        }
                    };

                    window.addEventListener('popstate', handlePopState);
                    
                    return () => {
                        window.removeEventListener('popstate', handlePopState);
                    };
                }
            }, [view, step, hasUnsavedChanges]);

            const showLoading = (show = true, minDelay = 300) => {
                if (show) {
                    setLoading(true);
                    setShowLoadingOverlay(true);
                } else {
                    setTimeout(() => {
                        setLoading(false);
                        setShowLoadingOverlay(false);
                    }, minDelay);
                }
            };

            const checkNewReceived = async () => {
                if (!currentUser) return;
                try {
                    const all = await mockDB.getAllForms();
                    const received = all.filter(i => 
                        i.sharedTo === currentUser.unitName && 
                        i.statusData === 'Proses' &&
                        i.createdUnit !== currentUser.unitName
                    );
                    setHasNewReceived(received.length > 0);
                } catch (e) {
                    console.error("Error checking new received:", e);
                }
            };

            useEffect(() => { 
                const init = async () => { 
                    await mockUserDB.checkAndCreateDefaultAdmin(); 
                    
                    if (view !== 'login' && !currentUser) {
                        setView('login'); 
                    }
                    
                    if (currentUser) {
                        console.log(`Current user: ${currentUser.name}, role: ${currentUser.role}, unit: ${currentUser.unitName}`);
                        
                        if (view === 'start') {
                            await checkNewReceived();
                        }
                        
                        if (['form-final', 'outgoing', 'inbox', 'drafts', 'pending', 'rejected'].includes(view)) {
                            console.log(`Loading data for view: ${view}`);
                            await loadDataForView();
                        }
                    }
                }; 
                init(); 
            }, [view, currentUser]);

            const loadDataForView = async () => {
                if (!currentUser) return;
                
                console.log(`Loading data for user: ${currentUser.username}, unit: ${currentUser.unitName}`);
                showLoading(true);
                try {
                    const allForms = await mockDB.getAllForms();
                    console.log(`Total forms loaded: ${allForms.length}`);
                    
                    // 1. Drafts
                    const drafts = allForms.filter(d => 
                        d.createdBy === currentUser.username && 
                        d.statusData === 'Draft'
                    );
                    console.log(`Drafts found: ${drafts.length}`);
                    setDraftsList(drafts);
                    
                    // 2. Pending Form
                    const pending = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isPendingStatus = i.statusData === 'Pending';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        return isPendingStatus && isOwnedByMe;
                    });
                    console.log(`Pending forms: ${pending.length}`);
                    setPendingList(pending);
                    
                    // 3. Form Final
                    const formFinal = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isFinalStatus = i.statusData === 'Final';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        return isFinalStatus && isOwnedByMe;
                    });
                    console.log(`Form Final: ${formFinal.length}`);
                    setFormFinalList(formFinal);
                    
                    // 4. Formulir Keluar
                    const outgoing = allForms.filter(i => {
                        const isCreatedByMe = i.createdBy === currentUser.username;
                        const hasBeenShared = i.sharedTo && i.sharedTo !== '';
                        const notToMyself = i.sharedTo !== currentUser.unitName;
                        
                        if (isCreatedByMe && hasBeenShared && notToMyself) {
                            const currentOwner = determineCurrentOwner(i);
                            
                            if ((i.statusData === 'Proses' || i.statusData === 'Ditolak') && 
                                currentOwner === currentUser.unitName) {
                                return true;
                            }
                        }
                        
                        return false;
                    });
                    console.log(`Outgoing forms: ${outgoing.length}`);
                    setOutgoingList(outgoing);
                    
                    // 5. Inbox
                    const received = allForms.filter(i => {
                        const isSharedToMe = i.sharedTo === currentUser.unitName;
                        const isInProcess = i.statusData === 'Proses';
                        const currentOwner = determineCurrentOwner(i);
                        
                        if (isSharedToMe && isInProcess && currentOwner !== currentUser.unitName) {
                            return true;
                        }
                        
                        return false;
                    });
                    console.log(`Inbox forms: ${received.length}`);
                    setReceivedList(received);
                    
                    // 6. Form Ditolak
                    const rejected = allForms.filter(i => {
                        const currentOwner = determineCurrentOwner(i);
                        const isRejected = i.statusData === 'Ditolak';
                        const isOwnedByMe = currentOwner === currentUser.unitName;
                        
                        return isRejected && isOwnedByMe;
                    });
                    console.log(`Rejected forms: ${rejected.length}`);
                    setRejectedList(rejected);
                    
                    setHasNewReceived(received.length > 0);
                    
                } catch (e) {
                    console.error("Error loading data:", e);
                    showNotification('Error memuat data: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            useEffect(() => { 
                if(view === 'form') window.scrollTo({ top: 0, behavior: 'smooth' }); 
            }, [step, view]);

            const handleLogin = async (e) => {
                e.preventDefault(); 
                showLoading(true);
                try {
                    const user = await mockUserDB.authenticate(username, password);
                    if (user) {
                        sessionManager.save(user); 
                        setCurrentUser(user);
                        if (user.role === 'admin') { 
                            setView('admin-dashboard'); 
                            showNotification('Welcome Admin', 'success'); 
                        } else { 
                            setView('start'); 
                            showNotification(`Halo, ${user.name}`, 'success'); 
                        }
                    } else { 
                        showNotification('Akun tidak ditemukan', 'error'); 
                    }
                } catch (error) {
                    showNotification('Error: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const handleLogout = () => { 
                setShowLogoutModal(true);
            };

            const confirmLogout = () => {
              sessionManager.clear(); 
              setUsername(''); 
              setPassword(''); 
              setCurrentUser(null); 
              setView('login'); 
              setShowLogoutModal(false);
            };

            const handleStartNew = async () => { 
                const newId = Date.now().toString(); 
                setFormData({ 
                    ...INITIAL_DATA, 
                    id: newId, 
                    createdBy: currentUser.username, 
                    createdUnit: currentUser.unitName,
                    originalUnit: currentUser.unitName,
                    currentOwner: currentUser.unitName,
                    transferHistory: []
                }); 
                setStep(1); 
                setHasUnsavedChanges(false);
                setView('form'); 
            };
            
            const handleEditForm = (item) => {
                console.log("Editing form:", item);
                
                const currentOwner = determineCurrentOwner(item);
                let canEdit = false;
                
                if (currentOwner === currentUser.unitName) {
                    canEdit = true;
                }
                
                if (!canEdit) {
                    showNotification('Anda tidak memiliki hak akses untuk mengedit formulir ini', 'error');
                    return;
                }
                
                const formDataToEdit = {
                    ...item,
                    updatedAt: Date.now()
                };
                
                showNotification('Formulir dibuka untuk diedit', 'success');
                setFormData(formDataToEdit);
                setStep(1); 
                setHasUnsavedChanges(false);
                setView('form'); 
            };
            
            const handleOpenDrafts = async () => { 
                await loadDataForView();
                setView('drafts'); 
            };
            
            const handleOpenPending = async () => { 
                await loadDataForView();
                setView('pending'); 
            };
            
            const handleOpenFormFinal = async () => { 
                await loadDataForView();
                setView('form-final'); 
            };
            
            const handleOpenOutgoing = async () => { 
                await loadDataForView();
                setView('outgoing'); 
            };
            
            const handleOpenInbox = async () => { 
                console.log("Opening inbox...");
                setHasNewReceived(false);
                await loadDataForView();
                setView('inbox');
                showNotification('Inbox dimuat', 'success');
            };

            const handleOpenRejected = async () => { 
                await loadDataForView();
                setView('rejected'); 
            };

            const handleShareForm = (item) => {
                setItemToShare(item);
                setShowShareModal(true);
            };

            const handleViewForm = (item) => {
                console.log("handleViewForm called with item:", item);
                console.log("Opening view modal for item:", item);
                if (!item) {
                    showNotification('Data tidak ditemukan', 'error');
                    return;
                }
                setItemToView(item);
                setShowViewModal(true);
                console.log("View modal should be visible now");
            };

            const handleCloseViewModal = () => {
                console.log("Closing view modal");
                setShowViewModal(false);
                setItemToView(null);
            };

            const handleTransferForm = (item) => {
                setItemToTransfer(item);
                setShowTransferModal(true);
            };

            const confirmShare = async (target) => {
                if (!target || target === currentUser.unitName) {
                    showNotification('Tidak dapat mengirim ke diri sendiri', 'error');
                    return;
                }
                
                showLoading(true);
                setShowShareModal(false);
                
                try {
                    const transferRecord = createTransferRecord(
                        'dikirim', 
                        currentUser.unitName, 
                        target
                    );
                    
                    const up = { 
                        ...itemToShare, 
                        statusData: 'Proses', 
                        sharedTo: target, 
                        updatedAt: Date.now(),
                        currentOwner: itemToShare.currentOwner || determineCurrentOwner(itemToShare),
                        transferHistory: [...(itemToShare.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setItemToShare(null);
                    showNotification(`Formulir dikirim ke ${target}`, 'success');
                } catch (e) {
                    console.error("Error sharing form:", e);
                    showNotification('Error mengirim formulir', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const confirmTransfer = async (target) => {
                if (!target || target === currentUser.unitName) {
                    showNotification('Tidak dapat meneruskan ke diri sendiri', 'error');
                    return;
                }
                
                showLoading(true);
                setShowTransferModal(false);
                
                try {
                    const transferRecord = createTransferRecord(
                        'diteruskan', 
                        currentUser.unitName, 
                        target
                    );
                    
                    const up = { 
                        ...itemToTransfer, 
                        statusData: 'Proses',
                        sharedTo: target,
                        updatedAt: Date.now(),
                        currentOwner: itemToTransfer.currentOwner || determineCurrentOwner(itemToTransfer),
                        transferHistory: [...(itemToTransfer.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setItemToTransfer(null);
                    showNotification(`Formulir diteruskan ke ${target}`, 'success');
                } catch (e) {
                    console.error("Error transferring form:", e);
                    showNotification('Error meneruskan formulir', 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            const handleAcceptTransfer = async (item) => { 
                showLoading(true); 
                try {
                    const transferRecord = createTransferRecord(
                        'diterima',
                        item.currentOwner || item.createdUnit,
                        currentUser.unitName,
                        currentUser.unitName
                    );
                    
                    const up = { 
                        ...item, 
                        statusData: 'Pending',
                        currentOwner: currentUser.unitName,
                        updatedAt: Date.now(),
                        transferHistory: [...(item.transferHistory || []), transferRecord]
                    }; 
                    
                    await mockDB.save(up); 
                    await loadDataForView();
                    setShowReviewModal(false); 
                    showNotification('Formulir diterima - Masuk ke menu Pending Form', 'success');
                } catch (e) {
                    console.error("Error accepting transfer:", e);
                    showNotification('Error menerima formulir', 'error');
                } finally {
                    showLoading(false); 
                }
            };
            
            const handleRejectTransfer = (item) => { 
                setItemToReject(item);
                setShowRejectModal(true);
            };
            
            const confirmRejectTransfer = async () => {
                if (!itemToReject) return;
                
                showLoading(true); 
                try {
                    const transferRecord = createTransferRecord(
                        'ditolak',
                        currentUser.unitName,
                        itemToReject.currentOwner || itemToReject.createdUnit
                    );
                    
                    const up = { 
                        ...itemToReject, 
                        statusData: 'Ditolak', 
                        currentOwner: itemToReject.currentOwner || determineCurrentOwner(itemToReject),
                        updatedAt: Date.now(),
                        transferHistory: [...(itemToReject.transferHistory || []), transferRecord]
                    }; 
                    
                    await mockDB.save(up); 
                    await loadDataForView();
                    setShowRejectModal(false); 
                    setItemToReject(null);
                    showNotification('Formulir ditolak - Kembali ke pengirim', 'error');
                } catch (e) {
                    console.error("Error rejecting transfer:", e);
                    showNotification('Error menolak formulir', 'error');
                } finally {
                    showLoading(false); 
                }
            };

            const handleFinalizeFromPending = (item) => {
                setItemToFinalize(item);
                setShowFinalizeModal(true);
            };

            const confirmFinalize = async () => {
                if (!itemToFinalize) return;
                
                showLoading(true); 
                try {
                    let finalData = { ...itemToFinalize };
                    
                    finalData.updatedAt = Date.now();
                    finalData.statusData = 'Final';
                    finalData.sharedTo = '';
                    finalData.currentOwner = finalData.currentOwner || finalData.createdUnit;
                    
                    await mockDB.save(finalData); 
                    await loadDataForView();
                    setShowFinalizeModal(false);
                    setItemToFinalize(null);
                    showNotification('Formulir berhasil difinalkan!', 'success');
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error menyimpan: ' + e.message, 'error'); 
                } finally {
                    showLoading(false);
                }
            };

            const handleUnfinalizeForm = (item) => {
                setItemToUnfinalize(item);
                setShowUnfinalizeModal(true);
            };

            const confirmUnfinalize = async () => {
                if (!itemToUnfinalize) return;
                
                showLoading(true);
                try {
                    const currentOwner = determineCurrentOwner(itemToUnfinalize);
                    
                    const transferRecord = createTransferRecord(
                        'dibatalkan_finalisasi',
                        'admin',
                        currentOwner
                    );
                    
                    const up = {
                        ...itemToUnfinalize,
                        statusData: 'Pending',
                        updatedAt: Date.now(),
                        currentOwner: currentOwner,
                        transferHistory: [...(itemToUnfinalize.transferHistory || []), transferRecord]
                    };
                    
                    await mockDB.save(up);
                    await loadDataForView();
                    setShowUnfinalizeModal(false);
                    setItemToUnfinalize(null);
                    showNotification('Formulir berhasil dibatalkan finalisasi! Kembali ke Pending Form ' + currentOwner, 'success');
                } catch (e) {
                    console.error("Error unfinalizing form:", e);
                    showNotification('Error membatalkan finalisasi: ' + e.message, 'error');
                } finally {
                    showLoading(false);
                }
            };

            const handleResumeDraft = (d) => { 
                setFormData(d); 
                setStep(1); 
                setHasUnsavedChanges(false);
                setView('form'); 
            };
            
            const handleExportMyData = () => { 
                if (formFinalList.length===0) {
                    showNotification('Tidak ada data untuk diexport', 'error'); 
                    return;
                }
                
                const enhancedData = formFinalList.map(item => {
                    const currentOwner = determineCurrentOwner(item);
                    return {
                        ...item,
                        currentOwner: currentOwner
                    };
                });
                
                exportToCSV(enhancedData, `GHPR_${currentUser.unitName}_${new Date().toISOString().split('T')[0]}.csv`); 
            };
            
            const handleOpenReview = (i) => { 
                setReviewItem(i); 
                setShowReviewModal(true); 
            };
            
            const handleBackToStart = () => {
                if (hasUnsavedChanges) {
                    setShowExitModal(true);
                } else {
                    setView('start');
                }
            };
            
            const handleConfirmExit = (act) => { 
                setShowExitModal(false); 
                if (act === 'save') { 
                    handleSaveDraft(); 
                    setTimeout(() => setView('start'), 1000); 
                } else if (act === 'discard') {
                    setHasUnsavedChanges(false);
                    setView('start'); 
                }
            };
            
            const confirmDelete = (i) => { 
                setItemToDelete(i); 
                setShowDeleteModal(true); 
            };
            
            const handleDeleteForm = async () => { 
                if (itemToDelete && currentUser?.role === 'admin') { 
                    showLoading(true);
                    try {
                        await mockDB.delete(itemToDelete.id); 
                        await loadDataForView();
                        setShowDeleteModal(false); 
                        showNotification('Formulir dihapus', 'success');
                    } catch (e) {
                        console.error("Error deleting form:", e);
                        showNotification('Error menghapus formulir', 'error');
                    } finally {
                        showLoading(false);
                    }
                } else {
                    showNotification('Hanya admin yang dapat menghapus formulir', 'error');
                }
            };

            const handleChange = (e) => { 
                const { name, value, type, checked } = e.target; 
                
                let processedValue = value;
                if (name === 'namaPenderita' || name === 'namaPetugas') {
                    processedValue = value.toUpperCase();
                }
                
                if (type === 'checkbox') { 
                    if (['lokasiGigitan'].includes(name)) { 
                        setFormData(prev => { 
                            const cur = prev[name] || []; 
                            const nv = checked ? [...cur, value] : cur.filter(v => v !== value); 
                            return { ...prev, [name]: nv }; 
                        }); 
                    } else { 
                        setFormData(prev => ({ ...prev, [name]: checked })); 
                    } 
                } else if (type === 'radio') {
                    setFormData(prev => ({ ...prev, [name]: processedValue }));
                } else { 
                    setFormData(prev => ({ ...prev, [name]: processedValue })); 
                } 
                
                // Tandai ada perubahan yang belum disimpan
                setHasUnsavedChanges(true);
            };
            
            const handleKecamatanChange = (e) => { 
                const v = e.target.value; 
                setFormData(p => ({ ...p, kecamatan: v, kelurahan: '' })); 
                setHasUnsavedChanges(true);
            };
            
            const getGeoLocation = () => { 
                showLoading(true); 
                navigator.geolocation.getCurrentPosition( 
                    (p) => { 
                        showLoading(false); 
                        showNotification('Koordinat berhasil direkam', 'success');
                    }, 
                    (e) => { 
                        showLoading(false); 
                        showNotification('GPS Error: ' + e.message, 'error'); 
                    } 
                ); 
            };
            
            const handleSaveDraft = async () => { 
                showLoading(true); 
                try { 
                    const d = { 
                        ...formData, 
                        statusData: 'Draft', 
                        updatedAt: Date.now(), 
                        createdBy: currentUser?.username, 
                        createdUnit: currentUser?.unitName,
                        originalUnit: currentUser?.unitName,
                        currentOwner: formData.currentOwner || currentUser?.unitName
                    }; 
                    
                    await mockDB.save(d); 
                    setFormData(d); 
                    setHasUnsavedChanges(false); // Reset status perubahan
                    showLoading(false); 
                    showNotification('Draft tersimpan', 'success'); 
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error Save: ' + e.message, 'error'); 
                } 
            };
            
            const handleSaveToPending = async () => { 
                if (!formData.namaPenderita) { 
                    showNotification('Nama Penderita wajib!', 'error'); 
                    return; 
                } 
                
                if (!formData.tanggalLaporan) {
                    showNotification('Tanggal Laporan wajib!', 'error');
                    return;
                }
                
                showLoading(true); 
                try { 
                    const d = { 
                        ...formData, 
                        statusData: 'Pending',
                        updatedAt: Date.now(), 
                        createdBy: currentUser?.username, 
                        createdUnit: currentUser?.unitName,
                        originalUnit: currentUser?.unitName,
                        currentOwner: currentUser?.unitName
                    }; 
                    
                    await mockDB.save(d); 
                    setFormData(d); 
                    setHasUnsavedChanges(false); // Reset status perubahan
                    showLoading(false); 
                    showNotification('Formulir disimpan ke Pending Form', 'success');
                    
                    setTimeout(() => {
                        setView('pending'); 
                    }, 1000);
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error Save: ' + e.message, 'error'); 
                } 
            };
            
            const handleSaveAndFinal = async () => {
                if (!formData.namaPenderita) { 
                    showNotification('Nama Penderita wajib!', 'error'); 
                    return; 
                } 
                
                if (!formData.tanggalLaporan) {
                    showNotification('Tanggal Laporan wajib!', 'error');
                    return;
                }
                
                if (!formData.kecamatan || !formData.kelurahan) {
                    showNotification('Kecamatan dan Kelurahan wajib!', 'error');
                    return;
                }
                
                showLoading(true); 
                try { 
                    let finalData = { ...formData };
                    
                    finalData.updatedAt = Date.now();
                    finalData.statusData = 'Final';
                    finalData.sharedTo = '';
                    finalData.currentOwner = finalData.currentOwner || finalData.createdUnit;
                    
                    await mockDB.save(finalData); 
                    setFormData(finalData); 
                    setHasUnsavedChanges(false); // Reset status perubahan
                    showLoading(false); 
                    
                    showNotification('Formulir berhasil difinalkan!', 'success');
                    
                    setTimeout(() => {
                        setView('success'); 
                    }, 500);
                    
                } catch (e) { 
                    showLoading(false); 
                    showNotification('Error menyimpan: ' + e.message, 'error'); 
                } 
            };
            
            const showNotification = (msg, type) => { 
                setNotification({ msg, type }); 
                setTimeout(() => setNotification(null), 3000); 
            };
            
            const nextStep = () => {
                setStep(p => Math.min(p + 1, 5));
                // Update history untuk step baru
                window.history.pushState({ view: 'form', step: Math.min(step + 1, 5) }, '');
                setTimeout(() => {
                    if (topRef.current) {
                        topRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 50);
            };
            
            const prevStep = () => {
                setStep(p => Math.max(p - 1, 1));
                // Kembali menggunakan history API
                window.history.back();
            };

            const STEP_LABELS = [
                { id: 1, label: 'Pasien GHPR', icon: Icons.User }, 
                { id: 2, label: 'Data Kasus', icon: Icons.Activity }, 
                { id: 3, label: 'Data HPR', icon: Icons.Shield }, 
                { id: 4, label: 'Pemberian VAR', icon: Icons.Syringe }, 
                { id: 5, label: 'Petugas', icon: Icons.Users }
            ];
                                        
            const renderCurrentView = () => {
                if (view === 'login') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-gradient-to-br from-slate-900 to-slate-800 overflow-y-auto">
                        <div className="min-h-full flex items-center justify-center p-6 relative z-10">
                            <div className="w-full max-w-sm bg-white/10 backdrop-blur-xl border border-white/20 p-8 rounded-2xl shadow-2xl">
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-blue-500 to-indigo-500 shadow-lg shadow-blue-500/40 mb-4">
                                        <Icons.Shield className="w-8 h-8 text-white" />
                                    </div>
                                    <h1 className="text-3xl font-black text-white mb-2 tracking-tight">Sistem GHPR</h1>
                                    <p className="text-slate-300 text-body font-medium">Gigitan Hewan Penular Rabies</p>
                                </div>
                                
                                <form onSubmit={handleLogin} className="space-y-5">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-300 mb-2 text-caption">Username</label>
                                        <div className="bg-white/10 rounded-xl p-1 flex items-center border border-white/20 focus-within:border-blue-400 transition">
                                            <div className="p-3 text-slate-400"><Icons.User className="w-5 h-5"/></div>
                                            <input 
                                                type="text" 
                                                value={username} 
                                                onChange={e=>setUsername(e.target.value)} 
                                                placeholder="Masukkan username" 
                                                className="bg-transparent w-full p-2 text-white placeholder-slate-500 outline-none font-medium text-body" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-300 mb-2 text-caption">Password</label>
                                        <div className="bg-white/10 rounded-xl p-1 flex items-center border border-white/20 focus-within:border-blue-400 transition">
                                            <div className="p-3 text-slate-400"><Icons.Lock className="w-5 h-5"/></div>
                                            <input 
                                                type="password" 
                                                value={password} 
                                                onChange={e=>setPassword(e.target.value)} 
                                                placeholder="Masukkan password" 
                                                className="bg-transparent w-full p-2 text-white placeholder-slate-500 outline-none font-medium text-body" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <button className="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:shadow-blue-500/30 transition-all active:scale-[0.98] text-subtitle mt-6">
                                        Masuk Sekarang
                                    </button>
                                </form>
                                
                                <div className="mt-8 text-center">
                                    <p className="text-[11px] font-bold text-slate-500 uppercase tracking-widest text-micro">by UPT Puskesmas Kampung Dalam</p>
                                </div>
                            </div>
                        </div>
                        {showLoadingOverlay && <LoadingOverlay />} 
                        <Toast notification={notification} />
                    </div>
                );

                if (view === 'admin-dashboard') return <AdminDashboard 
                    currentUser={currentUser} 
                    onLogout={handleLogout} 
                    mockDB={mockDB} 
                    mockUserDB={mockUserDB} 
                    showNotification={showNotification} 
                    exportToCSV={exportToCSV} 
                    loadDataForView={loadDataForView} 
                    ALL_SERVICES={ALL_SERVICES}
                    onViewForm={handleViewForm}
                    onUnfinalizeForm={handleUnfinalizeForm}
                    showAdminDeleteUserModal={showAdminDeleteUserModal}
                    setShowAdminDeleteUserModal={setShowAdminDeleteUserModal}
                    adminUserToDelete={adminUserToDelete}
                    setAdminUserToDelete={setAdminUserToDelete}
                    rejectedList={rejectedList}
                />;

                if (view === 'start') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                        <div className="p-6 pt-8 bg-white pb-6 rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <p className="text-slate-500 text-sm font-semibold uppercase tracking-wider mb-1 text-micro">Selamat datang,</p>
                                    <h1 className="text-2xl font-bold text-slate-800 tracking-tight">{currentUser?.name || 'Pengguna'}</h1>
                                    <div className="flex items-center gap-1 mt-2 text-blue-600 font-medium text-caption">
                                        <Icons.MapPin className="w-3.5 h-3.5"/> 
                                        {currentUser?.unitName}
                                    </div>
                                </div>
                                <button onClick={handleLogout} className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition">
                                    <Icons.LogOut className="w-5 h-5"/>
                                </button>
                            </div>
                            
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                                <p className="text-slate-700 font-medium text-caption">Sistem ini dikembangkan oleh UPT Puskesmas Kampung Dalam</p>
                                <p className="text-slate-900 font-bold text-subtitle">Sistem GHPR (Gigitan Hewan Penular Rabies)</p>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={handleStartNew} className="col-span-2 bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-2xl text-white shadow-lg hover:shadow-xl shadow-blue-500/30 flex items-center justify-between group active:scale-[0.98] transition-all">
                                    <div className="text-left">
                                        <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center mb-3 text-white">
                                            <Icons.FileText className="w-6 h-6"/>
                                        </div>
                                        <h3 className="font-bold text-lg tracking-tight">Buat Laporan Baru</h3>
                                        <p className="text-blue-100 text-body font-medium">Input kasus GHPR baru</p>
                                    </div>
                                    <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                        <Icons.ChevronLeft className="rotate-180 w-5 h-5"/>
                                    </div>
                                </button>

                                <button onClick={handleOpenDrafts} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-orange-50 text-orange-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.List className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Draft Tersimpan</h3>
                                    <p className="text-slate-500 text-caption mt-1">Lanjutkan Editing Formulir</p>
                                    {draftsList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {draftsList.length}
                                        </div>
                                    )}
                                </button>
                                
                                <button onClick={handleOpenPending} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Hourglass className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Pending Form</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir dalam verifikasi</p>
                                    {pendingList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-amber-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {pendingList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenFormFinal} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Archive className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Final</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir yang difinalisasi</p>
                                    {formFinalList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-emerald-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {formFinalList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenOutgoing} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Send className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Keluar</h3>
                                    <p className="text-slate-500 text-caption mt-1">Proses Pengiriman Formulir</p>
                                    {outgoingList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-indigo-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {outgoingList.length}
                                        </div>
                                    )}
                                </button>

                                <button onClick={handleOpenInbox} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative overflow-hidden group">
                                    <div className="w-10 h-10 bg-rose-50 text-rose-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.Inbox className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Inbox</h3>
                                    <p className="text-slate-500 text-caption mt-1">Penerimaan formulir</p>
                                    {hasNewReceived && (
                                        <div className="absolute top-4 right-4">
                                            <div className="w-3 h-3 bg-rose-500 rounded-full animate-ping"></div>
                                            <div className="absolute top-0 right-0 w-3 h-3 bg-rose-500 rounded-full"></div>
                                        </div>
                                    )}
                                    {receivedList.length > 0 && !hasNewReceived && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-rose-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {receivedList.length}
                                        </div>
                                    )}
                                </button>
                                
                                <button onClick={handleOpenRejected} className="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 text-left active:scale-95 transition-all relative">
                                    <div className="w-10 h-10 bg-red-50 text-red-600 rounded-lg flex items-center justify-center mb-3">
                                        <Icons.XOctagon className="w-5 h-5"/>
                                    </div>
                                    <h3 className="font-bold text-slate-800 text-subtitle">Form Ditolak</h3>
                                    <p className="text-slate-500 text-caption mt-1">Formulir yang ditolak</p>
                                    {rejectedList.length > 0 && (
                                        <div className="absolute top-4 right-4 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                                            {rejectedList.length}
                                        </div>
                                    )}
                                </button>
                            </div>
                            
                            <div className="mt-10 text-center">
                                <p className="text-slate-300 text-xs font-bold uppercase tracking-[0.2em] text-micro">Sistem GHPR v1.0</p>
                            </div>
                        </div>
                        
                        {showLoadingOverlay && <LoadingOverlay />} 
                        <Toast notification={notification} />
                    </div>
                );

                if (view === 'form') {
                    const progressPercent = ((step - 1) / (STEP_LABELS.length - 1)) * 100;
                    
                    return (
                        <div className="fixed inset-0 h-[100dvh] w-full flex flex-col bg-slate-50 overflow-hidden" ref={topRef}>
                            <div className="flex-none z-50 px-4 py-4 bg-white/90 backdrop-blur-sm border-b border-slate-100 shadow-sm">
                                <div className="max-w-3xl mx-auto">
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="flex items-center gap-2">
                                            <button onClick={step === 1 ? handleBackToStart : prevStep} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm hover:shadow-md active:scale-90 transition">
                                                {step === 1 ? (
                                                    <Icons.Home className="w-5 h-5" />
                                                ) : (
                                                    <Icons.ChevronLeft className="w-5 h-5" />
                                                )}
                                            </button>
                                            {step > 1 && (
                                                <button onClick={handleBackToStart} className="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 shadow-sm hover:shadow-md active:scale-90 transition" title="Kembali ke Menu Utama">
                                                    <Icons.Home className="w-5 h-5" />
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="flex flex-col items-center">
                                            <span className="text-[11px] font-bold text-blue-600 uppercase tracking-wider mb-0.5 text-micro">
                                                Langkah {step} dari 5
                                            </span>
                                            <h2 className="text-lg font-bold text-slate-800 tracking-tight">
                                                {STEP_LABELS[step-1].label}
                                            </h2>
                                        </div>

                                        {step < 5 ? (
                                            <button onClick={nextStep} className="h-10 px-5 rounded-full bg-slate-900 text-white text-sm font-bold shadow-md hover:shadow-lg active:scale-90 transition flex items-center gap-2">
                                                Lanjut <Icons.ChevronLeft className="rotate-180 w-3.5 h-3.5"/>
                                            </button>
                                        ) : (
                                            <div className="w-20"></div>
                                        )}
                                    </div>
                                    
                                    <div className="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-500 ease-out" style={{ width: `${progressPercent}%` }}></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 pb-32 scroll-smooth">
                                <div className="max-w-3xl mx-auto animate-fadeIn">
                                    <Card className="min-h-[60vh]">
                                        <div className="flex justify-between items-start mb-8">
                                            <div>
                                                <h3 className="font-bold text-2xl text-slate-800 mb-2 tracking-tight">
                                                    {STEP_LABELS[step-1].label}
                                                </h3>
                                                <p className="text-slate-500 text-body font-medium">
                                                    Lengkapi data berikut dengan benar dan teliti.
                                                </p>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                {hasUnsavedChanges && (
                                                    <span className="text-xs text-amber-600 font-bold bg-amber-50 px-2 py-1 rounded">
                                                        Belum Disimpan
                                                    </span>
                                                )}
                                                <button onClick={handleSaveDraft} className="text-blue-600 bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-100 transition flex items-center gap-2 border border-blue-100">
                                                    <Icons.Save className="w-4 h-4"/> Draft
                                                </button>
                                            </div>
                                        </div>

                                        {step === 1 && <Step1 data={formData} onChange={handleChange} onChangeKecamatan={handleKecamatanChange} Icons={Icons} />}
                                        {step === 2 && <Step2 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 3 && <Step3 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 4 && <Step4 data={formData} onChange={handleChange} Icons={Icons} />}
                                        {step === 5 && <Step5 
                                            data={formData} 
                                            onChange={handleChange} 
                                            getGeo={getGeoLocation} 
                                            loadingGeo={loading} 
                                            onSaveToPending={handleSaveToPending}
                                            onSaveAndFinal={handleSaveAndFinal}
                                            Icons={Icons} 
                                        />}
                                    </Card>
                                </div>
                            </div>

                            {showExitModal && <ExitConfirmationModal onSave={() => handleConfirmExit('save')} onDiscard={() => handleConfirmExit('discard')} onCancel={() => setShowExitModal(false)} />} 
                            {showLoadingOverlay && <LoadingOverlay />} 
                            <Toast notification={notification} />
                        </div>
                    );
                }
                
                if (view === 'drafts') return (
                    <ListView 
                        title="Draft Tersimpan" 
                        data={draftsList} 
                        type="draft" 
                        onBack={() => setView('start')} 
                        onAction={handleResumeDraft} 
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        notification={notification} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        currentUser={currentUser}
                        count={draftsList.length}
                    />
                );
                
                if (view === 'pending') return (
                    <PendingListView 
                        title="Pending Form" 
                        data={pendingList} 
                        type="pending" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onEdit={handleEditForm}
                        onFinalize={handleFinalizeFromPending}
                        onShare={handleShareForm}
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        showShareModal={showShareModal} 
                        setShowShareModal={setShowShareModal} 
                        confirmShare={confirmShare} 
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={pendingList.length}
                    />
                );
                
                if (view === 'form-final') return (
                    <FormFinalListView 
                        title="Form Final" 
                        data={formFinalList} 
                        type="form-final" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onExport={handleExportMyData} 
                        Icons={Icons} 
                        notification={notification} 
                        currentUser={currentUser}
                        count={formFinalList.length}
                    />
                );
                
                if (view === 'outgoing') return (
                    <OutgoingListView 
                        title="Formulir Keluar" 
                        data={outgoingList} 
                        type="outgoing" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        Icons={Icons} 
                        notification={notification} 
                        currentUser={currentUser}
                        count={outgoingList.length}
                    />
                );
                
                if (view === 'inbox') return (
                    <InboxListView 
                        title="Inbox" 
                        data={receivedList} 
                        type="inbox" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm} 
                        onAccept={handleAcceptTransfer} 
                        onReject={handleRejectTransfer}
                        onTransfer={handleTransferForm}
                        Icons={Icons} 
                        showReviewModal={showReviewModal} 
                        reviewItem={reviewItem} 
                        setShowReviewModal={setShowReviewModal} 
                        setReviewItem={setReviewItem} 
                        showTransferModal={showTransferModal}
                        setShowTransferModal={setShowTransferModal}
                        confirmTransfer={confirmTransfer}
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={receivedList.length}
                        showRejectModal={showRejectModal}
                        setShowRejectModal={setShowRejectModal}
                        confirmRejectTransfer={confirmRejectTransfer}
                    />
                );

                if (view === 'rejected') return (
                    <RejectedListView 
                        title="Form Ditolak" 
                        data={rejectedList} 
                        type="rejected" 
                        onBack={() => setView('start')} 
                        onView={handleViewForm}
                        onEdit={handleEditForm}
                        onShare={handleShareForm}
                        onDelete={confirmDelete} 
                        Icons={Icons} 
                        showDeleteModal={showDeleteModal} 
                        setShowDeleteModal={setShowDeleteModal} 
                        handleDelete={handleDeleteForm} 
                        showShareModal={showShareModal} 
                        setShowShareModal={setShowShareModal} 
                        confirmShare={confirmShare} 
                        notification={notification} 
                        loading={loading} 
                        ALL_SERVICES={ALL_SERVICES}
                        currentUser={currentUser}
                        count={rejectedList.length}
                    />
                );

                if (view === 'success') return (
                    <div className="fixed inset-0 h-[100dvh] w-full bg-white flex items-center justify-center p-6">
                        <div className="text-center w-full max-w-sm animate-fadeIn">
                            <div className="w-24 h-24 bg-gradient-to-br from-green-50 to-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-green-100">
                                <Icons.CheckCircle className="w-12 h-12 text-green-500" />
                            </div>
                            <h2 className="text-3xl font-black text-slate-800 mb-3 tracking-tight">Berhasil Disimpan!</h2>
                            <p className="text-slate-500 mb-8 font-medium text-body">Data GHPR telah tersimpan dengan aman.</p>
                            
                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-100 mb-8">
                                <p className="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 text-micro">ID Formulir</p>
                                <p className="text-2xl font-mono font-bold text-slate-800 tracking-tight">{formData.id}</p>
                                <p className="text-sm text-slate-500 mt-2">
                                    {formData.namaPenderita || 'Tanpa Nama'}
                                </p>
                            </div>
                            
                            <button onClick={() => setView('start')} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:shadow-slate-900/20 active:scale-95 transition text-subtitle">
                                Kembali ke Menu Utama
                            </button>
                        </div>
                    </div>
                );

                return (
                    <div className="fixed inset-0 bg-slate-900 text-white flex items-center justify-center">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold mb-4">Terjadi Kesalahan</h1>
                            <p>View tidak ditemukan: {view}</p>
                            <button onClick={() => setView('start')} className="mt-4 px-4 py-2 bg-blue-600 rounded-lg">
                                Kembali ke Start
                            </button>
                        </div>
                    </div>
                );
            };

            const StableLoadingOverlay = () => (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center min-w-[200px] min-h-[200px] justify-center">
                        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-slate-700 font-bold">Memproses...</p>
                        <p className="text-slate-500 text-sm mt-2">Harap tunggu sebentar</p>
                    </div>
                </div>
            );

            return (
                <div id="root">
                    {renderCurrentView()}
                    
                    {showViewModal && (
                        <ViewModal 
                            item={itemToView} 
                            onClose={() => {
                                console.log("Closing view modal");
                                setShowViewModal(false);
                                setItemToView(null);
                            }} 
                            Icons={Icons} 
                        />
                    )}
                    
                    {showLogoutModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.LogOut className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Konfirmasi Logout</h3>
                                <p className="text-slate-500 mb-6 text-body">Apakah Anda yakin ingin keluar dari akun ini?</p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowLogoutModal(false)} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmLogout} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    
                    {showFinalizeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.CheckCircle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-green-600">Finalisasi Formulir?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Apakah Anda yakin data ini sudah valid dan ingin difinalisasi?
                                </p>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowFinalizeModal(false);
                                            setItemToFinalize(null);
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmFinalize} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Finalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showUnfinalizeModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-amber-600">Batalkan Finalisasi?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    Formulir akan dikembalikan ke Pending Form current owner.
                                </p>
                                <div className="mb-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                                    <p className="text-sm text-amber-700 font-medium">
                                        Status: <strong>Pending</strong><br/>
                                        Current Owner: <strong>{itemToUnfinalize ? determineCurrentOwner(itemToUnfinalize) : ''}</strong>
                                    </p>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => {
                                            setShowUnfinalizeModal(false);
                                            setItemToUnfinalize(null);
                                        }} 
                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                    >
                                        Batal
                                    </button>
                                    <button 
                                        onClick={confirmUnfinalize} 
                                        className="flex-1 p-3.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-bold hover:shadow-lg transition"
                                    >
                                        Ya, Batalkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showTransferModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmTransfer} onCancel={() => setShowTransferModal(false)} />}
                    
                    {showRejectModal && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Tolak Formulir?</h3>
                                <p className="text-slate-500 mb-6 text-body">Formulir akan dikembalikan ke pengirim dengan status "Ditolak".</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowRejectModal(false)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={confirmRejectTransfer} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Tolak
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showLoadingOverlay && <StableLoadingOverlay />}
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        // BAGIAN 5: KOMPONEN LIST VIEW
        const ListView = ({ title, data, type, onBack, onAction, onDelete, Icons, notification, showDeleteModal, setShowDeleteModal, handleDelete, currentUser, count }) => (
            <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                    <div className="flex items-center justify-between mb-6">
                        <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                            <Icons.ChevronLeft className="w-5 h-5"/>
                        </button>
                        <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-blue-600 text-sm">({count})</span></h2>
                        <div className="w-10"></div>
                    </div>
                </div>
                
                <div className="flex-1 overflow-y-auto p-6 pb-24">
                    {data.length === 0 ? (
                        <div className="text-center text-slate-400 py-20 font-medium italic">
                            Tidak ada data untuk ditampilkan
                        </div>
                    ) : (
                        <div className="grid gap-4">
                            {data.map(item => (
                                <div key={item.id} className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                    <div className="flex justify-between items-start mb-3">
                                        <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                                            {item.noRM || 'DRAFT'}
                                        </div>
                                        <div className="text-xs text-slate-500 font-medium">
                                            {new Date(item.updatedAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    
                                    <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaPenderita || 'Tanpa Nama'}</h3>
                                    <p className="text-sm text-slate-600 font-medium mb-1">
                                        {item.jenisKelamin}  {item.umur || '-'}
                                    </p>
                                    <p className="text-sm text-slate-500 mb-5">
                                        {item.kelurahan || 'Lokasi tidak diketahui'}
                                    </p>
                                    
                                    <div className="flex gap-2 border-t border-slate-100 pt-4">
                                        <button onClick={() => onAction(item)} className="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition">
                                            Edit Draft
                                        </button>
                                        {currentUser?.role === 'admin' && (
                                            <button onClick={() => onDelete(item)} className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100">
                                                <Icons.Trash className="w-4.5 h-4.5"/>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                
                {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                <Toast notification={notification} />
            </div>
        );

        const PendingListView = ({ title, data, type, onBack, onView, onEdit, onFinalize, onShare, onDelete, Icons, showDeleteModal, setShowDeleteModal, handleDelete, showShareModal, setShowShareModal, confirmShare, notification, loading, ALL_SERVICES, currentUser, count }) => {
            const getStatusBadge = (status, isFromOtherUnit = false) => {
                const statusColors = {
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Draft': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200'
                };
                
                const color = statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                const fromOtherBadge = isFromOtherUnit ? 'bg-purple-100 text-purple-800 ml-1 border border-purple-200' : '';
                
                return (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`status-badge ${color}`}>
                            {status}
                        </span>
                        {isFromOtherUnit && (
                            <span className={`status-badge ${fromOtherBadge}`}>
                                Eksternal
                            </span>
                        )}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-amber-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                    const currentOwner = determineCurrentOwner(item);
                                    const isCurrentOwner = currentOwner === currentUser.unitName;
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.noRM || 'NO-RM'}
                                                    </div>
                                                    {getStatusBadge(item.statusData, isFromOtherUnit)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaPenderita || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.umur || '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                {isFromOtherUnit && (
                                                    <span className="block text-xs text-purple-600 mt-1 font-semibold">
                                                        Dari: {item.createdUnit}
                                                    </span>
                                                )}
                                                <span className="block text-xs text-green-600 mt-1">
                                                    Current Owner: {currentOwner}
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onEdit(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 border border-blue-100 hover:border-blue-200 hover:bg-blue-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Edit className="w-4 h-4"/> Edit
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onFinalize(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-green-50 to-emerald-50 text-green-600 border border-green-100 hover:border-green-200 hover:bg-green-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Check className="w-4 h-4"/> Finalisasi
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onShare(item) : null} 
                                                    disabled={!isCurrentOwner || isFromOtherUnit}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        (isCurrentOwner && !isFromOtherUnit)
                                                            ? 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-600 border border-purple-100 hover:border-purple-200 hover:bg-purple-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Share className="w-4 h-4"/> Bagikan
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onDelete(item)} 
                                                    className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100"
                                                >
                                                    <Icons.Trash className="w-4.5 h-4.5"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                    {showShareModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmShare} onCancel={() => setShowShareModal(false)} />}
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const FormFinalListView = ({ title, data, type, onBack, onView, onExport, Icons, notification, currentUser, count }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            const filteredData = data.filter(item => 
                item.namaPenderita?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.noRM?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.kelurahan?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.createdUnit?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredData.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            const nextPage = () => {
                if (currentPage < totalPages) setCurrentPage(currentPage + 1);
            };

            const prevPage = () => {
                if (currentPage > 1) setCurrentPage(currentPage - 1);
            };

            const getStatusBadge = (status) => {
                return (
                    <span className={`status-badge bg-green-100 text-green-800 border border-green-200`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-green-600 text-sm">({count})</span></h2>
                            <button onClick={onExport} className="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100">
                                <Icons.Download className="w-5 h-5"/>
                            </button>
                        </div>
                        
                        <div className="mt-4">
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="Cari di Form Final..."
                                    className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={searchTerm}
                                    onChange={(e) => {
                                        setSearchTerm(e.target.value);
                                        setCurrentPage(1);
                                    }}
                                />
                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" />
                            </div>
                            <p className="text-xs text-slate-500 mt-2">
                                Menampilkan {Math.min(filteredData.length, itemsPerPage)} data per halaman
                            </p>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {filteredData.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                {searchTerm ? 'Tidak ada data yang sesuai dengan pencarian' : 'Tidak ada data untuk ditampilkan'}
                            </div>
                        ) : (
                            <>
                                <div className="grid gap-4">
                                    {currentItems.map(item => {
                                        const currentOwner = determineCurrentOwner(item);
                                        const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                        
                                        return (
                                            <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex items-center gap-2 flex-nowrap">
                                                        <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                            {item.noRM || 'NO-RM'}
                                                        </div>
                                                        {getStatusBadge(item.statusData)}
                                                        {isFromOtherUnit && (
                                                            <span className="status-badge bg-purple-100 text-purple-800 border border-purple-200">
                                                                Rujukan
                                                            </span>
                                                        )}
                                                    
                                                    </div>
                                                </div>
                                                
                                                <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaPenderita || 'Tanpa Nama'}</h3>
                                                <p className="text-sm text-slate-600 font-medium mb-1">
                                                    {item.jenisKelamin}  {item.umur || '-'}
                                                </p>
                                                <p className="text-sm text-slate-500 mb-5">
                                                    {item.kelurahan || 'Lokasi tidak diketahui'}
                                                    {isFromOtherUnit && (
                                                        <span className="block text-xs text-purple-600 mt-1">
                                                            Asal: {item.createdUnit}
                                                        </span>
                                                    )}
                                                    <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                        Current Owner: {currentOwner}
                                                    </span>
                                                </p>
                                                
                                                <div className="flex gap-2 border-t border-slate-100 pt-4">
                                                    <button 
                                                        onClick={() => onView(item)} 
                                                        className="w-full py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                    >
                                                        <Icons.Eye className="w-4 h-4"/> Lihat Detail
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {filteredData.length > itemsPerPage && (
                                    <div className="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                        <p className="text-sm text-slate-600">
                                            Menampilkan {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, filteredData.length)} dari {filteredData.length} data
                                        </p>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={prevPage}
                                                disabled={currentPage === 1}
                                                className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                            >
                                                Sebelumnya
                                            </button>
                                            <span className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium">
                                                Halaman {currentPage} dari {totalPages}
                                            </span>
                                            <button
                                                onClick={nextPage}
                                                disabled={currentPage === totalPages}
                                                className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                            >
                                                Selanjutnya
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        const OutgoingListView = ({ title, data, type, onBack, onView, Icons, notification, currentUser, count }) => {
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Diterima': 'bg-emerald-100 text-emerald-800 border border-emerald-200',
                    'Transferred': 'bg-purple-100 text-purple-800 border border-purple-200'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-indigo-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const currentOwner = determineCurrentOwner(item);
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.noRM || 'NO-RM'}
                                                    </div>
                                                    {getStatusBadge(item.statusData)}
                                                </div>
                                               
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaPenderita || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.umur || '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-indigo-600 mt-1">
                                                    Dikirim ke: {item.sharedTo}
                                                </span>
                                                {item.statusData === 'Ditolak' && (
                                                    <span className="block text-xs text-red-600 mt-1">
                                                        Status: Ditolak oleh penerima
                                                    </span>
                                                )}
                                                {item.statusData === 'Diterima' && (
                                                    <span className="block text-xs text-green-600 mt-1">
                                                        Status: Diterima oleh penerima (masuk Pending Form)
                                                    </span>
                                                )}
                                            </p>
                                            
                                            <div className="flex gap-2 border-t border-slate-100 pt-4">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat Detail
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    <Toast notification={notification} />
                </div>
            );
        };

        const InboxListView = ({ title, data, type, onBack, onView, onAccept, onReject, onTransfer, Icons, showReviewModal, reviewItem, setShowReviewModal, setReviewItem, showTransferModal, setShowTransferModal, confirmTransfer, notification, loading, ALL_SERVICES, currentUser, count, showRejectModal, setShowRejectModal, confirmRejectTransfer }) => {
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200'}`}>
                        {status}
                    </span>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-rose-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const currentOwner = determineCurrentOwner(item);
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.noRM || 'NO-RM'}
                                                    </div>
                                                    {getStatusBadge(item.statusData)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaPenderita || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.umur || '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                <span className="block text-xs text-green-600 mt-1 font-semibold">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-indigo-600 mt-1">
                                                    Dari: {item.createdUnit}
                                                </span>
                                                <span className="block text-xs text-blue-600 mt-1">
                                                    Status: Menunggu tindakan Anda
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => { 
                                                        console.log("Accepting item:", item);
                                                        setReviewItem(item); 
                                                        setShowReviewModal(true); 
                                                    }} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-green-50 text-green-600 rounded-lg text-sm font-bold border border-green-100 hover:border-green-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Check className="w-4 h-4"/> Terima
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onReject(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-red-50 text-red-600 rounded-lg text-sm font-bold border border-red-100 hover:border-red-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.XCircle className="w-4 h-4"/> Tolak
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onTransfer(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold border border-indigo-100 hover:border-indigo-200 flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Send className="w-4 h-4"/> Teruskan
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showReviewModal && reviewItem && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.CheckCircle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-slate-800">Yakin Terima Formulir?</h3>
                                <p className="text-slate-500 mb-4 text-body">
                                    <strong>{reviewItem.namaPenderita || 'Formulir'}</strong>
                                </p>
                                <p className="text-slate-500 mb-6 text-sm">
                                    Formulir akan masuk ke <strong>Pending Form</strong> untuk verifikasi.
                                </p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowReviewModal(false)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={() => onAccept(reviewItem)} className="flex-1 p-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Terima
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    
                    
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const RejectedListView = ({ title, data, type, onBack, onView, onEdit, onShare, onDelete, Icons, showDeleteModal, setShowDeleteModal, handleDelete, showShareModal, setShowShareModal, confirmShare, notification, loading, ALL_SERVICES, currentUser, count }) => {
            const getStatusBadge = (status, isFromOtherUnit = false) => {
                const statusColors = {
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200'
                };
                
                const color = statusColors[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                const fromOtherBadge = isFromOtherUnit ? 'bg-purple-100 text-purple-800 ml-1 border border-purple-200' : '';
                
                return (
                    <div className="flex flex-wrap gap-1 mt-1">
                        <span className={`status-badge ${color}`}>
                            {status}
                        </span>
                        {isFromOtherUnit && (
                            <span className={`status-badge ${fromOtherBadge}`}>
                                Eksternal
                            </span>
                        )}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full bg-slate-50 flex flex-col">
                    <div className="flex-none p-6 pt-8 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 z-10">
                        <div className="flex items-center justify-between mb-6">
                            <button onClick={onBack} className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 active:scale-90 transition hover:bg-slate-200">
                                <Icons.ChevronLeft className="w-5 h-5"/>
                            </button>
                            <h2 className="text-xl font-bold text-slate-800 tracking-tight">{title} <span className="text-red-600 text-sm">({count})</span></h2>
                            <div className="w-10"></div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24">
                        {data.length === 0 ? (
                            <div className="text-center text-slate-400 py-20 font-medium italic">
                                Tidak ada data untuk ditampilkan
                            </div>
                        ) : (
                            <div className="grid gap-4">
                                {data.map(item => {
                                    const isFromOtherUnit = item.createdUnit !== currentUser.unitName;
                                    const currentOwner = determineCurrentOwner(item);
                                    const isCurrentOwner = currentOwner === currentUser.unitName;
                                    
                                    return (
                                        <div key={item.id} className="bg-white p-4 md:p-5 rounded-xl shadow-sm border border-slate-100 hover:border-slate-200 transition-all group">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-2 flex-nowrap">
                                                    <div className="bg-blue-50 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wider shrink-0">
                                                        {item.noRM || 'NO-RM'}
                                                    </div>
                                                    {getStatusBadge(item.statusData, isFromOtherUnit)}
                                                </div>
                                                <div className="text-xs text-slate-500 font-medium">
                                                    {new Date(item.updatedAt).toLocaleDateString()}
                                                </div>
                                            </div>
                                            
                                            <h3 className="font-bold text-lg text-slate-800 mb-1">{item.namaPenderita || 'Tanpa Nama'}</h3>
                                            <p className="text-sm text-slate-600 font-medium mb-1">
                                                {item.jenisKelamin}  {item.umur || '-'}
                                            </p>
                                            <p className="text-sm text-slate-500 mb-5">
                                                {item.kelurahan || 'Lokasi tidak diketahui'}
                                                {isFromOtherUnit && (
                                                    <span className="block text-xs text-purple-600 mt-1 font-semibold">
                                                        Dari: {item.createdUnit}
                                                    </span>
                                                )}
                                                <span className="block text-xs text-green-600 mt-1">
                                                    Current Owner: {currentOwner}
                                                </span>
                                                <span className="block text-xs text-red-600 mt-1 font-semibold">
                                                    Ditolak oleh: {item.sharedTo || 'Unit Lain'}
                                                </span>
                                            </p>
                                            
                                            <div className="flex flex-wrap gap-2 border-t border-slate-100 pt-4 mobile-button-group">
                                                <button 
                                                    onClick={() => onView(item)} 
                                                    className="flex-1 min-w-[120px] py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:shadow-md transition flex items-center justify-center gap-2"
                                                >
                                                    <Icons.Eye className="w-4 h-4"/> Lihat
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onEdit(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-600 border border-blue-100 hover:border-blue-200 hover:bg-blue-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Edit className="w-4 h-4"/> Edit
                                                </button>
                                                
                                                <button 
                                                    onClick={() => isCurrentOwner ? onShare(item) : null} 
                                                    disabled={!isCurrentOwner}
                                                    className={`flex-1 min-w-[120px] py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 ${
                                                        isCurrentOwner 
                                                            ? 'bg-gradient-to-r from-purple-50 to-indigo-50 text-purple-600 border border-purple-100 hover:border-purple-200 hover:bg-purple-100' 
                                                            : 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                                    }`}
                                                >
                                                    <Icons.Share className="w-4 h-4"/> Bagikan Ulang
                                                </button>
                                                
                                                <button 
                                                    onClick={() => onDelete(item)} 
                                                    className="w-12 flex items-center justify-center bg-red-50 text-red-500 rounded-lg hover:bg-red-100"
                                                >
                                                    <Icons.Trash className="w-4.5 h-4.5"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {showDeleteModal && <DeleteConfirmationModal onConfirm={handleDelete} onCancel={() => setShowDeleteModal(false)} />}
                    {showShareModal && <SharePuskesmasModalWithSearch servicesList={ALL_SERVICES} currentUnit={currentUser?.unitName} onConfirm={confirmShare} onCancel={() => setShowShareModal(false)} />}
                    {loading && <LoadingOverlay />} 
                    <Toast notification={notification} />
                </div>
            );
        };

        const SharePuskesmasModalWithSearch = ({ servicesList, currentUnit, onConfirm, onCancel, title = "Kirim ke Unit Lain", description = "Pilih unit layanan yang akan menerima formulir ini." }) => {
            const [search, setSearch] = useState('');
            const [selected, setSelected] = useState('');
            
            const filteredServices = servicesList.filter(s => 
                s.toLowerCase().includes(search.toLowerCase()) && 
                s !== currentUnit
            );
            
            const handleSelect = (service) => {
                setSelected(service);
            };
            
            const handleConfirm = () => {
                if (selected) {
                    onConfirm(selected);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="font-bold text-xl text-slate-800">{title}</h3>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600">
                                <Icons.XCircle className="w-6 h-6" />
                            </button>
                        </div>
                        
                        <p className="text-slate-500 mb-6 text-body">{description}</p>
                        
                        <div className="relative mb-6">
                            <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400">
                                <Icons.Search className="w-5 h-5" />
                            </div>
                            <input
                                type="text"
                                className="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                placeholder="Cari unit layanan (Puskesmas/Rumah Sakit)..."
                                value={search}
                                onChange={(e) => setSearch(e.target.value)}
                            />
                        </div>
                        
                        <div className="max-h-60 overflow-y-auto mb-6 border border-slate-200 rounded-lg">
                            {filteredServices.length === 0 ? (
                                <p className="text-center p-4 text-slate-400">Tidak ada unit layanan ditemukan</p>
                            ) : (
                                filteredServices.map(service => (
                                    <div
                                        key={service}
                                        className={`p-4 border-b border-slate-100 last:border-b-0 cursor-pointer hover:bg-slate-50 ${selected === service ? 'bg-blue-50 border-blue-200' : ''}`}
                                        onClick={() => handleSelect(service)}
                                    >
                                        <div className="flex items-center">
                                            <div className={`w-5 h-5 rounded-full border mr-3 flex items-center justify-center ${selected === service ? 'bg-blue-500 border-blue-500' : 'border-slate-300'}`}>
                                                {selected === service && <Icons.Check className="w-3 h-3 text-white" />}
                                            </div>
                                            <div>
                                                <span className="font-medium text-slate-800">{service}</span>
                                                <div className="text-xs text-slate-500 mt-1">
                                                    {service.startsWith('Puskesmas') ? 'Puskesmas' : 'Rumah Sakit'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                Batal
                            </button>
                            <button 
                                onClick={handleConfirm} 
                                className="flex-1 p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={!selected}
                            >
                                Konfirmasi
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ExitConfirmationModal = ({ onSave, onDiscard, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icons.AlertTriangle className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-xl mb-2 text-slate-800">Simpan Perubahan?</h3>
                    <p className="text-slate-500 mb-6 text-body">Ada perubahan yang belum disimpan. Apa yang ingin Anda lakukan?</p>
                    <div className="flex flex-col gap-3">
                        <button onClick={onSave} className="w-full p-3.5 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Simpan sebagai Draft
                        </button>
                        <button onClick={onDiscard} className="w-full p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Buang Perubahan
                        </button>
                        <button onClick={onCancel} className="w-full p-3.5 border border-slate-200 text-slate-500 rounded-lg font-bold hover:bg-slate-50 transition">
                            Kembali ke Form
                        </button>
                    </div>
                </div>
            </div>
        );

        const DeleteConfirmationModal = ({ onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                    <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Icons.AlertTriangle className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-xl mb-2 text-red-600">Hapus Formulir?</h3>
                    <p className="text-slate-500 mb-6 text-body">Formulir akan dihapus secara permanen dan tidak dapat dikembalikan.</p>
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                            Batal
                        </button>
                        <button onClick={onConfirm} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            </div>
        );

        // MODAL VIEW FORMULIR GHPR
        const ViewModal = ({ item, onClose, Icons }) => {
            if (!item) {
                console.log("ViewModal: No item provided");
                return null;
            }
            
            console.log("ViewModal rendering with item:", item);
            
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                try {
                    if (typeof dateString === 'number') {
                        return new Date(dateString).toLocaleDateString('id-ID');
                    }
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;
                    return date.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    console.log("Date formatting error:", e);
                    return dateString;
                }
            };
            
            const formatDateTime = (timestamp) => {
                if (!timestamp) return '-';
                try {
                    const date = new Date(timestamp);
                    if (isNaN(date.getTime())) return timestamp;
                    return date.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return timestamp;
                }
            };
            
            const getStatusBadge = (status) => {
                const statusColors = {
                    'Draft': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                    'Pending': 'bg-amber-100 text-amber-800 border border-amber-200',
                    'Final': 'bg-green-100 text-green-800 border border-green-200',
                    'Proses': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'Ditolak': 'bg-red-100 text-red-800 border border-red-200',
                    'Diterima': 'bg-emerald-100 text-emerald-800 border border-emerald-200',
                    'Transferred': 'bg-purple-100 text-purple-800 border border-purple-200',
                    'Baru': 'bg-gray-100 text-gray-800 border border-gray-200'
                };
                
                return (
                    <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${statusColors[status] || 'bg-gray-100 text-gray-800'}`}>
                        {status || 'Unknown'}
                    </span>
                );
            };
            
            const currentOwner = typeof determineCurrentOwner !== 'undefined' ? determineCurrentOwner(item) : (item.currentOwner || '-');
            const isFromOtherUnit = item.createdUnit !== currentOwner;
            
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="relative bg-white rounded-2xl w-full sm:w-[95%] md:w-[80%] lg:w-[70%] max-w-4xl shadow-2xl border border-slate-200 flex flex-col max-h-[80vh] overflow-hidden">
                        
                        {/* HEADER */}
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 border-b border-slate-200 flex-none">
                            <div className="flex justify-between items-start">
                                <div className="flex-1">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="bg-white p-2 rounded-lg shadow-sm">
                                            <Icons.FileText className="w-6 h-6 text-blue-600" />        
                                        </div>        
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800">Ringkasan Data</h2>
                                            <div className="flex items-center gap-3 mt-1 flex-nowrap">
                                                <span className="font-mono font-bold bg-gradient-to-r from-blue-500 to-indigo-500 text-white bg-black px-3 py-1 rounded shrink-0">
                                                    {item.noRM ||'NO-RM'}
                                                </span>
                                                {getStatusBadge(item.statusData)}
                                                {isFromOtherUnit && (
                                                    <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-800 border border-purple-200">
                                                        Eksternal
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex flex-wrap gap-4 mt-3 text-sm text-slate-600">
                                        <div className="flex items-center gap-1">
                                            <Icons.Shield className="w-4 h-4" />
                                            <span>Owner: <strong>{currentOwner}</strong></span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <Icons.Clock className="w-4 h-4" />
                                            <span>Update: <strong>{formatDateTime(item.updatedAt)}</strong></span>
                                        </div>
                                    </div>
                                </div>
                                <button 
                                    onClick={onClose}
                                    className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors z-10"
                                >
                                    <Icons.XCircle className="w-8 h-8" />
                                </button>
                            </div>
                        </div>
                        
                        {/* KONTEN ISI */}
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                    <Icons.User className="w-5 h-5 text-blue-500" />
                                    Data Pasien GHPR
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">No. RM</p>
                                        <p className="font-bold text-slate-800">{item.noRM || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Nama Penderita</p>
                                        <p className="font-bold text-slate-800 text-lg">{item.namaPenderita || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Umur</p>
                                        <p className="font-medium text-slate-800">{item.umur || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Jenis Kelamin</p>
                                        <p className="font-medium text-slate-800">{item.jenisKelamin || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Pekerjaan</p>
                                        <p className="font-medium text-slate-800">{item.pekerjaan || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg md:col-span-2">
                                        <p className="text-sm text-slate-500 mb-1">Alamat</p>
                                        <p className="font-medium text-slate-800">{item.alamat || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Kecamatan</p>
                                        <p className="font-medium text-slate-800">{item.kecamatan || '-'}</p>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg">
                                        <p className="text-sm text-slate-500 mb-1">Kelurahan</p>
                                        <p className="font-medium text-slate-800">{item.kelurahan || '-'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                    <Icons.Activity className="w-5 h-5 text-red-500" />
                                    Data Kasus GHPR
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Tanggal Laporan</p>
                                        <p className="font-medium text-red-800">{formatDate(item.tanggalLaporan)}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Tanggal Kejadian</p>
                                        <p className="font-medium text-red-800">{formatDate(item.tanggalKejadian)}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Tanggal Berobat</p>
                                        <p className="font-medium text-red-800">{formatDate(item.tanggalBerobat)}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Tempat Berobat</p>
                                        <p className="font-medium text-red-800">{item.tempatBerobat || '-'}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Cuci Luka</p>
                                        <p className="font-medium text-red-800">{item.cuciLuka || '-'}</p>
                                    </div>
                                    {item.cuciLuka === 'Ya' && (
                                        <div className="bg-red-50 p-4 rounded-lg">
                                            <p className="text-sm text-red-600 mb-1">Tanggal Cuci Luka</p>
                                            <p className="font-medium text-red-800">{formatDate(item.tanggalCuciLuka)}</p>
                                        </div>
                                    )}
                                    {item.cuciLuka === 'Tidak' && (
                                        <div className="bg-red-50 p-4 rounded-lg md:col-span-2">
                                            <p className="text-sm text-red-600 mb-1">Alasan Tidak Cuci Luka</p>
                                            <p className="font-medium text-red-800">{item.alasanTidakCuciLuka || '-'}</p>
                                        </div>
                                    )}
                                    <div className="bg-red-50 p-4 rounded-lg md:col-span-2">
                                        <p className="text-sm text-red-600 mb-1">Lokasi Gigitan</p>
                                        <div className="flex flex-wrap gap-2">
                                            {Array.isArray(item.lokasiGigitan) 
                                                ? item.lokasiGigitan.map((lokasi, idx) => (
                                                    <span key={idx} className="bg-white px-3 py-1 rounded-full text-sm font-medium text-red-800 border border-red-200">
                                                        {lokasi}
                                                    </span>
                                                ))
                                                : <p className="font-medium text-red-800">{item.lokasiGigitan || '-'}</p>
                                            }
                                        </div>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Jenis Luka Gigitan</p>
                                        <p className="font-medium text-red-800">{item.jenisLukaGigitan || '-'}</p>
                                    </div>
                                    <div className="bg-red-50 p-4 rounded-lg">
                                        <p className="text-sm text-red-600 mb-1">Kondisi Penderita</p>
                                        <p className="font-medium text-red-800">{item.kondisiPenderita || '-'}</p>
                                    </div>
                                    {item.kondisiPenderita === 'Meninggal' && (
                                        <>
                                            <div className="bg-red-50 p-4 rounded-lg">
                                                <p className="text-sm text-red-600 mb-1">Tanggal Meninggal</p>
                                                <p className="font-medium text-red-800">{formatDate(item.tanggalMeninggal)}</p>
                                            </div>
                                            <div className="bg-red-50 p-4 rounded-lg">
                                                <p className="text-sm text-red-600 mb-1">Diagnosa Meninggal</p>
                                                <p className="font-medium text-red-800">{item.diagnosaMeninggal || '-'}</p>
                                            </div>
                                            <div className="bg-red-50 p-4 rounded-lg md:col-span-2">
                                                <p className="text-sm text-red-600 mb-1">Gejala Sebelum Meninggal</p>
                                                <p className="font-medium text-red-800">{item.gejalaSebelumMeninggal || '-'}</p>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                    <Icons.Shield className="w-5 h-5 text-orange-500" />
                                    Data HPR
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-orange-50 p-4 rounded-lg">
                                        <p className="text-sm text-orange-600 mb-1">Jenis HPR</p>
                                        <p className="font-medium text-orange-800">{item.jenisHPR || '-'}</p>
                                    </div>
                                    <div className="bg-orange-50 p-4 rounded-lg">
                                        <p className="text-sm text-orange-600 mb-1">Alasan HPR Menggigit</p>
                                        <p className="font-medium text-orange-800">{item.alasanHPRMenggigit || '-'}</p>
                                    </div>
                                    <div className="bg-orange-50 p-4 rounded-lg md:col-span-2">
                                        <p className="text-sm text-orange-600 mb-1">Kronologi Singkat</p>
                                        <p className="font-medium text-orange-800">{item.kronologiSingkat || '-'}</p>
                                    </div>
                                    <div className="bg-orange-50 p-4 rounded-lg">
                                        <p className="text-sm text-orange-600 mb-1">Kondisi HPR</p>
                                        <p className="font-medium text-orange-800">{item.kondisiHPR || '-'}</p>
                                    </div>
                                    {item.kondisiHPR === 'Mati Sendiri' && (
                                        <div className="bg-orange-50 p-4 rounded-lg">
                                            <p className="text-sm text-orange-600 mb-1">Tanggal HPR Mati</p>
                                            <p className="font-medium text-orange-800">{formatDate(item.tanggalHPRMati)}</p>
                                        </div>
                                    )}
                                    {item.kondisiHPR === 'Dibunuh' && (
                                        <div className="bg-orange-50 p-4 rounded-lg">
                                            <p className="text-sm text-orange-600 mb-1">Tanggal HPR Dibunuh</p>
                                            <p className="font-medium text-orange-800">{formatDate(item.tanggalHPRDibunuh)}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {item.diberikanVAR && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                        <Icons.Syringe className="w-5 h-5 text-green-500" />
                                        Data Pemberian VAR
                                    </h3>
                                    <div className="bg-green-50 p-4 rounded-lg mb-4">
                                        <p className="text-sm text-green-600 mb-1">Diberikan VAR?</p>
                                        <p className="font-medium text-green-800">{item.diberikanVAR || '-'}</p>
                                    </div>
                                    
                                    {item.diberikanVAR === 'YA' && item.riwayatVAR && item.riwayatVAR.length > 0 && (
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-slate-700">Riwayat VAR</h4>
                                            {item.riwayatVAR.map((varRecord, index) => (
                                                <div key={varRecord.id || index} className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 p-4 rounded-xl">
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <div className="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                                                            <Icons.Syringe className="w-3 h-3" />
                                                        </div>
                                                        <h5 className="font-bold text-slate-800">VAR {index + 1}</h5>
                                                    </div>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                        <div>
                                                            <p className="text-xs text-green-600 mb-1">Layanan</p>
                                                            <p className="font-medium text-slate-700">{varRecord.layanan === 'pilihan' ? 'Pilihan Layanan' : 'Luar Kota Pontianak'}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-green-600 mb-1">Nama Layanan</p>
                                                            <p className="font-medium text-slate-700">{varRecord.layananLuarKota || '-'}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-green-600 mb-1">Tanggal VAR</p>
                                                            <p className="font-medium text-slate-700">{formatDate(varRecord.tanggalVAR)}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-green-600 mb-1">Nama Petugas</p>
                                                            <p className="font-medium text-slate-700">{varRecord.namaPetugas || '-'}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-green-600 mb-1">Nama VAR</p>
                                                            <p className="font-medium text-slate-700">{varRecord.namaVAR || '-'}</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs text-green-600 mb-1">No. Batch</p>
                                                            <p className="font-medium text-slate-700">{varRecord.noBatch || '-'}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {item.petugasPengumpulData && item.petugasPengumpulData.length > 0 && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                        <Icons.Users className="w-5 h-5 text-purple-500" />
                                        Petugas Pengumpul Data (Kontak Erat)
                                    </h3>
                                    <div className="space-y-4">
                                        {item.petugasPengumpulData.map((petugas, index) => (
                                            <div key={petugas.id || index} className="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 p-4 rounded-xl">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <div className="w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center">
                                                        <Icons.User className="w-3 h-3" />
                                                    </div>
                                                    <h5 className="font-bold text-slate-800">Petugas {index + 1}</h5>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    <div>
                                                        <p className="text-xs text-purple-600 mb-1">Nama Petugas</p>
                                                        <p className="font-medium text-slate-700">{petugas.nama || '-'}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-purple-600 mb-1">NIP</p>
                                                        <p className="font-medium text-slate-700">{petugas.nip || '-'}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-purple-600 mb-1">Jabatan</p>
                                                        <p className="font-medium text-slate-700">{petugas.jabatan || '-'}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-purple-600 mb-1">Tanggal Kunjungan</p>
                                                        <p className="font-medium text-slate-700">{formatDate(petugas.tanggalKunjungan)}</p>
                                                    </div>
                                                    <div className="md:col-span-2">
                                                        <p className="text-xs text-purple-600 mb-1">Unit Kerja</p>
                                                        <p className="font-medium text-slate-700">{petugas.unitKerja || '-'}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {item.transferHistory && item.transferHistory.length > 0 && (
                                <div className="mb-8">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200 flex items-center gap-2">
                                        <Icons.Share className="w-5 h-5 text-indigo-500" />
                                        Riwayat Transfer
                                    </h3>
                                    <div className="space-y-3">
                                        {item.transferHistory.map((record, idx) => (
                                            <div key={idx} className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${
                                                            record.action === 'dikirim' ? 'bg-blue-100 text-blue-800' :
                                                            record.action === 'diterima' ? 'bg-green-100 text-green-800' :
                                                            record.action === 'ditolak' ? 'bg-red-100 text-red-800' :
                                                            record.action === 'diteruskan' ? 'bg-purple-100 text-purple-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {record.action || 'transfer'}
                                                        </span>
                                                        <p className="text-sm text-slate-700 mt-2">
                                                            Dari: <span className="font-bold">{record.from}</span> 
                                                            <Icons.ChevronLeft className="inline w-4 h-4 mx-2 rotate-180" />
                                                            Ke: <span className="font-bold">{record.to}</span>
                                                        </p>
                                                        {record.newOwner && (
                                                            <p className="text-sm text-green-700 mt-1">
                                                                <span className="font-bold">Ownership berpindah ke:</span> {record.newOwner}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <span className="text-sm text-slate-500">
                                                        {new Date(record.date).toLocaleDateString('id-ID')}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                    </div>
                </div>
            );
        };

        // BAGIAN 6: ADMIN DASHBOARD
        const AdminDashboard = ({ currentUser, onLogout, mockDB, mockUserDB, showNotification, exportToCSV, loadDataForView, ALL_SERVICES, onViewForm, onUnfinalizeForm, showAdminDeleteUserModal, setShowAdminDeleteUserModal, adminUserToDelete, setAdminUserToDelete, rejectedList }) => {
            const [activeTab, setActiveTab] = useState('forms');
            const [allForms, setAllForms] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [newUser, setNewUser] = useState({ 
                name: '', 
                username: '', 
                password: '', 
                role: 'user', 
                unitName: '' 
            });
            const [deleteFormId, setDeleteFormId] = useState(null);
            const [editingUser, setEditingUser] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [userSearchTerm, setUserSearchTerm] = useState('');
            
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage] = useState(10);

            const getStatusBadge = (status) => {
                const statusColors = {
                    'Draft': 'bg-yellow-100 text-yellow-800',
                    'Pending': 'bg-amber-100 text-amber-800',
                    'Final': 'bg-green-100 text-green-800',
                    'Proses': 'bg-blue-100 text-blue-800',
                    'Ditolak': 'bg-red-100 text-red-800',
                    'Diterima': 'bg-emerald-100 text-emerald-800',
                    'Transferred': 'bg-purple-100 text-purple-800',
                    'Baru': 'bg-gray-100 text-gray-800'
                };
                
                return (
                    <span className={`status-badge ${statusColors[status] || 'bg-gray-100 text-gray-800'}`}>
                        {status}
                    </span>
                );
            };

            const loadAllData = async () => {
                try {
                    const forms = await mockDB.getAllForms();
                    const formsWithOwner = forms.map(form => ({
                        ...form,
                        currentOwner: determineCurrentOwner(form)
                    }));
                    setAllForms(formsWithOwner);
                    
                    const users = await mockUserDB.getUsers();
                    setAllUsers(users);
                } catch (e) {
                    console.error("Error loading admin data:", e);
                    showNotification('Error memuat data', 'error');
                }
            };

            useEffect(() => { 
                loadAllData();
            }, [activeTab]);

            const filteredForms = searchTerm ? allForms.filter(form => 
                form.namaPenderita?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.noRM?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.currentOwner?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.statusData?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                form.createdUnit?.toLowerCase().includes(searchTerm.toLowerCase())
            ) : allForms;

            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentForms = filteredForms.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(filteredForms.length / itemsPerPage);

            const nextPage = () => {
                if (currentPage < totalPages) setCurrentPage(currentPage + 1);
            };

            const prevPage = () => {
                if (currentPage > 1) setCurrentPage(currentPage - 1);
            };

            const filteredUsers = userSearchTerm ? allUsers.filter(user => 
                user.name?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.username?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.unitName?.toLowerCase().includes(userSearchTerm.toLowerCase()) ||
                user.role?.toLowerCase().includes(userSearchTerm.toLowerCase())
            ) : allUsers;

            const handleAddUser = async (e) => { 
                e.preventDefault(); 
                
                if (!newUser.name || !newUser.username || !newUser.password || !newUser.unitName) {
                    showNotification('Semua field wajib diisi', 'error');
                    return;
                }
                
                const existingUser = allUsers.find(u => u.username === newUser.username);
                if (existingUser) {
                    showNotification('Username sudah digunakan', 'error');
                    return;
                }
                
                if(await mockUserDB.addUser(newUser)) { 
                    showNotification('User berhasil ditambahkan', 'success'); 
                    setNewUser({ name: '', username: '', password: '', role: 'user', unitName: '' }); 
                    setAllUsers(await mockUserDB.getUsers()); 
                } else {
                    showNotification('Gagal menambahkan user', 'error'); 
                }
            };
            
            const handleUpdateUser = async (e) => {
                e.preventDefault();
                if (!editingUser) return;
                
                if (!editingUser.name || !editingUser.username || !editingUser.password || !editingUser.unitName) {
                    showNotification('Semua field wajib diisi', 'error');
                    return;
                }
                
                try {
                    if (dbStore) {
                        await dbStore.collection('users').doc(editingUser.id).update({
                            name: editingUser.name,
                            username: editingUser.username,
                            password: editingUser.password,
                            role: editingUser.role,
                            unitName: editingUser.unitName
                        });
                        showNotification('User berhasil diperbarui', 'success');
                        setEditingUser(null);
                        setAllUsers(await mockUserDB.getUsers());
                    } else {
                        showNotification('Database tidak tersedia', 'error');
                    }
                } catch (e) {
                    console.error("Error updating user:", e);
                    showNotification('Error memperbarui user: ' + e.message, 'error');
                }
            };
            
            const handleDeleteUser = async (id) => { 
                if(window.confirm('Yakin ingin menghapus user ini secara permanen?')) { 
                    await mockUserDB.deleteUser(id); 
                    showNotification('User dihapus', 'success'); 
                    setAllUsers(await mockUserDB.getUsers()); 
                } 
            };
            
            const handleExportAll = () => { 
                if(allForms.length > 0) {
                    exportToCSV(allForms, 'SEMUA_DATA_GHPR.csv', false);
                } else {
                    showNotification('Tidak ada data untuk didownload', 'error'); 
                }
            };

            const handleDeleteForm = async (formId) => {
                if (!formId) return;
                
                try {
                    await mockDB.delete(formId);
                    showNotification('Formulir dihapus', 'success');
                    setDeleteFormId(null);
                    await loadAllData();
                } catch (e) {
                    console.error("Error deleting form:", e);
                    showNotification('Error menghapus formulir: ' + e.message, 'error');
                }
            };

            const handleViewFormInAdmin = (form) => {
                onViewForm(form);
            };

            return (
                <div className="fixed inset-0 h-[100dvh] w-full flex flex-col bg-slate-50 overflow-hidden">
                    <div className="flex-none bg-gradient-to-r from-slate-800 to-slate-900 text-white p-4 shadow-lg z-20">
                        <div className="max-w-6xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="font-bold text-xl tracking-tight">Admin Panel GHPR</h1>
                                <p className="text-slate-300 text-sm font-medium mt-1">Manajemen data dan pengguna</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={onLogout} className="bg-red-600 hover:bg-red-700 px-5 py-2.5 rounded-lg text-sm font-bold shadow-sm">
                                    Keluar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 w-full">
                        <div className="max-w-6xl mx-auto">
                            <div className="flex gap-8 border-b border-slate-300 mb-8 overflow-x-auto">
                                <button 
                                    onClick={() => setActiveTab('forms')} 
                                    className={`pb-4 px-1 font-bold transition text-lg whitespace-nowrap ${activeTab === 'forms' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    Data Formulir
                                </button>
                                <button 
                                    onClick={() => setActiveTab('users')} 
                                    className={`pb-4 px-1 font-bold transition text-lg whitespace-nowrap ${activeTab === 'users' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    Manajemen User
                                </button>
                            </div>
                            
                            {activeTab === 'forms' && (
                                <div className="bg-white rounded-xl shadow border border-slate-200 p-4 md:p-6 fade-in">
                                    <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
                                        <div>
                                            <h3 className="font-bold text-xl text-slate-800 mb-1">Semua Data Formulir GHPR</h3>
                                            <p className="text-slate-500 text-body">Total: {allForms.length} formulir</p>
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-2">
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Cari formulir..."
                                                    className="w-full md:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                    value={searchTerm}
                                                    onChange={(e) => {
                                                        setSearchTerm(e.target.value);
                                                        setCurrentPage(1);
                                                    }}
                                                />
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            </div>
                                            <button onClick={handleExportAll} className="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                                <Icons.Download className="w-4 h-4"/> Download CSV
                                            </button>
                                            <button onClick={loadAllData} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                                                <Icons.Database className="w-4 h-4"/> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto border border-slate-200 rounded-lg mobile-scroll">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-600 uppercase text-xs font-bold">
                                                <tr>
                                                    <th className="px-4 py-3">No. RM</th>
                                                    <th className="px-4 py-3">Status</th>
                                                    <th className="px-4 py-3">Nama Penderita</th>
                                                    <th className="px-4 py-3">Umur</th>
                                                    <th className="px-4 py-3">Current Owner</th>
                                                    <th className="px-4 py-3">Tgl Update</th>
                                                    <th className="px-4 py-3">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {currentForms.map(form => (
                                                    <tr key={form.id} className="hover:bg-slate-50">
                                                        <td className="px-4 py-3 font-mono">
                                                            {form.noRM || 'DRAFT'}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            {getStatusBadge(form.statusData)}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="font-semibold text-slate-800">{form.namaPenderita || 'Tanpa Nama'}</div>
                                                            <div className="text-[10px] text-slate-400 mt-0.5">{form.jenisKelamin}</div>
                                                        </td>
                                                        <td className="px-4 py-3 font-medium text-slate-600">{form.umur || '-'}</td>
                                                        <td className="px-4 py-3">
                                                            <span className="text-slate-700 text-xs font-medium">
                                                                {form.currentOwner || determineCurrentOwner(form)}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-slate-500">
                                                            {new Date(form.updatedAt).toLocaleDateString()}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex gap-1">
                                                                <button 
                                                                    onClick={() => handleViewFormInAdmin(form)}
                                                                    className="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Lihat Detail"
                                                                >
                                                                    <Icons.Eye className="w-4 h-4"/>
                                                                </button>
                                                                {form.statusData === 'Final' && (
                                                                    <button 
                                                                        onClick={() => onUnfinalizeForm(form)}
                                                                        className="text-amber-500 bg-amber-50 hover:bg-amber-100 p-2 rounded-lg text-xs font-bold transition"
                                                                        title="Batalkan Finalisasi"
                                                                    >
                                                                        <Icons.AlertTriangle className="w-4 h-4"/>
                                                                    </button>
                                                                )}
                                                                <button 
                                                                    onClick={() => setDeleteFormId(form.id)}
                                                                    className="text-red-500 bg-red-50 hover:bg-red-100 p-2 rounded-lg text-xs font-bold transition"
                                                                    title="Hapus Formulir"
                                                                >
                                                                    <Icons.Trash className="w-4 h-4"/>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {currentForms.length === 0 && (
                                            <div className="text-center p-8 text-slate-400 italic">
                                                {searchTerm ? 'Tidak ada formulir yang sesuai dengan pencarian' : 'Belum ada data formulir.'}
                                            </div>
                                        )}
                                    </div>
                                    
                                    {filteredForms.length > itemsPerPage && (
                                        <div className="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                            <p className="text-sm text-slate-600">
                                                Menampilkan {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, filteredForms.length)} dari {filteredForms.length} formulir
                                            </p>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={prevPage}
                                                    disabled={currentPage === 1}
                                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                                >
                                                    Sebelumnya
                                                </button>
                                                <span className="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg font-medium">
                                                    Halaman {currentPage} dari {totalPages}
                                                </span>
                                                <button
                                                    onClick={nextPage}
                                                    disabled={currentPage === totalPages}
                                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-200"
                                                >
                                                    Selanjutnya
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="mt-6 grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <p className="text-xs text-blue-600 font-bold mb-1">Draft</p>
                                            <p className="text-2xl font-bold text-blue-800">
                                                {allForms.filter(f => f.statusData === 'Draft').length}
                                            </p>
                                        </div>
                                        <div className="bg-amber-50 p-4 rounded-lg border border-amber-200">
                                            <p className="text-xs text-amber-600 font-bold mb-1">Pending Form</p>
                                            <p className="text-2xl font-bold text-amber-800">
                                                {allForms.filter(f => f.statusData === 'Pending').length}
                                            </p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-xs text-green-600 font-bold mb-1">Form Final</p>
                                            <p className="text-2xl font-bold text-green-800">
                                                {allForms.filter(f => f.statusData === 'Final').length}
                                            </p>
                                        </div>
                                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                                            <p className="text-xs text-indigo-600 font-bold mb-1">Proses</p>
                                            <p className="text-2xl font-bold text-indigo-800">
                                                {allForms.filter(f => f.statusData === 'Proses').length}
                                            </p>
                                        </div>
                                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                                            <p className="text-xs text-red-600 font-bold mb-1">Ditolak</p>
                                            <p className="text-2xl font-bold text-red-800">
                                                {allForms.filter(f => f.statusData === 'Ditolak').length}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'users' && (
                                <div className="grid md:grid-cols-2 gap-8 fade-in">
                                    <div className="bg-white rounded-xl shadow border border-slate-200 p-6 h-fit">
                                        <h3 className="font-bold text-xl text-slate-800 mb-6 pb-3 border-b border-slate-100">
                                            {editingUser ? 'Edit User' : 'Tambah User Baru'}
                                        </h3>
                                        <form onSubmit={editingUser ? handleUpdateUser : handleAddUser} className="space-y-5">
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Nama Lengkap</label>
                                                <input 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    placeholder="Contoh: John Doe" 
                                                    value={editingUser ? editingUser.name : newUser.name} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, name:e.target.value}) 
                                                        : setNewUser({...newUser, name:e.target.value})} 
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Role / Peran</label>
                                                <select 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    value={editingUser ? editingUser.role : newUser.role} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, role:e.target.value}) 
                                                        : setNewUser({...newUser, role:e.target.value})}
                                                >
                                                    <option value="user">User (Petugas)</option>
                                                    <option value="admin">Admin (Dinkes)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Unit Layanan</label>
                                                <select 
                                                    className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                    value={editingUser ? editingUser.unitName : newUser.unitName} 
                                                    onChange={e => editingUser 
                                                        ? setEditingUser({...editingUser, unitName:e.target.value}) 
                                                        : setNewUser({...newUser, unitName:e.target.value})} 
                                                    required
                                                >
                                                    <option value="">-- Pilih Unit --</option>
                                                    {ALL_SERVICES.map(p=>
                                                        <option key={p} value={p}>{p}</option>
                                                    )}
                                                </select>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Username</label>
                                                    <input 
                                                        className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                        placeholder="user123" 
                                                        value={editingUser ? editingUser.username : newUser.username} 
                                                        onChange={e => editingUser 
                                                            ? setEditingUser({...editingUser, username:e.target.value}) 
                                                            : setNewUser({...newUser, username:e.target.value})} 
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-slate-600 mb-2 text-caption">Password</label>
                                                    <input 
                                                        className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-body"
                                                        placeholder="***" 
                                                        type="password"
                                                        value={editingUser ? editingUser.password : newUser.password} 
                                                        onChange={e => editingUser 
                                                            ? setEditingUser({...editingUser, password:e.target.value}) 
                                                            : setNewUser({...newUser, password:e.target.value})} 
                                                        required
                                                    />
                                                </div>
                                            </div>
                                            <div className="flex gap-3">
                                                {editingUser && (
                                                    <button 
                                                        type="button"
                                                        onClick={() => {
                                                            setEditingUser(null);
                                                            setNewUser({ name: '', username: '', password: '', role: 'user', unitName: '' });
                                                        }}
                                                        className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition"
                                                    >
                                                        Batal
                                                    </button>
                                                )}
                                                <button 
                                                    type="submit"
                                                    className={`${editingUser ? 'flex-1' : 'w-full'} p-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition transform active:scale-95 text-subtitle`}
                                                >
                                                    {editingUser ? 'Simpan Perubahan' : 'Simpan User Baru'}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div className="bg-white rounded-xl shadow border border-slate-200 p-6">
                                        <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6 pb-3 border-b border-slate-100">
                                            <h3 className="font-bold text-xl text-slate-800">Daftar User Terdaftar ({filteredUsers.length})</h3>
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    placeholder="Cari user..."
                                                    className="w-full md:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
                                                    value={userSearchTerm}
                                                    onChange={(e) => setUserSearchTerm(e.target.value)}
                                                />
                                                <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            </div>
                                        </div>
                                        <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                            {filteredUsers.map(u => (
                                                <div key={u.id} className="flex justify-between items-center p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition group">
                                                    <div className="flex-1">
                                                        <p className="font-bold text-slate-800">{u.name}</p>
                                                        <p className="text-sm text-slate-500 mt-1">
                                                            {u.unitName}  
                                                            <span className={`ml-2 px-2 py-0.5 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                                {u.role}
                                                            </span>
                                                        </p>
                                                        <p className="text-xs text-slate-400 font-mono mt-2">
                                                            Username: @{u.username} | Password: {u.password}
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => setEditingUser(u)} 
                                                            className="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2.5 rounded-lg text-sm font-bold transition border border-blue-100"
                                                            title="Edit User"
                                                        >
                                                            <Icons.Edit className="w-4 h-4" />
                                                        </button>
                                                        {u.role !== 'admin' && u.username !== 'admin' && (
                                                            <button 
                                                                onClick={() => handleDeleteUser(u.id)} 
                                                                className="text-red-500 bg-red-50 hover:bg-red-100 p-2.5 rounded-lg text-sm font-bold transition border border-red-100"
                                                                title="Hapus User"
                                                            >
                                                                <Icons.Trash className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredUsers.length === 0 && (
                                                <div className="text-center p-8 text-slate-400 italic">
                                                    {userSearchTerm ? 'Tidak ada user yang sesuai dengan pencarian' : 'Belum ada user terdaftar.'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {deleteFormId && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icons.AlertTriangle className="w-8 h-8" />
                                </div>
                                <h3 className="font-bold text-xl mb-2 text-red-600">Hapus Formulir?</h3>
                                <p className="text-slate-500 mb-6 text-body">Formulir akan dihapus permanen.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteFormId(null)} className="flex-1 p-3.5 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition">
                                        Batal
                                    </button>
                                    <button onClick={() => handleDeleteForm(deleteFormId)} className="flex-1 p-3.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-lg font-bold hover:shadow-lg transition">
                                        Ya, Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // BAGIAN 7: RENDER UTAMA
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
